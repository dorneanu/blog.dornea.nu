<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<meta name="generator" content="Hugo 0.120.3">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet"/>
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">
<link rel="stylesheet" href="https://blog.dornea.nu/css/syntax.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />



<script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="b8a4b728-8eda-42fb-8376-10168c622160" async>

</script>

</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/' title="Home">Home</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://dornea.nu' title="About">About</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Simple memory managment using linked lists (implement my_malloc and my_free)</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>06 Dec 2010</time> 
     | 
    

    
     ~
  

8 mins
|

    
    tags: [ <a href='https://blog.dornea.nu/tags/coding' class="link silver">coding</a> <a href='https://blog.dornea.nu/tags/c' class="link silver">c</a>  ]
    

  </p>
  <div class="lh-copy post-content">
    

      <p>Suppose you were a Linux developer and you&rsquo;re about to implement the well known system calls:  <strong>malloc</strong> and <strong>free</strong>. How would you start? Which (already implemented) functions would you use? How would you <strong>organize</strong> your (free) <strong>memory</strong>? Which information would you like to have about certain memory regions? Those are the minimal problems you&rsquo;re about to face with. What about <strong>memory fragmentation</strong>? Speaking of memory: How would you implement this thing called <code>memory</code>? And so on..</p>
<p>The same task caused me a few weeks ago a lot of head scratching. Although I had a framework I could work with, it was more sophisticated than I thought. But let&rsquo;s start with simple things and have a look at the memory I was supposed to use:</p>
<p><img src="https://blog.dornea.nu/posts/img/2010/222/mm_char_memory.png" alt="Memory representation"></p>
<p>So that&rsquo;s my memory: a simple char array of BUFFSIZE elements. My code is supposed to use this range of memory in an intelligent way. Therefore we&rsquo;ll have to split the memory into multiple <strong>fragments</strong>. Each fragment has a certain size (they don&rsquo;t have to be at the same size) and coresponds to memory that has been allocated to a variable.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.c" data-lang=".c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="nf">my_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nf">my_malloc</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">status</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;o&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;o&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;l&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;�&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>my_malloc(int size)</strong> returns the address of the fragment that has been assigned to variable a or b. When there is no more space left on the memory, NULL will be returned. The same applies when free fragments can&rsquo;t be merged together to a bigger one - in this case we&rsquo;ll have to remap the fragments in order to have enough space for later memory allocations.  Furthermore you can tell* my_malloc* how much space to allocate.</p>
<p>So there must be a way how to organize our fragments inside the memory. By using only pointer to certain addresses within the memory space we have no information about its size, the data size it is storing or the next fragment. That&rsquo;s why a so called <strong>memoryBlock</strong> will be used to store this information. Given a <strong>head</strong> block a linked list should allow us to access all blocks in the memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.c" data-lang=".c"><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">memBlockState</span><span class="p">{</span><span class="n">not_allocated</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allocated</span><span class="o">=</span><span class="mi">1</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// memory block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_memoryblock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>                                       <span class="c1">// points to the data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">dataLength</span><span class="p">;</span>                     
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="n">memBlockState</span> <span class="n">state</span><span class="p">;</span>             <span class="c1">// Is this Block free?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">_memoryblock</span> <span class="o">*</span> <span class="n">nextBlock</span><span class="p">;</span>    <span class="c1">// points to the next entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">memoryBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define memoryBlockHeaderSize sizeof(memoryBlock)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// First block in the list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">memoryBlock</span><span class="o">*</span> <span class="n">head</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And this is the graphical representation:</p>
<p><img src="https://blog.dornea.nu/posts/img/2010/222/mm_head.png" alt="Memory Block(s) inside memory"></p>
<p>Now we&rsquo;ll have to inter-connect the memory blocks. Therefor we&rsquo;ll be using a <strong>pointer</strong> to next block. In that way we can iterate the blocks, (re)move them or find a suitable place where to place a new block.</p>
<p><img src="https://blog.dornea.nu/posts/img/2010/222/mm_head_nextblock.png" alt="nextBlock pointer"></p>
<p>So those are the most important programm structures. Let&rsquo;s have a look at the main function within the C-code (see appendix):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.c" data-lang=".c"><span class="line"><span class="cl"><span class="c1">// my_alloc will try to allocate &lt;byteCount&gt; bytes within our char memory. 
</span></span></span><span class="line"><span class="cl"><span class="c1">// The function will return the address of the allocated memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">my_malloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">byteCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">memoryBlock</span> <span class="o">*</span><span class="n">searchBlock</span> <span class="o">=</span> <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">b_initialized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If we don&#39;t have enough place to allocate then we give up and return NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">byteCount</span> <span class="o">&gt;</span> <span class="nf">get_free_space</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Search for the block whose dataLength &gt;= byteCount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">searchBlock</span><span class="o">-&gt;</span><span class="n">dataLength</span> <span class="o">&lt;</span> <span class="n">byteCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">searchBlock</span> <span class="o">=</span> <span class="n">searchBlock</span><span class="o">-&gt;</span><span class="n">nextBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// We have found an unused memory block. Now we split it. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tmp</span> <span class="o">=</span> <span class="nf">splitBlock</span><span class="p">(</span><span class="n">searchBlock</span><span class="p">,</span> <span class="n">byteCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Return the address of data (see memoryBlock structure)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Before beeing able to allocate some memory, the <strong>head</strong> block must be initialized.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.c" data-lang=".c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">b_initialized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">b_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// head will point to the address of memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">memoryBlock</span><span class="o">*</span><span class="p">)</span><span class="n">memory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// The data offset is &gt;beginning of memoryBlock&gt; + memoryBlockHeaderSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">head</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">head</span> <span class="o">+</span> <span class="n">memoryBlockHeaderSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span><span class="o">-&gt;</span><span class="n">dataLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="o">-</span> <span class="n">memoryBlockHeaderSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// self-explanatory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">head</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">not_allocated</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">head</span><span class="o">-&gt;</span><span class="n">nextBlock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I think the most interesting part of the allocation process is the <strong>splitBlock</strong> function. It searches for the proper block that has to be splitted into 2 parts:</p>
<ul>
<li>a smaller unused/unallocated memory block (new size = old size - byteCount)</li>
<li>an allocated memory block (size = byteCount)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.c" data-lang=".c"><span class="line"><span class="cl"><span class="n">memoryBlock</span> <span class="o">*</span><span class="nf">splitBlock</span><span class="p">(</span><span class="n">memoryBlock</span><span class="o">*</span> <span class="n">block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byteCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">memoryBlock</span> <span class="o">*</span><span class="n">new_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// When no enough space in the current block -&gt; return NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">byteCount</span> <span class="o">&gt;</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">dataLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Update blocks dataLength
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">block</span><span class="o">-&gt;</span><span class="n">dataLength</span> <span class="o">-=</span> <span class="p">(</span><span class="n">memoryBlockHeaderSize</span> <span class="o">+</span> <span class="n">byteCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create new block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">new_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">memoryBlock</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span> <span class="o">+</span> <span class="n">memoryBlockHeaderSize</span> <span class="o">+</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">dataLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... set data pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">new_block</span> <span class="o">+</span> <span class="n">memoryBlockHeaderSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">dataLength</span> <span class="o">=</span> <span class="n">byteCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">allocated</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// new_block.nextBlock will point to right neighbour of block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">nextBlock</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">nextBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">block</span><span class="o">-&gt;</span><span class="n">nextBlock</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After some dry runs - allocating memory for some integer/string variables (check out <em>test_mm.c</em>) - the memory could end up like this:</p>
<p><img src="https://blog.dornea.nu/posts/img/2010/222/mm_memory_fragmentation.png" alt="Memory fragmentation"></p>
<p>As you see we could re-arrange the allocated regions in order to get more unused/free memory space. Since this wasn&rsquo;t part of the task - although you could have a look at my_free() too -   I&rsquo;ll leave it to you to google for some dynamic memory allocation algorithms.</p>
<p>In the end I&rsquo;d like to show you some debugging stuff I&rsquo;ve made with <strong>ddd</strong>. As you see each (allocated) portion of memory has its memory header (consisting of the memoryBlock structure) plus a (void *) pointer  to an address inside the memory, where data is stored.</p>
<p><img src="https://blog.dornea.nu/posts/img/2010/222/mm_ddd_session.png" alt="Memory Block(s) inside memory"></p>
<p>Finally some output generated by the programm:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Uebersicht des Speichers: 10216 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           10216   [0x5026e0,0x504ec7]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Split block at 0x5024a0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">5
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 10188 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           10188   [0x5026e0,0x504eab]    0x504c84
</span></span><span class="line"><span class="cl">2  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Split block at 0x5024a0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 10064 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           10064   [0x5026e0,0x504e2f]    0x504c08
</span></span><span class="line"><span class="cl">2  0x504c08      TRUE            100     [0x504c20,0x504c83]    0x504c84
</span></span><span class="line"><span class="cl">3  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cool
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Split block at 0x5024a0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 9960 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           9960    [0x5026e0,0x504dc7]    0x504ba0
</span></span><span class="line"><span class="cl">2  0x504ba0      TRUE            80      [0x504bb8,0x504c07]    0x504c08
</span></span><span class="line"><span class="cl">3  0x504c08      TRUE            100     [0x504c20,0x504c83]    0x504c84
</span></span><span class="line"><span class="cl">4  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Konnte kein Speicher allozieeren
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 9960 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           9960    [0x5026e0,0x504dc7]    0x504ba0
</span></span><span class="line"><span class="cl">2  0x504ba0      TRUE            80      [0x504bb8,0x504c07]    0x504c08
</span></span><span class="line"><span class="cl">3  0x504c08      TRUE            100     [0x504c20,0x504c83]    0x504c84
</span></span><span class="line"><span class="cl">4  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Free block at 0x504c08
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 9960 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           9960    [0x5026e0,0x504dc7]    0x504ba0
</span></span><span class="line"><span class="cl">2  0x504ba0      TRUE            204     [0x504bb8,0x504c83]    0x504c84
</span></span><span class="line"><span class="cl">3  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 9960 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           9960    [0x5026e0,0x504dc7]    0x504ba0
</span></span><span class="line"><span class="cl">2  0x504ba0      TRUE            204     [0x504bb8,0x504c83]    0x504c84
</span></span><span class="line"><span class="cl">3  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Split block at 0x5024a0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 9856 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           9856    [0x5026e0,0x504d5f]    0x504b38
</span></span><span class="line"><span class="cl">2  0x504b38      TRUE            80      [0x504b50,0x504b9f]    0x504ba0
</span></span><span class="line"><span class="cl">3  0x504ba0      TRUE            204     [0x504bb8,0x504c83]    0x504c84
</span></span><span class="line"><span class="cl">4  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Free block at 0x504ba0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 9856 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           9856    [0x5026e0,0x504d5f]    0x504b38
</span></span><span class="line"><span class="cl">2  0x504b38      TRUE            308     [0x504b50,0x504c83]    0x504c84
</span></span><span class="line"><span class="cl">3  0x504c84      TRUE            4       [0x504c9c,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Free block at 0x504c84
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 9856 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           9856    [0x5026e0,0x504d5f]    0x504b38
</span></span><span class="line"><span class="cl">2  0x504b38      TRUE            336     [0x504b50,0x504c9f]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[DEBUG] Free block at 0x504b38
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uebersicht des Speichers: 10216 / 10240 Speicher frei
</span></span><span class="line"><span class="cl">------------------------------------------------
</span></span><span class="line"><span class="cl">#  at            allocated       space   data                   next block
</span></span><span class="line"><span class="cl">1  0x5024a0      FALSE           10216   [0x5026e0,0x504ec7]    0x0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Press any key to continue...(Where&#39;s the &#39;any&#39; key btw?)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Download material:</strong></p>
<table style="width: 100%;" border="1" cellspacing="1" cellpadding="1">
  <tr>
    <td class="rtecenter" style="background-color: #9999ff;" colspan="2">
      <strong>mm.c</strong>
    </td>
<pre><code>&lt;td style=&quot;border-color: #000000;&quot;&gt;
  &lt;a href=&quot;http://git.dornea.nu/studium/raw/master/wise2010-2011/ti3/exercises/0x4/Aufgabe_4/mm.c&quot;&gt;http://git.dornea.nu/studium/raw/master/wise2010-2011/ti3/exercises/0x4/Aufgabe_4/mm.c&lt;/a&gt;
&lt;/td&gt;
</code></pre>
  </tr>
  <tr>
    <td class="rtecenter" style="background-color: #9999ff;" colspan="2">
      <strong>mm.h</strong>
    </td>
<pre><code>&lt;td style=&quot;border-color: #000000;&quot;&gt;
  &lt;a href=&quot;http://git.dornea.nu/studium/raw/master/wise2010-2011/ti3/exercises/0x4/Aufgabe_4/mm.h&quot;&gt;http://git.dornea.nu/studium/raw/master/wise2010-2011/ti3/exercises/0x4/Aufgabe_4/mm.h&lt;/a&gt;
&lt;/td&gt;
</code></pre>
  </tr>
  <tr>
    <td class="rtecenter" style="background-color: #9999ff;" colspan="2">
      <strong>test_mm.c</strong>
    </td>
<pre><code>&lt;td style=&quot;border-color: #000000;&quot;&gt;
  &lt;a href=&quot;http://git.dornea.nu/studium/raw/master/wise2010-2011/ti3/exercises/0x4/Aufgabe_4/test_mm.c&quot;&gt;http://git.dornea.nu/studium/raw/master/wise2010-2011/ti3/exercises/0x4/Aufgabe_4/test_mm.c&lt;/a&gt;
&lt;/td&gt;
</code></pre>
  </tr>
</table>

    

  </div>
  <div id="comments">
      

  </div>
</main>
 








<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="https://blog.dornea.nu/2010/11/25/howto-snat/ip-masquerade-between-2-wlan-cards-on-linux/">prev</a>
  <a href="https://blog.dornea.nu/2011/02/04/openbsd-4.8-first-impressions/">next</a>
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
  2009-2025 Victor Dorneanu - All rights reserved
  <a href="https://blog.dornea.nu/feed.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
</footer>

  






<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}







</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
