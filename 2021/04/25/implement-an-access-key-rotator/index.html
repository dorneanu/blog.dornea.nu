<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<meta name="generator" content="Hugo 0.120.3">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet"/>
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">
<link rel="stylesheet" href="https://blog.dornea.nu/css/syntax.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />



<script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="b8a4b728-8eda-42fb-8376-10168c622160" async>

</script>

</head>
<body class="global-font">
  <nav class="fixed w-100 bg-white bb b--black-10" id="navbar" style="z-index: 9999;">
  <div class="content-width center flex flex-wrap justify-between items-center pa3">
    
    <div class="flex items-center">
      <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph3 br2 white" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
    </div>

    
    <div class="dn flex-l items-center">
      
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
        
      
    </div>

    
    <div class="db dn-l">
      <button class="bg-transparent bn pointer dim" id="menu-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  
  <div class="dn bg-white w-100 pa3 shadow-1" id="mobile-menu">
    
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
      
    
  </div>
</nav>


<div class="h3"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    
    menuToggle.addEventListener('click', function() {
      const expanded = mobileMenu.classList.contains('db');
      mobileMenu.classList.toggle('db');
      mobileMenu.classList.toggle('dn');
    });
  });
</script>

  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Implement an access key rotator</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>25 Apr 2021</time> 
     | 
    

    
     ~
  

9 mins
|

    
    tags: [ <a href='https://blog.dornea.nu/tags/golang' class="link silver">golang</a> <a href='https://blog.dornea.nu/tags/architecture' class="link silver">architecture</a> <a href='https://blog.dornea.nu/tags/aws' class="link silver">aws</a> <a href='https://blog.dornea.nu/tags/github' class="link silver">github</a>  ]
    

  </p>
  <div class="lh-copy post-content">
    

      <h2 id="introduction">Introduction</h2>
<p>With the recent success of <a href="https://docs.github.com/en/actions/learn-github-actions">Github actions</a> you can automate lots of things whenever something in your repos changes, e.g. automatically generate static HTML content (using <a href="https://blog.dornea.nu/tags/hugo">hugo</a>) and push it to some repository for which GitHub Pages has been configured. Check this <a href="https://github.com/sdras/awesome-actions">awesome actions</a> list for more use cases.</p>
<p>Using <a href="https://docs.github.com/en/actions/reference/encrypted-secrets">encrypted secrets</a> defined either per repository or organization, you can bring your Github workflow to the next level: Authenticate against APIs, login to different services while keeping your secrets/credentials away from your repositories. As a general you should <strong>never</strong> store credentials in your repositories, even
if they&rsquo;re private. Misconfigurations happen all the time and private repos can become public ones without further notice.</p>
<p>In this post I want to show the <a href="https://blog.dornea.nu/tags/golang">Golang</a> way how to update Github <strong>secrets</strong> in some repository. These secrets (more concrete an <code>AWS IAM access key ID</code> and an <code>AWS IAM access secret key</code>) should be used to interact with <a href="https://blog.dornea.nu/tags/aws">AWS</a>. Rotating these keys regularly is essential and also part of the <a href="https://docs.aws.amazon.com/general/latest/gr/aws-access-keys-best-practices.html">AWS access keys best practices</a>.</p>



<blockquote class="notice info">
  Make sure you also check <a href="https://github.com/dorneanu/access-key-rotator">github.com/dorneanu/access-key-rotator</a> for the complete project.
</blockquote>

<h2 id="clean-architecture">Clean architecture</h2>
<p>I&rsquo;m obsessed with clean code, clean architecture and almost everything that has an easy to understand structure.
First of all I&rsquo;ll start with the <code>use cases</code> which describe what the application is capabable of doing. In our case we have</p>
<ul>
<li>Rotate keys
<ul>
<li>Given a <code>key manager</code> the existing access keys will be rotated</li>
</ul>
</li>
<li>Upload secrets
<ul>
<li>using a <code>secrets store</code> we&rsquo;ll upload the <strong>encrypted</strong> access key to some storage for later usage</li>
</ul>
</li>
</ul>
<p>The <code>KeyManager</code> and the <code>SecretsStore</code> are interfaces to be implemented by different service providers. What the both have in common is the
<code>AccessKey</code> data structure which holds everything we need to know about an access key.</p>
<figure><img src="https://blog.dornea.nu/posts/img/2021/key-rotator-interfavces-entities.png"
         alt="Figure 1: Interfaces using entities"/><figcaption>
            <p>Figure 1: Interfaces using entities</p>
        </figcaption>
</figure>

<p>Now that we have defined the general application design, let&rsquo;s go more into details and see which components have to implement the declared interfaces:</p>
<ul>
<li><code>KeyManager</code>
<ul>
<li>a key manager is something that holds/stores your access keys and provides functionalities (CRUD: create, read, update, delete) in order to manage those</li>
<li>examples: AWS IAM, Google Cloud IAM, Azure IAM</li>
</ul>
</li>
<li><code>SecretsStore</code>
<ul>
<li>something that stores your access keys in a secure manner</li>
<li>examples: GitHub Secrets, Gitlab Secrets, LastPass</li>
</ul>
</li>
<li><code>ConfigStore</code>
<ul>
<li>something related to a parameter store</li>
<li>examples: AWS SecretsManager, Google Cloud Secret Manager</li>
</ul>
</li>
</ul>
<p>Each of these components (using 3rd-party libraries etc.) will need to implement the correspondig interface.</p>
<figure><img src="https://blog.dornea.nu/posts/img/2021/key-rotator.png"
         alt="Figure 2: Components implementing interfaces"/><figcaption>
            <p>Figure 2: Components implementing interfaces</p>
        </figcaption>
</figure>

<h2 id="aws-golang-sdk-v2">AWS Golang SDK v2</h2>
<p>I&rsquo;ll be using the latest Golang SDK which is <a href="https://github.com/aws/aws-sdk-go-v2">v2</a>. In order to manage the <a href="https://aws.github.io/aws-sdk-go-v2/docs/code-examples/iam/">IAM access</a> keys we&rsquo;re going to need these endpoints:</p>
<ul>
<li>list all available access keys using <a href="https://aws.github.io/aws-sdk-go-v2/docs/code-examples/iam/listaccesskeys/">ListAccessKeysV2</a></li>
<li>generate new IAM access key using <a href="https://aws.github.io/aws-sdk-go-v2/docs/code-examples/iam/createaccesskey/">CreateAccessKeyv2</a></li>
<li>delete old access keys using <a href="https://aws.github.io/aws-sdk-go-v2/docs/code-examples/iam/deleteaccesskey/">DeleteAccessKeyv2</a></li>
</ul>
<p>In order the make the code more <strong>testable</strong> I&rsquo;ll be using an <strong>interface</strong> called <code>IAMAPI</code> which should contain all methods an IAM API real implementation
should provide. Generating mocks should be then also an easy task as described in <a href="https://aws.github.io/aws-sdk-go-v2/docs/unit-testing/">Unit Testing with the AWS SDK for Go V2</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">IAMAPI</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListAccessKeys</span><span class="p">()</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateAccessKey</span><span class="p">()</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteAccessKey</span><span class="p">()</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Additionally I&rsquo;ll use an own <code>Configuration</code> type meant to hold all information my applications needs. I find <a href="https://github.com/kelseyhightower/envconfig">github.com/kelseyhightower/envconfig</a> to be quite
handy when you have to deal with <strong>environment</strong> variables:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Config holds all relevant information for this application to run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">IAM_User</span>   <span class="kt">string</span> <span class="s">`envconfig:&#34;IAM_USER&#34;, required:&#34;true&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AWS_REGION</span> <span class="kt">string</span> <span class="s">`envconfig:&#34;AWS_REGION&#34; required:&#34;true&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-fetch-all-available-iam-keys">List/Fetch all available IAM keys</h3>
<p>First of all let&rsquo;s list all available IAM access keys.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/aws/aws-sdk-go-v2/aws&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/aws/aws-sdk-go-v2/config&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/aws/aws-sdk-go-v2/service/iam&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kelseyhightower/envconfig&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Config holds all relevant information for this application to run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">IAM_User</span>   <span class="kt">string</span> <span class="s">`envconfig:&#34;IAM_USER&#34;, required:&#34;true&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AWS_REGION</span> <span class="kt">string</span> <span class="s">`envconfig:&#34;AWS_REGION&#34; required:&#34;true&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// We&#39;ll define an interface fot the IAM API in order to make testing easy
</span></span></span><span class="line"><span class="cl"><span class="c1">// This interface will be extended as we go through the different steps
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">IAMAPI</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListAccessKeys</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">params</span> <span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysInput</span><span class="p">,</span> <span class="nx">optFns</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Options</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ListAccessKeys retrieves the IAM access keys for an user
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">ListAccessKeys</span><span class="p">(</span><span class="nx">c</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">api</span> <span class="nx">IAMAPI</span><span class="p">,</span> <span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">input</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysInput</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MaxItems</span><span class="p">:</span> <span class="nx">aws</span><span class="p">.</span><span class="nf">Int32</span><span class="p">(</span><span class="nb">int32</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UserName</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nf">ListAccessKeys</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// loadConfig will return an instance of Config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">loadConfig</span><span class="p">()</span> <span class="o">*</span><span class="nx">Config</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">c</span> <span class="nx">Config</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">envconfig</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Get configuration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span> <span class="o">:=</span> <span class="nf">loadConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Initialize AWS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cfg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">LoadDefaultConfig</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;configuration error, &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create new IAM client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">iam_client</span> <span class="o">:=</span> <span class="nx">iam</span><span class="p">.</span><span class="nf">NewFromConfig</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ListAccessKeys</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">iam_client</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">IAM_User</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Got an error retrieving user access keys:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Print available IAM access keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">key</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">result</span><span class="p">.</span><span class="nx">AccessKeyMetadata</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Status for access key &#34;</span> <span class="o">+</span> <span class="o">*</span><span class="nx">key</span><span class="p">.</span><span class="nx">AccessKeyId</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="nb">string</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">Status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Status for access key AKIAWSIW5AN47M5YY72J: Active
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see there is an IAM access key with the ID <code>AKIAWSIW5AN47M5YY72J</code> and it&rsquo;s active.</p>
<h3 id="generate-new-iam-access-key">Generate new IAM access key</h3>
<p>In the next step we&rsquo;ll generate a new pair of access key. Therefore we&rsquo;ll extend the <code>IAMAPI</code> interface with a 2nd method:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">IAMAPI</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListAccessKeys</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">params</span> <span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysInput</span><span class="p">,</span> <span class="nx">optFns</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Options</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateAccessKey</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">params</span> <span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">CreateAccessKeyInput</span><span class="p">,</span> <span class="nx">optFns</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Options</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">CreateAccessKeyOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Creating a new key pair should also be straght forwards:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// CreateAccessKey will create a new IAM access key for a specified user
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CreateAccessKey</span><span class="p">(</span><span class="nx">c</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">api</span> <span class="nx">IAMAPI</span><span class="p">,</span> <span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">CreateAccessKeyOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">input</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">iam</span><span class="p">.</span><span class="nx">CreateAccessKeyInput</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UserName</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nf">CreateAccessKey</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And then in the <code>main()</code> we add:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="c1">// Create new IAM access key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">new_key</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateAccessKey</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">iam_client</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">IAM_User</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t create new key: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Print new key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Created new access key with ID: &#34;</span> <span class="o">+</span> <span class="o">*</span><span class="nx">new_key</span><span class="p">.</span><span class="nx">AccessKey</span><span class="p">.</span><span class="nx">AccessKeyId</span> <span class="o">+</span> <span class="s">&#34; and secret key: &#34;</span> <span class="o">+</span> <span class="o">*</span><span class="nx">new_key</span><span class="p">.</span><span class="nx">AccessKey</span><span class="p">.</span><span class="nx">SecretAccessKey</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And if we run it, we&rsquo;ll get the new key id and the secret key:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Created new access key with ID: AKIAWSIW5AN46DT2ENLL and secret key: ****************************************
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="delete-old-access-key">Delete old access key</h3>
<p>We&rsquo;ll extend the <code>IAMAPI</code> interface again:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">IAMAPI</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListAccessKeys</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">params</span> <span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysInput</span><span class="p">,</span> <span class="nx">optFns</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Options</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">ListAccessKeysOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateAccessKey</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">params</span> <span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">CreateAccessKeyInput</span><span class="p">,</span> <span class="nx">optFns</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Options</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">CreateAccessKeyOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteAccessKey</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">params</span> <span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">DeleteAccessKeyInput</span><span class="p">,</span> <span class="nx">optFns</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Options</span><span class="p">))</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">DeleteAccessKeyOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>DeleteAccessKey</code> will also need an <code>access key ID</code> and an <code>username</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// DeleteAccessKey disables and removes an IAM access key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">DeleteAccessKey</span><span class="p">(</span><span class="nx">c</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">api</span> <span class="nx">IAMAPI</span><span class="p">,</span> <span class="nx">keyID</span><span class="p">,</span> <span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">iam</span><span class="p">.</span><span class="nx">DeleteAccessKeyOutput</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">input</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">iam</span><span class="p">.</span><span class="nx">DeleteAccessKeyInput</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">AccessKeyId</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">keyID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UserName</span><span class="p">:</span>    <span class="o">&amp;</span><span class="nx">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nf">DeleteAccessKey</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For this example we&rsquo;ll just delete the previously created IAM access key:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="c1">// Delete key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">DeleteAccessKey</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">iam_client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="nx">new_key</span><span class="p">.</span><span class="nx">AccessKey</span><span class="p">.</span><span class="nx">AccessKeyId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">IAM_User</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t delete key: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Deleted key: %s\n&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">new_key</span><span class="p">.</span><span class="nx">AccessKey</span><span class="p">.</span><span class="nx">AccessKeyId</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="github-setup">Github setup</h2>
<p>The Github implementation will have to satisfy the <code>SecretsStore</code> interface:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">SecretsStore</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">EncryptKey</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">AccessKey</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">EncryptedKey</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListSecrets</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">([]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">AccessKey</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateSecret</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">EncryptedKey</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteSecret</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">EncryptedKey</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="secretsstore-implementation">SecretsStore implementation</h3>
<p>As we have done with <strong>AWS</strong> we&rsquo;ll try to decouple everything and have less cohesion. This will make every part of our code testable.
The <code>GithubSecretsStore</code> (implementing <code>SecretsStore</code>) will look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">GithubSecretsStore</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">repo_owner</span>    <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">repo_name</span>     <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">secretsClient</span> <span class="nx">GithubSecretsService</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="make-secrets-service-abstract">Make secrets service abstract</h3>
<p>The <code>secretsClient</code> is a <strong>service</strong> that allows us to create, upload and delete secrets using <a href="https://docs.github.com/en/rest/reference/actions#secrets">Github&rsquo;s Secrets API</a>. The <code>GithubSecretsService</code>
will have following definition (make sure to have a look at the methods provided by the <a href="https://pkg.go.dev/github.com/google/go-github/v32/github#ActionsService">ActionsService</a>):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">GithubSecretsService</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetRepoPublicKey</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">repo</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">PublicKey</span><span class="p">,</span> <span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateOrUpdateRepoSecret</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">repo</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">eSecret</span> <span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">EncryptedSecret</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListRepoSecrets</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">repo</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">Secrets</span><span class="p">,</span> <span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteRepoSecret</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">repo</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This way we can create a <code>GithubSecretsStore</code> with a mocked version of <code>GithubSecretsService</code>. But there is still something missing. Of course, the <code>Github client</code> itself:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">GithubClient</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">*</span><span class="nx">github</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="use-a-real-github-client">Use a real Github client</h3>
<p>And how does this structure fit together with the <strong>service</strong> and the <strong>store</strong>? Following <em>constructor</em> should provide the answer:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewGithubClient</span><span class="p">(</span><span class="nx">accessToken</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">GithubSecretsService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ts</span> <span class="o">:=</span> <span class="nx">oauth2</span><span class="p">.</span><span class="nf">StaticTokenSource</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">oauth2</span><span class="p">.</span><span class="nx">Token</span><span class="p">{</span><span class="nx">AccessToken</span><span class="p">:</span> <span class="nx">accessToken</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tc</span> <span class="o">:=</span> <span class="nx">oauth2</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">github</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">tc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Actions</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here I initialize a new <code>github.Client</code> by using an OAUTH2 token. Afterwards I return <code>client.Actions</code> which btw satisfies the <code>GithubSecretsService</code> interface. Now let&rsquo;s code a constructor for the <code>GithubSecretsStore</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewGithubSecretsStore</span><span class="p">(</span><span class="nx">secretsService</span> <span class="nx">GithubSecretsService</span><span class="p">,</span> <span class="nx">repoOwner</span><span class="p">,</span> <span class="nx">repoName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">GithubSecretsStore</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">GithubSecretsStore</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">secretsClient</span><span class="p">:</span> <span class="nx">secretsService</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">repo_owner</span><span class="p">:</span>    <span class="nx">repoOwner</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">repo_name</span><span class="p">:</span>     <span class="nx">repoName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here <code>NewGithubSecretsStore</code> expects a <code>GithubSecretsService</code> and some other additional information (repository owner/name). As the <a href="https://brainfck.org/#LSP"> Liskow Substitution Principle</a> says:</p>
<blockquote>
<p>Express dependencies between packages in terms of interfaces and not concrete types</p>
</blockquote>
<p>in <code>NewGithubSecretsStore</code> we don&rsquo;t expect an <code>ActionsService</code> as it is returned by <code>github.Client.Actions</code>. So, in order to glue everything together we&rsquo;ll have to</p>
<ul>
<li>first create a concrete implementation of <code>GithubSecretsService</code></li>
<li>and then create a new <code>GithubSecretsStore</code> with that concrete implementation</li>
</ul>
<p>So in the real code this will look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">configStore</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;github-token&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Unable to get value from config store: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">githubSecretsClient</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">NewGithubClient</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">secretsStore</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">NewGithubSecretsStore</span><span class="p">(</span><span class="nx">githubSecretsClient</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">RepoOwner</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">RepoName</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="conclusion">Conclusion</h2>
<p>Setting up a project with clean code in mind is not an easy task. You have to abstract things
and always keep in mind:</p>
<blockquote>
<p>How can you know your code works? That’s easy. Test it. Test it again. Test it up. Test it down. Test it seven ways to Sunday &ndash; <a href="https://brainfck.org/bib.html#The%20Clean%20Code%20-%20Note%208"> Source</a></p>
</blockquote>
<p>And how do you make sure your code is <em>testable</em>? By using abstractions instead of concrete implementations and making each single part of your code <em>mockable</em> aka testable.</p>

    

  </div>
  
  
  

<section class="related-topics mt5 mb4">
  <div class="bt b--black-10 pt4">
    <h3 class="f4 fw6 mb3">Explore Related Topics</h3>
    
    <div class="cf">
      
      
      
      
      
      
      
      
      <div class="fl w-100 
        
          w-100-l
        ">
        <div class="pa3 br2 bg-white ba b--black-10 h-100">
          <h4 class="f5 fw6 mt0 mb2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            Technology
          </h4>
          <ul class="list pl0 mt0">
            <li class="pv1"><a href="https://blog.dornea.nu/tags/coding" class="link dim dark-gray f6">Coding</a></li>
            <li class="pv1"><a href="https://blog.dornea.nu/tags/emacs" class="link dim dark-gray f6">Emacs</a></li>
            
            <li class="pv1"><a href="https://brainfck.org" class="link dim dark-gray f6">My Zettelkasten</a></li>
          </ul>
        </div>
      </div>
      
      
      
      
    </div>
    
    <div class="tc mt4">
      <a href="https://blog.dornea.nu/tags" class="f6 link dim br-pill ph3 pv2 mb2 dib white bg-main-color">Browse All Tags</a>
    </div>
  </div>
</section>
  
  <div id="comments">
      

  </div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="https://blog.dornea.nu/2021/02/08/4-years-and-7-days-later/">prev</a>
  <a href="https://blog.dornea.nu/2021/06/13/note-taking-in-2021/">next</a>
  </p>
</div>

  <footer class="content-width mt5 mb4 center ph3 gray f6">
  
  <div class="bt b--black-10 pv3"></div>
  
  
  <div class="cf">
    
    <div class="fl w-100 w-50-l pr4-l">
      <p class="mb2 fw6">About this blog</p>
      <p class="mv0 lh-copy">
        Personal thoughts on programming, productivity, and philosophy. I write about things I'm learning and ideas I find interesting.
      </p>
      <p class="mt3 o-70">
        © 2025 Victor Dorneanu
      </p>
    </div>
    
    
    <div class="fl w-100 w-50-l pl4-l mt4 mt0-l">
      <div class="cf">
        
        <div class="fl w-33">
          <p class="mb2 fw6">Navigation</p>
          <ul class="list pl0">
            <li class="pv1"><a href='https://blog.dornea.nu/' title="Home" class="link gray dim">Home</a></li>
            <li class="pv1"><a href='http://dornea.nu' title="About" class="link gray dim">About</a></li>
            <li class="pv1"><a href='https://blog.dornea.nu/tags' title="Tags" class="link gray dim">Tags</a></li>
            <li class="pv1"><a href='https://brainfck.org' title="Zettelkasten" class="link gray dim">Zettelkasten</a></li>
          </ul>
        </div>
        
        
        <div class="fl w-33">
          <p class="mb2 fw6">Connect</p>
          <ul class="list pl0">
            <li class="pv1">
              <a href='https://blog.dornea.nu/feed.xml' title="RSS" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
                RSS Feed
              </a>
            </li>
            <li class="pv1">
              <a href='https://github.com/dorneanu' title="GitHub" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                GitHub
              </a>
            </li>
            <li class="pv1">
              <a href='https://www.goodreads.com/user/show/121423977-victor-dorneanu' title="Goodreads" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                Goodreads
              </a>
            </li>
          </ul>
        </div>

        
        <div class="fl w-33">
          <p class="mb2 fw6">Support</p>
          <div class="pv1">
            <a href="https://www.buymeacoffee.com/dorneanu" target="_blank" class="dib">
              <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px;">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  
  <div class="tc mt4 pt3 f7 o-70">
    Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
  </div>
</footer>
  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
