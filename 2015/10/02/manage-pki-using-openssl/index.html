<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<meta name="generator" content="Hugo 0.120.3">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet"/>
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">
<link rel="stylesheet" href="https://blog.dornea.nu/css/syntax.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />



<script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="b8a4b728-8eda-42fb-8376-10168c622160" async>

</script>

</head>
<body class="global-font">
  <nav class="fixed w-100 bg-white bb b--black-10" id="navbar" style="z-index: 9999;">
  <div class="content-width center flex flex-wrap justify-between items-center pa3">
    
    <div class="flex items-center">
      
      <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph3 br2 white" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
      
    </div>

    
    <div class="dn flex-l items-center">
      
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/archive' title="Archive">Archive</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
        
      
    </div>

    
    <div class="db dn-l">
      <button class="bg-transparent bn pointer dim" id="menu-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  
  <div class="dn bg-white w-100 pa3 shadow-1" id="mobile-menu">
    
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/archive' title="Archive">Archive</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
      
    
  </div>
</nav>


<div class="h3"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    
    menuToggle.addEventListener('click', function() {
      const expanded = mobileMenu.classList.contains('db');
      mobileMenu.classList.toggle('db');
      mobileMenu.classList.toggle('dn');
    });
  });
</script>

  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Manage PKI using OpenSSL</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>02 Oct 2015</time> 
     | 
    

    
     ~
  

37 mins
|

    
    tags: [ <a href='https://blog.dornea.nu/tags/ssl' class="link silver">ssl</a> <a href='https://blog.dornea.nu/tags/tls' class="link silver">tls</a> <a href='https://blog.dornea.nu/tags/openssl' class="link silver">openssl</a> <a href='https://blog.dornea.nu/tags/crypto' class="link silver">crypto</a> <a href='https://blog.dornea.nu/tags/python' class="link silver">python</a> <a href='https://blog.dornea.nu/tags/ipython' class="link silver">ipython</a> <a href='https://blog.dornea.nu/tags/admin' class="link silver">admin</a> <a href='https://blog.dornea.nu/tags/pki' class="link silver">pki</a> <a href='https://blog.dornea.nu/tags/openssl' class="link silver">openssl</a> <a href='https://blog.dornea.nu/tags/x.509' class="link silver">x.509</a>  ]
    

  </p>
  <div class="lh-copy post-content">
    

      


<blockquote class="notice info">
  For better display results you can also have a look at the <a href="https://github.com/dorneanu/blog/blob/master/content/jupyter/2015-10-02-manage-a-pki-using-openssl.v3.ipynb">Manage a PKI using OpenSSL</a>.
</blockquote>

<p>In the previous X.509 related <a href="http://blog.dornea.nu/2015/05/24/validating-and-pinning-x509-certificates/">post</a> I&rsquo;ve had a look at the internals of a X.509 certficate. This time I want to setup my own <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI</a> using some <em>open source</em> software. This post is a preparation for setting up a VPN using <em>OpenVPN</em>.</p>
<p>Before implementing the PKI let&rsquo;s have a look what a PKI should definitely include (make sure you have a look at the <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">Wikipedia entry</a>):</p>
<ul>
<li>certificate authority (<strong>CA</strong>)
<ul>
<li>has a public and a private key</li>
<li>used to digitally sign <em>certificates</em></li>
</ul>
</li>
<li>registration authority (<strong>RA</strong>)
<ul>
<li>verify identify of users requesting information from the CA</li>
</ul>
</li>
<li>certificate management system
<ul>
<li>probably the most important component</li>
</ul>
</li>
</ul>
<h2 id="revision">
  Revision
  <a href="#revision" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<table class="equalDevide" cellpadding="0" cellspacing="0" width="100%" border="0">
  <tr>
    <th><b>Date</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>2015-10-02</td>
    <td>First release</td>
  </tr>
  <tr>
    <td>2015-11-17</td>
    <td>Added creation of VPN-CA and related certificates.</td>
  </tr>
</table>
<h2 id="ca-types">
  CA types
  <a href="#ca-types" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<p>There are several <a href="https://pki-tutorial.readthedocs.org/en/latest/#ca-types">types</a> of <strong>CA</strong>s:</p>
<ul>
<li>root CA
<ul>
<li>the <em>root</em> of the PKI hierarchy</li>
<li>issues <em>CA certificates</em></li>
</ul>
</li>
<li>intermediate CA
<ul>
<li>the CA right below the <em>root</em> CA</li>
<li>issues <em>CA certificates</em></li>
</ul>
</li>
<li>signing CA
<ul>
<li>CA at the bottom of the PKI hierarchy</li>
<li>issues only <em>user certificates</em></li>
</ul>
</li>
</ul>
<h2 id="certificates-types">
  Certificates types
  <a href="#certificates-types" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<p>There are several <a href="https://pki-tutorial.readthedocs.org/en/latest/#certificate-types">types of certificates</a> used in real-world:</p>
<ul>
<li>root certificate
<ul>
<li><em>self-signed</em> certificate at the root of the PKI hierarchy</li>
<li>has to be kept <em>secret</em></li>
</ul>
</li>
<li>CA certificate
<ul>
<li>used to sign other certificates and CRLs</li>
</ul>
</li>
<li>user certificate
<ul>
<li>end-user certificate issues for one purpose: code signing, mail protection etc.</li>
<li>user certificates can <strong>not</strong> sign other certificates</li>
</ul>
</li>
</ul>
<h2 id="pki-hierarchy">
  PKI hierarchy
  <a href="#pki-hierarchy" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<p>In most modern companies you&rsquo;ll find a <strong>3-tier</strong> PKI hierarchy.</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {↔
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Define class (list of attributes)
</span></span><span class="line"><span class="cl">class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">class blue [color = lightblue];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA [class = &#34;emphasis&#34;, label = &#34;Root CA&#34;];
</span></span><span class="line"><span class="cl">Intermediate_CA1 [class = &#34;blue&#34;, label = &#34;Intermediate CA&#34;];
</span></span><span class="line"><span class="cl">Intermediate_CA2 [class = &#34;blue&#34;, label = &#34;Intermediate CA&#34;];
</span></span><span class="line"><span class="cl">Intermediate_CA3 [class = &#34;blue&#34;, label = &#34; ... &#34;];
</span></span><span class="line"><span class="cl">Signing_CA1 [label = &#34;Signing CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA1_0 [label = &#34; ... &#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA2 [label = &#34;Signing CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA2_0 [label = &#34; ... &#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA3 [label = &#34;Signing CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA3_0 [label = &#34; ... &#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA -&gt; Intermediate_CA1;
</span></span><span class="line"><span class="cl">Root_CA -&gt; Intermediate_CA2 [class = &#34;blackline&#34;];
</span></span><span class="line"><span class="cl">Root_CA -&gt; Intermediate_CA3 [class = &#34;blackline&#34;];
</span></span><span class="line"><span class="cl">Intermediate_CA1 -&gt; Signing_CA1;
</span></span><span class="line"><span class="cl">Intermediate_CA1 -&gt; Signing_CA1_0 [class = &#34;blackline&#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Intermediate_CA2 -&gt; Signing_CA2 [class = &#34;blackline&#34;];
</span></span><span class="line"><span class="cl">Intermediate_CA2 -&gt; Signing_CA2_0 [class = &#34;blackline&#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Intermediate_CA3 -&gt; Signing_CA3 [class = &#34;blackline&#34;];
</span></span><span class="line"><span class="cl">Intermediate_CA3 -&gt; Signing_CA3_0 [class = &#34;blackline&#34;];
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_1_0.png" alt="png"></p>
<p>For my purposes I&rsquo;ll be using only a <strong>2-tier</strong> hierarchy as shown below:</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">// Define orientation
</span></span><span class="line"><span class="cl">orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Define class (list of attributes)
</span></span><span class="line"><span class="cl">class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">class blue [color = lightblue];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA [class = &#34;emphasis&#34;, label = &#34;Root CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA1 [label = &#34;Signing CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA2 [label = &#34;Signing CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA3 [label = &#34;Signing CA&#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA1;
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_3_0.png" alt="png"></p>
<p>The level of security is increased because you separate the root CA from the issuing CAs. The root CA is mostly offline so the private key to sign the certificates should be thus protected from compromise. If one of the <em>issuing CAs</em> is being compromised, you can <em>revoke</em> the certificate issued for that specific CA and create another one using the <em>root CA</em>. You can also have multiple issuing CAs distributed geographically and with different security levels. This increases <em>flexibility</em> and <em>scalability</em>.</p>
<blockquote>
<p>Also checkout this <a href="http://blogs.technet.com/b/askds/archive/2009/09/01/designing-and-implementing-a-pki-part-i-design-and-planning.aspx">awesome article</a> for further details.</p>
</blockquote>
<h3 id="dorneanu-pki-hierarchy">
  dornea.nu PKI hierarchy
  <a href="#dorneanu-pki-hierarchy" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>And now let&rsquo;s make this whole hierarchy more personalized:</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">// Define orientation
</span></span><span class="line"><span class="cl">orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Define class (list of attributes)
</span></span><span class="line"><span class="cl">class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">class blue [color = lightblue];
</span></span><span class="line"><span class="cl">class inactive [color = lightgrey];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA [class = &#34;emphasis&#34;, label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA2 [label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA3 [label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">TLS_Server_CA [label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">TLS_Client_CA [label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">VPN_Server_CA [class = inactive, label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">VPN_Client_CA [class = inactive, label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA2 [label = &#34;issues&#34;];
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA2 -&gt; TLS_Server_CA [label = &#34;issues&#34;];
</span></span><span class="line"><span class="cl">Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA3 -&gt; VPN_Server_CA [label = &#34;issues&#34;];
</span></span><span class="line"><span class="cl">Signing_CA3 -&gt; VPN_Client_CA;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_5_0.png" alt="png"></p>
<p>We&rsquo;ll have a <strong>root CA</strong> bound to the domain <code>dornea.nu</code> followed by 2 intermediate CAs: <strong>dev.dornea.nu CA</strong> and <strong>vpn.dornea.nu CA</strong>. The CAs will be used to issue certificates to <em>users</em> and <em>networks</em>.</p>
<p>The <strong>TLS Server CA</strong> will be used by a web server like Apache or Nginx to server content over a SSL/TLS connection. The server will only accept connection from clients with a valid <strong>TLS Client CA</strong> which has been signed (and generated) from <strong>dev.dornea.nu CA</strong>.</p>
<p>The <strong>vpn.dornea.nu CA</strong> will then issue certificates for a <strong>VPN Server CA</strong> and a <strong>VPN Client CA</strong>.</p>
<blockquote>
<p>In this post the creation of the <em>VPN Server CA</em> and <em>VPN Client CA</em> will be ommitted. I&rsquo;ll cover this in a related post.</p>
</blockquote>
<h2 id="openssl">
  OpenSSL
  <a href="#openssl" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<p><a href="https://www.openssl.org">OpenSSL</a> is probably the most known cryptography software and SSL/TLS toolkit. Let&rsquo;s have look how things are done using OpenSSL. First of all I&rsquo;ll setup a directory structure to represent each of the PKI component in a clean way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">bash</span><span class="err">↔</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Initialize and create cert database:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">touch ca/root-ca/db/root-ca.db
</span></span><span class="line"><span class="cl">touch ca/root-ca/db/root-ca.db.attr
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">01</span> &gt; ca/root-ca/db/root-ca.crt.srl
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">01</span> &gt; ca/root-ca/db/root-ca.crl.srl
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl">tree /tmp/pki
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>/tmp/pki
└── ca
    ├── conf
    └── root-ca
        ├── certs
        ├── crl
        ├── db
        │   ├── root-ca.crl.srl
        │   ├── root-ca.crt.srl
        │   ├── root-ca.db
        │   └── root-ca.db.attr
        └── private

7 directories, 4 files
</code></pre>
<p>In order to create the certificates I&rsquo;ll keep track of every CA using OpenSSL <strong>configuration files</strong>.</p>
<h3 id="sub-commands">
  Sub-commands
  <a href="#sub-commands" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>Below there is an overview of the most used <em>subcommands</em> in openssl:</p>
<table class="equalDevide" cellpadding="0" cellspacing="0" width="100%" border="0">
  <tr>
    <th class="tg-yw4l">Subcommand</th>
    <th class="tg-yw4l">Description</th>
    <th>Details</th>
  </tr>
  <tr>
    <td class="tg-yw4l">req</td>
    <td class="tg-yw4l">PKCS#10 X.509 Certificate Signing Request (CSR) Management</td>
    <td>The req command primarily creates and processes certificate requests in PKCS#10 format. It can additionally create self signed certificates for use as root CAs for example.</td>
  </tr>
  <tr>
    <td class="tg-yw4l">ca</td>
    <td class="tg-yw4l">Certificate Authority (CA) Management</td>
    <td>It can be used to sign certificate requests in a variety of forms and generate CRLs it also maintains a text database of issued certificates and their status.</td>
  </tr>
  <tr>
    <td class="tg-yw4l">pkcs12</td>
    <td class="tg-yw4l">PKCS#12 Data Management</td>
    <td>The pkcs12 command allows PKCS#12 files (sometimes referred to as PFX files) to be created and parsed. PKCS#12 files are used by several programs including Netscape, MSIE and MS Outlook.</td>
  </tr>
  <tr>
    <td class="tg-yw4l">x509</td>
    <td class="tg-yw4l">X.509 Certificate Data Management</td>
    <td>It can be used to display certificate information, convert certificates to various forms, sign certificate requests like a "mini CA" or edit certificate trust settings.</td>
  </tr>
</table>
<h3 id="create-dorneanu-root-ca">
  Create dornea.nu root CA
  <a href="#create-dorneanu-root-ca" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">// Define orientation
</span></span><span class="line"><span class="cl">orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Define class (list of attributes)
</span></span><span class="line"><span class="cl">class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">class blue [color = lightblue];
</span></span><span class="line"><span class="cl">class active [color = lightgreen];
</span></span><span class="line"><span class="cl">class inactive [color = lightgrey];  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA [class = active, label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA2 [label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA3 [class = inactive, label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">TLS_Server_CA [label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">TLS_Client_CA [label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">VPN_Server_CA [class = inactive, label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">VPN_Client_CA [class = inactive, label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA2 -&gt; TLS_Server_CA;
</span></span><span class="line"><span class="cl">Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA3 -&gt; VPN_Server_CA;
</span></span><span class="line"><span class="cl">Signing_CA3 -&gt; VPN_Client_CA;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_14_0.png" alt="png"></p>
<p>The configuration file can be shown here:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">writefile</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">root</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;!-- collapse=True --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dornea.nu Root CA</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/expert/root-ca.conf.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">default</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ca</span>                      <span class="o">=</span> <span class="n">root</span><span class="o">-</span><span class="n">ca</span>               <span class="c1"># CA name</span>
</span></span><span class="line"><span class="cl"><span class="nb">dir</span>                     <span class="o">=</span> <span class="o">.</span>                     <span class="c1"># Top dir</span>
</span></span><span class="line"><span class="cl"><span class="n">base_url</span>                <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pki</span><span class="o">.</span><span class="n">dornea</span><span class="o">.</span><span class="n">nu</span>  <span class="c1"># CA base URL</span>
</span></span><span class="line"><span class="cl"><span class="n">aia_url</span>                 <span class="o">=</span> <span class="err">$</span><span class="n">base_url</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">cer</span>     <span class="c1"># CA certificate URL</span>
</span></span><span class="line"><span class="cl"><span class="n">crl_url</span>                 <span class="o">=</span> <span class="err">$</span><span class="n">base_url</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span>     <span class="c1"># CRL distribution point</span>
</span></span><span class="line"><span class="cl"><span class="n">name_opt</span>                <span class="o">=</span> <span class="n">multiline</span><span class="p">,</span><span class="o">-</span><span class="n">esc_msb</span><span class="p">,</span><span class="n">utf8</span> <span class="c1"># Display UTF-8 characters</span>
</span></span><span class="line"><span class="cl"><span class="n">openssl_conf</span>            <span class="o">=</span> <span class="n">openssl_init</span>          <span class="c1"># Library config section</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA certificate request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">req</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_bits</span>            <span class="o">=</span> <span class="mi">4096</span>                  <span class="c1"># RSA key size</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_key</span>             <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Protect private key</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha2</span>                  <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">utf8</span>                    <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Input is UTF-8</span>
</span></span><span class="line"><span class="cl"><span class="n">string_mask</span>             <span class="o">=</span> <span class="n">utf8only</span>              <span class="c1"># Emit UTF-8 strings</span>
</span></span><span class="line"><span class="cl"><span class="n">prompt</span>                  <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Don&#39;t prompt for DN</span>
</span></span><span class="line"><span class="cl"><span class="n">distinguished_name</span>      <span class="o">=</span> <span class="n">ca_dn</span>                 <span class="c1"># DN section</span>
</span></span><span class="line"><span class="cl"><span class="n">req_extensions</span>          <span class="o">=</span> <span class="n">ca_reqext</span>             <span class="c1"># Desired extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca_dn</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="s2">&#34;NU&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="s2">&#34;dornea.nu&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="s2">&#34;dornea.nu Root CA&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="s2">&#34;dornea.nu Root CA&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca_reqext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">keyCertSign</span><span class="p">,</span><span class="n">cRLSign</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">CA</span><span class="p">:</span><span class="n">true</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA operational settings</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_ca</span>              <span class="o">=</span> <span class="n">root_ca</span>               <span class="c1"># The default CA section</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">root_ca</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">certificate</span>             <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>       <span class="c1"># The CA cert</span>
</span></span><span class="line"><span class="cl"><span class="n">private_key</span>             <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">key</span> <span class="c1"># CA private key</span>
</span></span><span class="line"><span class="cl"><span class="n">new_certs_dir</span>           <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span>           <span class="c1"># Certificate archive</span>
</span></span><span class="line"><span class="cl"><span class="n">serial</span>                  <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span><span class="o">.</span><span class="n">srl</span> <span class="c1"># Serial number file</span>
</span></span><span class="line"><span class="cl"><span class="n">crlnumber</span>               <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">srl</span> <span class="c1"># CRL number file</span>
</span></span><span class="line"><span class="cl"><span class="n">database</span>                <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">db</span> <span class="c1"># Index file</span>
</span></span><span class="line"><span class="cl"><span class="n">unique_subject</span>          <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Require unique subject</span>
</span></span><span class="line"><span class="cl"><span class="n">default_days</span>            <span class="o">=</span> <span class="mi">3652</span>                  <span class="c1"># How long to certify for</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha1</span>                  <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">policy</span>                  <span class="o">=</span> <span class="n">match_pol</span>             <span class="c1"># Default naming policy</span>
</span></span><span class="line"><span class="cl"><span class="n">email_in_dn</span>             <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Add email to cert DN</span>
</span></span><span class="line"><span class="cl"><span class="n">preserve</span>                <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Keep passed DN ordering</span>
</span></span><span class="line"><span class="cl"><span class="n">name_opt</span>                <span class="o">=</span> <span class="err">$</span><span class="n">name_opt</span>             <span class="c1"># Subject DN display options</span>
</span></span><span class="line"><span class="cl"><span class="n">cert_opt</span>                <span class="o">=</span> <span class="n">ca_default</span>            <span class="c1"># Certificate display options</span>
</span></span><span class="line"><span class="cl"><span class="n">copy_extensions</span>         <span class="o">=</span> <span class="n">none</span>                  <span class="c1"># Copy extensions from CSR</span>
</span></span><span class="line"><span class="cl"><span class="n">x509_extensions</span>         <span class="o">=</span> <span class="n">signing_ca_ext</span>        <span class="c1"># Default cert extensions</span>
</span></span><span class="line"><span class="cl"><span class="n">default_crl_days</span>        <span class="o">=</span> <span class="mi">30</span>                    <span class="c1"># How long before next CRL</span>
</span></span><span class="line"><span class="cl"><span class="n">crl_extensions</span>          <span class="o">=</span> <span class="n">crl_ext</span>               <span class="c1"># CRL extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">match_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="k">match</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="k">match</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">supplied</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">any_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">domainComponent</span>         <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">emailAddress</span>            <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">root_ca_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">keyCertSign</span><span class="p">,</span><span class="n">cRLSign</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">CA</span><span class="p">:</span><span class="n">true</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">signing_ca_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">keyCertSign</span><span class="p">,</span><span class="n">cRLSign</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">CA</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">pathlen</span><span class="p">:</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl"><span class="n">crlDistributionPoints</span>   <span class="o">=</span> <span class="nd">@crl_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">crl_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">issuer_info</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">caIssuers</span><span class="p">;</span><span class="n">URI</span><span class="mf">.0</span>         <span class="o">=</span> <span class="err">$</span><span class="n">aia_url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">crl_info</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">URI</span><span class="mf">.0</span>                   <span class="o">=</span> <span class="err">$</span><span class="n">crl_url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Policy OIDs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">openssl_init</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">oid_section</span>             <span class="o">=</span> <span class="n">additional_oids</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">additional_oids</span> <span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Writing /tmp/pki/ca/conf/root-ca.conf
</code></pre>
<p>Now let&rsquo;s create the <strong>CA request</strong>. The configuration for the creation of the <strong>CSR</strong> if found in the <em>configuration</em> file in the section <code>[req]</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl req -new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -config ca/conf/root-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -out ca/root-ca/root-ca.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -keyout ca/root-ca/private/root-ca.key
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">Generating a <span class="m">4096</span> bit RSA private key
</span></span><span class="line"><span class="cl">.......................................++
</span></span><span class="line"><span class="cl">............................++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;ca/root-ca/private/root-ca.key&#39;</span>
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">-----
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now create the <strong>CA certificate</strong> (will be valid for 10 years):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl ca -selfsign <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -config ca/conf/root-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -in ca/root-ca/root-ca.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -out ca/root-ca/root-ca.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -extensions root_ca_ext <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -days <span class="m">3650</span>
</span></span><span class="line"><span class="cl">           
</span></span><span class="line"><span class="cl">Using configuration from ca/conf/root-ca.conf
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ./ca/root-ca/private/root-ca.key:
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">Certificate Details:
</span></span><span class="line"><span class="cl">        Serial Number: <span class="m">1</span> <span class="o">(</span>0x1<span class="o">)</span>
</span></span><span class="line"><span class="cl">        Validity
</span></span><span class="line"><span class="cl">            Not Before: Sep <span class="m">28</span> 17:37:10 <span class="m">2015</span> GMT
</span></span><span class="line"><span class="cl">            Not After : Sep <span class="m">25</span> 17:37:10 <span class="m">2025</span> GMT
</span></span><span class="line"><span class="cl">        Subject:
</span></span><span class="line"><span class="cl">            <span class="nv">countryName</span>               <span class="o">=</span> NU
</span></span><span class="line"><span class="cl">            <span class="nv">organizationName</span>          <span class="o">=</span> dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">organizationalUnitName</span>    <span class="o">=</span> dornea.nu Root CA
</span></span><span class="line"><span class="cl">            <span class="nv">commonName</span>                <span class="o">=</span> dornea.nu Root CA
</span></span><span class="line"><span class="cl">        X509v3 extensions:
</span></span><span class="line"><span class="cl">            X509v3 Key Usage: critical
</span></span><span class="line"><span class="cl">                Certificate Sign, CRL Sign
</span></span><span class="line"><span class="cl">            X509v3 Basic Constraints: critical
</span></span><span class="line"><span class="cl">                CA:TRUE
</span></span><span class="line"><span class="cl">            X509v3 Subject Key Identifier: 
</span></span><span class="line"><span class="cl">                72:39:A1:56:5E:9D:09:ED:8D:DE:31:9E:80:9B:C4:5D:62:3B:64:66
</span></span><span class="line"><span class="cl">            X509v3 Authority Key Identifier: 
</span></span><span class="line"><span class="cl">                keyid:72:39:A1:56:5E:9D:09:ED:8D:DE:31:9E:80:9B:C4:5D:62:3B:64:66
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Sep <span class="m">25</span> 17:37:10 <span class="m">2025</span> GMT <span class="o">(</span><span class="m">3650</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:Y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> out of <span class="m">1</span> certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span><span class="line"><span class="cl">          
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now you can check the <strong>status</strong> of the previously generated certificate (serial number = <strong>1</strong>):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ openssl -config ca/conf/root-ca.conf -status <span class="m">01</span>
</span></span><span class="line"><span class="cl">Using configuration from ca/conf/root-ca.conf
</span></span><span class="line"><span class="cl"><span class="nv">01</span><span class="o">=</span>Valid <span class="o">(</span>V<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-devdorneanu-ca">
  Create dev.dornea.nu CA
  <a href="#create-devdorneanu-ca" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">// Define orientation
</span></span><span class="line"><span class="cl">orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Define class (list of attributes)
</span></span><span class="line"><span class="cl">class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">class blue [color = lightblue];
</span></span><span class="line"><span class="cl">class active [color = lightgreen];
</span></span><span class="line"><span class="cl">class inactive [color = lightgrey];    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA [label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA2 [class = active, label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">Signing_CA3 [label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">TLS_Server_CA [label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">TLS_Client_CA [label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">VPN_Server_CA [class = inactive, label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">VPN_Client_CA [class = inactive, label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA2 -&gt; TLS_Server_CA;
</span></span><span class="line"><span class="cl">Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Signing_CA3 -&gt; VPN_Server_CA;
</span></span><span class="line"><span class="cl">Signing_CA3 -&gt; VPN_Client_CA;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_20_0.png" alt="png"></p>
<p>Create the directories:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">bash</span><span class="err">↔</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Initialize the database:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">touch ca/dev-ca/db/dev-ca.db
</span></span><span class="line"><span class="cl">touch ca/dev-ca/db/dev-ca.db.attr
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">01</span> &gt; ca/dev-ca/db/dev-ca.crt.srl
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">01</span> &gt; ca/dev-ca/db/dev-ca.crl.srl
</span></span></code></pre></td></tr></table>
</div>
</div><p>Configure the CA:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">writefile</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">dev</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;!-- collapse=True --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dev.dornea.nu CA</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adapated from https://pki-tutorial.readthedocs.org/en/latest/advanced/tls-ca.conf.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">default</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ca</span>                      <span class="o">=</span> <span class="n">dev</span><span class="o">-</span><span class="n">ca</span>                <span class="c1"># CA name</span>
</span></span><span class="line"><span class="cl"><span class="nb">dir</span>                     <span class="o">=</span> <span class="o">.</span>                     <span class="c1"># Top dir</span>
</span></span><span class="line"><span class="cl"><span class="n">base_url</span>                <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dev</span><span class="o">.</span><span class="n">dornea</span><span class="o">.</span><span class="n">nu</span><span class="o">/</span><span class="n">ca</span>    <span class="c1"># CA base URL</span>
</span></span><span class="line"><span class="cl"><span class="n">aia_url</span>                 <span class="o">=</span> <span class="err">$</span><span class="n">base_url</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">cer</span>     <span class="c1"># CA certificate URL</span>
</span></span><span class="line"><span class="cl"><span class="n">crl_url</span>                 <span class="o">=</span> <span class="err">$</span><span class="n">base_url</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span>     <span class="c1"># CRL distribution point</span>
</span></span><span class="line"><span class="cl"><span class="n">name_opt</span>                <span class="o">=</span> <span class="n">multiline</span><span class="p">,</span><span class="o">-</span><span class="n">esc_msb</span><span class="p">,</span><span class="n">utf8</span> <span class="c1"># Display UTF-8 characters</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA certificate request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">req</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_bits</span>            <span class="o">=</span> <span class="mi">4096</span>                  <span class="c1"># RSA key size</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_key</span>             <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Protect private key</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha2</span>                  <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">utf8</span>                    <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Input is UTF-8</span>
</span></span><span class="line"><span class="cl"><span class="n">string_mask</span>             <span class="o">=</span> <span class="n">utf8only</span>              <span class="c1"># Emit UTF-8 strings</span>
</span></span><span class="line"><span class="cl"><span class="n">prompt</span>                  <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Don&#39;t prompt for DN</span>
</span></span><span class="line"><span class="cl"><span class="n">distinguished_name</span>      <span class="o">=</span> <span class="n">ca_dn</span>                 <span class="c1"># DN section</span>
</span></span><span class="line"><span class="cl"><span class="n">req_extensions</span>          <span class="o">=</span> <span class="n">ca_reqext</span>             <span class="c1"># Desired extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca_dn</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="s2">&#34;NU&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="s2">&#34;dornea.nu&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="s2">&#34;dornea.nu Root CA&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="s2">&#34;dev.dornea.nu CA&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca_reqext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">keyCertSign</span><span class="p">,</span><span class="n">cRLSign</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">CA</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">pathlen</span><span class="p">:</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA operational settings</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_ca</span>              <span class="o">=</span> <span class="n">dev_ca</span>                <span class="c1"># The default CA section</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">dev_ca</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">certificate</span>             <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>       <span class="c1"># The CA cert</span>
</span></span><span class="line"><span class="cl"><span class="n">private_key</span>             <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">key</span> <span class="c1"># CA private key</span>
</span></span><span class="line"><span class="cl"><span class="n">new_certs_dir</span>           <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span>           <span class="c1"># Certificate archive</span>
</span></span><span class="line"><span class="cl"><span class="n">serial</span>                  <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span><span class="o">.</span><span class="n">srl</span> <span class="c1"># Serial number file</span>
</span></span><span class="line"><span class="cl"><span class="n">crlnumber</span>               <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">srl</span> <span class="c1"># CRL number file</span>
</span></span><span class="line"><span class="cl"><span class="n">database</span>                <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">db</span> <span class="c1"># Index file</span>
</span></span><span class="line"><span class="cl"><span class="n">unique_subject</span>          <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Require unique subject</span>
</span></span><span class="line"><span class="cl"><span class="n">default_days</span>            <span class="o">=</span> <span class="mi">365</span>                   <span class="c1"># How long to certify for</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha256</span>                <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">policy</span>                  <span class="o">=</span> <span class="n">match_pol</span>             <span class="c1"># Default naming policy</span>
</span></span><span class="line"><span class="cl"><span class="n">email_in_dn</span>             <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Add email to cert DN</span>
</span></span><span class="line"><span class="cl"><span class="n">preserve</span>                <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Keep passed DN ordering</span>
</span></span><span class="line"><span class="cl"><span class="n">name_opt</span>                <span class="o">=</span> <span class="err">$</span><span class="n">name_opt</span>             <span class="c1"># Subject DN display options</span>
</span></span><span class="line"><span class="cl"><span class="n">cert_opt</span>                <span class="o">=</span> <span class="n">ca_default</span>            <span class="c1"># Certificate display options</span>
</span></span><span class="line"><span class="cl"><span class="n">copy_extensions</span>         <span class="o">=</span> <span class="n">copy</span>                  <span class="c1"># Copy extensions from CSR</span>
</span></span><span class="line"><span class="cl"><span class="n">x509_extensions</span>         <span class="o">=</span> <span class="n">server_ext</span>            <span class="c1"># Default cert extensions</span>
</span></span><span class="line"><span class="cl"><span class="n">default_crl_days</span>        <span class="o">=</span> <span class="mi">1</span>                     <span class="c1"># How long before next CRL</span>
</span></span><span class="line"><span class="cl"><span class="n">crl_extensions</span>          <span class="o">=</span> <span class="n">crl_ext</span>               <span class="c1"># CRL extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">match_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="k">match</span>                 <span class="c1"># Must match &#39;NO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="k">match</span>                 <span class="c1"># Must match &#39;Green AS&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">extern_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">any_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">domainComponent</span>         <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">emailAddress</span>            <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">server_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span><span class="p">,</span><span class="n">keyEncipherment</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">CA</span><span class="p">:</span><span class="n">false</span>
</span></span><span class="line"><span class="cl"><span class="n">extendedKeyUsage</span>        <span class="o">=</span> <span class="n">serverAuth</span><span class="p">,</span><span class="n">clientAuth</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl"><span class="n">crlDistributionPoints</span>   <span class="o">=</span> <span class="nd">@crl_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">client_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">CA</span><span class="p">:</span><span class="n">false</span>
</span></span><span class="line"><span class="cl"><span class="n">extendedKeyUsage</span>        <span class="o">=</span> <span class="n">clientAuth</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl"><span class="n">crlDistributionPoints</span>   <span class="o">=</span> <span class="nd">@crl_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">crl_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">issuer_info</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">caIssuers</span><span class="p">;</span><span class="n">URI</span><span class="mf">.0</span>         <span class="o">=</span> <span class="err">$</span><span class="n">aia_url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">crl_info</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">URI</span><span class="mf">.0</span>                   <span class="o">=</span> <span class="err">$</span><span class="n">crl_url</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Writing /tmp/pki/ca/conf/dev-ca.conf
</code></pre>
<p>Create <strong>CA signing request</strong> (CSR):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl req -new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -config ca/conf/dev-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -out ca/dev-ca/dev-ca.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -keyout ca/dev-ca/private/dev-ca.key
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">Generating a <span class="m">4096</span> bit RSA private key
</span></span><span class="line"><span class="cl">.............++
</span></span><span class="line"><span class="cl">..........................................................................++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;ca/dev-ca/private/dev-ca.key&#39;</span>
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">-----
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we use the <strong>root CA</strong> to create the <strong>dev-ca</strong> certificate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl ca -config ca/conf/root-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -in ca/dev-ca/dev-ca.csr <span class="se">\ </span>      
</span></span><span class="line"><span class="cl">           -out ca/dev-ca/dev-ca.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -extensions signing_ca_ext
</span></span><span class="line"><span class="cl">           
</span></span><span class="line"><span class="cl">Using configuration from ca/conf/root-ca.conf
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ./ca/root-ca/private/root-ca.key:
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">Certificate Details:
</span></span><span class="line"><span class="cl">        Serial Number: <span class="m">2</span> <span class="o">(</span>0x2<span class="o">)</span>
</span></span><span class="line"><span class="cl">        Validity
</span></span><span class="line"><span class="cl">            Not Before: Sep <span class="m">28</span> 18:13:56 <span class="m">2015</span> GMT
</span></span><span class="line"><span class="cl">            Not After : Sep <span class="m">27</span> 18:13:56 <span class="m">2025</span> GMT
</span></span><span class="line"><span class="cl">        Subject:
</span></span><span class="line"><span class="cl">            <span class="nv">countryName</span>               <span class="o">=</span> NU
</span></span><span class="line"><span class="cl">            <span class="nv">organizationName</span>          <span class="o">=</span> dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">organizationalUnitName</span>    <span class="o">=</span> dornea.nu Root CA
</span></span><span class="line"><span class="cl">            <span class="nv">commonName</span>                <span class="o">=</span> dev.dornea.nu CA
</span></span><span class="line"><span class="cl">        X509v3 extensions:
</span></span><span class="line"><span class="cl">            X509v3 Key Usage: critical
</span></span><span class="line"><span class="cl">                Certificate Sign, CRL Sign
</span></span><span class="line"><span class="cl">            X509v3 Basic Constraints: critical
</span></span><span class="line"><span class="cl">                CA:TRUE, pathlen:0
</span></span><span class="line"><span class="cl">            X509v3 Subject Key Identifier: 
</span></span><span class="line"><span class="cl">                1A:42:33:7A:18:93:91:5F:B1:92:AA:37:39:76:31:92:3D:A6:2C:68
</span></span><span class="line"><span class="cl">            X509v3 Authority Key Identifier: 
</span></span><span class="line"><span class="cl">                keyid:B1:56:7C:FB:69:C7:77:CE:6C:7D:BA:CF:C7:7D:0C:6A:24:AF:8A:A1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            Authority Information Access: 
</span></span><span class="line"><span class="cl">                CA Issuers - URI:http://pki.dornea.nu/root-ca.cer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 CRL Distribution Points: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                Full Name:
</span></span><span class="line"><span class="cl">                  URI:http://pki.dornea.nu/root-ca.crl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Sep <span class="m">27</span> 18:13:56 <span class="m">2025</span> GMT <span class="o">(</span><span class="m">3652</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> out of <span class="m">1</span> certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-vpndorneanu-ca">
  Create vpn.dornea.nu CA
  <a href="#create-vpndorneanu-ca" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">  // Define orientation
</span></span><span class="line"><span class="cl">  orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // Define class (list of attributes)
</span></span><span class="line"><span class="cl">  class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">  class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">  class blue [color = lightblue];
</span></span><span class="line"><span class="cl">  class active [color = lightgreen];
</span></span><span class="line"><span class="cl">  class inactive [color = lightgrey]; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA [label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA2 [label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA3 [class = active, label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  TLS_Server_CA [label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  TLS_Client_CA [label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Server_CA [class = inactive, label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Client_CA [class = inactive, label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Client_CA;
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_30_0.png" alt="png"></p>
<p>Create the directories:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">mkdir -p ca/vpn-ca/ ca/vpn-ca/private ca/vpn-ca/db ca/vpn-ca/certs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Initialize the database:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">touch ca/vpn-ca/db/vpn-ca.db
</span></span><span class="line"><span class="cl">touch ca/vpn-ca/db/vpn-ca.db.attr
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">01</span> &gt; ca/vpn-ca/db/vpn-ca.crt.srl
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">01</span> &gt; ca/vpn-ca/db/vpn-ca.crl.srl
</span></span></code></pre></td></tr></table>
</div>
</div><p>Configure CA:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">writefile</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">vpn</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;!-- collapse=True --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># vpn.dornea.nu CA</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adapated from https://pki-tutorial.readthedocs.org/en/latest/advanced/tls-ca.conf.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">default</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ca</span>                      <span class="o">=</span> <span class="n">vpn</span><span class="o">-</span><span class="n">ca</span>                <span class="c1"># CA name</span>
</span></span><span class="line"><span class="cl"><span class="nb">dir</span>                     <span class="o">=</span> <span class="o">.</span>                     <span class="c1"># Top dir</span>
</span></span><span class="line"><span class="cl"><span class="n">base_url</span>                <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">vpn</span><span class="o">.</span><span class="n">dornea</span><span class="o">.</span><span class="n">nu</span><span class="o">/</span><span class="n">ca</span>    <span class="c1"># CA base URL</span>
</span></span><span class="line"><span class="cl"><span class="n">aia_url</span>                 <span class="o">=</span> <span class="err">$</span><span class="n">base_url</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">cer</span>     <span class="c1"># CA certificate URL</span>
</span></span><span class="line"><span class="cl"><span class="n">crl_url</span>                 <span class="o">=</span> <span class="err">$</span><span class="n">base_url</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span>     <span class="c1"># CRL distribution point</span>
</span></span><span class="line"><span class="cl"><span class="n">name_opt</span>                <span class="o">=</span> <span class="n">multiline</span><span class="p">,</span><span class="o">-</span><span class="n">esc_msb</span><span class="p">,</span><span class="n">utf8</span> <span class="c1"># Display UTF-8 characters</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA certificate request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">req</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_bits</span>            <span class="o">=</span> <span class="mi">4096</span>                  <span class="c1"># RSA key size</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_key</span>             <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Protect private key</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha2</span>                  <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">utf8</span>                    <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Input is UTF-8</span>
</span></span><span class="line"><span class="cl"><span class="n">string_mask</span>             <span class="o">=</span> <span class="n">utf8only</span>              <span class="c1"># Emit UTF-8 strings</span>
</span></span><span class="line"><span class="cl"><span class="n">prompt</span>                  <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Don&#39;t prompt for DN</span>
</span></span><span class="line"><span class="cl"><span class="n">distinguished_name</span>      <span class="o">=</span> <span class="n">ca_dn</span>                 <span class="c1"># DN section</span>
</span></span><span class="line"><span class="cl"><span class="n">req_extensions</span>          <span class="o">=</span> <span class="n">ca_reqext</span>             <span class="c1"># Desired extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca_dn</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="s2">&#34;NU&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="s2">&#34;dornea.nu&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="s2">&#34;dornea.nu Root CA&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="s2">&#34;vpn.dornea.nu CA&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca_reqext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">keyCertSign</span><span class="p">,</span><span class="n">cRLSign</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">CA</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">pathlen</span><span class="p">:</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA operational settings</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">ca</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_ca</span>              <span class="o">=</span> <span class="n">vpn_ca</span>                <span class="c1"># The default CA section</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">vpn_ca</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">certificate</span>             <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>       <span class="c1"># The CA cert</span>
</span></span><span class="line"><span class="cl"><span class="n">private_key</span>             <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">key</span> <span class="c1"># CA private key</span>
</span></span><span class="line"><span class="cl"><span class="n">new_certs_dir</span>           <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span>           <span class="c1"># Certificate archive</span>
</span></span><span class="line"><span class="cl"><span class="n">serial</span>                  <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span><span class="o">.</span><span class="n">srl</span> <span class="c1"># Serial number file</span>
</span></span><span class="line"><span class="cl"><span class="n">crlnumber</span>               <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">srl</span> <span class="c1"># CRL number file</span>
</span></span><span class="line"><span class="cl"><span class="n">database</span>                <span class="o">=</span> <span class="err">$</span><span class="nb">dir</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="err">$</span><span class="n">ca</span><span class="o">.</span><span class="n">db</span> <span class="c1"># Index file</span>
</span></span><span class="line"><span class="cl"><span class="n">unique_subject</span>          <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Require unique subject</span>
</span></span><span class="line"><span class="cl"><span class="n">default_days</span>            <span class="o">=</span> <span class="mi">365</span>                   <span class="c1"># How long to certify for</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha1</span>                  <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">policy</span>                  <span class="o">=</span> <span class="n">match_pol</span>             <span class="c1"># Default naming policy</span>
</span></span><span class="line"><span class="cl"><span class="n">email_in_dn</span>             <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Add email to cert DN</span>
</span></span><span class="line"><span class="cl"><span class="n">preserve</span>                <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Keep passed DN ordering</span>
</span></span><span class="line"><span class="cl"><span class="n">name_opt</span>                <span class="o">=</span> <span class="err">$</span><span class="n">name_opt</span>             <span class="c1"># Subject DN display options</span>
</span></span><span class="line"><span class="cl"><span class="n">cert_opt</span>                <span class="o">=</span> <span class="n">ca_default</span>            <span class="c1"># Certificate display options</span>
</span></span><span class="line"><span class="cl"><span class="n">copy_extensions</span>         <span class="o">=</span> <span class="n">copy</span>                  <span class="c1"># Copy extensions from CSR</span>
</span></span><span class="line"><span class="cl"><span class="n">x509_extensions</span>         <span class="o">=</span> <span class="n">server_ext</span>            <span class="c1"># Default cert extensions</span>
</span></span><span class="line"><span class="cl"><span class="n">default_crl_days</span>        <span class="o">=</span> <span class="mi">1</span>                     <span class="c1"># How long before next CRL</span>
</span></span><span class="line"><span class="cl"><span class="n">crl_extensions</span>          <span class="o">=</span> <span class="n">crl_ext</span>               <span class="c1"># CRL extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">match_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="k">match</span>                 <span class="c1"># Must match &#39;NO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="k">match</span>                 <span class="c1"># Must match &#39;Green AS&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">extern_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>              <span class="c1"># Included if present</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">supplied</span>              <span class="c1"># Must be present</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">any_pol</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">domainComponent</span>         <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl"><span class="n">emailAddress</span>            <span class="o">=</span> <span class="n">optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">server_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span><span class="p">,</span><span class="n">keyEncipherment</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">CA</span><span class="p">:</span><span class="n">false</span>
</span></span><span class="line"><span class="cl"><span class="n">extendedKeyUsage</span>        <span class="o">=</span> <span class="n">serverAuth</span><span class="p">,</span><span class="n">clientAuth</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl"><span class="n">crlDistributionPoints</span>   <span class="o">=</span> <span class="nd">@crl_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">client_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span>
</span></span><span class="line"><span class="cl"><span class="n">basicConstraints</span>        <span class="o">=</span> <span class="n">CA</span><span class="p">:</span><span class="n">false</span>
</span></span><span class="line"><span class="cl"><span class="n">extendedKeyUsage</span>        <span class="o">=</span> <span class="n">clientAuth</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl"><span class="n">crlDistributionPoints</span>   <span class="o">=</span> <span class="nd">@crl_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">crl_ext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityKeyIdentifier</span>  <span class="o">=</span> <span class="n">keyid</span><span class="p">:</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">authorityInfoAccess</span>     <span class="o">=</span> <span class="nd">@issuer_info</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">issuer_info</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">caIssuers</span><span class="p">;</span><span class="n">URI</span><span class="mf">.0</span>         <span class="o">=</span> <span class="err">$</span><span class="n">aia_url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">crl_info</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">URI</span><span class="mf">.0</span>                   <span class="o">=</span> <span class="err">$</span><span class="n">crl_url</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Overwriting /tmp/pki/ca/conf/vpn-ca.conf
</code></pre>
<p>Create <strong>CA signing request</strong> (CSR):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl req -new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -config ca/conf/vpn-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -out ca/vpn-ca/vpn-ca.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -keyout ca/vpn-ca/private/vpn-ca.key
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">Generating a <span class="m">4096</span> bit RSA private key
</span></span><span class="line"><span class="cl">...........................................++
</span></span><span class="line"><span class="cl">.......++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;ca/vpn-ca/private/vpn-ca.key&#39;</span>
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">-----
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we use the <strong>root CA</strong> to create the <strong>vpn-ca</strong> certificate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl ca -config ca/conf/root-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -in ca/vpn-ca/vpn-ca.csr <span class="se">\ </span>      
</span></span><span class="line"><span class="cl">           -out ca/vpn-ca/vpn-ca.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>           -extensions signing_ca_ext
</span></span><span class="line"><span class="cl">           
</span></span><span class="line"><span class="cl">Using configuration from ca/conf/root-ca.conf
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ./ca/root-ca/private/root-ca.key:
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">Certificate Details:
</span></span><span class="line"><span class="cl">        Serial Number: <span class="m">3</span> <span class="o">(</span>0x3<span class="o">)</span>
</span></span><span class="line"><span class="cl">        Validity
</span></span><span class="line"><span class="cl">            Not Before: Sep <span class="m">29</span> 18:28:45 <span class="m">2015</span> GMT
</span></span><span class="line"><span class="cl">            Not After : Sep <span class="m">28</span> 18:28:45 <span class="m">2025</span> GMT
</span></span><span class="line"><span class="cl">        Subject:
</span></span><span class="line"><span class="cl">            <span class="nv">countryName</span>               <span class="o">=</span> NU
</span></span><span class="line"><span class="cl">            <span class="nv">organizationName</span>          <span class="o">=</span> dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">organizationalUnitName</span>    <span class="o">=</span> dornea.nu Root CA
</span></span><span class="line"><span class="cl">            <span class="nv">commonName</span>                <span class="o">=</span> vpn.dornea.nu CA
</span></span><span class="line"><span class="cl">        X509v3 extensions:
</span></span><span class="line"><span class="cl">            X509v3 Key Usage: critical
</span></span><span class="line"><span class="cl">                Certificate Sign, CRL Sign
</span></span><span class="line"><span class="cl">            X509v3 Basic Constraints: critical
</span></span><span class="line"><span class="cl">                CA:TRUE, pathlen:0
</span></span><span class="line"><span class="cl">            X509v3 Subject Key Identifier: 
</span></span><span class="line"><span class="cl">                52:53:49:45:12:D4:7B:A3:B7:8D:E0:14:00:81:4E:30:BC:A0:19:69
</span></span><span class="line"><span class="cl">            X509v3 Authority Key Identifier: 
</span></span><span class="line"><span class="cl">                keyid:F4:3B:44:1F:6D:02:26:06:C1:16:B9:1F:84:FC:41:48:5B:F6:0D:77
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            Authority Information Access: 
</span></span><span class="line"><span class="cl">                CA Issuers - URI:http://pki.dornea.nu/root-ca.cer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 CRL Distribution Points: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                Full Name:
</span></span><span class="line"><span class="cl">                  URI:http://pki.dornea.nu/root-ca.crl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Sep <span class="m">28</span> 18:28:45 <span class="m">2025</span> GMT <span class="o">(</span><span class="m">3652</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> out of <span class="m">1</span> certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span><span class="line"><span class="cl">           
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="create-dev-ca-ca-chain">
  Create dev-ca CA chain
  <a href="#create-dev-ca-ca-chain" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">cat ca/dev-ca/dev-ca.crt ca/root-ca/root-ca.crt &gt; ca/dev-ca/dev-ca-chain.pem
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="create-vpn-ca-ca-chain">
  Create vpn-ca CA chain
  <a href="#create-vpn-ca-ca-chain" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">cat ca/vpn-ca/vpn-ca.crt ca/root-ca/root-ca.crt &gt; ca/vpn-ca/vpn-ca-chain.pem
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="issue-dev-ca-certificates">
  Issue dev-CA certificates
  <a href="#issue-dev-ca-certificates" class="heading-anchor" aria-label="Anchor">#</a>
</h1>
<p>We&rsquo;ll now create the <strong>TLS</strong> <em>server</em> and <em>client</em> certificates.</p>
<h2 id="create-tls-server-certificate">
  Create TLS server certificate
  <a href="#create-tls-server-certificate" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">  // Define orientation
</span></span><span class="line"><span class="cl">  orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // Define class (list of attributes)
</span></span><span class="line"><span class="cl">  class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">  class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">  class blue [color = lightblue];
</span></span><span class="line"><span class="cl">  class active [color = lightgreen];
</span></span><span class="line"><span class="cl">  class inactive [color = lightgrey]; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA [label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA2 [label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA3 [label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  TLS_Server_CA [class = active, label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  TLS_Client_CA [label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Server_CA [class = inactive, label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Client_CA [class = inactive, label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  dev_dornea_nu [class = active, label = &#34;DNS: dev.dornea.nu\nDNS: dev2.dornea.nu\nIP: 10.10.10.1\nIP: 10.20.20.1&#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Client_CA;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  TLS_Server_CA -&gt; dev_dornea_nu;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_44_0.png" alt="png"></p>
<p>We will specify <strong>multiple domains</strong> with one certificate by using <strong>SANs</strong> (Subject Alternatve Name). Those are a <em>X.509</em> V3 extension to allow a SSL certificate to specify multiple names that the certificate should match. They can contain:</p>
<ul>
<li>mail addresses</li>
<li>IP addresses</li>
<li>DNS names</li>
<li>etc.</li>
</ul>
<p>Let&rsquo;s have a look at the config file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">writefile</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">vpn</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">cert</span><span class="o">.</span><span class="n">conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;!-- collapse=True --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># # Code-signing certificate request for the VPN server</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/advanced/server.conf.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">default</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">SAN</span>                     <span class="o">=</span> <span class="n">DNS</span><span class="p">:</span><span class="n">dev</span><span class="o">.</span><span class="n">dornea</span><span class="o">.</span><span class="n">nu</span>    <span class="c1"># Default value / [S]ubject[A]lt[N]ame</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">req</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_bits</span>            <span class="o">=</span> <span class="mi">4096</span>                  <span class="c1"># RSA key size</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_key</span>             <span class="o">=</span> <span class="n">no</span>                    <span class="c1"># Protect private key</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha2</span>                  <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">utf8</span>                    <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Input is UTF-8</span>
</span></span><span class="line"><span class="cl"><span class="n">string_mask</span>             <span class="o">=</span> <span class="n">utf8only</span>              <span class="c1"># Emit UTF-8 strings</span>
</span></span><span class="line"><span class="cl"><span class="n">prompt</span>                  <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Prompt for DN</span>
</span></span><span class="line"><span class="cl"><span class="n">distinguished_name</span>      <span class="o">=</span> <span class="n">server_dn</span>             <span class="c1"># DN template</span>
</span></span><span class="line"><span class="cl"><span class="n">req_extensions</span>          <span class="o">=</span> <span class="n">server_reqext</span>         <span class="c1"># Desired extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">server_dn</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="s2">&#34;1. Country Name (2 letters) (eg, US)       &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName_max</span>         <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="s2">&#34;2. State or Province Name   (eg, region)   &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="s2">&#34;3. Locality Name            (eg, city)     &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="s2">&#34;4. Organization Name        (eg, company)  &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="s2">&#34;5. Organizational Unit Name (eg, section)  &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="s2">&#34;6. Common Name              (eg, FQDN)     &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName_max</span>          <span class="o">=</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">server_reqext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span><span class="p">,</span><span class="n">keyEncipherment</span>
</span></span><span class="line"><span class="cl"><span class="n">extendedKeyUsage</span>        <span class="o">=</span> <span class="n">serverAuth</span><span class="p">,</span><span class="n">clientAuth</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectAltName</span>          <span class="o">=</span> <span class="nd">@alt_names</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">alt_names</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">DNS</span><span class="mf">.1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">dornea</span><span class="o">.</span><span class="n">nu</span>
</span></span><span class="line"><span class="cl"><span class="n">DNS</span><span class="mf">.2</span> <span class="o">=</span> <span class="n">dev2</span><span class="o">.</span><span class="n">dornea</span><span class="o">.</span><span class="n">nu</span>
</span></span><span class="line"><span class="cl"><span class="n">IP</span><span class="mf">.1</span> <span class="o">=</span> <span class="mf">10.10.10.1</span>
</span></span><span class="line"><span class="cl"><span class="n">IP</span><span class="mf">.2</span> <span class="o">=</span> <span class="mf">10.20.20.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Overwriting /tmp/pki/ca/conf/dev-server-ca.conf
</code></pre>
<p>Create directories:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">mkdir -p ca/dev-server-ca/ ca/dev-server-ca/private ca/dev-server-ca/db ca/dev-server-ca/certs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a private key and CSR for the TLS server certificate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl req -new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -config ca/conf/dev-server-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -out ca/dev-server-ca/certs/dev.dornea.nu.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -keyout ca/dev-server-ca/certs/dev.dornea.nu.key
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">Generating a <span class="m">4096</span> bit RSA private key
</span></span><span class="line"><span class="cl">......................................................................................................................................................++
</span></span><span class="line"><span class="cl">...........................................++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;ca/dev-server-ca/private/dev-server-ca.key&#39;</span>
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">You are about to be asked to enter information that will be incorporated
</span></span><span class="line"><span class="cl">into your certificate request.
</span></span><span class="line"><span class="cl">What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class="line"><span class="cl">There are quite a few fields but you can leave some blank
</span></span><span class="line"><span class="cl">For some fields there will be a default value,
</span></span><span class="line"><span class="cl">If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">1. Country Name <span class="o">(</span><span class="m">2</span> letters<span class="o">)</span> <span class="o">(</span>eg, US<span class="o">)</span>        <span class="o">[]</span>:DE
</span></span><span class="line"><span class="cl">2. State or Province Name   <span class="o">(</span>eg, region<span class="o">)</span>    <span class="o">[]</span>:Berlin
</span></span><span class="line"><span class="cl">3. Locality Name            <span class="o">(</span>eg, city<span class="o">)</span>      <span class="o">[]</span>:Berlin
</span></span><span class="line"><span class="cl">4. Organization Name        <span class="o">(</span>eg, company<span class="o">)</span>   <span class="o">[]</span>:dornea.nu
</span></span><span class="line"><span class="cl">5. Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span>   <span class="o">[]</span>:dev.dornea.nu
</span></span><span class="line"><span class="cl">6. Common Name              <span class="o">(</span>eg, FQDN<span class="o">)</span>      <span class="o">[]</span>:dev.dornea.nu
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now use the <strong>dev-ca</strong> certificate to issue the TLS server certificate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl ca -config ca/conf/dev-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -in ca/dev-server-ca/certs/dev.dornea.nu.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -out ca/dev-server-ca/certs/dev.dornea.nu.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -extensions server_ext
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we create a <strong>PKCS#12 bundle</strong> including the private key, the certificate and the CA chain.</p>
<blockquote>
<p>PKCS#12 defines an archive file format to store crypto stuff inside a <em>single</em> file. It is usually used to store a
<em>private key</em> along with the <em>X.509 certificate</em>. The PKCS#12 file may be <em>encrypted</em> and <em>signed</em>.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> <span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl pkcs12 -export <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -name <span class="s2">&#34;dev.dornea.nu (Developer)&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -caname <span class="s2">&#34;dev.dornea.nu CA&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -caname <span class="s2">&#34;dornea.nu root CA&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -inkey certs/green.no.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -in ca/dev-server-ca/certs/dev.dornea.nu.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -certfile ca/dev-server-ca/dev-ca-chain.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -out ca/dev-server-ca/certs/dev.dornea.nu.p12
</span></span><span class="line"><span class="cl">Enter Export Password:
</span></span><span class="line"><span class="cl">Verifying - Enter Export Password:
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="verify-pkcs12-bundle">
  Verify PKCS#12 bundle
  <a href="#verify-pkcs12-bundle" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>You can now verify the bundle:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ openssl pkcs12 -in ca/dev-server-ca/certs/dev.dornea.nu.p12 -info <span class="p">|</span> egrep -e <span class="s2">&#34;issuer&#34;</span> -e <span class="s2">&#34;subject&#34;</span>
</span></span><span class="line"><span class="cl">Enter Import Password:
</span></span><span class="line"><span class="cl">MAC Iteration <span class="m">2048</span>
</span></span><span class="line"><span class="cl">MAC verified OK
</span></span><span class="line"><span class="cl">PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration <span class="m">2048</span>
</span></span><span class="line"><span class="cl">Certificate bag
</span></span><span class="line"><span class="cl">Certificate bag
</span></span><span class="line"><span class="cl">Certificate bag
</span></span><span class="line"><span class="cl">PKCS7 Data
</span></span><span class="line"><span class="cl">Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="nv">subject</span><span class="o">=</span>/C<span class="o">=</span>NU/ST<span class="o">=</span>Germany/L<span class="o">=</span>Berlin/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dev dornea.nu/CN<span class="o">=</span>dev.dornea.nu
</span></span><span class="line"><span class="cl"><span class="nv">issuer</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dev.dornea.nu CA
</span></span><span class="line"><span class="cl"><span class="nv">subject</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dev.dornea.nu CA
</span></span><span class="line"><span class="cl"><span class="nv">issuer</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dornea.nu Root CA
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl"><span class="nv">subject</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dornea.nu Root CA
</span></span><span class="line"><span class="cl"><span class="nv">issuer</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dornea.nu Root CA
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="create-tls-client-certificate">
  Create TLS client certificate
  <a href="#create-tls-client-certificate" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">  // Define orientation
</span></span><span class="line"><span class="cl">  orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // Define class (list of attributes)
</span></span><span class="line"><span class="cl">  class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">  class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">  class blue [color = lightblue];
</span></span><span class="line"><span class="cl">  class active [color = lightgreen];
</span></span><span class="line"><span class="cl">  class inactive [color = lightgrey]; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA [label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA2 [label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA3 [label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  TLS_Server_CA [label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  TLS_Client_CA [class = active, label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Server_CA [class = inactive, label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Client_CA [class = inactive, label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  dev_client_victor [class = active, label = &#34;CN: Victor Dorneanu\n&#34;];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Client_CA;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  TLS_Client_CA -&gt; dev_client_victor;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_52_0.png" alt="png"></p>
<p>Create directories:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">mkdir -p ca/dev-client-ca/ ca/dev-client-ca/ ca/dev-client-ca/db ca/dev-client-ca/certs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create config:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">writefile</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">dev</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">conf</span><span class="err">↔</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Overwriting /tmp/pki/ca/conf/dev-client-ca.conf
</code></pre>
<p>Now I&rsquo;ll create a new CSR for the user <strong>victor</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> openssl req -new <span class="se">\\</span>
</span></span><span class="line"><span class="cl">            -config ca/conf/dev-client-ca.conf <span class="se">\\</span>
</span></span><span class="line"><span class="cl">            -out ca/dev-client-ca/certs/victor.csr <span class="se">\\</span>
</span></span><span class="line"><span class="cl">            -keyout ca/dev-client-ca/certs/victor.key
</span></span><span class="line"><span class="cl">Generating a <span class="m">4096</span> bit RSA private key
</span></span><span class="line"><span class="cl">.......................................................................................++
</span></span><span class="line"><span class="cl">..........................................................................................................................................................................................++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;ca/dev-client-ca/certs/victor.key&#39;</span>
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">You are about to be asked to enter information that will be incorporated
</span></span><span class="line"><span class="cl">into your certificate request.
</span></span><span class="line"><span class="cl">What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class="line"><span class="cl">There are quite a few fields but you can leave some blank
</span></span><span class="line"><span class="cl">For some fields there will be a default value,
</span></span><span class="line"><span class="cl">If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">1. Country Name <span class="o">(</span><span class="m">2</span> letters<span class="o">)</span> <span class="o">(</span>eg, US<span class="o">)</span>        <span class="o">[]</span>:NU
</span></span><span class="line"><span class="cl">2. State or Province Name   <span class="o">(</span>eg, region<span class="o">)</span>    <span class="o">[]</span>:Germany
</span></span><span class="line"><span class="cl">3. Locality Name            <span class="o">(</span>eg, city<span class="o">)</span>      <span class="o">[]</span>:Berlin
</span></span><span class="line"><span class="cl">4. Organization Name        <span class="o">(</span>eg, company<span class="o">)</span>   <span class="o">[]</span>:dornea.nu
</span></span><span class="line"><span class="cl">5. Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span>   <span class="o">[]</span>:dev dornea.nu
</span></span><span class="line"><span class="cl">6. Common Name              <span class="o">(</span>eg, full name<span class="o">)</span> <span class="o">[]</span>:Victor Dorneanu
</span></span><span class="line"><span class="cl">7. Email Address            <span class="o">(</span>eg, name@fqdn<span class="o">)</span> <span class="o">[]</span>:blabla@dornea.nu
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now create the TLS client certificate:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl ca -config ca/conf/dev-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -in ca/dev-client-ca/certs/victor.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -out ca/dev-client-ca/certs/victor.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -extensions client_ext
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">Using configuration from ca/conf/dev-ca.conf
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ./ca/dev-ca/private/dev-ca.key:
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">Certificate Details:
</span></span><span class="line"><span class="cl">        Serial Number: <span class="m">3</span> <span class="o">(</span>0x3<span class="o">)</span>
</span></span><span class="line"><span class="cl">        Validity
</span></span><span class="line"><span class="cl">            Not Before: Sep <span class="m">30</span> 19:01:14 <span class="m">2015</span> GMT
</span></span><span class="line"><span class="cl">            Not After : Sep <span class="m">29</span> 19:01:14 <span class="m">2016</span> GMT
</span></span><span class="line"><span class="cl">        Subject:
</span></span><span class="line"><span class="cl">            <span class="nv">countryName</span>               <span class="o">=</span> NU
</span></span><span class="line"><span class="cl">            <span class="nv">stateOrProvinceName</span>       <span class="o">=</span> Germany
</span></span><span class="line"><span class="cl">            <span class="nv">localityName</span>              <span class="o">=</span> Berlin
</span></span><span class="line"><span class="cl">            <span class="nv">organizationName</span>          <span class="o">=</span> dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">organizationalUnitName</span>    <span class="o">=</span> dev dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">commonName</span>                <span class="o">=</span> Victor Dorneanu
</span></span><span class="line"><span class="cl">        X509v3 extensions:
</span></span><span class="line"><span class="cl">            X509v3 Key Usage: critical
</span></span><span class="line"><span class="cl">                Digital Signature
</span></span><span class="line"><span class="cl">            X509v3 Basic Constraints: 
</span></span><span class="line"><span class="cl">                CA:FALSE
</span></span><span class="line"><span class="cl">            X509v3 Extended Key Usage: 
</span></span><span class="line"><span class="cl">                TLS Web Client Authentication
</span></span><span class="line"><span class="cl">            X509v3 Subject Key Identifier: 
</span></span><span class="line"><span class="cl">                21:E4:47:97:E8:90:39:B5:8C:8A:5B:DD:24:78:23:A9:17:DB:97:9E
</span></span><span class="line"><span class="cl">            X509v3 Authority Key Identifier: 
</span></span><span class="line"><span class="cl">                keyid:C5:7E:17:39:6F:CE:D2:40:B8:7E:B8:5D:0E:41:04:75:BB:0D:2B:98
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            Authority Information Access: 
</span></span><span class="line"><span class="cl">                CA Issuers - URI:http://dev.dornea.nu/ca/dev-ca.cer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 CRL Distribution Points: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                Full Name:
</span></span><span class="line"><span class="cl">                  URI:http://dev.dornea.nu/ca/dev-ca.crl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 Subject Alternative Name: 
</span></span><span class="line"><span class="cl">                email:blabla@dornea.nu
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Sep <span class="m">29</span> 19:01:14 <span class="m">2016</span> GMT <span class="o">(</span><span class="m">365</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> out of <span class="m">1</span> certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-pkcs12-bundle">
  Create PKCS#12 bundle
  <a href="#create-pkcs12-bundle" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> openssl pkcs12 -export <span class="se">\\</span>
</span></span><span class="line"><span class="cl">                 -name <span class="s2">&#34;dev.dornea.nu (Developer)&#34;</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">                 -caname <span class="s2">&#34;dev.dornea.nu CA&#34;</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">                 -caname <span class="s2">&#34;dornea.nu Root CA&#34;</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">                 -inkey ca/dev-client-ca/certs/victor.key <span class="se">\\</span> 
</span></span><span class="line"><span class="cl">                 -in ca/dev-client-ca/certs/victor.crt <span class="se">\\</span> 
</span></span><span class="line"><span class="cl">                 -certfile ca/dev-ca/dev-ca-chain.pem <span class="se">\\</span> 
</span></span><span class="line"><span class="cl">                 -out ca/dev-client-ca/certs/victor.p12        
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ca/dev-client-ca/certs/victor.key:
</span></span><span class="line"><span class="cl">Enter Export Password:
</span></span><span class="line"><span class="cl">Verifying - Enter Export Password:
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now <em>verify</em> the bundle:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl pkcs12 -in ca/dev-client-ca/certs/victor.p12 -info <span class="p">|</span> egrep -e <span class="s2">&#34;issuer&#34;</span> -e <span class="s2">&#34;subject&#34;</span>
</span></span><span class="line"><span class="cl">Enter Import Password:
</span></span><span class="line"><span class="cl">MAC Iteration <span class="m">2048</span>
</span></span><span class="line"><span class="cl">MAC verified OK
</span></span><span class="line"><span class="cl">PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration <span class="m">2048</span>
</span></span><span class="line"><span class="cl">Certificate bag
</span></span><span class="line"><span class="cl">Certificate bag
</span></span><span class="line"><span class="cl">Certificate bag
</span></span><span class="line"><span class="cl">PKCS7 Data
</span></span><span class="line"><span class="cl">Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="nv">subject</span><span class="o">=</span>/C<span class="o">=</span>NU/ST<span class="o">=</span>Germany/L<span class="o">=</span>Berlin/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dev dornea.nu/CN<span class="o">=</span>Victor Dorneanu
</span></span><span class="line"><span class="cl"><span class="nv">issuer</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dev.dornea.nu CA
</span></span><span class="line"><span class="cl"><span class="nv">subject</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dev.dornea.nu CA
</span></span><span class="line"><span class="cl"><span class="nv">issuer</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dornea.nu Root CA
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl"><span class="nv">subject</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dornea.nu Root CA
</span></span><span class="line"><span class="cl"><span class="nv">issuer</span><span class="o">=</span>/C<span class="o">=</span>NU/O<span class="o">=</span>dornea.nu/OU<span class="o">=</span>dornea.nu Root CA/CN<span class="o">=</span>dornea.nu Root CA
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="issue-vpn-ca-certificates">
  Issue vpn-CA certificates
  <a href="#issue-vpn-ca-certificates" class="heading-anchor" aria-label="Anchor">#</a>
</h1>
<p>We&rsquo;ll now create <strong>VPN</strong> <em>server</em> and <em>client</em> certificates.</p>
<h2 id="create-vpn-server-certificate">
  Create VPN server certificate
  <a href="#create-vpn-server-certificate" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {↔
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // Define class (list of attributes)
</span></span><span class="line"><span class="cl">  class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">  class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">  class blue [color = lightblue];
</span></span><span class="line"><span class="cl">  class active [color = lightgreen];
</span></span><span class="line"><span class="cl">  class inactive [color = lightgrey]; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA [label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA2 [label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA3 [label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  TLS_Server_CA [label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  TLS_Client_CA [label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Server_CA [class = active, label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Client_CA [label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Client_CA;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_60_0.png" alt="png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">mkdir -p ca/vpn-ca/certs/vpn-server
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">writefile</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">vpn</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">cert</span><span class="o">.</span><span class="n">conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;!-- collapse=True --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dev.dornea.nu server certificate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/advanced/codesign.conf.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">req</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_bits</span>            <span class="o">=</span> <span class="mi">4096</span>                    <span class="c1"># RSA key size</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_key</span>             <span class="o">=</span> <span class="n">yes</span>                     <span class="c1"># Protect private key</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha2</span>                    <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">utf8</span>                    <span class="o">=</span> <span class="n">yes</span>                     <span class="c1"># Input is UTF-8</span>
</span></span><span class="line"><span class="cl"><span class="n">string_mask</span>             <span class="o">=</span> <span class="n">utf8only</span>                <span class="c1"># Emit UTF-8 strings</span>
</span></span><span class="line"><span class="cl"><span class="n">prompt</span>                  <span class="o">=</span> <span class="n">yes</span>                     <span class="c1"># Prompt for DN</span>
</span></span><span class="line"><span class="cl"><span class="n">distinguished_name</span>      <span class="o">=</span> <span class="n">vpn_server_dn</span>           <span class="c1"># DN template</span>
</span></span><span class="line"><span class="cl"><span class="n">req_extensions</span>          <span class="o">=</span> <span class="n">vpn_server_reqext</span>       <span class="c1"># Desired extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">vpn_server_dn</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="s2">&#34;1. Country Name (2 letters) (eg, US)       &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName_max</span>         <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="s2">&#34;2. State or Province Name   (eg, region)   &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="s2">&#34;3. Locality Name            (eg, city)     &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="s2">&#34;4. Organization Name        (eg, company)  &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="s2">&#34;5. Organizational Unit Name (eg, section)  &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="s2">&#34;6. Common Name              (eg, full name)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName_max</span>          <span class="o">=</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">vpn_server_reqext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span>
</span></span><span class="line"><span class="cl"><span class="n">extendedKeyUsage</span>        <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">codeSigning</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Overwriting /tmp/pki/ca/conf/vpn-server-cert.conf
</code></pre>
<h3 id="create-csr">
  Create CSR
  <a href="#create-csr" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>And now create the <strong>CSR</strong> (Code Signing Request):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> openssl req -new <span class="se">\\</span>
</span></span><span class="line"><span class="cl">            -config ca/conf/vpn-server-cert.conf <span class="se">\\</span>
</span></span><span class="line"><span class="cl">            -out ca/vpn-ca/certs/vpn-server/raspberry<span class="se">\_</span>pi.csr <span class="se">\\</span>
</span></span><span class="line"><span class="cl">            -keyout ca/vpn-ca/certs/vpn-server/raspberry<span class="se">\_</span>pi.key
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">Generating a <span class="m">4096</span> bit RSA private key
</span></span><span class="line"><span class="cl">............................................................................................................................................................++
</span></span><span class="line"><span class="cl">.....................................++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;ca/vpn-ca/certs/vpn-server/raspberry\_pi.key&#39;</span>
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verify failure
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">You are about to be asked to enter information that will be incorporated
</span></span><span class="line"><span class="cl">into your certificate request.
</span></span><span class="line"><span class="cl">What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class="line"><span class="cl">There are quite a few fields but you can leave some blank
</span></span><span class="line"><span class="cl">For some fields there will be a default value,
</span></span><span class="line"><span class="cl">If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">1. Country Name <span class="o">(</span><span class="m">2</span> letters<span class="o">)</span> <span class="o">(</span>eg, US<span class="o">)</span>        <span class="o">[]</span>:NU
</span></span><span class="line"><span class="cl">2. State or Province Name   <span class="o">(</span>eg, region<span class="o">)</span>    <span class="o">[]</span>:/dev/null
</span></span><span class="line"><span class="cl">3. Locality Name            <span class="o">(</span>eg, city<span class="o">)</span>      <span class="o">[]</span>:/dev/random
</span></span><span class="line"><span class="cl">4. Organization Name        <span class="o">(</span>eg, company<span class="o">)</span>   <span class="o">[]</span>:dornea.nu
</span></span><span class="line"><span class="cl">5. Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span>   <span class="o">[]</span>:VPN
</span></span><span class="line"><span class="cl">6. Common Name              <span class="o">(</span>eg, full name<span class="o">)</span> <span class="o">[]</span>:vpn.dornea.nu
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sign-certificate">
  Sign certificate
  <a href="#sign-certificate" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>Now use the <strong>VPN-CA</strong> to issue the <strong>CRT</strong> (Code Signing Certificate):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl ca -config ca/conf/vpn-ca.conf <span class="se">\ </span>                                                              <span class="m">1</span> ↵
</span></span><span class="line"><span class="cl">                -in ca/vpn-ca/certs/vpn-server/raspberry_pi.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -out ca/vpn-ca/certs/vpn-server/raspberry_pi.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -extensions server_ext
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">Using configuration from ca/conf/vpn-ca.conf
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ./ca/vpn-ca/private/vpn-ca.key:
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">Certificate Details:
</span></span><span class="line"><span class="cl">        Serial Number: <span class="m">1</span> <span class="o">(</span>0x1<span class="o">)</span>
</span></span><span class="line"><span class="cl">        Validity
</span></span><span class="line"><span class="cl">            Not Before: Nov  <span class="m">9</span> 19:39:48 <span class="m">2015</span> GMT
</span></span><span class="line"><span class="cl">            Not After : Nov  <span class="m">8</span> 19:39:48 <span class="m">2016</span> GMT
</span></span><span class="line"><span class="cl">        Subject:
</span></span><span class="line"><span class="cl">            <span class="nv">countryName</span>               <span class="o">=</span> NU
</span></span><span class="line"><span class="cl">            <span class="nv">stateOrProvinceName</span>       <span class="o">=</span> /dev/null
</span></span><span class="line"><span class="cl">            <span class="nv">localityName</span>              <span class="o">=</span> /dev/random
</span></span><span class="line"><span class="cl">            <span class="nv">organizationName</span>          <span class="o">=</span> dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">organizationalUnitName</span>    <span class="o">=</span> VPN
</span></span><span class="line"><span class="cl">            <span class="nv">commonName</span>                <span class="o">=</span> vpn.dornea.nu
</span></span><span class="line"><span class="cl">        X509v3 extensions:
</span></span><span class="line"><span class="cl">            X509v3 Key Usage: critical
</span></span><span class="line"><span class="cl">                Digital Signature, Key Encipherment
</span></span><span class="line"><span class="cl">            X509v3 Basic Constraints: 
</span></span><span class="line"><span class="cl">                CA:FALSE
</span></span><span class="line"><span class="cl">            X509v3 Extended Key Usage: 
</span></span><span class="line"><span class="cl">                TLS Web Server Authentication, TLS Web Client Authentication
</span></span><span class="line"><span class="cl">            X509v3 Subject Key Identifier: 
</span></span><span class="line"><span class="cl">                80:CA:5B:3C:C7:8A:E4:76:FF:4B:DC:5D:17:F9:99:07:27:69:76:60
</span></span><span class="line"><span class="cl">            X509v3 Authority Key Identifier: 
</span></span><span class="line"><span class="cl">                keyid:E2:DB:62:AB:F4:5D:56:17:65:B2:FA:66:55:C9:04:1D:1C:9B:10:A3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            Authority Information Access: 
</span></span><span class="line"><span class="cl">                CA Issuers - URI:http://vpn.dornea.nu/ca/vpn-ca.cer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 CRL Distribution Points: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                Full Name:
</span></span><span class="line"><span class="cl">                  URI:http://vpn.dornea.nu/ca/vpn-ca.crl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Nov  <span class="m">8</span> 19:39:48 <span class="m">2016</span> GMT <span class="o">(</span><span class="m">365</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> out of <span class="m">1</span> certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-pkcs12-bundle-1">
  Create PKCS12 bundle
  <a href="#create-pkcs12-bundle-1" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>Now bundle the <strong>root</strong> CA, <strong>VPN</strong> ca and the VPN <strong>server</strong> cert into one file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ openssl pkcs12 -export <span class="se">\ </span>                                                   
</span></span><span class="line"><span class="cl">    -name <span class="s2">&#34;VPN Server (Raspberry Pi)&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -caname <span class="s2">&#34;vpn.dornea.nu CA&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -caname <span class="s2">&#34;dornea.nu Root CA&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -inkey ca/vpn-ca/certs/vpn-server/raspberry_pi.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -in ca/vpn-ca/certs/vpn-server/raspberry_pi.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -certfile ca/vpn-ca/vpn-ca-chain.pem <span class="se">\ </span>
</span></span><span class="line"><span class="cl">    -out ca/vpn-ca/certs/vpn-server/raspberry_pi.p12
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ca/vpn-ca/certs/vpn-server/raspberry_pi.key:
</span></span><span class="line"><span class="cl">Enter Export Password:
</span></span><span class="line"><span class="cl">Verifying - Enter Export Password:
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="create-vpn-client-certificate">
  Create VPN client certificate
  <a href="#create-vpn-client-certificate" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    blockdiag code
    
  </summary>
  <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">blockdiag {
</span></span><span class="line"><span class="cl">  // Define orientation
</span></span><span class="line"><span class="cl">  orientation = portrait;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // Define class (list of attributes)
</span></span><span class="line"><span class="cl">  class emphasis [color = pink, style = dashed];
</span></span><span class="line"><span class="cl">  class blackline [color = black, style = dotted];
</span></span><span class="line"><span class="cl">  class blue [color = lightblue];
</span></span><span class="line"><span class="cl">  class active [color = lightgreen];
</span></span><span class="line"><span class="cl">  class inactive [color = lightgrey]; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA [label = &#34;dornea.nu root CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA2 [label = &#34;dev.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  Signing_CA3 [label = &#34;vpn.dornea.nu CA&#34;];
</span></span><span class="line"><span class="cl">  TLS_Server_CA [label = &#34;TLS Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  TLS_Client_CA [label = &#34;TLS Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Server_CA [label = &#34;VPN Server Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">  VPN_Client_CA [class = active, label = &#34;VPN Client Cert&#34;, shape = flowchart.terminator, style = dotted];
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA2;
</span></span><span class="line"><span class="cl">  Root_CA -&gt; Signing_CA3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA2 -&gt; TLS_Client_CA;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Server_CA;
</span></span><span class="line"><span class="cl">  Signing_CA3 -&gt; VPN_Client_CA;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div>
</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/manage-a-pki-using-openssl/output_65_0.png" alt="png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">%%bash
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp/pki
</span></span><span class="line"><span class="cl">mkdir -p ca/vpn-ca/certs/vpn-client
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%%</span><span class="n">writefile</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">vpn</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">.</span><span class="n">conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;!-- collapse=True --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># VPN client certificate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/advanced/client.conf.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">req</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">default_bits</span>            <span class="o">=</span> <span class="mi">4096</span>                  <span class="c1"># RSA key size</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypt_key</span>             <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Protect private key</span>
</span></span><span class="line"><span class="cl"><span class="n">default_md</span>              <span class="o">=</span> <span class="n">sha2</span>                  <span class="c1"># MD to use</span>
</span></span><span class="line"><span class="cl"><span class="n">utf8</span>                    <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Input is UTF-8</span>
</span></span><span class="line"><span class="cl"><span class="n">string_mask</span>             <span class="o">=</span> <span class="n">utf8only</span>              <span class="c1"># Emit UTF-8 strings</span>
</span></span><span class="line"><span class="cl"><span class="n">prompt</span>                  <span class="o">=</span> <span class="n">yes</span>                   <span class="c1"># Prompt for DN</span>
</span></span><span class="line"><span class="cl"><span class="n">distinguished_name</span>      <span class="o">=</span> <span class="n">client_dn</span>             <span class="c1"># DN template</span>
</span></span><span class="line"><span class="cl"><span class="n">req_extensions</span>          <span class="o">=</span> <span class="n">client_reqext</span>         <span class="c1"># Desired extensions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">client_dn</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName</span>             <span class="o">=</span> <span class="s2">&#34;1. Country Name (2 letters) (eg, US)       &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">countryName_max</span>         <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">stateOrProvinceName</span>     <span class="o">=</span> <span class="s2">&#34;2. State or Province Name   (eg, region)   &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">localityName</span>            <span class="o">=</span> <span class="s2">&#34;3. Locality Name            (eg, city)     &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationName</span>        <span class="o">=</span> <span class="s2">&#34;4. Organization Name        (eg, company)  &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">organizationalUnitName</span>  <span class="o">=</span> <span class="s2">&#34;5. Organizational Unit Name (eg, section)  &#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName</span>              <span class="o">=</span> <span class="s2">&#34;6. Common Name              (eg, full name)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">commonName_max</span>          <span class="o">=</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl"><span class="n">emailAddress</span>            <span class="o">=</span> <span class="s2">&#34;7. Email Address            (eg, name@fqdn)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">emailAddress_max</span>        <span class="o">=</span> <span class="mi">40</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="n">client_reqext</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">keyUsage</span>                <span class="o">=</span> <span class="n">critical</span><span class="p">,</span><span class="n">digitalSignature</span>
</span></span><span class="line"><span class="cl"><span class="n">extendedKeyUsage</span>        <span class="o">=</span> <span class="n">clientAuth</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectKeyIdentifier</span>    <span class="o">=</span> <span class="nb">hash</span>
</span></span><span class="line"><span class="cl"><span class="n">subjectAltName</span>          <span class="o">=</span> <span class="n">email</span><span class="p">:</span><span class="n">move</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>Overwriting /tmp/pki/ca/conf/vpn-client-cert.conf
</code></pre>
<h3 id="create-csr-1">
  Create CSR
  <a href="#create-csr-1" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>Now create the <strong>CSR</strong> for the user <strong>victor</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">(</span> openssl req -new <span class="se">\\</span>                      
</span></span><span class="line"><span class="cl">            -config ca/conf/vpn-client-cert.conf <span class="se">\\</span>               
</span></span><span class="line"><span class="cl">            -out ca/vpn-ca/certs/vpn-client/victor.csr <span class="se">\\</span>      
</span></span><span class="line"><span class="cl">            -keyout ca/vpn-ca/certs/vpn-client/victor.key    
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">Generating a <span class="m">4096</span> bit RSA private key
</span></span><span class="line"><span class="cl">...............................................................++
</span></span><span class="line"><span class="cl">................................................................................++
</span></span><span class="line"><span class="cl">writing new private key to <span class="s1">&#39;ca/vpn-ca/certs/vpn-client/victor.key&#39;</span>
</span></span><span class="line"><span class="cl">Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">Verifying - Enter PEM pass phrase:
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">You are about to be asked to enter information that will be incorporated
</span></span><span class="line"><span class="cl">into your certificate request.
</span></span><span class="line"><span class="cl">What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class="line"><span class="cl">There are quite a few fields but you can leave some blank
</span></span><span class="line"><span class="cl">For some fields there will be a default value,
</span></span><span class="line"><span class="cl">If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">1. Country Name <span class="o">(</span><span class="m">2</span> letters<span class="o">)</span> <span class="o">(</span>eg, US<span class="o">)</span>        <span class="o">[]</span>:NU
</span></span><span class="line"><span class="cl">2. State or Province Name   <span class="o">(</span>eg, region<span class="o">)</span>    <span class="o">[]</span>:/dev/null
</span></span><span class="line"><span class="cl">3. Locality Name            <span class="o">(</span>eg, city<span class="o">)</span>      <span class="o">[]</span>:/dev/random
</span></span><span class="line"><span class="cl">4. Organization Name        <span class="o">(</span>eg, company<span class="o">)</span>   <span class="o">[]</span>:dornea.nu
</span></span><span class="line"><span class="cl">5. Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span>   <span class="o">[]</span>:vpn.dornea.nu
</span></span><span class="line"><span class="cl">6. Common Name              <span class="o">(</span>eg, full name<span class="o">)</span> <span class="o">[]</span>:Victor Dorneanu
</span></span><span class="line"><span class="cl">7. Email Address            <span class="o">(</span>eg, name@fqdn<span class="o">)</span> <span class="o">[]</span>:bla@nsa.gov
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sign-the-csr">
  Sign the CSR
  <a href="#sign-the-csr" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>Sign the <strong>CSR</strong> using <strong>VPN-CA</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="se">\\</span><span class="o">)</span> openssl ca -config ca/conf/vpn-ca.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                -in ca/vpn-ca/certs/vpn-client/victor.csr <span class="se">\ </span>     
</span></span><span class="line"><span class="cl">                -out ca/vpn-ca/certs/vpn-client/victor.crt <span class="se">\ </span>     
</span></span><span class="line"><span class="cl">                -extensions client_ext              
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">Using configuration from ca/conf/vpn-ca.conf
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ./ca/vpn-ca/private/vpn-ca.key:
</span></span><span class="line"><span class="cl">Check that the request matches the signature
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">Certificate Details:
</span></span><span class="line"><span class="cl">        Serial Number: <span class="m">2</span> <span class="o">(</span>0x2<span class="o">)</span>
</span></span><span class="line"><span class="cl">        Validity
</span></span><span class="line"><span class="cl">            Not Before: Nov  <span class="m">9</span> 19:49:16 <span class="m">2015</span> GMT
</span></span><span class="line"><span class="cl">            Not After : Nov  <span class="m">8</span> 19:49:16 <span class="m">2016</span> GMT
</span></span><span class="line"><span class="cl">        Subject:
</span></span><span class="line"><span class="cl">            <span class="nv">countryName</span>               <span class="o">=</span> NU
</span></span><span class="line"><span class="cl">            <span class="nv">stateOrProvinceName</span>       <span class="o">=</span> /dev/null
</span></span><span class="line"><span class="cl">            <span class="nv">localityName</span>              <span class="o">=</span> /dev/random
</span></span><span class="line"><span class="cl">            <span class="nv">organizationName</span>          <span class="o">=</span> dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">organizationalUnitName</span>    <span class="o">=</span> vpn.dornea.nu
</span></span><span class="line"><span class="cl">            <span class="nv">commonName</span>                <span class="o">=</span> Victor Dorneanu
</span></span><span class="line"><span class="cl">        X509v3 extensions:
</span></span><span class="line"><span class="cl">            X509v3 Key Usage: critical
</span></span><span class="line"><span class="cl">                Digital Signature
</span></span><span class="line"><span class="cl">            X509v3 Basic Constraints: 
</span></span><span class="line"><span class="cl">                CA:FALSE
</span></span><span class="line"><span class="cl">            X509v3 Extended Key Usage: 
</span></span><span class="line"><span class="cl">                TLS Web Client Authentication
</span></span><span class="line"><span class="cl">            X509v3 Subject Key Identifier: 
</span></span><span class="line"><span class="cl">                12:3F:57:DF:1D:DB:73:BC:E0:A0:97:18:0D:B9:6C:C9:FF:53:8E:1B
</span></span><span class="line"><span class="cl">            X509v3 Authority Key Identifier: 
</span></span><span class="line"><span class="cl">                keyid:E2:DB:62:AB:F4:5D:56:17:65:B2:FA:66:55:C9:04:1D:1C:9B:10:A3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            Authority Information Access: 
</span></span><span class="line"><span class="cl">                CA Issuers - URI:http://vpn.dornea.nu/ca/vpn-ca.cer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 CRL Distribution Points: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                Full Name:
</span></span><span class="line"><span class="cl">                  URI:http://vpn.dornea.nu/ca/vpn-ca.crl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            X509v3 Subject Alternative Name: 
</span></span><span class="line"><span class="cl">                email:bla@nsa.gov
</span></span><span class="line"><span class="cl">Certificate is to be certified <span class="k">until</span> Nov  <span class="m">8</span> 19:49:16 <span class="m">2016</span> GMT <span class="o">(</span><span class="m">365</span> days<span class="o">)</span>
</span></span><span class="line"><span class="cl">Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> out of <span class="m">1</span> certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span></span><span class="line"><span class="cl">Write out database with <span class="m">1</span> new entries
</span></span><span class="line"><span class="cl">Data Base Updated
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-pkcs12-bundle-2">
  Create PKCS#12 bundle
  <a href="#create-pkcs12-bundle-2" class="heading-anchor" aria-label="Anchor">#</a>
</h3>
<p>Bundle the <strong>root CA</strong>, **VPN CA ** and the VPN <strong>client</strong> cert into a single file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ openssl pkcs12 -export <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -name <span class="s2">&#34;VPN Client (Victor)&#34;</span> <span class="se">\ </span>     
</span></span><span class="line"><span class="cl">    -caname <span class="s2">&#34;vpn.dornea.nu CA&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -caname <span class="s2">&#34;dornea.nu Root CA&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -inkey ca/vpn-ca/certs/vpn-client/victor.key <span class="se">\ </span>
</span></span><span class="line"><span class="cl">    -in ca/vpn-ca/certs/vpn-client/victor.crt <span class="se">\ </span>     
</span></span><span class="line"><span class="cl">    -certfile ca/vpn-ca/vpn-ca-chain.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -out ca/vpn-ca/certs/vpn-client/victor.p12      
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">Enter pass phrase <span class="k">for</span> ca/vpn-ca/certs/vpn-client/victor.key:
</span></span><span class="line"><span class="cl">Enter Export Password:
</span></span><span class="line"><span class="cl">Verifying - Enter Export Password:
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="references">
  References
  <a href="#references" class="heading-anchor" aria-label="Anchor">#</a>
</h2>
<ul>
<li><a href="https://pki-tutorial.readthedocs.org/en/latest/advanced/index.html">https://pki-tutorial.readthedocs.org/en/latest/advanced/index.html</a></li>
<li><a href="http://serverfault.com/questions/306345/certification-authority-root-certificate-expiry-and-renewal">http://serverfault.com/questions/306345/certification-authority-root-certificate-expiry-and-renewal</a></li>
<li><a href="http://www.flatmtn.com/article/setting-openssl-create-certificates">http://www.flatmtn.com/article/setting-openssl-create-certificates</a></li>
<li><a href="https://www.debian-administration.org/article/284/Creating_and_Using_a_self_signed__SSL_Certificates_in_debian">https://www.debian-administration.org/article/284/Creating_and_Using_a_self_signed__SSL_Certificates_in_debian</a></li>
<li><a href="http://gatwards.org/techblog/creating-and-signing-ssl-certs">http://gatwards.org/techblog/creating-and-signing-ssl-certs</a></li>
</ul>

    

  </div>
  
  
  






  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  

  
    
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
        
      
    
      
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
    
      
    
  

  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
        
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
        
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
        
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
        
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
        
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
        
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
        
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
        
      
    
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
        
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
        
      
    
      
        
      
    
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
        
      
    
      
    
    
      
    
  

  
    
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
    
  

  
    
    
      
    
      
    
      
    
      
    
      
    
    
  

  



<section class="related-topics mt5 mb4">
  <div class="bt b--black-10 pt4">
    <h3 class="f4 fw6 mb3">Related Posts</h3>

    <div class="related-posts-grid">
      
        <div class="related-post-card">
          <a href="https://blog.dornea.nu/2015/11/17/openvpn-for-paranoids/" class="link">
            <div class="related-post-title">OpenVPN for paranoids </div>
            <div class="related-post-date">17 Nov 2015</div>
            
              <div class="related-post-tags">
                
                  <span class="tag-badge">networking</span>
                
                  <span class="tag-badge">openvpn</span>
                
                  <span class="tag-badge">ssl</span>
                
              </div>
            
          </a>
        </div>
      
        <div class="related-post-card">
          <a href="https://blog.dornea.nu/2015/05/24/validating-and-pinning-x.509-certificates/" class="link">
            <div class="related-post-title">Validating and pinning X.509 certificates</div>
            <div class="related-post-date">24 May 2015</div>
            
              <div class="related-post-tags">
                
                  <span class="tag-badge">python</span>
                
                  <span class="tag-badge">coding</span>
                
                  <span class="tag-badge">ipython</span>
                
              </div>
            
          </a>
        </div>
      
        <div class="related-post-card">
          <a href="https://blog.dornea.nu/2014/07/01/on-java-openssl-crypto-blowfish-and-stuff/" class="link">
            <div class="related-post-title">On Java, OpenSSL, Crypto, Blowfish and stuff</div>
            <div class="related-post-date">01 Jul 2014</div>
            
              <div class="related-post-tags">
                
                  <span class="tag-badge">java</span>
                
                  <span class="tag-badge">cryptography</span>
                
                  <span class="tag-badge">crypto</span>
                
              </div>
            
          </a>
        </div>
      
        <div class="related-post-card">
          <a href="https://blog.dornea.nu/notes/tls-client-authentication-using-bitnami-nginx-stack/" class="link">
            <div class="related-post-title">TLS Client authentication using Bitnami Nginx stack</div>
            <div class="related-post-date">18 Feb 2016</div>
            
              <div class="related-post-tags">
                
                  <span class="tag-badge">nginx</span>
                
                  <span class="tag-badge">openssl</span>
                
                  <span class="tag-badge">tls</span>
                
              </div>
            
          </a>
        </div>
      
        <div class="related-post-card">
          <a href="https://blog.dornea.nu/2014/01/17/links-of-the-week-23/" class="link">
            <div class="related-post-title">Links of the Week 23</div>
            <div class="related-post-date">17 Jan 2014</div>
            
              <div class="related-post-tags">
                
                  <span class="tag-badge">botnet</span>
                
                  <span class="tag-badge">crypto</span>
                
                  <span class="tag-badge">tools</span>
                
              </div>
            
          </a>
        </div>
      
        <div class="related-post-card">
          <a href="https://blog.dornea.nu/2015/11/06/advanced-inter-vlan-switching-using-cisco/" class="link">
            <div class="related-post-title">Advanced inter VLAN switching using Cisco</div>
            <div class="related-post-date">06 Nov 2015</div>
            
              <div class="related-post-tags">
                
                  <span class="tag-badge">networking</span>
                
                  <span class="tag-badge">cisco</span>
                
                  <span class="tag-badge">ccna</span>
                
              </div>
            
          </a>
        </div>
      
    </div>

    <div class="tc mt4">
      <a href="https://blog.dornea.nu/tags" class="f6 link dim br-pill ph3 pv2 mb2 dib white bg-main-color">Browse All Tags</a>
    </div>
  </div>
</section>


  
  <div id="comments">
      

  </div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="post-navigation-container fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>

  <div class="post-nav-links">
    <a href="https://blog.dornea.nu/2015/09/17/organizing-and-visualizing-knowledge/" class="post-nav-btn">← prev</a>
    <a href="https://blog.dornea.nu/2015/10/21/basic-layer-2-switching-using-cisco-packet-tracer/" class="post-nav-btn">next →</a>
  </div>
</div>

  <footer class="content-width mt5 mb4 center ph3 gray f6">
  
  <div class="bt b--black-10 pv3"></div>
  
  
  <div class="cf">
    
    <div class="fl w-100 w-50-l pr4-l">
      <p class="mb2 fw6">About this blog</p>
      <p class="mv0 lh-copy">
        Personal thoughts on programming, productivity, and philosophy. I write about things I'm learning and ideas I find interesting.
      </p>
      <p class="mt3 o-70">
        © 2026 Victor Dorneanu
      </p>
    </div>
    
    
    <div class="fl w-100 w-50-l pl4-l mt4 mt0-l">
      <div class="cf">
        
        <div class="fl w-33">
          <p class="mb2 fw6">Navigation</p>
          <ul class="list pl0">
            <li class="pv1"><a href='https://blog.dornea.nu/' title="Home" class="link gray dim">Home</a></li>
            <li class="pv1"><a href='http://dornea.nu' title="About" class="link gray dim">About</a></li>
            <li class="pv1"><a href='https://blog.dornea.nu/tags' title="Tags" class="link gray dim">Tags</a></li>
            <li class="pv1"><a href='https://brainfck.org' title="Zettelkasten" class="link gray dim">Zettelkasten</a></li>
          </ul>
        </div>
        
        
        <div class="fl w-33">
          <p class="mb2 fw6">Connect</p>
          <ul class="list pl0">
            <li class="pv1">
              <a href='https://blog.dornea.nu/feed.xml' title="RSS" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
                RSS Feed
              </a>
            </li>
            <li class="pv1">
              <a href='https://github.com/dorneanu' title="GitHub" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                GitHub
              </a>
            </li>
            <li class="pv1">
              <a href='https://www.goodreads.com/user/show/121423977-victor-dorneanu' title="Goodreads" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                Goodreads
              </a>
            </li>
          </ul>
        </div>

        
        <div class="fl w-33">
          <p class="mb2 fw6">Support</p>
          <div class="pv1">
            <a href="https://www.buymeacoffee.com/dorneanu" target="_blank" class="dib">
              <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px;">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  
  <div class="tc mt4 pt3 f7 o-70">
    Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo 0.120.3</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
    <br>
    <span class="o-50">Last build: 05 Jan 2026, 09:32 UTC</span>
  </div>
</footer>
  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>
  .is-active-link::before { background-color: var(--secondary-color); }
  #contents-list .heading-anchor { display: none; }
</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByTagName("main").length !== 0) {
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: 'main',
    
    headingSelector: 'h1, h2, h3',
  });

  
  setTimeout(function() {
    var tocLinks = document.querySelectorAll('#contents-list a');
    tocLinks.forEach(function(link) {
      link.textContent = link.textContent.replace(/\s*#\s*$/, '');
    });
  }, 100);
}


</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
