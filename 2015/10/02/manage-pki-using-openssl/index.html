<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <title>Manage PKI using OpenSSL - blog.dornea.nu</title>
  <meta content='Manage PKI using OpenSSL - blog.dornea.nu' property='title' />
  <meta content='Manage PKI using OpenSSL - blog.dornea.nu' property='og:title' />


<meta property="og:description" content="In the previous X.509 related post I&rsquo;ve had a look at the internals of a X.509 certficate. This time I want to setup my own PKI using some open source software. This post is a preparation for setting up a VPN using OpenVPN.
Before implementing the PKI let&rsquo;s have a look what a PKI should definitely include (make sure you have a look at the Wikipedia entry):
 certificate authority (CA)  has a public and a private key used to digitally sign certificates   registration authority (RA)  verify identify of users requesting information from the CA   certificate management system  probably the most important component    Revision CA types There are several types of CAs:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.dornea.nu/2015/10/02/manage-pki-using-openssl/" />


<meta property="article:published_time" content="2015-10-02T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2015-10-02T00:00:00&#43;00:00"/>








<meta name="generator" content="Hugo 0.75.1" />

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='http://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='http://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="http://blog.dornea.nu/css/custom.css">


<link rel="icon" 
 
  href='http://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='http://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />

</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='http://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/' title="Home">Home</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://dornea.nu' title="About">About</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/tags' title="Tags">Tags</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org/bookmarks.html' title="Bookmarks">Bookmarks</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org/bib.html' title="Books">Books</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/notes' title="Notes">Notes</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Manage PKI using OpenSSL</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>02 Oct 2015</time> 
     | 
    
    
    tags: [ <a href='http://blog.dornea.nu/tags/ssl' class="link silver">ssl</a> <a href='http://blog.dornea.nu/tags/tls' class="link silver">tls</a> <a href='http://blog.dornea.nu/tags/openssl' class="link silver">openssl</a> <a href='http://blog.dornea.nu/tags/crypto' class="link silver">crypto</a> <a href='http://blog.dornea.nu/tags/python' class="link silver">python</a> <a href='http://blog.dornea.nu/tags/ipython' class="link silver">ipython</a> <a href='http://blog.dornea.nu/tags/admin' class="link silver">admin</a> <a href='http://blog.dornea.nu/tags/pki' class="link silver">pki</a> <a href='http://blog.dornea.nu/tags/openssl' class="link silver">openssl</a> <a href='http://blog.dornea.nu/tags/x.509' class="link silver">x.509</a>  ]
    
  </p>
  <div class="lh-copy post-content"><p>In the previous X.509 related <a href="http://blog.dornea.nu/2015/05/24/validating-and-pinning-x509-certificates/">post</a> I&rsquo;ve had a look at the internals of a X.509 certficate. This time I want to setup my own <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI</a> using some <em>open source</em> software. This post is a preparation for setting up a VPN using <em>OpenVPN</em>.</p>
<p>Before implementing the PKI let&rsquo;s have a look what a PKI should definitely include (make sure you have a look at the <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">Wikipedia entry</a>):</p>
<ul>
<li>certificate authority (<strong>CA</strong>)
<ul>
<li>has a public and a private key</li>
<li>used to digitally sign <em>certificates</em></li>
</ul>
</li>
<li>registration authority (<strong>RA</strong>)
<ul>
<li>verify identify of users requesting information from the CA</li>
</ul>
</li>
<li>certificate management system
<ul>
<li>probably the most important component</li>
</ul>
</li>
</ul>
<h2 id="revision">Revision</h2>
<!-- raw HTML omitted -->
<h2 id="ca-types">CA types</h2>
<p>There are several <a href="https://pki-tutorial.readthedocs.org/en/latest/#ca-types">types</a> of <strong>CA</strong>s:</p>
<ul>
<li>root CA
<ul>
<li>the <em>root</em> of the PKI hierarchy</li>
<li>issues <em>CA certificates</em></li>
</ul>
</li>
<li>intermediate CA
<ul>
<li>the CA right below the <em>root</em> CA</li>
<li>issues <em>CA certificates</em></li>
</ul>
</li>
<li>signing CA
<ul>
<li>CA at the bottom of the PKI hierarchy</li>
<li>issues only <em>user certificates</em></li>
</ul>
</li>
</ul>
<h2 id="certificates-types">Certificates types</h2>
<p>There are several <a href="https://pki-tutorial.readthedocs.org/en/latest/#certificate-types">types of certificates</a> used in real-world:</p>
<ul>
<li>root certificate
<ul>
<li><em>self-signed</em> certificate at the root of the PKI hierarchy</li>
<li>has to be kept <em>secret</em></li>
</ul>
</li>
<li>CA certificate
<ul>
<li>used to sign other certificates and CRLs</li>
</ul>
</li>
<li>user certificate
<ul>
<li>end-user certificate issues for one purpose: code signing, mail protection etc.</li>
<li>user certificates can <strong>not</strong> sign other certificates</li>
</ul>
</li>
</ul>
<h2 id="pki-hierarchy">PKI hierarchy</h2>
<p>In most modern companies you&rsquo;ll find a <strong>3-tier</strong> PKI hierarchy.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {<span style="color:#a61717;background-color:#e3d2d2">↔</span>

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];

  Root_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">emphasis</span><span style="color:#ed9d13">&#34;, label = &#34;</span>Root CA<span style="color:#ed9d13">&#34;];</span>
  Intermediate_CA1 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blue</span><span style="color:#ed9d13">&#34;, label = &#34;</span>Intermediate CA<span style="color:#ed9d13">&#34;];</span>
  Intermediate_CA2 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blue</span><span style="color:#ed9d13">&#34;, label = &#34;</span>Intermediate CA<span style="color:#ed9d13">&#34;];</span>
  Intermediate_CA3 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blue</span><span style="color:#ed9d13">&#34;, label = &#34;</span> ... <span style="color:#ed9d13">&#34;];</span>
  Signing_CA1 [label = <span style="color:#ed9d13">&#34;Signing CA&#34;</span>];
  Signing_CA1_0 [label = <span style="color:#ed9d13">&#34; ... &#34;</span>];
  
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;Signing CA&#34;</span>];
  Signing_CA2_0 [label = <span style="color:#ed9d13">&#34; ... &#34;</span>];
  
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;Signing CA&#34;</span>];
  Signing_CA3_0 [label = <span style="color:#ed9d13">&#34; ... &#34;</span>];

  Root_CA -&gt; Intermediate_CA1;
  Root_CA -&gt; Intermediate_CA2 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blackline</span><span style="color:#ed9d13">&#34;];</span>
  Root_CA -&gt; Intermediate_CA3 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blackline</span><span style="color:#ed9d13">&#34;];</span>
  Intermediate_CA1 -&gt; Signing_CA1;
  Intermediate_CA1 -&gt; Signing_CA1_0 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blackline</span><span style="color:#ed9d13">&#34;];</span>

  Intermediate_CA2 -&gt; Signing_CA2 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blackline</span><span style="color:#ed9d13">&#34;];</span>
  Intermediate_CA2 -&gt; Signing_CA2_0 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blackline</span><span style="color:#ed9d13">&#34;];</span>

  Intermediate_CA3 -&gt; Signing_CA3 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blackline</span><span style="color:#ed9d13">&#34;];</span>
  Intermediate_CA3 -&gt; Signing_CA3_0 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">blackline</span><span style="color:#ed9d13">&#34;];</span>
}
</code></pre></div><p><img src="output_1_0.png" alt="png"></p>
<p>For my purposes I&rsquo;ll be using only a <strong>2-tier</strong> hierarchy as shown below:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];

  Root_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">emphasis</span><span style="color:#ed9d13">&#34;, label = &#34;</span>Root CA<span style="color:#ed9d13">&#34;];</span>
  Signing_CA1 [label = <span style="color:#ed9d13">&#34;Signing CA&#34;</span>];
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;Signing CA&#34;</span>];
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;Signing CA&#34;</span>];

  Root_CA -&gt; Signing_CA1;
  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;
}
</code></pre></div><p><img src="output_3_0.png" alt="png"></p>
<p>The level of security is increased because you separate the root CA from the issuing CAs. The root CA is mostly offline so the private key to sign the certificates should be thus protected from compromise. If one of the <em>issuing CAs</em> is being compromised, you can <em>revoke</em> the certificate issued for that specific CA and create another one using the <em>root CA</em>. You can also have multiple issuing CAs distributed geographically and with different security levels. This increases <em>flexibility</em> and <em>scalability</em>.</p>
<blockquote>
<p>Also checkout this <a href="http://blogs.technet.com/b/askds/archive/2009/09/01/designing-and-implementing-a-pki-part-i-design-and-planning.aspx">awesome article</a> for further details.</p>
</blockquote>
<h3 id="dorneanu-pki-hierarchy">dornea.nu PKI hierarchy</h3>
<p>And now let&rsquo;s make this whole hierarchy more personalized:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey];

  Root_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= &#34;</span><span style="color:#447fcf;text-decoration:underline">emphasis</span><span style="color:#ed9d13">&#34;, label = &#34;</span>dornea.nu root CA<span style="color:#ed9d13">&#34;];</span>
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];

  Root_CA -&gt; Signing_CA2 [label = <span style="color:#ed9d13">&#34;issues&#34;</span>];
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA [label = <span style="color:#ed9d13">&#34;issues&#34;</span>];
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA [label = <span style="color:#ed9d13">&#34;issues&#34;</span>];
  Signing_CA3 -&gt; VPN_Client_CA;
}
</code></pre></div><p><img src="output_5_0.png" alt="png"></p>
<p>We&rsquo;ll have a <strong>root CA</strong> bound to the domain <code>dornea.nu</code> followed by 2 intermediate CAs: <strong>dev.dornea.nu CA</strong> and <strong>vpn.dornea.nu CA</strong>. The CAs will be used to issue certificates to <em>users</em> and <em>networks</em>.</p>
<p>The <strong>TLS Server CA</strong> will be used by a web server like Apache or Nginx to server content over a SSL/TLS connection. The server will only accept connection from clients with a valid <strong>TLS Client CA</strong> which has been signed (and generated) from <strong>dev.dornea.nu CA</strong>.</p>
<p>The <strong>vpn.dornea.nu CA</strong> will then issue certificates for a <strong>VPN Server CA</strong> and a <strong>VPN Client CA</strong>.</p>
<blockquote>
<p>In this post the creation of the <em>VPN Server CA</em> and <em>VPN Client CA</em> will be ommitted. I&rsquo;ll cover this in a related post.</p>
</blockquote>
<h2 id="openssl">OpenSSL</h2>
<p><a href="https://www.openssl.org">OpenSSL</a> is probably the most known cryptography software and SSL/TLS toolkit. Let&rsquo;s have look how things are done using OpenSSL. First of all I&rsquo;ll setup a directory structure to represent each of the PKI component in a clean way.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%bash<span style="color:#a61717;background-color:#e3d2d2">↔</span>

</code></pre></div><p>Initialize and create cert database:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
touch ca/root-ca/db/root-ca.db
touch ca/root-ca/db/root-ca.db.attr
<span style="color:#24909d">echo</span> <span style="color:#3677a9">01</span> &gt; ca/root-ca/db/root-ca.crt.srl
<span style="color:#24909d">echo</span> <span style="color:#3677a9">01</span> &gt; ca/root-ca/db/root-ca.crl.srl
</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
tree /tmp/pki
</code></pre></div><pre><code>/tmp/pki
└── ca
    ├── conf
    └── root-ca
        ├── certs
        ├── crl
        ├── db
        │   ├── root-ca.crl.srl
        │   ├── root-ca.crt.srl
        │   ├── root-ca.db
        │   └── root-ca.db.attr
        └── private

7 directories, 4 files
</code></pre>
<p>In order to create the certificates I&rsquo;ll keep track of every CA using OpenSSL <strong>configuration files</strong>.</p>
<h3 id="sub-commands">Sub-commands</h3>
<p>Below there is an overview of the most used <em>subcommands</em> in openssl:</p>
<!-- raw HTML omitted -->
<h3 id="create-dorneanu-root-ca">Create dornea.nu root CA</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">active</span> [color = lightgreen];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey];  

  Root_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
}
</code></pre></div><p><img src="output_14_0.png" alt="png"></p>
<p>The configuration file can be shown here:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%writefile /tmp/pki/ca/conf/root-ca.conf
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>

<span style="color:#999;font-style:italic"># dornea.nu Root CA</span>
<span style="color:#999;font-style:italic"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/expert/root-ca.conf.html</span>

[ default ]
ca                      = root-ca               <span style="color:#999;font-style:italic"># CA name</span>
<span style="color:#24909d">dir</span>                     = .                     <span style="color:#999;font-style:italic"># Top dir</span>
base_url                = http://pki.dornea.nu  <span style="color:#999;font-style:italic"># CA base URL</span>
aia_url                 = <span style="color:#a61717;background-color:#e3d2d2">$</span>base_url/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.cer     <span style="color:#999;font-style:italic"># CA certificate URL</span>
crl_url                 = <span style="color:#a61717;background-color:#e3d2d2">$</span>base_url/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crl     <span style="color:#999;font-style:italic"># CRL distribution point</span>
name_opt                = multiline,-esc_msb,utf8 <span style="color:#999;font-style:italic"># Display UTF-8 characters</span>
openssl_conf            = openssl_init          <span style="color:#999;font-style:italic"># Library config section</span>

<span style="color:#999;font-style:italic"># CA certificate request</span>

[ req ]
default_bits            = <span style="color:#3677a9">4096</span>                  <span style="color:#999;font-style:italic"># RSA key size</span>
encrypt_key             = yes                   <span style="color:#999;font-style:italic"># Protect private key</span>
default_md              = sha2                  <span style="color:#999;font-style:italic"># MD to use</span>
utf8                    = yes                   <span style="color:#999;font-style:italic"># Input is UTF-8</span>
string_mask             = utf8only              <span style="color:#999;font-style:italic"># Emit UTF-8 strings</span>
prompt                  = no                    <span style="color:#999;font-style:italic"># Don&#39;t prompt for DN</span>
distinguished_name      = ca_dn                 <span style="color:#999;font-style:italic"># DN section</span>
req_extensions          = ca_reqext             <span style="color:#999;font-style:italic"># Desired extensions</span>

[ ca_dn ]
countryName             = <span style="color:#ed9d13">&#34;NU&#34;</span>
organizationName        = <span style="color:#ed9d13">&#34;dornea.nu&#34;</span>
organizationalUnitName  = <span style="color:#ed9d13">&#34;dornea.nu Root CA&#34;</span>
commonName              = <span style="color:#ed9d13">&#34;dornea.nu Root CA&#34;</span>

[ ca_reqext ]
keyUsage                = critical,keyCertSign,cRLSign
basicConstraints        = critical,CA:true
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>

<span style="color:#999;font-style:italic"># CA operational settings</span>

[ ca ]
default_ca              = root_ca               <span style="color:#999;font-style:italic"># The default CA section</span>

[ root_ca ]
certificate             = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crt       <span style="color:#999;font-style:italic"># The CA cert</span>
private_key             = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/private/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.key <span style="color:#999;font-style:italic"># CA private key</span>
new_certs_dir           = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca           <span style="color:#999;font-style:italic"># Certificate archive</span>
serial                  = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crt.srl <span style="color:#999;font-style:italic"># Serial number file</span>
crlnumber               = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crl.srl <span style="color:#999;font-style:italic"># CRL number file</span>
database                = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.db <span style="color:#999;font-style:italic"># Index file</span>
unique_subject          = no                    <span style="color:#999;font-style:italic"># Require unique subject</span>
default_days            = <span style="color:#3677a9">3652</span>                  <span style="color:#999;font-style:italic"># How long to certify for</span>
default_md              = sha1                  <span style="color:#999;font-style:italic"># MD to use</span>
policy                  = match_pol             <span style="color:#999;font-style:italic"># Default naming policy</span>
email_in_dn             = no                    <span style="color:#999;font-style:italic"># Add email to cert DN</span>
preserve                = no                    <span style="color:#999;font-style:italic"># Keep passed DN ordering</span>
name_opt                = <span style="color:#a61717;background-color:#e3d2d2">$</span>name_opt             <span style="color:#999;font-style:italic"># Subject DN display options</span>
cert_opt                = ca_default            <span style="color:#999;font-style:italic"># Certificate display options</span>
copy_extensions         = none                  <span style="color:#999;font-style:italic"># Copy extensions from CSR</span>
x509_extensions         = signing_ca_ext        <span style="color:#999;font-style:italic"># Default cert extensions</span>
default_crl_days        = <span style="color:#3677a9">30</span>                    <span style="color:#999;font-style:italic"># How long before next CRL</span>
crl_extensions          = crl_ext               <span style="color:#999;font-style:italic"># CRL extensions</span>

[ match_pol ]
countryName             = match
stateOrProvinceName     = optional
localityName            = optional
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied

[ any_pol ]
domainComponent         = optional
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = optional
emailAddress            = optional

<span style="color:#999;font-style:italic"># Extensions</span>

[ root_ca_ext ]
keyUsage                = critical,keyCertSign,cRLSign
basicConstraints        = critical,CA:true
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
authorityKeyIdentifier  = keyid:always

[ signing_ca_ext ]
keyUsage                = critical,keyCertSign,cRLSign
basicConstraints        = critical,CA:true,pathlen:<span style="color:#3677a9">0</span>
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>
crlDistributionPoints   = <span style="color:#ffa500">@crl_info</span>

[ crl_ext ]
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>

[ issuer_info ]
caIssuers;URI.<span style="color:#3677a9">0</span>         = <span style="color:#a61717;background-color:#e3d2d2">$</span>aia_url

[ crl_info ]
URI.<span style="color:#3677a9">0</span>                   = <span style="color:#a61717;background-color:#e3d2d2">$</span>crl_url

<span style="color:#999;font-style:italic"># Policy OIDs</span>

[ openssl_init ]
oid_section             = additional_oids

[ additional_oids ]

</code></pre></div><pre><code>Writing /tmp/pki/ca/conf/root-ca.conf
</code></pre>
<p>Now let&rsquo;s create the <strong>CA request</strong>. The configuration for the creation of the <strong>CSR</strong> if found in the <em>configuration</em> file in the section <code>[req]</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl req -new <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -config ca/conf/root-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -out ca/root-ca/root-ca.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -keyout ca/root-ca/private/root-ca.key
            
Generating a <span style="color:#3677a9">4096</span> bit RSA private key
.......................................++
............................++
writing new private key to <span style="color:#ed9d13">&#39;ca/root-ca/private/root-ca.key&#39;</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
</code></pre></div><p>Now create the <strong>CA certificate</strong> (will be valid for 10 years):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl ca -selfsign <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -config ca/conf/root-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -in ca/root-ca/root-ca.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -out ca/root-ca/root-ca.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -extensions root_ca_ext <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -days <span style="color:#3677a9">3650</span>
           
Using configuration from ca/conf/root-ca.conf
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ./ca/root-ca/private/root-ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span style="color:#3677a9">1</span> (0x1)
        Validity
            Not Before: Sep <span style="color:#3677a9">28</span> 17:37:10 <span style="color:#3677a9">2015</span> GMT
            Not After : Sep <span style="color:#3677a9">25</span> 17:37:10 <span style="color:#3677a9">2025</span> GMT
        Subject:
            <span style="color:#40ffff">countryName</span>               = NU
            <span style="color:#40ffff">organizationName</span>          = dornea.nu
            <span style="color:#40ffff">organizationalUnitName</span>    = dornea.nu Root CA
            <span style="color:#40ffff">commonName</span>                = dornea.nu Root CA
        X509v3 extensions:
            X509v3 Key Usage: critical
                Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Subject Key Identifier: 
                72:39:A1:56:5E:9D:09:ED:8D:DE:31:9E:80:9B:C4:5D:62:3B:64:66
            X509v3 Authority Key Identifier: 
                keyid:72:39:A1:56:5E:9D:09:ED:8D:DE:31:9E:80:9B:C4:5D:62:3B:64:66

Certificate is to be certified <span style="color:#6ab825;font-weight:bold">until</span> Sep <span style="color:#3677a9">25</span> 17:37:10 <span style="color:#3677a9">2025</span> GMT (<span style="color:#3677a9">3650</span> days)
Sign the certificate? [y/n]:Y


<span style="color:#3677a9">1</span> out of <span style="color:#3677a9">1</span> certificate requests certified, commit? [y/n]y
Write out database with <span style="color:#3677a9">1</span> new entries
Data Base Updated
          
</code></pre></div><p>Now you can check the <strong>status</strong> of the previously generated certificate (serial number = <strong>1</strong>):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ openssl -config ca/conf/root-ca.conf -status <span style="color:#3677a9">01</span>
Using configuration from ca/conf/root-ca.conf
<span style="color:#40ffff">01</span>=Valid (V)
</code></pre></div><h3 id="create-devdorneanu-ca">Create dev.dornea.nu CA</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">active</span> [color = lightgreen];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey];    

  Root_CA [label = <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
}
</code></pre></div><p><img src="output_20_0.png" alt="png"></p>
<p>Create the directories:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%bash<span style="color:#a61717;background-color:#e3d2d2">↔</span>

</code></pre></div><p>Initialize the database:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
touch ca/dev-ca/db/dev-ca.db
touch ca/dev-ca/db/dev-ca.db.attr
<span style="color:#24909d">echo</span> <span style="color:#3677a9">01</span> &gt; ca/dev-ca/db/dev-ca.crt.srl
<span style="color:#24909d">echo</span> <span style="color:#3677a9">01</span> &gt; ca/dev-ca/db/dev-ca.crl.srl
</code></pre></div><p>Configure the CA:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%writefile /tmp/pki/ca/conf/dev-ca.conf
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>

<span style="color:#999;font-style:italic"># dev.dornea.nu CA</span>
<span style="color:#999;font-style:italic"># Adapated from https://pki-tutorial.readthedocs.org/en/latest/advanced/tls-ca.conf.html</span>

[ default ]
ca                      = dev-ca                <span style="color:#999;font-style:italic"># CA name</span>
<span style="color:#24909d">dir</span>                     = .                     <span style="color:#999;font-style:italic"># Top dir</span>
base_url                = http://dev.dornea.nu/ca    <span style="color:#999;font-style:italic"># CA base URL</span>
aia_url                 = <span style="color:#a61717;background-color:#e3d2d2">$</span>base_url/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.cer     <span style="color:#999;font-style:italic"># CA certificate URL</span>
crl_url                 = <span style="color:#a61717;background-color:#e3d2d2">$</span>base_url/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crl     <span style="color:#999;font-style:italic"># CRL distribution point</span>
name_opt                = multiline,-esc_msb,utf8 <span style="color:#999;font-style:italic"># Display UTF-8 characters</span>

<span style="color:#999;font-style:italic"># CA certificate request</span>

[ req ]
default_bits            = <span style="color:#3677a9">4096</span>                  <span style="color:#999;font-style:italic"># RSA key size</span>
encrypt_key             = yes                   <span style="color:#999;font-style:italic"># Protect private key</span>
default_md              = sha2                  <span style="color:#999;font-style:italic"># MD to use</span>
utf8                    = yes                   <span style="color:#999;font-style:italic"># Input is UTF-8</span>
string_mask             = utf8only              <span style="color:#999;font-style:italic"># Emit UTF-8 strings</span>
prompt                  = no                    <span style="color:#999;font-style:italic"># Don&#39;t prompt for DN</span>
distinguished_name      = ca_dn                 <span style="color:#999;font-style:italic"># DN section</span>
req_extensions          = ca_reqext             <span style="color:#999;font-style:italic"># Desired extensions</span>

[ ca_dn ]
countryName             = <span style="color:#ed9d13">&#34;NU&#34;</span>
organizationName        = <span style="color:#ed9d13">&#34;dornea.nu&#34;</span>
organizationalUnitName  = <span style="color:#ed9d13">&#34;dornea.nu Root CA&#34;</span>
commonName              = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>

[ ca_reqext ]
keyUsage                = critical,keyCertSign,cRLSign
basicConstraints        = critical,CA:true,pathlen:<span style="color:#3677a9">0</span>
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>

<span style="color:#999;font-style:italic"># CA operational settings</span>

[ ca ]
default_ca              = dev_ca                <span style="color:#999;font-style:italic"># The default CA section</span>

[ dev_ca ]
certificate             = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crt       <span style="color:#999;font-style:italic"># The CA cert</span>
private_key             = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/private/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.key <span style="color:#999;font-style:italic"># CA private key</span>
new_certs_dir           = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca           <span style="color:#999;font-style:italic"># Certificate archive</span>
serial                  = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crt.srl <span style="color:#999;font-style:italic"># Serial number file</span>
crlnumber               = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crl.srl <span style="color:#999;font-style:italic"># CRL number file</span>
database                = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.db <span style="color:#999;font-style:italic"># Index file</span>
unique_subject          = no                    <span style="color:#999;font-style:italic"># Require unique subject</span>
default_days            = <span style="color:#3677a9">365</span>                   <span style="color:#999;font-style:italic"># How long to certify for</span>
default_md              = sha256                <span style="color:#999;font-style:italic"># MD to use</span>
policy                  = match_pol             <span style="color:#999;font-style:italic"># Default naming policy</span>
email_in_dn             = no                    <span style="color:#999;font-style:italic"># Add email to cert DN</span>
preserve                = no                    <span style="color:#999;font-style:italic"># Keep passed DN ordering</span>
name_opt                = <span style="color:#a61717;background-color:#e3d2d2">$</span>name_opt             <span style="color:#999;font-style:italic"># Subject DN display options</span>
cert_opt                = ca_default            <span style="color:#999;font-style:italic"># Certificate display options</span>
copy_extensions         = copy                  <span style="color:#999;font-style:italic"># Copy extensions from CSR</span>
x509_extensions         = server_ext            <span style="color:#999;font-style:italic"># Default cert extensions</span>
default_crl_days        = <span style="color:#3677a9">1</span>                     <span style="color:#999;font-style:italic"># How long before next CRL</span>
crl_extensions          = crl_ext               <span style="color:#999;font-style:italic"># CRL extensions</span>

[ match_pol ]
countryName             = match                 <span style="color:#999;font-style:italic"># Must match &#39;NO&#39;</span>
stateOrProvinceName     = optional              <span style="color:#999;font-style:italic"># Included if present</span>
localityName            = optional              <span style="color:#999;font-style:italic"># Included if present</span>
organizationName        = match                 <span style="color:#999;font-style:italic"># Must match &#39;Green AS&#39;</span>
organizationalUnitName  = optional              <span style="color:#999;font-style:italic"># Included if present</span>
commonName              = supplied              <span style="color:#999;font-style:italic"># Must be present</span>

[ extern_pol ]
countryName             = supplied              <span style="color:#999;font-style:italic"># Must be present</span>
stateOrProvinceName     = optional              <span style="color:#999;font-style:italic"># Included if present</span>
localityName            = optional              <span style="color:#999;font-style:italic"># Included if present</span>
organizationName        = supplied              <span style="color:#999;font-style:italic"># Must be present</span>
organizationalUnitName  = optional              <span style="color:#999;font-style:italic"># Included if present</span>
commonName              = supplied              <span style="color:#999;font-style:italic"># Must be present</span>

[ any_pol ]
domainComponent         = optional
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = optional
emailAddress            = optional

<span style="color:#999;font-style:italic"># Extensions</span>

[ server_ext ]
keyUsage                = critical,digitalSignature,keyEncipherment
basicConstraints        = CA:false
extendedKeyUsage        = serverAuth,clientAuth
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>
crlDistributionPoints   = <span style="color:#ffa500">@crl_info</span>

[ client_ext ]
keyUsage                = critical,digitalSignature
basicConstraints        = CA:false
extendedKeyUsage        = clientAuth
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>
crlDistributionPoints   = <span style="color:#ffa500">@crl_info</span>

[ crl_ext ]
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>

[ issuer_info ]
caIssuers;URI.<span style="color:#3677a9">0</span>         = <span style="color:#a61717;background-color:#e3d2d2">$</span>aia_url

[ crl_info ]
URI.<span style="color:#3677a9">0</span>                   = <span style="color:#a61717;background-color:#e3d2d2">$</span>crl_url

</code></pre></div><pre><code>Writing /tmp/pki/ca/conf/dev-ca.conf
</code></pre>
<p>Create <strong>CA signing request</strong> (CSR):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl req -new <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -config ca/conf/dev-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -out ca/dev-ca/dev-ca.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -keyout ca/dev-ca/private/dev-ca.key
            
Generating a <span style="color:#3677a9">4096</span> bit RSA private key
.............++
..........................................................................++
writing new private key to <span style="color:#ed9d13">&#39;ca/dev-ca/private/dev-ca.key&#39;</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----

</code></pre></div><p>Now we use the <strong>root CA</strong> to create the <strong>dev-ca</strong> certificate:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl ca -config ca/conf/root-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -in ca/dev-ca/dev-ca.csr <span style="color:#ed9d13">\ </span>      
           -out ca/dev-ca/dev-ca.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -extensions signing_ca_ext
           
Using configuration from ca/conf/root-ca.conf
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ./ca/root-ca/private/root-ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span style="color:#3677a9">2</span> (0x2)
        Validity
            Not Before: Sep <span style="color:#3677a9">28</span> 18:13:56 <span style="color:#3677a9">2015</span> GMT
            Not After : Sep <span style="color:#3677a9">27</span> 18:13:56 <span style="color:#3677a9">2025</span> GMT
        Subject:
            <span style="color:#40ffff">countryName</span>               = NU
            <span style="color:#40ffff">organizationName</span>          = dornea.nu
            <span style="color:#40ffff">organizationalUnitName</span>    = dornea.nu Root CA
            <span style="color:#40ffff">commonName</span>                = dev.dornea.nu CA
        X509v3 extensions:
            X509v3 Key Usage: critical
                Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE, pathlen:0
            X509v3 Subject Key Identifier: 
                1A:42:33:7A:18:93:91:5F:B1:92:AA:37:39:76:31:92:3D:A6:2C:68
            X509v3 Authority Key Identifier: 
                keyid:B1:56:7C:FB:69:C7:77:CE:6C:7D:BA:CF:C7:7D:0C:6A:24:AF:8A:A1

            Authority Information Access: 
                CA Issuers - URI:http://pki.dornea.nu/root-ca.cer

            X509v3 CRL Distribution Points: 

                Full Name:
                  URI:http://pki.dornea.nu/root-ca.crl

Certificate is to be certified <span style="color:#6ab825;font-weight:bold">until</span> Sep <span style="color:#3677a9">27</span> 18:13:56 <span style="color:#3677a9">2025</span> GMT (<span style="color:#3677a9">3652</span> days)
Sign the certificate? [y/n]:y


<span style="color:#3677a9">1</span> out of <span style="color:#3677a9">1</span> certificate requests certified, commit? [y/n]y
Write out database with <span style="color:#3677a9">1</span> new entries
Data Base Updated

</code></pre></div><h3 id="create-vpndorneanu-ca">Create vpn.dornea.nu CA</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">active</span> [color = lightgreen];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey]; 

  Root_CA [label = <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
}
</code></pre></div><p><img src="output_30_0.png" alt="png"></p>
<p>Create the directories:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
mkdir -p ca/vpn-ca/ ca/vpn-ca/private ca/vpn-ca/db ca/vpn-ca/certs
</code></pre></div><p>Initialize the database:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
touch ca/vpn-ca/db/vpn-ca.db
touch ca/vpn-ca/db/vpn-ca.db.attr
<span style="color:#24909d">echo</span> <span style="color:#3677a9">01</span> &gt; ca/vpn-ca/db/vpn-ca.crt.srl
<span style="color:#24909d">echo</span> <span style="color:#3677a9">01</span> &gt; ca/vpn-ca/db/vpn-ca.crl.srl
</code></pre></div><p>Configure CA:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%writefile /tmp/pki/ca/conf/vpn-ca.conf
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>

<span style="color:#999;font-style:italic"># vpn.dornea.nu CA</span>
<span style="color:#999;font-style:italic"># Adapated from https://pki-tutorial.readthedocs.org/en/latest/advanced/tls-ca.conf.html</span>

[ default ]
ca                      = vpn-ca                <span style="color:#999;font-style:italic"># CA name</span>
<span style="color:#24909d">dir</span>                     = .                     <span style="color:#999;font-style:italic"># Top dir</span>
base_url                = http://vpn.dornea.nu/ca    <span style="color:#999;font-style:italic"># CA base URL</span>
aia_url                 = <span style="color:#a61717;background-color:#e3d2d2">$</span>base_url/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.cer     <span style="color:#999;font-style:italic"># CA certificate URL</span>
crl_url                 = <span style="color:#a61717;background-color:#e3d2d2">$</span>base_url/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crl     <span style="color:#999;font-style:italic"># CRL distribution point</span>
name_opt                = multiline,-esc_msb,utf8 <span style="color:#999;font-style:italic"># Display UTF-8 characters</span>

<span style="color:#999;font-style:italic"># CA certificate request</span>

[ req ]
default_bits            = <span style="color:#3677a9">4096</span>                  <span style="color:#999;font-style:italic"># RSA key size</span>
encrypt_key             = yes                   <span style="color:#999;font-style:italic"># Protect private key</span>
default_md              = sha2                  <span style="color:#999;font-style:italic"># MD to use</span>
utf8                    = yes                   <span style="color:#999;font-style:italic"># Input is UTF-8</span>
string_mask             = utf8only              <span style="color:#999;font-style:italic"># Emit UTF-8 strings</span>
prompt                  = no                    <span style="color:#999;font-style:italic"># Don&#39;t prompt for DN</span>
distinguished_name      = ca_dn                 <span style="color:#999;font-style:italic"># DN section</span>
req_extensions          = ca_reqext             <span style="color:#999;font-style:italic"># Desired extensions</span>

[ ca_dn ]
countryName             = <span style="color:#ed9d13">&#34;NU&#34;</span>
organizationName        = <span style="color:#ed9d13">&#34;dornea.nu&#34;</span>
organizationalUnitName  = <span style="color:#ed9d13">&#34;dornea.nu Root CA&#34;</span>
commonName              = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>

[ ca_reqext ]
keyUsage                = critical,keyCertSign,cRLSign
basicConstraints        = critical,CA:true,pathlen:<span style="color:#3677a9">0</span>
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>

<span style="color:#999;font-style:italic"># CA operational settings</span>

[ ca ]
default_ca              = vpn_ca                <span style="color:#999;font-style:italic"># The default CA section</span>

[ vpn_ca ]
certificate             = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crt       <span style="color:#999;font-style:italic"># The CA cert</span>
private_key             = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/private/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.key <span style="color:#999;font-style:italic"># CA private key</span>
new_certs_dir           = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca           <span style="color:#999;font-style:italic"># Certificate archive</span>
serial                  = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crt.srl <span style="color:#999;font-style:italic"># Serial number file</span>
crlnumber               = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.crl.srl <span style="color:#999;font-style:italic"># CRL number file</span>
database                = <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#24909d">dir</span>/ca/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca/db/<span style="color:#a61717;background-color:#e3d2d2">$</span>ca.db <span style="color:#999;font-style:italic"># Index file</span>
unique_subject          = no                    <span style="color:#999;font-style:italic"># Require unique subject</span>
default_days            = <span style="color:#3677a9">365</span>                   <span style="color:#999;font-style:italic"># How long to certify for</span>
default_md              = sha1                  <span style="color:#999;font-style:italic"># MD to use</span>
policy                  = match_pol             <span style="color:#999;font-style:italic"># Default naming policy</span>
email_in_dn             = no                    <span style="color:#999;font-style:italic"># Add email to cert DN</span>
preserve                = no                    <span style="color:#999;font-style:italic"># Keep passed DN ordering</span>
name_opt                = <span style="color:#a61717;background-color:#e3d2d2">$</span>name_opt             <span style="color:#999;font-style:italic"># Subject DN display options</span>
cert_opt                = ca_default            <span style="color:#999;font-style:italic"># Certificate display options</span>
copy_extensions         = copy                  <span style="color:#999;font-style:italic"># Copy extensions from CSR</span>
x509_extensions         = server_ext            <span style="color:#999;font-style:italic"># Default cert extensions</span>
default_crl_days        = <span style="color:#3677a9">1</span>                     <span style="color:#999;font-style:italic"># How long before next CRL</span>
crl_extensions          = crl_ext               <span style="color:#999;font-style:italic"># CRL extensions</span>

[ match_pol ]
countryName             = match                 <span style="color:#999;font-style:italic"># Must match &#39;NO&#39;</span>
stateOrProvinceName     = optional              <span style="color:#999;font-style:italic"># Included if present</span>
localityName            = optional              <span style="color:#999;font-style:italic"># Included if present</span>
organizationName        = match                 <span style="color:#999;font-style:italic"># Must match &#39;Green AS&#39;</span>
organizationalUnitName  = optional              <span style="color:#999;font-style:italic"># Included if present</span>
commonName              = supplied              <span style="color:#999;font-style:italic"># Must be present</span>

[ extern_pol ]
countryName             = supplied              <span style="color:#999;font-style:italic"># Must be present</span>
stateOrProvinceName     = optional              <span style="color:#999;font-style:italic"># Included if present</span>
localityName            = optional              <span style="color:#999;font-style:italic"># Included if present</span>
organizationName        = supplied              <span style="color:#999;font-style:italic"># Must be present</span>
organizationalUnitName  = optional              <span style="color:#999;font-style:italic"># Included if present</span>
commonName              = supplied              <span style="color:#999;font-style:italic"># Must be present</span>

[ any_pol ]
domainComponent         = optional
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = optional
emailAddress            = optional

<span style="color:#999;font-style:italic"># Extensions</span>

[ server_ext ]
keyUsage                = critical,digitalSignature,keyEncipherment
basicConstraints        = CA:false
extendedKeyUsage        = serverAuth,clientAuth
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>
crlDistributionPoints   = <span style="color:#ffa500">@crl_info</span>

[ client_ext ]
keyUsage                = critical,digitalSignature
basicConstraints        = CA:false
extendedKeyUsage        = clientAuth
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>
crlDistributionPoints   = <span style="color:#ffa500">@crl_info</span>

[ crl_ext ]
authorityKeyIdentifier  = keyid:always
authorityInfoAccess     = <span style="color:#ffa500">@issuer_info</span>

[ issuer_info ]
caIssuers;URI.<span style="color:#3677a9">0</span>         = <span style="color:#a61717;background-color:#e3d2d2">$</span>aia_url

[ crl_info ]
URI.<span style="color:#3677a9">0</span>                   = <span style="color:#a61717;background-color:#e3d2d2">$</span>crl_url

</code></pre></div><pre><code>Overwriting /tmp/pki/ca/conf/vpn-ca.conf
</code></pre>
<p>Create <strong>CA signing request</strong> (CSR):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl req -new <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -config ca/conf/vpn-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -out ca/vpn-ca/vpn-ca.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -keyout ca/vpn-ca/private/vpn-ca.key
            
Generating a <span style="color:#3677a9">4096</span> bit RSA private key
...........................................++
.......++
writing new private key to <span style="color:#ed9d13">&#39;ca/vpn-ca/private/vpn-ca.key&#39;</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----

</code></pre></div><p>Now we use the <strong>root CA</strong> to create the <strong>vpn-ca</strong> certificate:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl ca -config ca/conf/root-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -in ca/vpn-ca/vpn-ca.csr <span style="color:#ed9d13">\ </span>      
           -out ca/vpn-ca/vpn-ca.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>           -extensions signing_ca_ext
           
Using configuration from ca/conf/root-ca.conf
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ./ca/root-ca/private/root-ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span style="color:#3677a9">3</span> (0x3)
        Validity
            Not Before: Sep <span style="color:#3677a9">29</span> 18:28:45 <span style="color:#3677a9">2015</span> GMT
            Not After : Sep <span style="color:#3677a9">28</span> 18:28:45 <span style="color:#3677a9">2025</span> GMT
        Subject:
            <span style="color:#40ffff">countryName</span>               = NU
            <span style="color:#40ffff">organizationName</span>          = dornea.nu
            <span style="color:#40ffff">organizationalUnitName</span>    = dornea.nu Root CA
            <span style="color:#40ffff">commonName</span>                = vpn.dornea.nu CA
        X509v3 extensions:
            X509v3 Key Usage: critical
                Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE, pathlen:0
            X509v3 Subject Key Identifier: 
                52:53:49:45:12:D4:7B:A3:B7:8D:E0:14:00:81:4E:30:BC:A0:19:69
            X509v3 Authority Key Identifier: 
                keyid:F4:3B:44:1F:6D:02:26:06:C1:16:B9:1F:84:FC:41:48:5B:F6:0D:77

            Authority Information Access: 
                CA Issuers - URI:http://pki.dornea.nu/root-ca.cer

            X509v3 CRL Distribution Points: 

                Full Name:
                  URI:http://pki.dornea.nu/root-ca.crl

Certificate is to be certified <span style="color:#6ab825;font-weight:bold">until</span> Sep <span style="color:#3677a9">28</span> 18:28:45 <span style="color:#3677a9">2025</span> GMT (<span style="color:#3677a9">3652</span> days)
Sign the certificate? [y/n]:y


<span style="color:#3677a9">1</span> out of <span style="color:#3677a9">1</span> certificate requests certified, commit? [y/n]y
Write out database with <span style="color:#3677a9">1</span> new entries
Data Base Updated
           
</code></pre></div><h2 id="create-dev-ca-ca-chain">Create dev-ca CA chain</h2>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
cat ca/dev-ca/dev-ca.crt ca/root-ca/root-ca.crt &gt; ca/dev-ca/dev-ca-chain.pem
</code></pre></div><h2 id="create-vpn-ca-ca-chain">Create vpn-ca CA chain</h2>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
cat ca/vpn-ca/vpn-ca.crt ca/root-ca/root-ca.crt &gt; ca/vpn-ca/vpn-ca-chain.pem
</code></pre></div><h1 id="issue-dev-ca-certificates">Issue dev-CA certificates</h1>
<p>We&rsquo;ll now create the <strong>TLS</strong> <em>server</em> and <em>client</em> certificates.</p>
<h2 id="create-tls-server-certificate">Create TLS server certificate</h2>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">active</span> [color = lightgreen];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey]; 

  Root_CA [label = <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
    
  dev_dornea_nu [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;DNS: dev.dornea.nu</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">DNS: dev2.dornea.nu</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">IP: 10.10.10.1</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">IP: 10.20.20.1&#34;</span>];

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
    
  TLS_Server_CA -&gt; dev_dornea_nu;
}
</code></pre></div><p><img src="output_44_0.png" alt="png"></p>
<p>We will specify <strong>multiple domains</strong> with one certificate by using <strong>SANs</strong> (Subject Alternatve Name). Those are a <em>X.509</em> V3 extension to allow a SSL certificate to specify multiple names that the certificate should match. They can contain:</p>
<ul>
<li>mail addresses</li>
<li>IP addresses</li>
<li>DNS names</li>
<li>etc.</li>
</ul>
<p>Let&rsquo;s have a look at the config file:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%writefile /tmp/pki/ca/conf/vpn-server-cert.conf
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>

<span style="color:#999;font-style:italic"># # Code-signing certificate request for the VPN server</span>
<span style="color:#999;font-style:italic"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/advanced/server.conf.html</span>

[ default ]
SAN                     = DNS:dev.dornea.nu    <span style="color:#999;font-style:italic"># Default value / [S]ubject[A]lt[N]ame</span>

[ req ]
default_bits            = <span style="color:#3677a9">4096</span>                  <span style="color:#999;font-style:italic"># RSA key size</span>
encrypt_key             = no                    <span style="color:#999;font-style:italic"># Protect private key</span>
default_md              = sha2                  <span style="color:#999;font-style:italic"># MD to use</span>
utf8                    = yes                   <span style="color:#999;font-style:italic"># Input is UTF-8</span>
string_mask             = utf8only              <span style="color:#999;font-style:italic"># Emit UTF-8 strings</span>
prompt                  = yes                   <span style="color:#999;font-style:italic"># Prompt for DN</span>
distinguished_name      = server_dn             <span style="color:#999;font-style:italic"># DN template</span>
req_extensions          = server_reqext         <span style="color:#999;font-style:italic"># Desired extensions</span>

[ server_dn ]
countryName             = <span style="color:#ed9d13">&#34;1. Country Name (2 letters) (eg, US)       &#34;</span>
countryName_max         = <span style="color:#3677a9">2</span>
stateOrProvinceName     = <span style="color:#ed9d13">&#34;2. State or Province Name   (eg, region)   &#34;</span>
localityName            = <span style="color:#ed9d13">&#34;3. Locality Name            (eg, city)     &#34;</span>
organizationName        = <span style="color:#ed9d13">&#34;4. Organization Name        (eg, company)  &#34;</span>
organizationalUnitName  = <span style="color:#ed9d13">&#34;5. Organizational Unit Name (eg, section)  &#34;</span>
commonName              = <span style="color:#ed9d13">&#34;6. Common Name              (eg, FQDN)     &#34;</span>
commonName_max          = <span style="color:#3677a9">64</span>

[ server_reqext ]
keyUsage                = critical,digitalSignature,keyEncipherment
extendedKeyUsage        = serverAuth,clientAuth
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
subjectAltName          = <span style="color:#ffa500">@alt_names</span>

[alt_names]
DNS.<span style="color:#3677a9">1</span> = dev.dornea.nu
DNS.<span style="color:#3677a9">2</span> = dev2.dornea.nu
IP.<span style="color:#3677a9">1</span> = <span style="color:#3677a9">10.10</span>.<span style="color:#3677a9">10.1</span>
IP.<span style="color:#3677a9">2</span> = <span style="color:#3677a9">10.20</span>.<span style="color:#3677a9">20.1</span>
</code></pre></div><pre><code>Overwriting /tmp/pki/ca/conf/dev-server-ca.conf
</code></pre>
<p>Create directories:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
mkdir -p ca/dev-server-ca/ ca/dev-server-ca/private ca/dev-server-ca/db ca/dev-server-ca/certs
</code></pre></div><p>Create a private key and CSR for the TLS server certificate:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl req -new <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -config ca/conf/dev-server-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -out ca/dev-server-ca/certs/dev.dornea.nu.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -keyout ca/dev-server-ca/certs/dev.dornea.nu.key
            
Generating a <span style="color:#3677a9">4096</span> bit RSA private key
......................................................................................................................................................++
...........................................++
writing new private key to <span style="color:#ed9d13">&#39;ca/dev-server-ca/private/dev-server-ca.key&#39;</span>
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color:#ed9d13">&#39;.&#39;</span>, the field will be left blank.
-----
1. Country Name (<span style="color:#3677a9">2</span> letters) (eg, US)        []:DE
2. State or Province Name   (eg, region)    []:Berlin
3. Locality Name            (eg, city)      []:Berlin
4. Organization Name        (eg, company)   []:dornea.nu
5. Organizational Unit Name (eg, section)   []:dev.dornea.nu
6. Common Name              (eg, FQDN)      []:dev.dornea.nu
</code></pre></div><p>Now use the <strong>dev-ca</strong> certificate to issue the TLS server certificate:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl ca -config ca/conf/dev-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -in ca/dev-server-ca/certs/dev.dornea.nu.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -out ca/dev-server-ca/certs/dev.dornea.nu.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -extensions server_ext
</code></pre></div><p>Now we create a <strong>PKCS#12 bundle</strong> including the private key, the certificate and the CA chain.</p>
<blockquote>
<p>PKCS#12 defines an archive file format to store crypto stuff inside a <em>single</em> file. It is usually used to store a
<em>private key</em> along with the <em>X.509 certificate</em>. The PKCS#12 file may be <em>encrypted</em> and <em>signed</em>.</p>
</blockquote>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( <span style="color:#24909d">cd</span> /tmp/pki
<span style="color:#ed9d13">\\</span>) openssl pkcs12 -export <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -name <span style="color:#ed9d13">&#34;dev.dornea.nu (Developer)&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -caname <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -caname <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -inkey certs/green.no.key <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -in ca/dev-server-ca/certs/dev.dornea.nu.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -certfile ca/dev-server-ca/dev-ca-chain.pem <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -out ca/dev-server-ca/certs/dev.dornea.nu.p12
Enter Export Password:
Verifying - Enter Export Password:
</code></pre></div><h3 id="verify-pkcs12-bundle">Verify PKCS#12 bundle</h3>
<p>You can now verify the bundle:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ openssl pkcs12 -in ca/dev-server-ca/certs/dev.dornea.nu.p12 -info | egrep -e <span style="color:#ed9d13">&#34;issuer&#34;</span> -e <span style="color:#ed9d13">&#34;subject&#34;</span>
Enter Import Password:
MAC Iteration <span style="color:#3677a9">2048</span>
MAC verified OK
PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration <span style="color:#3677a9">2048</span>
Certificate bag
Certificate bag
Certificate bag
PKCS7 Data
Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration <span style="color:#3677a9">2048</span>
<span style="color:#40ffff">subject</span>=/C=NU/ST=Germany/L=Berlin/O=dornea.nu/OU=dev dornea.nu/CN=dev.dornea.nu
<span style="color:#40ffff">issuer</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dev.dornea.nu CA
<span style="color:#40ffff">subject</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dev.dornea.nu CA
<span style="color:#40ffff">issuer</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dornea.nu Root CA
Enter PEM pass phrase:
<span style="color:#40ffff">subject</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dornea.nu Root CA
<span style="color:#40ffff">issuer</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dornea.nu Root CA
</code></pre></div><h2 id="create-tls-client-certificate">Create TLS client certificate</h2>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">active</span> [color = lightgreen];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey]; 

  Root_CA [label = <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">inactive</span>, label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
    
  dev_client_victor [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;CN: Victor Dorneanu</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>];

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
    
  TLS_Client_CA -&gt; dev_client_victor;
}
</code></pre></div><p><img src="output_52_0.png" alt="png"></p>
<p>Create directories:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
mkdir -p ca/dev-client-ca/ ca/dev-client-ca/ ca/dev-client-ca/db ca/dev-client-ca/certs
</code></pre></div><p>Create config:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%writefile /tmp/pki/ca/conf/dev-client-ca.conf<span style="color:#a61717;background-color:#e3d2d2">↔</span>

</code></pre></div><pre><code>Overwriting /tmp/pki/ca/conf/dev-client-ca.conf
</code></pre>
<p>Now I&rsquo;ll create a new CSR for the user <strong>victor</strong>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( openssl req -new <span style="color:#ed9d13">\\</span>
            -config ca/conf/dev-client-ca.conf <span style="color:#ed9d13">\\</span>
            -out ca/dev-client-ca/certs/victor.csr <span style="color:#ed9d13">\\</span>
            -keyout ca/dev-client-ca/certs/victor.key
Generating a <span style="color:#3677a9">4096</span> bit RSA private key
.......................................................................................++
..........................................................................................................................................................................................++
writing new private key to <span style="color:#ed9d13">&#39;ca/dev-client-ca/certs/victor.key&#39;</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color:#ed9d13">&#39;.&#39;</span>, the field will be left blank.
-----
1. Country Name (<span style="color:#3677a9">2</span> letters) (eg, US)        []:NU
2. State or Province Name   (eg, region)    []:Germany
3. Locality Name            (eg, city)      []:Berlin
4. Organization Name        (eg, company)   []:dornea.nu
5. Organizational Unit Name (eg, section)   []:dev dornea.nu
6. Common Name              (eg, full name) []:Victor Dorneanu
7. Email Address            (eg, name@fqdn) []:blabla@dornea.nu
</code></pre></div><p>Now create the TLS client certificate:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>) openssl ca -config ca/conf/dev-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -in ca/dev-client-ca/certs/victor.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -out ca/dev-client-ca/certs/victor.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>            -extensions client_ext
            
Using configuration from ca/conf/dev-ca.conf
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ./ca/dev-ca/private/dev-ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span style="color:#3677a9">3</span> (0x3)
        Validity
            Not Before: Sep <span style="color:#3677a9">30</span> 19:01:14 <span style="color:#3677a9">2015</span> GMT
            Not After : Sep <span style="color:#3677a9">29</span> 19:01:14 <span style="color:#3677a9">2016</span> GMT
        Subject:
            <span style="color:#40ffff">countryName</span>               = NU
            <span style="color:#40ffff">stateOrProvinceName</span>       = Germany
            <span style="color:#40ffff">localityName</span>              = Berlin
            <span style="color:#40ffff">organizationName</span>          = dornea.nu
            <span style="color:#40ffff">organizationalUnitName</span>    = dev dornea.nu
            <span style="color:#40ffff">commonName</span>                = Victor Dorneanu
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Extended Key Usage: 
                TLS Web Client Authentication
            X509v3 Subject Key Identifier: 
                21:E4:47:97:E8:90:39:B5:8C:8A:5B:DD:24:78:23:A9:17:DB:97:9E
            X509v3 Authority Key Identifier: 
                keyid:C5:7E:17:39:6F:CE:D2:40:B8:7E:B8:5D:0E:41:04:75:BB:0D:2B:98

            Authority Information Access: 
                CA Issuers - URI:http://dev.dornea.nu/ca/dev-ca.cer

            X509v3 CRL Distribution Points: 

                Full Name:
                  URI:http://dev.dornea.nu/ca/dev-ca.crl

            X509v3 Subject Alternative Name: 
                email:blabla@dornea.nu
Certificate is to be certified <span style="color:#6ab825;font-weight:bold">until</span> Sep <span style="color:#3677a9">29</span> 19:01:14 <span style="color:#3677a9">2016</span> GMT (<span style="color:#3677a9">365</span> days)
Sign the certificate? [y/n]:y


<span style="color:#3677a9">1</span> out of <span style="color:#3677a9">1</span> certificate requests certified, commit? [y/n]y
Write out database with <span style="color:#3677a9">1</span> new entries
Data Base Updated

</code></pre></div><h3 id="create-pkcs12-bundle">Create PKCS#12 bundle</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( openssl pkcs12 -export <span style="color:#ed9d13">\\</span>
                 -name <span style="color:#ed9d13">&#34;dev.dornea.nu (Developer)&#34;</span> <span style="color:#ed9d13">\\</span>
                 -caname <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span> <span style="color:#ed9d13">\\</span>
                 -caname <span style="color:#ed9d13">&#34;dornea.nu Root CA&#34;</span> <span style="color:#ed9d13">\\</span>
                 -inkey ca/dev-client-ca/certs/victor.key <span style="color:#ed9d13">\\</span> 
                 -in ca/dev-client-ca/certs/victor.crt <span style="color:#ed9d13">\\</span> 
                 -certfile ca/dev-ca/dev-ca-chain.pem <span style="color:#ed9d13">\\</span> 
                 -out ca/dev-client-ca/certs/victor.p12        
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ca/dev-client-ca/certs/victor.key:
Enter Export Password:
Verifying - Enter Export Password:
</code></pre></div><p>Now <em>verify</em> the bundle:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>) openssl pkcs12 -in ca/dev-client-ca/certs/victor.p12 -info | egrep -e <span style="color:#ed9d13">&#34;issuer&#34;</span> -e <span style="color:#ed9d13">&#34;subject&#34;</span>
Enter Import Password:
MAC Iteration <span style="color:#3677a9">2048</span>
MAC verified OK
PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration <span style="color:#3677a9">2048</span>
Certificate bag
Certificate bag
Certificate bag
PKCS7 Data
Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration <span style="color:#3677a9">2048</span>
<span style="color:#40ffff">subject</span>=/C=NU/ST=Germany/L=Berlin/O=dornea.nu/OU=dev dornea.nu/CN=Victor Dorneanu
<span style="color:#40ffff">issuer</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dev.dornea.nu CA
<span style="color:#40ffff">subject</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dev.dornea.nu CA
<span style="color:#40ffff">issuer</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dornea.nu Root CA
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
<span style="color:#40ffff">subject</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dornea.nu Root CA
<span style="color:#40ffff">issuer</span>=/C=NU/O=dornea.nu/OU=dornea.nu Root CA/CN=dornea.nu Root CA

</code></pre></div><h1 id="issue-vpn-ca-certificates">Issue vpn-CA certificates</h1>
<p>We&rsquo;ll now create <strong>VPN</strong> <em>server</em> and <em>client</em> certificates.</p>
<h2 id="create-vpn-server-certificate">Create VPN server certificate</h2>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {<span style="color:#a61717;background-color:#e3d2d2">↔</span>

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">active</span> [color = lightgreen];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey]; 

  Root_CA [label = <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
    

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
}
</code></pre></div><p><img src="output_60_0.png" alt="png"></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
mkdir -p ca/vpn-ca/certs/vpn-server
</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%writefile /tmp/pki/ca/conf/vpn-server-cert.conf
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>

<span style="color:#999;font-style:italic"># dev.dornea.nu server certificate</span>
<span style="color:#999;font-style:italic"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/advanced/codesign.conf.html</span>

[ req ]
default_bits            = <span style="color:#3677a9">4096</span>                    <span style="color:#999;font-style:italic"># RSA key size</span>
encrypt_key             = yes                     <span style="color:#999;font-style:italic"># Protect private key</span>
default_md              = sha2                    <span style="color:#999;font-style:italic"># MD to use</span>
utf8                    = yes                     <span style="color:#999;font-style:italic"># Input is UTF-8</span>
string_mask             = utf8only                <span style="color:#999;font-style:italic"># Emit UTF-8 strings</span>
prompt                  = yes                     <span style="color:#999;font-style:italic"># Prompt for DN</span>
distinguished_name      = vpn_server_dn           <span style="color:#999;font-style:italic"># DN template</span>
req_extensions          = vpn_server_reqext       <span style="color:#999;font-style:italic"># Desired extensions</span>

[ vpn_server_dn ]
countryName             = <span style="color:#ed9d13">&#34;1. Country Name (2 letters) (eg, US)       &#34;</span>
countryName_max         = <span style="color:#3677a9">2</span>
stateOrProvinceName     = <span style="color:#ed9d13">&#34;2. State or Province Name   (eg, region)   &#34;</span>
localityName            = <span style="color:#ed9d13">&#34;3. Locality Name            (eg, city)     &#34;</span>
organizationName        = <span style="color:#ed9d13">&#34;4. Organization Name        (eg, company)  &#34;</span>
organizationalUnitName  = <span style="color:#ed9d13">&#34;5. Organizational Unit Name (eg, section)  &#34;</span>
commonName              = <span style="color:#ed9d13">&#34;6. Common Name              (eg, full name)&#34;</span>
commonName_max          = <span style="color:#3677a9">64</span>

[ vpn_server_reqext ]
keyUsage                = critical,digitalSignature
extendedKeyUsage        = critical,codeSigning
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
</code></pre></div><pre><code>Overwriting /tmp/pki/ca/conf/vpn-server-cert.conf
</code></pre>
<h3 id="create-csr">Create CSR</h3>
<p>And now create the <strong>CSR</strong> (Code Signing Request):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( openssl req -new <span style="color:#ed9d13">\\</span>
            -config ca/conf/vpn-server-cert.conf <span style="color:#ed9d13">\\</span>
            -out ca/vpn-ca/certs/vpn-server/raspberry<span style="color:#ed9d13">\_</span>pi.csr <span style="color:#ed9d13">\\</span>
            -keyout ca/vpn-ca/certs/vpn-server/raspberry<span style="color:#ed9d13">\_</span>pi.key
            
Generating a <span style="color:#3677a9">4096</span> bit RSA private key
............................................................................................................................................................++
.....................................++
writing new private key to <span style="color:#ed9d13">&#39;ca/vpn-ca/certs/vpn-server/raspberry\_pi.key&#39;</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
Verify failure
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color:#ed9d13">&#39;.&#39;</span>, the field will be left blank.
-----
1. Country Name (<span style="color:#3677a9">2</span> letters) (eg, US)        []:NU
2. State or Province Name   (eg, region)    []:/dev/null
3. Locality Name            (eg, city)      []:/dev/random
4. Organization Name        (eg, company)   []:dornea.nu
5. Organizational Unit Name (eg, section)   []:VPN
6. Common Name              (eg, full name) []:vpn.dornea.nu

</code></pre></div><h3 id="sign-certificate">Sign certificate</h3>
<p>Now use the <strong>VPN-CA</strong> to issue the <strong>CRT</strong> (Code Signing Certificate):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>) openssl ca -config ca/conf/vpn-ca.conf <span style="color:#ed9d13">\ </span>                                                              <span style="color:#3677a9">1</span> ↵
                -in ca/vpn-ca/certs/vpn-server/raspberry_pi.csr <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -out ca/vpn-ca/certs/vpn-server/raspberry_pi.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -extensions server_ext
                
Using configuration from ca/conf/vpn-ca.conf
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ./ca/vpn-ca/private/vpn-ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span style="color:#3677a9">1</span> (0x1)
        Validity
            Not Before: Nov  <span style="color:#3677a9">9</span> 19:39:48 <span style="color:#3677a9">2015</span> GMT
            Not After : Nov  <span style="color:#3677a9">8</span> 19:39:48 <span style="color:#3677a9">2016</span> GMT
        Subject:
            <span style="color:#40ffff">countryName</span>               = NU
            <span style="color:#40ffff">stateOrProvinceName</span>       = /dev/null
            <span style="color:#40ffff">localityName</span>              = /dev/random
            <span style="color:#40ffff">organizationName</span>          = dornea.nu
            <span style="color:#40ffff">organizationalUnitName</span>    = VPN
            <span style="color:#40ffff">commonName</span>                = vpn.dornea.nu
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 Subject Key Identifier: 
                80:CA:5B:3C:C7:8A:E4:76:FF:4B:DC:5D:17:F9:99:07:27:69:76:60
            X509v3 Authority Key Identifier: 
                keyid:E2:DB:62:AB:F4:5D:56:17:65:B2:FA:66:55:C9:04:1D:1C:9B:10:A3

            Authority Information Access: 
                CA Issuers - URI:http://vpn.dornea.nu/ca/vpn-ca.cer

            X509v3 CRL Distribution Points: 

                Full Name:
                  URI:http://vpn.dornea.nu/ca/vpn-ca.crl

Certificate is to be certified <span style="color:#6ab825;font-weight:bold">until</span> Nov  <span style="color:#3677a9">8</span> 19:39:48 <span style="color:#3677a9">2016</span> GMT (<span style="color:#3677a9">365</span> days)
Sign the certificate? [y/n]:y


<span style="color:#3677a9">1</span> out of <span style="color:#3677a9">1</span> certificate requests certified, commit? [y/n]y
Write out database with <span style="color:#3677a9">1</span> new entries
Data Base Updated

</code></pre></div><h3 id="create-pkcs12-bundle-1">Create PKCS12 bundle</h3>
<p>Now bundle the <strong>root</strong> CA, <strong>VPN</strong> ca and the VPN <strong>server</strong> cert into one file:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ openssl pkcs12 -export <span style="color:#ed9d13">\ </span>                                                   
    -name <span style="color:#ed9d13">&#34;VPN Server (Raspberry Pi)&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -caname <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -caname <span style="color:#ed9d13">&#34;dornea.nu Root CA&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -inkey ca/vpn-ca/certs/vpn-server/raspberry_pi.key <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -in ca/vpn-ca/certs/vpn-server/raspberry_pi.crt <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -certfile ca/vpn-ca/vpn-ca-chain.pem <span style="color:#ed9d13">\ </span>
    -out ca/vpn-ca/certs/vpn-server/raspberry_pi.p12
    
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ca/vpn-ca/certs/vpn-server/raspberry_pi.key:
Enter Export Password:
Verifying - Enter Export Password:
</code></pre></div><h2 id="create-vpn-client-certificate">Create VPN client certificate</h2>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%blockdiag
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">(</span><span style="color:#447fcf;text-decoration:underline">list</span> of attributes)
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">emphasis</span> [color = pink, style = dashed];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blackline</span> [color = black, style = dotted];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">blue</span> [color = lightblue];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">active</span> [color = lightgreen];
  <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">inactive</span> [color = lightgrey]; 

  Root_CA [label = <span style="color:#ed9d13">&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [label = <span style="color:#ed9d13">&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [label = <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style="color:#ed9d13">&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style="color:#ed9d13">&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [label = <span style="color:#ed9d13">&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">= </span><span style="color:#447fcf;text-decoration:underline">active</span>, label = <span style="color:#ed9d13">&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
    

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
}
</code></pre></div><p><img src="output_65_0.png" alt="png"></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
<span style="color:#24909d">cd</span> /tmp/pki
mkdir -p ca/vpn-ca/certs/vpn-client
</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">%%writefile /tmp/pki/ca/conf/vpn-client-cert.conf
<span style="color:#999;font-style:italic"># &lt;!-- collapse=True --&gt;</span>

<span style="color:#999;font-style:italic"># VPN client certificate</span>
<span style="color:#999;font-style:italic"># Adapted from https://pki-tutorial.readthedocs.org/en/latest/advanced/client.conf.html</span>

[ req ]
default_bits            = <span style="color:#3677a9">4096</span>                  <span style="color:#999;font-style:italic"># RSA key size</span>
encrypt_key             = yes                   <span style="color:#999;font-style:italic"># Protect private key</span>
default_md              = sha2                  <span style="color:#999;font-style:italic"># MD to use</span>
utf8                    = yes                   <span style="color:#999;font-style:italic"># Input is UTF-8</span>
string_mask             = utf8only              <span style="color:#999;font-style:italic"># Emit UTF-8 strings</span>
prompt                  = yes                   <span style="color:#999;font-style:italic"># Prompt for DN</span>
distinguished_name      = client_dn             <span style="color:#999;font-style:italic"># DN template</span>
req_extensions          = client_reqext         <span style="color:#999;font-style:italic"># Desired extensions</span>

[ client_dn ]
countryName             = <span style="color:#ed9d13">&#34;1. Country Name (2 letters) (eg, US)       &#34;</span>
countryName_max         = <span style="color:#3677a9">2</span>
stateOrProvinceName     = <span style="color:#ed9d13">&#34;2. State or Province Name   (eg, region)   &#34;</span>
localityName            = <span style="color:#ed9d13">&#34;3. Locality Name            (eg, city)     &#34;</span>
organizationName        = <span style="color:#ed9d13">&#34;4. Organization Name        (eg, company)  &#34;</span>
organizationalUnitName  = <span style="color:#ed9d13">&#34;5. Organizational Unit Name (eg, section)  &#34;</span>
commonName              = <span style="color:#ed9d13">&#34;6. Common Name              (eg, full name)&#34;</span>
commonName_max          = <span style="color:#3677a9">64</span>
emailAddress            = <span style="color:#ed9d13">&#34;7. Email Address            (eg, name@fqdn)&#34;</span>
emailAddress_max        = <span style="color:#3677a9">40</span>

[ client_reqext ]
keyUsage                = critical,digitalSignature
extendedKeyUsage        = clientAuth
subjectKeyIdentifier    = <span style="color:#24909d">hash</span>
subjectAltName          = email:move
</code></pre></div><pre><code>Overwriting /tmp/pki/ca/conf/vpn-client-cert.conf
</code></pre>
<h3 id="create-csr-1">Create CSR</h3>
<p>Now create the <strong>CSR</strong> for the user <strong>victor</strong>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>( openssl req -new <span style="color:#ed9d13">\\</span>                      
            -config ca/conf/vpn-client-cert.conf <span style="color:#ed9d13">\\</span>               
            -out ca/vpn-ca/certs/vpn-client/victor.csr <span style="color:#ed9d13">\\</span>      
            -keyout ca/vpn-ca/certs/vpn-client/victor.key    
            
Generating a <span style="color:#3677a9">4096</span> bit RSA private key
...............................................................++
................................................................................++
writing new private key to <span style="color:#ed9d13">&#39;ca/vpn-ca/certs/vpn-client/victor.key&#39;</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color:#ed9d13">&#39;.&#39;</span>, the field will be left blank.
-----
1. Country Name (<span style="color:#3677a9">2</span> letters) (eg, US)        []:NU
2. State or Province Name   (eg, region)    []:/dev/null
3. Locality Name            (eg, city)      []:/dev/random
4. Organization Name        (eg, company)   []:dornea.nu
5. Organizational Unit Name (eg, section)   []:vpn.dornea.nu
6. Common Name              (eg, full name) []:Victor Dorneanu
7. Email Address            (eg, name@fqdn) []:bla@nsa.gov

</code></pre></div><h3 id="sign-the-csr">Sign the CSR</h3>
<p>Sign the <strong>CSR</strong> using <strong>VPN-CA</strong>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#ed9d13">\\</span>) openssl ca -config ca/conf/vpn-ca.conf <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>                -in ca/vpn-ca/certs/vpn-client/victor.csr <span style="color:#ed9d13">\ </span>     
                -out ca/vpn-ca/certs/vpn-client/victor.crt <span style="color:#ed9d13">\ </span>     
                -extensions client_ext              
                
Using configuration from ca/conf/vpn-ca.conf
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ./ca/vpn-ca/private/vpn-ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span style="color:#3677a9">2</span> (0x2)
        Validity
            Not Before: Nov  <span style="color:#3677a9">9</span> 19:49:16 <span style="color:#3677a9">2015</span> GMT
            Not After : Nov  <span style="color:#3677a9">8</span> 19:49:16 <span style="color:#3677a9">2016</span> GMT
        Subject:
            <span style="color:#40ffff">countryName</span>               = NU
            <span style="color:#40ffff">stateOrProvinceName</span>       = /dev/null
            <span style="color:#40ffff">localityName</span>              = /dev/random
            <span style="color:#40ffff">organizationName</span>          = dornea.nu
            <span style="color:#40ffff">organizationalUnitName</span>    = vpn.dornea.nu
            <span style="color:#40ffff">commonName</span>                = Victor Dorneanu
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Extended Key Usage: 
                TLS Web Client Authentication
            X509v3 Subject Key Identifier: 
                12:3F:57:DF:1D:DB:73:BC:E0:A0:97:18:0D:B9:6C:C9:FF:53:8E:1B
            X509v3 Authority Key Identifier: 
                keyid:E2:DB:62:AB:F4:5D:56:17:65:B2:FA:66:55:C9:04:1D:1C:9B:10:A3

            Authority Information Access: 
                CA Issuers - URI:http://vpn.dornea.nu/ca/vpn-ca.cer

            X509v3 CRL Distribution Points: 

                Full Name:
                  URI:http://vpn.dornea.nu/ca/vpn-ca.crl

            X509v3 Subject Alternative Name: 
                email:bla@nsa.gov
Certificate is to be certified <span style="color:#6ab825;font-weight:bold">until</span> Nov  <span style="color:#3677a9">8</span> 19:49:16 <span style="color:#3677a9">2016</span> GMT (<span style="color:#3677a9">365</span> days)
Sign the certificate? [y/n]:y


<span style="color:#3677a9">1</span> out of <span style="color:#3677a9">1</span> certificate requests certified, commit? [y/n]y
Write out database with <span style="color:#3677a9">1</span> new entries
Data Base Updated

</code></pre></div><h3 id="create-pkcs12-bundle-2">Create PKCS#12 bundle</h3>
<p>Bundle the <strong>root CA</strong>, **VPN CA ** and the VPN <strong>client</strong> cert into a single file:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ openssl pkcs12 -export <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -name <span style="color:#ed9d13">&#34;VPN Client (Victor)&#34;</span> <span style="color:#ed9d13">\ </span>     
    -caname <span style="color:#ed9d13">&#34;vpn.dornea.nu CA&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -caname <span style="color:#ed9d13">&#34;dornea.nu Root CA&#34;</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -inkey ca/vpn-ca/certs/vpn-client/victor.key <span style="color:#ed9d13">\ </span>
    -in ca/vpn-ca/certs/vpn-client/victor.crt <span style="color:#ed9d13">\ </span>     
    -certfile ca/vpn-ca/vpn-ca-chain.pem <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>    -out ca/vpn-ca/certs/vpn-client/victor.p12      
    
Enter pass phrase <span style="color:#6ab825;font-weight:bold">for</span> ca/vpn-ca/certs/vpn-client/victor.key:
Enter Export Password:
Verifying - Enter Export Password:

</code></pre></div><h2 id="references">References</h2>
<ul>
<li><a href="https://pki-tutorial.readthedocs.org/en/latest/advanced/index.html">https://pki-tutorial.readthedocs.org/en/latest/advanced/index.html</a></li>
<li><a href="http://serverfault.com/questions/306345/certification-authority-root-certificate-expiry-and-renewal">http://serverfault.com/questions/306345/certification-authority-root-certificate-expiry-and-renewal</a></li>
<li><a href="http://www.flatmtn.com/article/setting-openssl-create-certificates">http://www.flatmtn.com/article/setting-openssl-create-certificates</a></li>
<li><a href="https://www.debian-administration.org/article/284/Creating_and_Using_a_self_signed__SSL_Certificates_in_debian">https://www.debian-administration.org/article/284/Creating_and_Using_a_self_signed__SSL_Certificates_in_debian</a></li>
<li><a href="http://gatwards.org/techblog/creating-and-signing-ssl-certs">http://gatwards.org/techblog/creating-and-signing-ssl-certs</a></li>
</ul>
</div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="http://blog.dornea.nu/2015/09/17/organizing-and-visualizing-knowledge/">prev post</a>
  <a href="http://blog.dornea.nu/2015/10/21/basic-layer-2-switching-using-cisco-packet-tracer/">next post</a>
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme. <br>
  
</footer>
  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>




</body>
</html>