<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<meta name="generator" content="Hugo 0.120.3">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet"/>
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">
<link rel="stylesheet" href="https://blog.dornea.nu/css/syntax.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />



<script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="b8a4b728-8eda-42fb-8376-10168c622160" async>

</script>

</head>
<body class="global-font">
  <nav class="fixed w-100 bg-white bb b--black-10" id="navbar" style="z-index: 9999;">
  <div class="content-width center flex flex-wrap justify-between items-center pa3">
    
    <div class="flex items-center">
      <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph3 br2 white" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
    </div>

    
    <div class="dn flex-l items-center">
      
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
        
      
    </div>

    
    <div class="db dn-l">
      <button class="bg-transparent bn pointer dim" id="menu-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  
  <div class="dn bg-white w-100 pa3 shadow-1" id="mobile-menu">
    
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
      
    
  </div>
</nav>


<div class="h3"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    
    menuToggle.addEventListener('click', function() {
      const expanded = mobileMenu.classList.contains('db');
      mobileMenu.classList.toggle('db');
      mobileMenu.classList.toggle('dn');
    });
  });
</script>

  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Adding concurrency to smalisca</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>06 May 2015</time> 
     | 
    

    
     ~
  

15 mins
|

    
    tags: [ <a href='https://blog.dornea.nu/tags/python' class="link silver">python</a> <a href='https://blog.dornea.nu/tags/coding' class="link silver">coding</a> <a href='https://blog.dornea.nu/tags/smalisca' class="link silver">smalisca</a>  ]
    

  </p>
  <div class="lh-copy post-content">
    

      <p>When it comes to parallelism Python has some constraints which have to be taken into consideration
before starting coding. I think the biggest one has to do with the <a href="https://wiki.python.org/moin/GlobalInterpreterLock">Global Interpreter Lock</a> which prevents several threads from
executing Python bytecodes at once. Nevertheless you may want to apply <a href="http://en.wikipedia.org/wiki/Concurrency_pattern">concurrency patterns</a> to you code in order to achieve more speed. Besides that
you may want to use your cores properly otherwise you&rsquo;ll end up like this:</p>
<p><img src="https://pbs.twimg.com/media/CCjk6ySWYAIBrfc.jpg" alt="Parallelism in Action"></p>
<p>In my specific case I wanted to speed up the process of parsing files (as a major features of <a href="https://github.com/dorneanu/smalisca">smalisca</a>). I&rsquo;ve ended up looking at the <a href="https://docs.python.org/2/library/multiprocessing.html">muliprocessing</a> package which seemed quite promising:</p>
<blockquote>
<p>multiprocessing is a package that supports spawning processes using an API similar to the threading module. The multiprocessing package offers both local and remote concurrency, effectively side-stepping the Global Interpreter Lock by using subprocesses instead of threads. Due to this, the multiprocessing module allows the programmer to fully leverage multiple processors on a given machine. It runs on both Unix and Windows.</p>
</blockquote>
<p>In the next steps I&rsquo;ll try to document my beginners attempts at <strong>concurrency</strong> in Python.</p>
<h2 id="the-idea">The idea</h2>
<p>Using the <code>-l</code> (location) parameter you can specify the location path where <em>smalisca</em> should
lookup for files before parsing them and afterwards collecting valuable information. Looking closely
at the <a href="https://github.com/dorneanu/smalisca/blob/master/smalisca/modules/module_smali_parser.py#L134">code</a> I&rsquo;ve noticed that <code>os.walk</code> already returns a list of &ldquo;some important information about files and directories.&rdquo; The <code>multiprocessing</code> documentation refers to the <code>Pool</code> object:</p>
<blockquote>
<p>[&hellip;] is the Pool object which offers a convenient means of parallelizing the execution of a function across multiple input values, distributing the input data across processes (data parallelism).
[&hellip;]</p>
</blockquote>
<p>So I can:</p>
<ul>
<li><em>parallelize</em> the execution of a single function</li>
<li>use the <em>same input data</em> source for each thread/process</li>
<li><em>distribute</em> the input data across processes</li>
</ul>
<p>Ok, that sounds great!</p>
<h2 id="some-basic-code">Some basic code</h2>
<p>The basic idea is to &ldquo;walk&rdquo; through files and call a <em>function</em> for every single found file. You&rsquo;d usually start like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># call here some function(s) to do whatever with the dirs/files</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>But first an input filename list has to be generated:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">get_file_list</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; Returns a list of files inside the &lt;folder&gt; directory &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># &#34;Walk&#34; through folder</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check if it&#39;s file</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">file_list</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In order to achieve concurrency the initial list has to be splitted into several sub-lists
which are then distributed to some &ldquo;workers&rdquo; (aka processes). The best way to do this is to
distribute the sub-lists equally to the number of available CPU cores. Given an initial
<code>file_list</code> one could do following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">cpu_cores</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span> <span class="k">if</span> <span class="n">j</span> <span class="o">%</span> <span class="n">cpu_cores</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Start new process with sub-list</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>But wait a second&hellip; What should every process do? Well, the answer is quite obvious:
For every file in its sub-list, it has to call a certain function. Afterwards the process
has to somehow return the results to the parent process. But how is this done?</p>
<h2 id="communication-between-processes">Communication between processes</h2>
<p>A simple way is to use <code>Queue</code> where you can pass messages back and forth between your processes. In a more complicated example you might use <code>JoinableQueue</code> where you have typical consumer scenario: Processes fetch data, modify it and then push them back into the queue (<a href="http://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem">producer consumer pattern</a>).</p>
<p>In my case a <code>Queue</code> is perfectly fine. That way I have a safe way of letting the process pushing back the results into the queue, before merging all available results globally.
Let&rsquo;s have a look at some example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_files</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; Proprocess every file in &lt;file_list&gt; and call parse_file() &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">([])</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Put results into queue</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>process_files</code> gets a file list (a sub-list from the big list) and a <em>queue</em>. After
<em>parsing</em> the files, the function will simply <code>put</code> the results into the queue. This
specific type of queue <em>should</em> be thread and process safe as the documentation states.</p>
<h2 id="collecting-results">Collecting results</h2>
<p>After all processes are done doing their job, it&rsquo;s time to collect the results:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">procs</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>q</code> is the queue used by the processes. Just <code>get</code> all collected results and then you&rsquo;re
ready to go. You can found the whole code <a href="https://gist.github.com/dorneanu/2393d8d03d0ed443baeb">here</a>.</p>
<p>Ok, I&rsquo;ve shown some introductory example how to use <code>multiprocessing</code> properly by using
a very simplified code. Now let&rsquo;s move on to a more (or less) complicated scenrio:
Implement parallelism for <a href="https://github.com/dorneanu/smalisca">smalisca&rsquo;s</a> <a href="http://smalisca.readthedocs.org/en/latest/parsing.html#page-parsing">parsing</a> features.</p>
<h2 id="smalisca-and-parallelism">Smalisca and parallelism</h2>
<p>One of the slowest step within <em>smalisca</em> is parsing. And that&rsquo;s because every directory,
every file found within it, has to be parsed <em>sequentially</em>. Even from the beginning of
the development I&rsquo;ve thought <em>concurrency</em> would be a better choice to solve that. Due
to the priority of other main functionalities this never happened. Till now :)</p>
<p>As I&rsquo;m writing this text I also implement this new feature into <em>smalisca</em>. Before I&rsquo;ve
started with the coding part, I had to think about several things:</p>
<ol>
<li>Should concurrency be implemented as a <em>core</em> feature of the parsing component?</li>
<li>Regarding the sub-lists: Should I split <em>file</em> or <em>directory</em> lists?</li>
<li>How do I collect the results gained from the processes?</li>
<li>Will there be any major side-effects caused by the concurrency?</li>
</ol>
<p>Regarding <strong>1</strong>: Since I want to keep things simple and clean, I like the idea of a controller which <em>controls</em> the parser. <code>SmaliParser</code> should implement everything that has to do with the parsing itself, but the concurrency should be implemented on-top. That&rsquo;s why I&rsquo;ve
decided to parallelize several <code>SmaliParser</code> instances rather than creating processes inside it.</p>
<p>Regarding <strong>2</strong>: Due to the fact that the current directory path is used when creating new <code>class</code> objects, I&rsquo;ve decided to split the directory list, distribute the sub-lists equally across the <em>workers</em> and then collect the results.</p>
<p>Regarding <strong>3</strong>: The answer to this one should be quite obvious. One could use a <code>Queue</code> (a thread-safe one like <code>mutiprocessing.Queue</code>) and <code>put</code> the results of every worker
into it. Well that&rsquo;s pretty much what I&rsquo;ve done except for the fact that I&rsquo;ve used <strong>proxy</strong> objects instead of directly accessed ones. I&rsquo;ll come to this later one.</p>
<p>Regarding <strong>4</strong>: I couldn&rsquo;t notice any side-effects.</p>
<h2 id="the-basic-stuff">The basic stuff</h2>
<p>I didn&rsquo;t have to write a lot of code. In my case the concurrency has been implemented this way:</p>
<ul>
<li>for a given path location, <em>walk</em> the location and return lists of all found directories and files</li>
<li>split the big list into smaller sub-lists</li>
<li>every worker/process gets a sub-list</li>
<li>each worker initiates a <code>SmaliParser</code> instance for every directory in its sub-list</li>
<li>after <code>SmaliParser</code> finishes its work, the results are pushed into a thread-safe <code>Queue</code></li>
</ul>
<p>So basically you&rsquo;ll have a list of directory paths:</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    Graphviz code
    
  </summary>
  <pre><code>dot {
    digraph G {
        graph [splines=curve, rankdir = LR, pad=&quot;.15&quot;, ranksep=&quot;1.25&quot;, nodesep=&quot;2.25&quot;];
        node[fontname=&quot;FreeSans&quot;,fontsize=&quot;14&quot;,shape=Mrecord,width=7, height=.5];

        compound = true;

        Bar[label=&quot;{\
              {PATHS \r |\
               &lt;p1&gt;/smali/com/android \l|\
               &lt;p2&gt;/smali/com/android/support \l|\
               &lt;p3&gt;/smali/com/gmail/framework \l|\
               &lt;p4&gt;/smali/com/gmail/calender/user \l|\
               &lt;p5&gt;/smali/de/bla/bla/ble \l |\
               &lt;pn&gt;... \l \
              }\
        }&quot;, width=8];
    }
}
</code></pre>

</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/smalisca-concurrency/paths.dot.png" alt="paths"></p>
<p>And some workers to do the job:</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    Graphviz code
    
  </summary>
  <pre><code>dot {
    digraph G {
        graph [splines=curve, rankdir = LR, pad=&quot;.15&quot;, ranksep=&quot;1.25&quot;, nodesep=&quot;2.25&quot;];
        node[fontname=&quot;FreeSans&quot;,fontsize=&quot;14&quot;,shape=Mrecord,width=2, height=.5];

        compound = true;

        Workers[label=&quot;{\
              {WORKERS \r |\
               &lt;w1&gt;Worker #1 \l|\
               &lt;w2&gt;Worker #2 \l|\
               &lt;w3&gt;Worker #3 \l|\
               &lt;w4&gt;Worker #n \l\
              }\
        }&quot;, width=8];
    }
}
</code></pre>

</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/smalisca-concurrency/workers.dot.png" alt="workers"></p>
<p>In my case the paths have to be distributed to the workers:</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    Graphviz code
    
  </summary>
  <pre><code>dot {
    digraph G {
        graph [splines=curve, rankdir = LR, pad=&quot;.15&quot;, ranksep=&quot;1.25&quot;, nodesep=&quot;2.25&quot;];
        node[fontname=&quot;FreeSans&quot;,fontsize=&quot;14&quot;,shape=Mrecord,width=2, height=.5];

        compound = true;

        Bar[label=&quot;{\
              {PATHS \r |\
               &lt;p1&gt;/smali/com/android \l|\
               &lt;p2&gt;/smali/com/android/support \l|\
               &lt;p3&gt;/smali/com/gmail/framework \l|\
               &lt;p4&gt;/smali/com/gmail/calender/user \l|\
               &lt;p5&gt;/smali/de/bla/bla/ble \l |\
               &lt;pn&gt;... \l \
              }\
        }&quot;, width=5];

        Workers[label=&quot;{\
              {WORKERS \r |\
               &lt;w1&gt;Worker #1 \l|\
               &lt;w2&gt;Worker #2 \l|\
               &lt;w3&gt;Worker #3 \l|\
               &lt;w4&gt;Worker #n \l\
              }\
        }&quot;, width=5];
        
        Bar:p1 -&gt; Workers:w1;
        Bar:p2 -&gt; Workers:w1;
        Bar:p3 -&gt; Workers:w2;
        Bar:p4 -&gt; Workers:w2;
        Bar:p5 -&gt; Workers:w2;
    }
}
</code></pre>

</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/smalisca-concurrency/paths-workers.dot.png" alt="paths-workers"></p>
<p>So let&rsquo;s continue with some code examples. A typical <strong>parser process</strong> would look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SmaliParserProcess</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Implements a multiprocessing.Process
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Attributes:
</span></span></span><span class="line"><span class="cl"><span class="s2">        dirs (list): List of directory paths
</span></span></span><span class="line"><span class="cl"><span class="s2">        files (list): List of file paths
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span> <span class="o">=</span> <span class="n">result_queue</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span> <span class="o">=</span> <span class="n">dirs</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Runs the process&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> Parsing </span><span class="si">%s</span><span class="s2"> ... &#34;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">),</span> <span class="n">d</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Parse directory</span>
</span></span><span class="line"><span class="cl">            <span class="n">parser</span> <span class="o">=</span> <span class="n">SmaliParser</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">parser</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Get and save results</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A process will have a list of directories to scan plus a results queue where to put
its individual results.</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    Graphviz code
    
  </summary>
  <pre><code>dot {
    digraph G {
        graph [splines=curve, rankdir = LR, pad=&quot;.15&quot;, ranksep=&quot;1.25&quot;, nodesep=&quot;2.25&quot;];
        node[fontname=&quot;FreeSans&quot;,fontsize=&quot;14&quot;,shape=Mrecord,width=2, height=.5];

        compound = true;

        Workers[label=&quot;{\
              {WORKERS \r |\
               &lt;w1&gt;Worker #1 \l|\
               &lt;w2&gt;Worker #2 \l|\
               &lt;w3&gt;Worker #3 \l|\
               &lt;w4&gt;Worker #n \l\
              }\
        }&quot;, width=4];

        Queue [label=&quot;Results Queue&quot;, shape=box3d, width=4];

        Workers:w1 -&gt; Queue;
        Workers:w2 -&gt; Queue;
        Workers:w3 -&gt; Queue;
        Workers:w4 -&gt; Queue;
    }
}
</code></pre>

</details>

<p><img src="https://blog.dornea.nu/posts/img/2015/smalisca-concurrency/queue.dot.png" alt="queue"></p>
<p>A <strong>controller</strong> should create and create the workers. Afterwards it should collect the
results:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ConcurrentParser</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Implements concurrency features
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Attributes:
</span></span></span><span class="line"><span class="cl"><span class="s2">        processes (list): List of processes/workers
</span></span></span><span class="line"><span class="cl"><span class="s2">        result_queue (Queue): Proxy to some thread-safe queue
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Use a manager to proxy access to the real queue</span>
</span></span><span class="line"><span class="cl">    <span class="n">multimanager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_queue</span> <span class="o">=</span> <span class="n">multimanager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">jobs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">jobs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Parallelize parsing
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Split input list into sublists according to the number of
</span></span></span><span class="line"><span class="cl"><span class="s2">        specified jobs. Create new processes/workers and let them
</span></span></span><span class="line"><span class="cl"><span class="s2">        do the parsing job.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Create sub-lists</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">sub_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">j</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Create new process</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span> <span class="o">=</span> <span class="n">SmaliParserProcess</span><span class="p">(</span><span class="n">sub_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Start processes</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Exit the completed processes</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Get results</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Pretty straightforward, isn&rsquo;t it? Split the lists into sub-lists, assign each worker a sub-list and let them <em>run</em>. Then <em>join</em> the processes and collect the results.</p>
<h2 id="concurrency-caveats">Concurrency caveats</h2>
<p>In some initial code I&rsquo;ve had, I was using a simple <code>multiprocessing.Queue()</code> to collect
the results. After some testing I&rsquo;ve noticed that my processes never <strong>terminated</strong>.
Sometimes (in fact <strong>always</strong>) it&rsquo;s a good idea to take a closer look at the documentation.
Looking at the <a href="https://docs.python.org/3.1/library/multiprocessing.html#all-platforms">programming guidelines</a> I&rsquo;ve read following:</p>
<blockquote>
<p><strong>Joining processes that use queues</strong></p>
<p>Bear in mind that a process that has put items in a queue will wait before terminating until all the buffered items are fed by the “feeder” thread to the underlying pipe. (The child process can call the Queue.cancel_join_thread() method of the queue to avoid this behaviour.)</p>
<p>Ä This means that whenever you use a queue you need to make sure that all items which have been put on the queue will eventually be removed before the process is joined. Otherwise you cannot be sure that processes which have put items on the queue will terminate. Remember also that non-daemonic processes will be automatically be joined.</p>
</blockquote>
<p>So my previous implementation was prone to a <strong>deadlock</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">queue</span><span class="p">,))</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>                    <span class="c1"># this deadlocks</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>OK, leason lerned! And then I&rsquo;ve found this <a href="http://code.activestate.com/lists/python-tutor/99561/">post</a> which deals with <code>multiprocessing.Manager</code>s. In my current code I&rsquo;m also using a <code>Queue</code> but <strong>proxied</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">multimanager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">result_queue</span> <span class="o">=</span> <span class="n">multimanager</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this case <code>result_queue</code> is also a <code>Queue</code> wrapped by a proxy. As stated <a href="https://docs.python.org/3/library/multiprocessing.html#proxy-objects">here</a>:</p>
<blockquote>
<p>A proxy is an object which refers to a shared object which lives (presumably) in a different process. The shared object is said to be the referent of the proxy. Multiple proxy objects may have the same referent.
..
An important feature of proxy objects is that they are picklable so they can be passed between processes. Note, however, that if a proxy is sent to the corresponding manager’s process then unpickling it will produce the referent itself.</p>
</blockquote>
<p>Ahhhh! Now that we&rsquo;ve implemented it (hopefully) the clean way, let&rsquo;s have a look at some metrics.</p>
<h2 id="metrics">Metrics</h2>
<p>Of course I wanted to somehow measure my improvements. Having that said don&rsquo;t expect <strong>huge</strong> improvements.
It kind of surprised me too. I&rsquo;ve compared the execution time (<strong>just for the parsing job</strong>) between</p>
<ul>
<li><strong>old</strong> and <strong>new</strong> version of smalisca</li>
<li>using different number of jobs/workers</li>
</ul>
<p>I&rsquo;ve used my Laptop (<strong>Dell XPS 13 with Intel Core i7</strong>) for the testings. Using a larger code repository (bigger than the <em>FakeBanker</em> one) I&rsquo;ve first ran the <strong>old</strong> smalisca version (0.1). This what I&rsquo;ve got:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">CMD</span><span class="o">=</span><span class="s2">&#34;time smalisca parser -l /home/victor/work/Projects/XXX/source/smali -s java -f sqlite  -o ~/work/Projects/XXXX/db.sqlite&#34;</span>
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span><span class="k">do</span> <span class="nb">eval</span> <span class="si">${</span><span class="nv">CMD</span><span class="si">}</span> <span class="p">|</span> grep total<span class="p">;</span> <span class="k">done</span> 
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.61s user 0.11s system 100% cpu 3.712 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.66s user 0.12s system 100% cpu 3.778 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.66s user 0.10s system 100% cpu 3.762 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.64s user 0.11s system 100% cpu 3.748 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.67s user 0.18s system 100% cpu 3.853 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.56s user 0.13s system 100% cpu 3.689 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.55s user 0.11s system 100% cpu 3.663 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.63s user 0.12s system 100% cpu 3.746 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.52s user 0.16s system 100% cpu 3.681 total
</span></span><span class="line"><span class="cl">smalisca parser -l  -s java -f sqlite -o   3.55s user 0.11s system 100% cpu 3.658 total
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you see it takes ca. <strong>3.5 seconds</strong> to finish the parsing. OK, now what about the
<strong>concurrent</strong> version of smalisca?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">CMD</span><span class="o">=</span><span class="s2">&#34;time ./smalisca-test.py parser --depth 2 -l /home/victor/work/Projects/XXX/source/smali -s java -f sqlite  -o ~/work/Projects/XXXX/db.sqlite&#34;</span>
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span><span class="k">do</span> <span class="nb">eval</span> <span class="si">${</span><span class="nv">CMD</span><span class="si">}</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> /dev/null <span class="p">|</span> grep total<span class="p">;</span> <span class="k">done</span> 
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.52s user 0.28s system 156% cpu 3.704 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.50s user 0.32s system 155% cpu 3.743 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.59s user 0.29s system 152% cpu 3.864 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.48s user 0.40s system 155% cpu 3.794 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.42s user 0.35s system 155% cpu 3.720 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.79s user 0.32s system 156% cpu 3.904 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.50s user 0.34s system 152% cpu 3.836 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.39s user 0.35s system 150% cpu 3.824 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.58s user 0.31s system 159% cpu 3.684 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">2</span> -l  -s java -f sqlite -o   5.44s user 0.33s system 155% cpu 3.707 total
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>5.5 seconds</strong>!!! It takes <strong>longer</strong>! Obviously the <code>Queue</code> processing and starting new processes increases
execution time. Ok, now let&rsquo;s try with more <strong>jobs</strong> (=8):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">CMD</span><span class="o">=</span><span class="s2">&#34;time ./smalisca-test.py parser --depth 3 -j 8 -l /home/victor/work/Projects/XXX/source/smali -s java -f sqlite  -o ~/work/Projects/XXXX/db.sqlite&#34;</span>
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span><span class="k">do</span> <span class="nb">eval</span> <span class="si">${</span><span class="nv">CMD</span><span class="si">}</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> /dev/null <span class="p">|</span> grep total<span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.66s user 0.36s system 161% cpu 3.730 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.80s user 0.29s system 161% cpu 3.761 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.57s user 0.40s system 158% cpu 3.756 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.49s user 0.32s system 156% cpu 3.700 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.76s user 0.30s system 162% cpu 3.741 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.62s user 0.28s system 162% cpu 3.641 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.54s user 0.30s system 161% cpu 3.627 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.63s user 0.31s system 159% cpu 3.724 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.73s user 0.35s system 162% cpu 3.747 total
</span></span><span class="line"><span class="cl">./smalisca-test.py parser --depth <span class="m">3</span> -j <span class="m">8</span> -l  -s java -f sqlite -o   5.43s user 0.34s system 153% cpu 3.764 total
</span></span></code></pre></td></tr></table>
</div>
</div><p>Pretty much the <strong>same</strong> results. And here is the overall results table:</p>
<table>
<thead>
<tr>
<th>Run</th>
<th>Non-Concurrent (v0.1)</th>
<th>Concurrent (v0.1-dev)</th>
<th>Using Jobs = 8</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>3.61</td>
<td>5.52</td>
<td>5.66</td>
</tr>
<tr>
<td>2</td>
<td>3.66</td>
<td>5.50</td>
<td>5.80</td>
</tr>
<tr>
<td>3</td>
<td>3.66</td>
<td>5.59</td>
<td>5.57</td>
</tr>
<tr>
<td>4</td>
<td>3.64</td>
<td>5.48</td>
<td>5.49</td>
</tr>
<tr>
<td>5</td>
<td>3.67</td>
<td>5.42</td>
<td>5.76</td>
</tr>
<tr>
<td>6</td>
<td>3.56</td>
<td>5.79</td>
<td>5.62</td>
</tr>
<tr>
<td>7</td>
<td>3.55</td>
<td>5.50</td>
<td>5.54</td>
</tr>
<tr>
<td>8</td>
<td>3.63</td>
<td>5.39</td>
<td>5.63</td>
</tr>
<tr>
<td>9</td>
<td>3.52</td>
<td>5.38</td>
<td>5.73</td>
</tr>
<tr>
<td>10</td>
<td>3.55</td>
<td>5.44</td>
<td>5.43</td>
</tr>
</tbody>
</table>
<h2 id="lessons-learned">Lessons learned</h2>
<ul>
<li>Concurrency is <strong>NOT</strong> easy</li>
<li>It may not always have a big (positive) impact on the <strong>performance</strong> of your code</li>
<li>There are a lot of side-effects (related to concurrency in general) which you&rsquo;ll have to pay attention to</li>
<li>I need a really <strong>big</strong> code repository to test against in order to make sure I&rsquo;ve implemented it correctly</li>
<li>Despite all those kind of problems, it&rsquo;s <strong>fun</strong>! :)</li>
<li>Have a look at the <a href="https://github.com/dorneanu/smalisca/commit/a48a1b9e3eb648baf6547658e06bfe32c094551c">commit details</a> in the <a href="https://github.com/dorneanu/smalisca/tree/develop">develop</a> branch.</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="http://everydayimlearning.blogspot.de/2013/03/multiprocessing-with-python.html">Multiprocessing with Python</a></li>
<li><a href="https://moinakg.wordpress.com/2013/07/01/parallel-directory-tree-compare-in-python/">Parallel Directory Tree Compare with Python</a></li>
<li><a href="https://www.binpress.com/tutorial/simple-python-parallelism/121?utm_content=bufferc7776&amp;utm_medium=social&amp;utm_source=twitter.com&amp;utm_campaign=buffer">Simple parallelism with Python</a></li>
<li><a href="http://pymotw.com/2/multiprocessing/communication.html">Communication between processes</a></li>
</ul>

    

  </div>
  
  
  

<section class="related-topics mt5 mb4">
  <div class="bt b--black-10 pt4">
    <h3 class="f4 fw6 mb3">Explore Related Topics</h3>
    
    <div class="cf">
      
      
      
      
      
      
      
      
      <div class="fl w-100 
        
          w-100-l
        ">
        <div class="pa3 br2 bg-white ba b--black-10 h-100">
          <h4 class="f5 fw6 mt0 mb2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            Technology
          </h4>
          <ul class="list pl0 mt0">
            
            <li class="pv1"><a href="https://blog.dornea.nu/tags/emacs" class="link dim dark-gray f6">Emacs</a></li>
            <li class="pv1"><a href="https://blog.dornea.nu/tags/golang" class="link dim dark-gray f6">Golang</a></li>
            <li class="pv1"><a href="https://brainfck.org" class="link dim dark-gray f6">My Zettelkasten</a></li>
          </ul>
        </div>
      </div>
      
      
      
      
    </div>
    
    <div class="tc mt4">
      <a href="https://blog.dornea.nu/tags" class="f6 link dim br-pill ph3 pv2 mb2 dib white bg-main-color">Browse All Tags</a>
    </div>
  </div>
</section>
  
  <div id="comments">
      

  </div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="https://blog.dornea.nu/2015/04/30/gethostbyname-vs.-getaddrinfo/">prev</a>
  <a href="https://blog.dornea.nu/2015/05/24/validating-and-pinning-x.509-certificates/">next</a>
  </p>
</div>

  <footer class="content-width mt5 mb4 center ph3 gray f6">
  
  <div class="bt b--black-10 pv3"></div>
  
  
  <div class="cf">
    
    <div class="fl w-100 w-50-l pr4-l">
      <p class="mb2 fw6">About this blog</p>
      <p class="mv0 lh-copy">
        Personal thoughts on programming, productivity, and philosophy. I write about things I'm learning and ideas I find interesting.
      </p>
      <p class="mt3 o-70">
        © 2025 Victor Dorneanu
      </p>
    </div>
    
    
    <div class="fl w-100 w-50-l pl4-l mt4 mt0-l">
      <div class="cf">
        
        <div class="fl w-33">
          <p class="mb2 fw6">Navigation</p>
          <ul class="list pl0">
            <li class="pv1"><a href='https://blog.dornea.nu/' title="Home" class="link gray dim">Home</a></li>
            <li class="pv1"><a href='http://dornea.nu' title="About" class="link gray dim">About</a></li>
            <li class="pv1"><a href='https://blog.dornea.nu/tags' title="Tags" class="link gray dim">Tags</a></li>
            <li class="pv1"><a href='https://brainfck.org' title="Zettelkasten" class="link gray dim">Zettelkasten</a></li>
          </ul>
        </div>
        
        
        <div class="fl w-33">
          <p class="mb2 fw6">Connect</p>
          <ul class="list pl0">
            <li class="pv1">
              <a href='https://blog.dornea.nu/feed.xml' title="RSS" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
                RSS Feed
              </a>
            </li>
            <li class="pv1">
              <a href='https://github.com/dorneanu' title="GitHub" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                GitHub
              </a>
            </li>
            <li class="pv1">
              <a href='https://www.goodreads.com/user/show/121423977-victor-dorneanu' title="Goodreads" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                Goodreads
              </a>
            </li>
          </ul>
        </div>

        
        <div class="fl w-33">
          <p class="mb2 fw6">Support</p>
          <div class="pv1">
            <a href="https://www.buymeacoffee.com/dorneanu" target="_blank" class="dib">
              <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px;">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  
  <div class="tc mt4 pt3 f7 o-70">
    Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
  </div>
</footer>
  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
