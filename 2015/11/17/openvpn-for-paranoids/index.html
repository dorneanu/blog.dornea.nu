<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><title>OpenVPN for paranoids - blog.dornea.nu</title><meta content="OpenVPN for paranoids  - blog.dornea.nu" property="title"><meta content="OpenVPN for paranoids  - blog.dornea.nu" property="og:title"><meta property="og:description" content="Continuing my admin series this time I&rsquo;d like to setup a VPN using OpenVPN  as user-based VPN solution. Unlike IPSec solutions which require IPSec on both (server and client) sides, securing the VPN tunnel by OpenSSL is a more preferable option.
In this post I&rsquo;ll try to show which steps have to be taken in order to:
 secure the communication channel use up-to-date (and secure!) TLS configurations prevent information leaks when the VPN tunnel is down  At least for the last one some additional steps are required to route your traffic only through the VPN tunnel."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.dornea.nu/2015/11/17/openvpn-for-paranoids/"><meta property="article:published_time" content="2015-11-17T00:00:00+00:00"><meta property="article:modified_time" content="2015-11-17T00:00:00+00:00"><meta name=generator content="Hugo 0.75.1"><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel=stylesheet><style type=text/css>:root{--main-color: #8C6056;--secondary-color: #AFD5AA;--logo-text-color: #fff;--body-text-color: #3d3d3d;--heading-text-color: #383838;--background-color: #fff}</style><link href=http://blog.dornea.nu/css/tachyons.min.css rel=stylesheet><link href=http://blog.dornea.nu/css/styles.css rel=stylesheet><link rel=icon href=http://blog.dornea.nu/favicon.ico type=image/x-icon><link href=http://blog.dornea.nu/feed.xml rel=alternate type=application/atom+xml title=blog.dornea.nu></head><body class=global-font><nav class="flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id=navbar><div class=flex><a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id=site-title href=http://blog.dornea.nu/ title=Home>blog.dornea.nu</a></div><div class="flex-ns mt2 mt0-ns pv1"><a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href=http://blog.dornea.nu/ title=Home>Home</a>
<a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href=http://dornea.nu title=About>About</a>
<a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href=http://blog.dornea.nu/tags title=Tags>Tags</a>
<a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href=https://brainfck.org title=Zettelkasten>Zettelkasten</a>
<a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href=https://brainfck.org/bookmarks.html title=Bookmarks>Bookmarks</a>
<a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href=https://brainfck.org/bib.html title=Books>Books</a>
<a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href=http://blog.dornea.nu/notes title=Notes>Notes</a></div></nav><main class="center mv4 content-width ph3"><div class="f3 fw6 heading-color heading-font post-title">OpenVPN for paranoids</div><p class="silver f6 mt1 mb4 post-meta"><time>17 Nov 2015</time>
|
tags: [ <a href=http://blog.dornea.nu/tags/networking class="link silver">networking</a> <a href=http://blog.dornea.nu/tags/openvpn class="link silver">openvpn</a> <a href=http://blog.dornea.nu/tags/ssl class="link silver">ssl</a> <a href=http://blog.dornea.nu/tags/tls class="link silver">tls</a> <a href=http://blog.dornea.nu/tags/iptables class="link silver">iptables</a> <a href=http://blog.dornea.nu/tags/crypto class="link silver">crypto</a> <a href=http://blog.dornea.nu/tags/ipython class="link silver">ipython</a> <a href=http://blog.dornea.nu/tags/admin class="link silver">admin</a> <a href=http://blog.dornea.nu/tags/openssl class="link silver">openssl</a> <a href=http://blog.dornea.nu/tags/x.509 class="link silver">x.509</a> <a href=http://blog.dornea.nu/tags/firewall class="link silver">firewall</a> <a href=http://blog.dornea.nu/tags/vpn class="link silver">vpn</a> <a href=http://blog.dornea.nu/tags/openvpn class="link silver">openvpn</a> ]</p><div class="lh-copy post-content"><p>Continuing my <a href=http://blog.dornea.nu/tag/admin/>admin</a> series this time I&rsquo;d like to setup a <strong>VPN</strong> using <a href=https://openvpn.net>OpenVPN</a> as <strong>user-based</strong> VPN solution. Unlike <em>IPSec</em> solutions which require IPSec on both (server and client) sides, securing the VPN tunnel by <strong>OpenSSL</strong> is a more preferable option.</p><p>In this post I&rsquo;ll try to show which steps have to be taken in order to:</p><ul><li>secure the communication channel</li><li>use up-to-date (and secure!) TLS configurations</li><li>prevent information leaks when the VPN tunnel is down</li></ul><p>At least for the last one some additional steps are required to route your traffic <strong>only</strong> through the VPN tunnel. As a client you don&rsquo;t want your connection to be &ldquo;downgraded&rdquo; (in terms of security) without even realizing it. That&rsquo;s why you might want to restrict your routes and allow outbound connection only through the (virtual) interface dedicated to the VPN. How this is done and which methods exist, is covered later on.</p><h2 id=revision>Revision</h2><h1 id=create-certificates>Create certificates</h1><p>In the last <a href=http://blog.dornea.nu/2015/10/02/manage-pki-using-openssl/>post</a> I&rsquo;ve already created the <a href=http://blog.dornea.nu/2015/10/02/manage-pki-using-openssl/#Create-vpn.dornea.nu-CA>VPN CA</a> and also <strong>issued</strong> certificates for server and client. Perhaps you do remember the PKI:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>%%blockdiag
<span style=color:#999;font-style:italic># &lt;!-- collapse=True --&gt;↔</span>
blockdiag {
  // Define orientation
  orientation = portrait;

  // Define <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:#447fcf;text-decoration:underline>list</span> of attributes)
  <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>emphasis</span> [color = pink, style = dashed];
  <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>blackline</span> [color = black, style = dotted];
  <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>blue</span> [color = lightblue];
  <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>active</span> [color = lightgreen];
  <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>inactive</span> [color = lightgrey]; 

  Root_CA [label = <span style=color:#ed9d13>&#34;dornea.nu root CA&#34;</span>];
  Signing_CA2 [label = <span style=color:#ed9d13>&#34;dev.dornea.nu CA&#34;</span>];
  Signing_CA3 [<span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>= </span><span style=color:#447fcf;text-decoration:underline>active</span>, label = <span style=color:#ed9d13>&#34;vpn.dornea.nu CA&#34;</span>];
  TLS_Server_CA [label = <span style=color:#ed9d13>&#34;TLS Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  TLS_Client_CA [label = <span style=color:#ed9d13>&#34;TLS Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Server_CA [<span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>= </span><span style=color:#447fcf;text-decoration:underline>inactive</span>, label = <span style=color:#ed9d13>&#34;VPN Server Cert&#34;</span>, shape = flowchart.terminator, style = dotted];
  VPN_Client_CA [<span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>= </span><span style=color:#447fcf;text-decoration:underline>inactive</span>, label = <span style=color:#ed9d13>&#34;VPN Client Cert&#34;</span>, shape = flowchart.terminator, style = dotted];

  Root_CA -&gt; Signing_CA2;
  Root_CA -&gt; Signing_CA3;

  Signing_CA2 -&gt; TLS_Server_CA;
  Signing_CA2 -&gt; TLS_Client_CA;
    
  Signing_CA3 -&gt; VPN_Server_CA;
  Signing_CA3 -&gt; VPN_Client_CA;
}
</code></pre></div><p><img src=output_2_0.png alt=png></p><p>My solution is more a <em>DIY</em> one. If you want to use a more convient one, have a look at <a href=https://github.com/OpenVPN/easy-rsa>easy-rsa</a>.</p><h1 id=configure-vpn-server>Configure VPN server</h1><p>There are several steps aimed at successfully configuring your OpenVPN server.</p><h2 id=basic-configuration>Basic configuration</h2><ul><li>Add new user <code>openvpn</code></li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# useradd openvpn
</code></pre></div><ul><li>Specify which interface the server should listen on</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Which local IP address should OpenVPN</span>
<span style=color:#999;font-style:italic># listen on? (optional)</span>
;<span style=color:#24909d>local</span> a.b.c.d
<span style=color:#24909d>local</span> 192.168.178.163
</code></pre></div><ul><li>Specify protocol and port OpenVPN should initiate connections over</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Which TCP/UDP port should OpenVPN listen on?</span>
<span style=color:#999;font-style:italic># If you want to run multiple OpenVPN instances</span>
<span style=color:#999;font-style:italic># on the same machine, use a different port</span>
<span style=color:#999;font-style:italic># number for each one.  You will need to</span>
<span style=color:#999;font-style:italic># open up this port on your firewall.</span>
port <span style=color:#3677a9>443</span>

<span style=color:#999;font-style:italic># TCP or UDP server?</span>
;proto tcp
proto udp
</code></pre></div><ul><li>Specify VPN subnet where to assign IP addresses to clients from</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Configure server mode and supply a VPN subnet</span>
<span style=color:#999;font-style:italic># for OpenVPN to draw client addresses from.</span>
<span style=color:#999;font-style:italic># The server will take 10.8.0.1 for itself,</span>
<span style=color:#999;font-style:italic># the rest will be made available to clients.</span>
<span style=color:#999;font-style:italic># Each client will be able to reach the server</span>
<span style=color:#999;font-style:italic># on 10.8.0.1. Comment this line out if you are</span>
<span style=color:#999;font-style:italic># ethernet bridging. See the man page for more info.</span>
server 10.66.0.0 255.255.255.0
</code></pre></div><h2 id=secure-communication-channel>Secure communication channel</h2><h3 id=add-dh-params>Add <strong>DH params</strong></h3><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# openssl dhparam -out dh2048.pem <span style=color:#3677a9>2048</span>
Generating DH parameters, <span style=color:#3677a9>2048</span> bit long safe prime, generator <span style=color:#3677a9>2</span>
This is going to take a long <span style=color:#24909d>time</span>
...
</code></pre></div><p>And now add it to the config file:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Diffie hellman parameters.</span>
<span style=color:#999;font-style:italic># Generate your own with:</span>
<span style=color:#999;font-style:italic>#   openssl dhparam -out dh2048.pem 2048</span>
dh /etc/openvpn/dh2048.pem
</code></pre></div><h3 id=hmac-firewall-using-tls-auth><strong>HMAC firewall</strong> using tls-auth</h3><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# openvpn --genkey --secret ta.key
</code></pre></div><p>And add it to the config file:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># For extra security beyond that provided</span>
<span style=color:#999;font-style:italic># by SSL/TLS, create an &#34;HMAC firewall&#34;</span>
<span style=color:#999;font-style:italic># to help block DoS attacks and UDP port flooding.</span>
<span style=color:#999;font-style:italic>#</span>
<span style=color:#999;font-style:italic># Generate with:</span>
<span style=color:#999;font-style:italic>#   openvpn --genkey --secret ta.key</span>
<span style=color:#999;font-style:italic>#</span>
<span style=color:#999;font-style:italic># The server and each client must have</span>
<span style=color:#999;font-style:italic># a copy of this key.</span>
<span style=color:#999;font-style:italic># The second parameter should be &#39;0&#39;</span>
<span style=color:#999;font-style:italic># on the server and &#39;1&#39; on the clients.</span>
tls-auth /etc/openvpn/ta.key <span style=color:#3677a9>0</span> <span style=color:#999;font-style:italic># This file is secret</span>
</code></pre></div><h3 id=strong-cryptographic-cipher>Strong <strong>cryptographic cipher</strong></h3><p>First let&rsquo;s have a look at the available ciphers (filter only those with 256 bit key length:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# openvpn --show-ciphers | grep <span style=color:#3677a9>256</span>
AES-256-CBC <span style=color:#3677a9>256</span> bit default key (fixed)
AES-256-OFB <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
AES-256-CFB <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
AES-256-CFB1 <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
AES-256-CFB8 <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
CAMELLIA-256-CBC <span style=color:#3677a9>256</span> bit default key (fixed)
CAMELLIA-256-CFB <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
CAMELLIA-256-CFB1 <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
CAMELLIA-256-CFB8 <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
CAMELLIA-256-OFB <span style=color:#3677a9>256</span> bit default key (fixed) (TLS client/server mode)
</code></pre></div><p>I&rsquo;ll select <strong>AES-256-CBC</strong>:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Select a cryptographic cipher.</span>
<span style=color:#999;font-style:italic># This config item must be copied to</span>
<span style=color:#999;font-style:italic># the client config file as well.</span>
;cipher BF-CBC        <span style=color:#999;font-style:italic># Blowfish (default)</span>
;cipher AES-128-CBC   <span style=color:#999;font-style:italic># AES</span>
;cipher DES-EDE3-CBC  <span style=color:#999;font-style:italic># Triple-DES</span>
cipher AES-256-CBC
</code></pre></div><h3 id=select-tls-cipher>Select TLS cipher</h3><p>In order to guarantee <a href=https://en.wikipedia.org/wiki/Forward_secrecy>FPS</a> I&rsquo;ll be using a <strong>Diffie–Hellman key exchange-based PFS</strong> like <strong>DHE-[&mldr;]</strong> or an <strong>elliptic curve Diffie–Hellman-based PFS</strong> like <strong>ECDHE-[&mldr;]</strong>. As stated <a href=https://community.openvpn.net/openvpn/wiki/Hardening#Useof--tls-cipher>here</a> OpenVPN does not support TLS-ECDHE-* or more exotic cipher-suites as there is no elliptic curve support currently.</p><p>Let&rsquo;s have a look at the available <strong>TLS ciphers</strong>:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# openvpn --show-tls | grep TLS-DHE
TLS-DHE-DSS-WITH-AES-256-GCM-SHA384
TLS-DHE-RSA-WITH-AES-256-GCM-SHA384
TLS-DHE-RSA-WITH-AES-256-CBC-SHA256
TLS-DHE-DSS-WITH-AES-256-CBC-SHA256
TLS-DHE-RSA-WITH-AES-256-CBC-SHA
TLS-DHE-DSS-WITH-AES-256-CBC-SHA
TLS-DHE-RSA-WITH-CAMELLIA-256-CBC-SHA
TLS-DHE-DSS-WITH-CAMELLIA-256-CBC-SHA
TLS-DHE-DSS-WITH-AES-128-GCM-SHA256
TLS-DHE-RSA-WITH-AES-128-GCM-SHA256
TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
TLS-DHE-DSS-WITH-AES-128-CBC-SHA256
TLS-DHE-RSA-WITH-AES-128-CBC-SHA
TLS-DHE-DSS-WITH-AES-128-CBC-SHA
TLS-DHE-RSA-WITH-SEED-CBC-SHA
TLS-DHE-DSS-WITH-SEED-CBC-SHA
TLS-DHE-RSA-WITH-CAMELLIA-128-CBC-SHA
TLS-DHE-DSS-WITH-CAMELLIA-128-CBC-SHA
TLS-DHE-RSA-WITH-3DES-EDE-CBC-SHA
TLS-DHE-DSS-WITH-3DES-EDE-CBC-SHA
TLS-DHE-RSA-WITH-DES-CBC-SHA
TLS-DHE-DSS-WITH-DES-CBC-SHA
</code></pre></div><p>Add <strong>some</strong> ciphers to the config file:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Select a TLS cipher</span>
tls-cipher TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256:TLS-DHE-DSS-WITH-AES-128-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA
</code></pre></div><p>Additionally you can specify which <strong>TLS version</strong> should be used</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Use TLS 1.2 as minimum requirement</span>
tls-version-min 1.2
</code></pre></div><h3 id=use-sha2-for-message-authentication>Use SHA2 for message authentication</h3><p>In case you don&rsquo;t have performance issues, change the the MAC digest to:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>auth SHA512
</code></pre></div><h3 id=verify-revoked-client-certs>Verify revoked client certs</h3><p>Also make sure that no client with a revoked certificate is allowed to connect to the VPN server:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>crl-verify path-to/your-ca-crl.pem
</code></pre></div><h3 id=route-all-client-traffic-incl-dns-through-vpn-tunnel>Route all client traffic (incl. DNS) through VPN tunnel</h3><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>push <span style=color:#ed9d13>&#34;redirect-gateway def1&#34;</span>
</code></pre></div><p>Pushing this option to the clients will route all client originating traffic through the OpenVPN server. The server however must know how to deal with this traffic by <strong>NAT</strong>ing it to the Internet or passing it to some <strong>proxy</strong>. <strong>DNS</strong> traffic will be routed as well. You may want to <em>push</em> some DNS server to the clients, such as:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>push <span style=color:#ed9d13>&#34;dhcp-option DNS 208.67.222.222&#34;</span>
push <span style=color:#ed9d13>&#34;dhcp-option DNS 8.8.8.8&#34;</span>
</code></pre></div><h3 id=make-other-subnets-available-to-the-clients>Make other subnets available to the clients</h3><p>In order to allow VPN clients to access subnets behind the VPN-gateway you&rsquo;ll have to advertise these subnets to the clients. One example:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Push routes to the client to allow it</span>
<span style=color:#999;font-style:italic># to reach other private subnets behind</span>
<span style=color:#999;font-style:italic># the server.  Remember that these</span>
<span style=color:#999;font-style:italic># private subnets will also need</span>
<span style=color:#999;font-style:italic># to know to route the OpenVPN client</span>
<span style=color:#999;font-style:italic># address pool (10.8.0.0/255.255.255.0)</span>
<span style=color:#999;font-style:italic># back to the OpenVPN server.</span>
push <span style=color:#ed9d13>&#34;route 192.168.178.0 255.255.255.0&#34;</span>
</code></pre></div><p>More on <strong>Routing</strong> in the section below.</p><h2 id=harden-server>Harden server</h2><h3 id=move-it-to-chroot>Move it to chroot</h3><p>In a <strong>chroot</strong> environment a process/daemon would not be able to access any part of the system&rsquo;s filesystem except for the directory it is currently in.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# mkdir -p /home/openvpn/tmp
root@debian:/etc/openvpn# chown -R openvpn:openvpn /home/openvpn
</code></pre></div><p>Also add to the config file:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Lock down daemon to chroot jail</span>
chroot jail
</code></pre></div><h3 id=dont-run-as-root>Don&rsquo;t run as root</h3><p>Reduce OpenVPN&rsquo;s server privileges:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># It&#39;s a good idea to reduce the OpenVPN</span>
<span style=color:#999;font-style:italic># daemon&#39;s privileges after initialization.</span>
<span style=color:#999;font-style:italic>#</span>
<span style=color:#999;font-style:italic># You can uncomment this out on</span>
<span style=color:#999;font-style:italic># non-Windows systems.</span>
user openvpn
group openvpn
</code></pre></div><h3 id=unprivileged-mode>Unprivileged mode</h3><p>While being able to operate on a <code>tun</code> device, the OpenVPN daemon should be able to access it in an unprivileged mode. Internally <code>sudo</code> is being used to call <code>iproute</code> which will apply the interface properties and add/delete/modify routing information. For getting this to work I&rsquo;ll use the described steps in the <a href=https://openvpn.net/index.php/open-source/documentation/howto.html>official documentation</a>:</p><ul><li>Create a new script</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# cat /usr/local/sbin/unpriv-ip 
<span style=color:#999;font-style:italic>#!/bin/sh</span>
sudo /sbin/ip <span style=color:#40ffff>$*</span>
root@debian:/etc/openvpn# chmod a+x /usr/local/sbin/unpriv-ip
</code></pre></div><ul><li>Allow <code>user1</code> to execute <code>/sbin/ip</code> (in <code>/etc/sudoers</code>):</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Allow user1 nobody to execute /sbin/ip</span>
openvpn <span style=color:#40ffff>ALL</span>=(ALL)  NOPASSWD: /sbin/ip
</code></pre></div><ul><li>Change OpenVPN configuration</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Set  alternate command to execute instead of default iproute2 command.</span>
iproute /usr/local/sbin/unpriv-ip
</code></pre></div><h3 id=check-file-permissions>Check file permissions</h3><p>Also check the file permissions for the file inside <code>/etc/openvpn</code>:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# chmod go-rwx /etc/openvpn/ta.key /etc/openvpn/dh2048.pem /etc/openvpn/certs/raspberry_pi.p12
</code></pre></div><h3 id=disable-password--caching>Disable password caching</h3><p>You might get some warning like</p><blockquote><p>WARNING: this configuration may cache passwords in memory &ndash; use the auth-nocache option to prevent this</p></blockquote><p>Then add it fo the conf:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Prevent password caching</span>
auth-nocache
</code></pre></div><h2 id=start-server>Start server</h2><p>Let&rsquo;s give it a try:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/etc/openvpn# openvpn server.conf 
Tue Nov <span style=color:#3677a9>17</span> 17:30:12 <span style=color:#3677a9>2015</span> OpenVPN 2.3.4 arm-unknown-linux-gnueabihf [SSL (OpenSSL)] [LZO] [EPOLL] [PKCS11] [MH] [IPv6] built on Dec  <span style=color:#3677a9>5</span> <span style=color:#3677a9>2014</span>
...

Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> Control Channel Authentication: using <span style=color:#ed9d13>&#39;ta.key&#39;</span> as a OpenVPN static key file
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> Outgoing Control Channel Authentication: Using <span style=color:#3677a9>512</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA512&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> Incoming Control Channel Authentication: Using <span style=color:#3677a9>512</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA512&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> Socket Buffers: <span style=color:#40ffff>R</span>=[163840-&gt;131072] <span style=color:#40ffff>S</span>=[163840-&gt;131072]
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> ROUTE_GATEWAY 192.168.178.1/255.255.255.0 <span style=color:#40ffff>IFACE</span>=eth0 <span style=color:#40ffff>HWADDR</span>=b8:27:eb:5c:0a:5d
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> TUN/TAP device tun0 opened
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> TUN/TAP TX queue length <span style=color:#24909d>set</span> to <span style=color:#3677a9>100</span>
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> do_ifconfig, tt-&gt;ipv6=0, tt-&gt;did_ifconfig_ipv6_setup=<span style=color:#3677a9>0</span>
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> /usr/local/sbin/unpriv-ip link <span style=color:#24909d>set</span> dev tun0 up mtu <span style=color:#3677a9>1500</span>
Tue Nov <span style=color:#3677a9>17</span> 17:30:16 <span style=color:#3677a9>2015</span> /usr/local/sbin/unpriv-ip addr add dev tun0 <span style=color:#24909d>local</span> 10.66.0.1 peer 10.66.0.2
Tue Nov <span style=color:#3677a9>17</span> 17:30:17 <span style=color:#3677a9>2015</span> /usr/local/sbin/unpriv-ip route add 10.66.0.0/24 via 10.66.0.2
Tue Nov <span style=color:#3677a9>17</span> 17:30:17 <span style=color:#3677a9>2015</span> chroot to <span style=color:#ed9d13>&#39;/home/openvpn&#39;</span> and <span style=color:#24909d>cd</span> to <span style=color:#ed9d13>&#39;/&#39;</span> succeeded
Tue Nov <span style=color:#3677a9>17</span> 17:30:17 <span style=color:#3677a9>2015</span> GID <span style=color:#24909d>set</span> to openvpn
Tue Nov <span style=color:#3677a9>17</span> 17:30:17 <span style=color:#3677a9>2015</span> UID <span style=color:#24909d>set</span> to openvpn
...
Tue Nov <span style=color:#3677a9>17</span> 17:30:17 <span style=color:#3677a9>2015</span> Initialization Sequence Completed


</code></pre></div><p>So everything seemed to work. Let&rsquo;s check some things:</p><ul><li>Process owner</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/home/victor# ps -efl | grep openvpn
<span style=color:#3677a9>4</span> S openvpn   <span style=color:#3677a9>9930</span>  <span style=color:#3677a9>1633</span>  <span style=color:#3677a9>0</span>  <span style=color:#3677a9>80</span>   <span style=color:#3677a9>0</span> -  <span style=color:#3677a9>1356</span>  e0778 17:30 pts/1    00:00:00 openvpn server.conf
</code></pre></div><ul><li>Opened files</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/home/victor# lsof | grep <span style=color:#3677a9>9930</span>
openvpn    <span style=color:#3677a9>9930</span>         openvpn  cwd       DIR      179,2     <span style=color:#3677a9>4096</span>        <span style=color:#3677a9>101</span> /home/openvpn
openvpn    <span style=color:#3677a9>9930</span>         openvpn  rtd       DIR      179,2     <span style=color:#3677a9>4096</span>        <span style=color:#3677a9>101</span> /home/openvpn

...
</code></pre></div><ul><li>Connectivity</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/home/openvpn# netstat -uptan | grep <span style=color:#3677a9>443</span>
udp        <span style=color:#3677a9>0</span>      192.168.178.163:443             0.0.0.0:*                           9930/openvpn    
</code></pre></div><p>Looks good.</p><h1 id=configure-client>Configure client</h1><h2 id=basic-configuration-1>Basic configuration</h2><p>Let&rsquo;s add the basic stuff:</p><ul><li>Specify we&rsquo;re operating in client mode</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Specify that we are a client and that we</span>
<span style=color:#999;font-style:italic># will be pulling certain config file directives</span>
<span style=color:#999;font-style:italic># from the server.</span>
client
</code></pre></div><ul><li>Specify TUN/TAP device for the client</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash> Use the same setting as you are using on
<span style=color:#999;font-style:italic># the server.</span>
<span style=color:#999;font-style:italic># On most systems, the VPN will not function</span>
<span style=color:#999;font-style:italic># unless you partially or fully disable</span>
<span style=color:#999;font-style:italic># the firewall for the TUN/TAP interface.</span>
;dev tap
dev tun
</code></pre></div><ul><li>Connection details</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Are we connecting to a TCP or</span>
<span style=color:#999;font-style:italic># UDP server?  Use the same setting as</span>
<span style=color:#999;font-style:italic># on the server.</span>
;proto tcp
proto udp

<span style=color:#999;font-style:italic># The hostname/IP and port of the server.</span>
<span style=color:#999;font-style:italic># You can have multiple remote entries</span>
<span style=color:#999;font-style:italic># to load balance between the servers.</span>
;remote my-server-1 <span style=color:#3677a9>1194</span>
remote 10.0.1.169 <span style=color:#3677a9>443</span>

</code></pre></div><h3 id=secure-communication-channel-1>Secure communication channel</h3><ul><li>Specify previously generated client certificate and key</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash> SSL/TLS parms.
<span style=color:#999;font-style:italic># See the server config file for more</span>
<span style=color:#999;font-style:italic># description.  It&#39;s best to use</span>
<span style=color:#999;font-style:italic># a separate .crt/.key file pair</span>
<span style=color:#999;font-style:italic># for each client.  A single ca</span>
<span style=color:#999;font-style:italic># file can be used for all clients.</span>
ca vpn-ca.crt
cert victor.crt
key victor.key
</code></pre></div><ul><li>Verify server certificate</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Verify server certificate by checking that the</span>
<span style=color:#999;font-style:italic># certicate has the correct key usage set.</span>
<span style=color:#999;font-style:italic># This is an important precaution to protect against</span>
<span style=color:#999;font-style:italic># a potential attack discussed here:</span>
<span style=color:#999;font-style:italic>#  http://openvpn.net/howto.html#mitm</span>
<span style=color:#999;font-style:italic>#</span>
<span style=color:#999;font-style:italic># To use this feature, you will need to generate</span>
<span style=color:#999;font-style:italic># your server certificates with the keyUsage set to</span>
<span style=color:#999;font-style:italic>#   digitalSignature, keyEncipherment</span>
<span style=color:#999;font-style:italic># and the extendedKeyUsage to</span>
<span style=color:#999;font-style:italic>#   serverAuth</span>
<span style=color:#999;font-style:italic># EasyRSA can do this for you.</span>
remote-cert-tls server
</code></pre></div><ul><li>Verify server&rsquo;s CN</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>verify-x509-name <span style=color:#ed9d13>&#39;C=NU, O=dornea.nu, OU=dornea.nu Root CA, CN=vpn.dornea.nu&#39;</span> subject
</code></pre></div><ul><li>Use <strong>tls-auth</strong> key (make sure you use the same one as on the server)</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># If a tls-auth key is used on the server</span>
<span style=color:#999;font-style:italic># then every client must also have the key.</span>
tls-auth ta.key <span style=color:#3677a9>1</span>
</code></pre></div><ul><li>Use SHA2 as MAC</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>auth SHA512
</code></pre></div><ul><li>Select cryptographic cipher (same as on the server)</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Select a cryptographic cipher.</span>
<span style=color:#999;font-style:italic># If the cipher option is used on the server</span>
<span style=color:#999;font-style:italic># then you must also specify it here.</span>
cipher cipher AES-256-CFB
</code></pre></div><h2 id=test-connection>Test connection</h2><ul><li>Initial try (with errors, see below)</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>OpenVPN 2.3_git [git:master/60fd44e501f20024+] x86_64-unknown-linux-gnu [SSL (OpenSSL)] [LZO] [SNAPPY] [LZ4] [EPOLL] [MH] [IPv6] built on Jun <span style=color:#3677a9>11</span> <span style=color:#3677a9>2015</span>
library versions: OpenSSL 1.0.2d <span style=color:#3677a9>9</span> Jul 2015, LZO 2.09
Enter Private Key Password: ******************
...
VERIFY ERROR: <span style=color:#40ffff>depth</span>=2, <span style=color:#40ffff>error</span>=self signed certificate in certificate chain: <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=dornea.nu Root CA, <span style=color:#40ffff>CN</span>=dornea.nu Root CA
OpenSSL: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed
TLS_ERROR: BIO <span style=color:#24909d>read</span> tls_read_plaintext error
TLS Error: TLS object -&gt; incoming plaintext <span style=color:#24909d>read</span> error
TLS Error: TLS handshake failed
...
</code></pre></div><p>We can see that the <strong>certificate verification</strong> has failed. So the client is not able to verify the certificate presented by the server because it doesn&rsquo;t have the <strong>root cert</strong>. Let&rsquo;s adapt the config:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># SSL/TLS parms.</span>
...
ca vpn-ca-chain.pem
...
</code></pre></div><p>Give it another try:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>OpenVPN 2.3_git [git:master/60fd44e501f20024+] x86_64-unknown-linux-gnu [SSL (OpenSSL)] [LZO] [SNAPPY] [LZ4] [EPOLL] [MH] [IPv6] built on Jun <span style=color:#3677a9>11</span> <span style=color:#3677a9>2015</span>
library versions: OpenSSL 1.0.2d <span style=color:#3677a9>9</span> Jul 2015, LZO 2.09
NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
Enter Private Key Password: ******************
WARNING: this configuration may cache passwords in memory -- use the auth-nocache option to prevent this
Control Channel Authentication: using <span style=color:#ed9d13>&#39;ta.key&#39;</span> as a OpenVPN static key file
Outgoing Control Channel Authentication: Using <span style=color:#3677a9>512</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA512&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
Incoming Control Channel Authentication: Using <span style=color:#3677a9>512</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA512&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
TCP/UDP: Preserving recently used remote address: [AF_INET]&lt;vpn-server&gt;:80
Socket Buffers: <span style=color:#40ffff>R</span>=[212992-&gt;131072] <span style=color:#40ffff>S</span>=[212992-&gt;131072]
UDP link local: (not bound)
UDP link remote: [AF_INET]&lt;vpn-server&gt;:80
TLS: Initial packet from [AF_INET]&lt;vpn-server&gt;, <span style=color:#40ffff>sid</span>=d4f744bb e391d690
VERIFY OK: <span style=color:#40ffff>depth</span>=2, <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=dornea.nu Root CA, <span style=color:#40ffff>CN</span>=dornea.nu Root CA
VERIFY OK: <span style=color:#40ffff>depth</span>=1, <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=dornea.nu Root CA, <span style=color:#40ffff>CN</span>=vpn.dornea.nu CA
Validating certificate key usage
++ Certificate has key usage  00a0, expects 00a0
VERIFY KU OK
Validating certificate extended key usage
++ Certificate has EKU (str) TLS Web Server Authentication, expects TLS Web Server Authentication
VERIFY EKU OK
VERIFY X509NAME OK: <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>ST</span>=/dev/null, <span style=color:#40ffff>L</span>=/dev/random, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=VPN, <span style=color:#40ffff>CN</span>=vpn.dornea.nu
VERIFY OK: <span style=color:#40ffff>depth</span>=0, <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>ST</span>=/dev/null, <span style=color:#40ffff>L</span>=/dev/random, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=VPN, <span style=color:#40ffff>CN</span>=vpn.dornea.nu
Data Channel Encrypt: Cipher <span style=color:#ed9d13>&#39;AES-256-CBC&#39;</span> initialized with <span style=color:#3677a9>256</span> bit key
Data Channel Encrypt: Using <span style=color:#3677a9>512</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA512&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
Data Channel Decrypt: Cipher <span style=color:#ed9d13>&#39;AES-256-CBC&#39;</span> initialized with <span style=color:#3677a9>256</span> bit key
Data Channel Decrypt: Using <span style=color:#3677a9>512</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA512&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
Control Channel: TLSv1.2, cipher TLSv1/SSLv3 DHE-RSA-AES256-SHA256, <span style=color:#3677a9>4096</span> bit RSA
[vpn.dornea.nu] Peer Connection Initiated with [AF_INET]&lt;vpn-server&gt;:80
SENT CONTROL [vpn.dornea.nu]: <span style=color:#ed9d13>&#39;PUSH_REQUEST&#39;</span> (<span style=color:#40ffff>status</span>=1)
PUSH: Received control message: <span style=color:#ed9d13>&#39;PUSH_REPLY,route 192.168.178.0 255.255.255.0,redirect-gateway def1,dhcp-option DNS 208.67.222.222,dhcp-option DNS 8.8.8.8,route 10.66.0.1,topology net30,ping 10,ping-restart 120,ifconfig 10.66.0.6 10.66.0.5&#39;</span>
OPTIONS IMPORT: timers and/or timeouts modified
OPTIONS IMPORT: --ifconfig/up options modified
OPTIONS IMPORT: route options modified
OPTIONS IMPORT: --ip-win32 and/or --dhcp-option options modified
ROUTE_GATEWAY 192.168.178.1/255.255.255.0 <span style=color:#40ffff>IFACE</span>=wlan0 <span style=color:#40ffff>HWADDR</span>=3c:77:e6:18:f9:65
TUN/TAP device tun0 opened
TUN/TAP TX queue length <span style=color:#24909d>set</span> to <span style=color:#3677a9>100</span>
do_ifconfig, tt-&gt;ipv6=0, tt-&gt;did_ifconfig_ipv6_setup=<span style=color:#3677a9>0</span>
/usr/bin/ip link <span style=color:#24909d>set</span> dev tun0 up mtu <span style=color:#3677a9>1500</span>
/usr/bin/ip addr add dev tun0 <span style=color:#24909d>local</span> 10.66.0.6 peer 10.66.0.5
/etc/openvpn/update-resolv-conf tun0 <span style=color:#3677a9>1500</span> <span style=color:#3677a9>1602</span> 10.66.0.6 10.66.0.5 init
2.222

/usr/bin/ip route add &lt;vpn-server&gt;/32 via 192.168.178.1
/usr/bin/ip route add 0.0.0.0/1 via 10.66.0.5
/usr/bin/ip route add 128.0.0.0/1 via 10.66.0.5
/usr/bin/ip route add 192.168.178.0/24 via 10.66.0.5
/usr/bin/ip route add 10.66.0.1/32 via 10.66.0.5
Initialization Sequence Completed
</code></pre></div><p>Looks good. What about the <strong>server</strong>?</p><ul><li>Server logs</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>TLS: Initial packet from [AF_INET]10.0.1.1:59824, <span style=color:#40ffff>sid</span>=230b4633 1fb1bfae
VERIFY OK: <span style=color:#40ffff>depth</span>=2, <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=dornea.nu Root CA, <span style=color:#40ffff>CN</span>=dornea.nu Root CA
VERIFY OK: <span style=color:#40ffff>depth</span>=1, <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=dornea.nu Root CA, <span style=color:#40ffff>CN</span>=vpn.dornea.nu CA
VERIFY OK: <span style=color:#40ffff>depth</span>=0, <span style=color:#40ffff>C</span>=NU, <span style=color:#40ffff>ST</span>=/dev/null, <span style=color:#40ffff>L</span>=/dev/random, <span style=color:#40ffff>O</span>=dornea.nu, <span style=color:#40ffff>OU</span>=vpn.dornea.nu, <span style=color:#40ffff>CN</span>=Victor Dorneanu
Data Channel Encrypt: Cipher <span style=color:#ed9d13>&#39;AES-256-CFB&#39;</span> initialized with <span style=color:#3677a9>256</span> bit key
Data Channel Encrypt: Using <span style=color:#3677a9>160</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA1&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
Data Channel Decrypt: Cipher <span style=color:#ed9d13>&#39;AES-256-CFB&#39;</span> initialized with <span style=color:#3677a9>256</span> bit key
Data Channel Decrypt: Using <span style=color:#3677a9>160</span> bit message <span style=color:#24909d>hash</span> <span style=color:#ed9d13>&#39;SHA1&#39;</span> <span style=color:#6ab825;font-weight:700>for</span> HMAC authentication
Control Channel: TLSv1.2, cipher TLSv1/SSLv3 DHE-RSA-AES256-GCM-SHA384, <span style=color:#3677a9>4096</span> bit RSA
[Victor Dorneanu] Peer Connection Initiated with [AF_INET]10.0.1.1:59824
Victor Dorneanu/10.0.1.1:59824 MULTI_sva: pool returned <span style=color:#40ffff>IPv4</span>=10.66.0.6, <span style=color:#40ffff>IPv6</span>=(Not enabled)
Victor Dorneanu/10.0.1.1:59824 MULTI: Learn: 10.66.0.6 -&gt; Victor Dorneanu/10.0.1.1:59824
Victor Dorneanu/10.0.1.1:59824 MULTI: primary virtual IP <span style=color:#6ab825;font-weight:700>for</span> Victor Dorneanu/10.0.1.1:59824: 10.66.0.6
Victor Dorneanu/10.0.1.1:59824 PUSH: Received control message: <span style=color:#ed9d13>&#39;PUSH_REQUEST&#39;</span>
Victor Dorneanu/10.0.1.1:59824 send_push_reply(): <span style=color:#40ffff>safe_cap</span>=<span style=color:#3677a9>940</span>
Victor Dorneanu/10.0.1.1:59824 SENT CONTROL [Victor Dorneanu]: <span style=color:#ed9d13>&#39;PUSH_REPLY,route 10.66.0.1,topology net30,ping 10,ping-restart 120,ifconfig 10.66.0.6 10.66.0.5&#39;</span> (<span style=color:#40ffff>status</span>=1)
</code></pre></div><p>Perfect!</p><ul><li>Port scanning</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>$ sudo nmap -sU 192.168.178.163 -p <span style=color:#3677a9>443</span> 

Starting Nmap 6.47 ( http://nmap.org ) at 2015-11-11 20:24 CET
Nmap scan report <span style=color:#6ab825;font-weight:700>for</span> debian.local (192.168.178.163)
Host is up (0.00048s latency).
PORT    STATE  SERVICE
443/tcp closed https
MAC Address: 52:54:00:E5:01:E4 (QEMU Virtual NIC)

Nmap <span style=color:#6ab825;font-weight:700>done</span>: <span style=color:#3677a9>1</span> IP address (<span style=color:#3677a9>1</span> host up) scanned in 0.14 seconds

</code></pre></div><p>So <code>tls-auth</code> seems to work.</p><h1 id=routing>Routing</h1><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>%%nwdiag
<span style=color:#999;font-style:italic># &lt;!-- collapse=True --&gt;↔</span>

    client              [shape = <span style=color:#ed9d13>&#34;cisco.pc&#34;</span>];
    internet            [shape = <span style=color:#ed9d13>&#34;cloud&#34;</span>];
    
    client -- internet;
    internet -- gw;
    gw [label = <span style=color:#ed9d13>&#34;Server&#34;</span>];
    <span style=color:#999;font-style:italic>#internet -- gw1;</span>
    <span style=color:#999;font-style:italic>#internet -- gw;</span>
        
    network vpn-net {
        address = <span style=color:#ed9d13>&#34;10.66.0.0/24&#34;</span>
        gw        [address = <span style=color:#ed9d13>&#34;.1&#34;</span>, shape = cisco.vpn_gateway];
        <span style=color:#999;font-style:italic>#victor    [address = &#34;.4&#34;, shape = cisco.pc];</span>
        
    }
    network home-net {
        address = <span style=color:#ed9d13>&#34;192.168.178.0/24&#34;</span>
        
        gw        [address = <span style=color:#ed9d13>&#34;.2&#34;</span>];
        <span style=color:#999;font-style:italic>#router    [address = &#34;.1&#34;, label = &#34;R&#34;, class = obj_router];</span>
        raspberry [address = <span style=color:#ed9d13>&#34;.24&#34;</span>, label = <span style=color:#ed9d13>&#34;Laptop&#34;</span>, <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>= </span><span style=color:#447fcf;text-decoration:underline>obj_workstation</span>];
        storage   [address = <span style=color:#ed9d13>&#34;.25&#34;</span>, label = <span style=color:#ed9d13>&#34;Storage&#34;</span>, <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>= </span><span style=color:#447fcf;text-decoration:underline>obj_storage</span>];    
        
    }
}
</code></pre></div><p><img src=output_7_0.png alt=png></p><p>We have a typical <strong>road-warrior</strong> use case where a single client connects to a remote subnet using a VPN. Afer sucessfully establishing the VPN connection the client will be part of the <code>vpn-net</code> subnet:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>%%nwdiag
<span style=color:#999;font-style:italic># &lt;!-- collapse=True --&gt;</span>
 nwdiag {
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_old</span>       [color = lighgray,style = dotted];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_new</span>       [color = lightblue,style = dotted];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_null</span>      [style = dotted,stacked];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_router</span>    [shape = cisco.router];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_l2sw</span>      [shape = cisco.layer_2_remote_switch];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_fw</span>        [shape = cisco.firewall];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_wlan</span>      [shape = cisco.wireless_router];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_pc</span>        [shape = cisco.pc];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_mobile</span>    [shape = cisco.pda];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_workstation</span> [shape = cisco.workstation];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_storage</span>   [shape = cisco.storage_server];
    <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>obj_web</span>       [shape = cisco.web_cluster];

    client              [shape = <span style=color:#ed9d13>&#34;cisco.pc&#34;</span>];
    <span style=color:#999;font-style:italic>#internet            [shape = &#34;cloud&#34;];</span>
    
    <span style=color:#999;font-style:italic>#internet -- gw;</span>
    gw [label = <span style=color:#ed9d13>&#34;Server&#34;</span>];
    <span style=color:#999;font-style:italic>#internet -- gw1;</span>
    <span style=color:#999;font-style:italic>#internet -- gw;</span>
        
    network vpn-net {
        address = <span style=color:#ed9d13>&#34;10.66.0.0/24&#34;</span>
        gw        [address = <span style=color:#ed9d13>&#34;.1&#34;</span>, shape = cisco.vpn_gateway];
        client    [address = <span style=color:#ed9d13>&#34;.4&#34;</span>, shape = cisco.pc];
        
    }
    network home-net {
        address = <span style=color:#ed9d13>&#34;192.168.178.0/24&#34;</span>
        
        gw        [address = <span style=color:#ed9d13>&#34;.2&#34;</span>];
        <span style=color:#999;font-style:italic>#router    [address = &#34;.1&#34;, label = &#34;R&#34;, class = obj_router];</span>
        raspberry [address = <span style=color:#ed9d13>&#34;.24&#34;</span>, label = <span style=color:#ed9d13>&#34;Laptop&#34;</span>, <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>= </span><span style=color:#447fcf;text-decoration:underline>obj_workstation</span>];
        storage   [address = <span style=color:#ed9d13>&#34;.25&#34;</span>, label = <span style=color:#ed9d13>&#34;Storage&#34;</span>, <span style=color:#6ab825;font-weight:700>class</span> <span style=color:#a61717;background-color:#e3d2d2>= </span><span style=color:#447fcf;text-decoration:underline>obj_storage</span>];    
        
    }
}
</code></pre></div><p><img src=output_9_0.png alt=png></p><p>Having advertised the network address of <code>home-net</code> the client should be able to access <code>Laptop</code> (192.168.178.24) or <code>Storage</code> (192.168.178.25). Also keep in mind that the client will be able to access the whole <code>192.168.178.0/24</code> range. You may want to add client-specific <strong>access policies</strong>.</p><h2 id=nating-client-traffic-to-the-internet>NATing client traffic to the Internet</h2><p>By passing client&rsquo;s traffic through the OpenVPN server you&rsquo;ll need to implement <strong>NAT</strong>ing in order to let your clients access the Internet or other subnets.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>root@debian:/# iptables -t nat -A POSTROUTING -s 10.66.0.0/24 -o eth0 -j MASQUERADE
</code></pre></div><h1 id=client-based-attack-vectors>Client based attack vectors</h1><p>Regardless the countermeasures taken to secure the server, as a client you want your VPN connection to be safe and secure. In a hostile environment like a coffee shop or on any security conferences you want to keep your data safe from any curios eyes. Using a VPN no one could have a look at at the data inside the &ldquo;stream&rdquo; but there are some problems you should be aware of.</p><p>An attacker could bring down your VPN connection by spoofing the server and sending you TCP packets with a RST flag inside it. As a consequence this might destroy the virtual interface which in turn will remove all routing rules previously added by the OpenVPN client regarding that specific interface. Afterwards you will be using your physical interface without any further protection. And the worst thing about it: <strong>You won&rsquo;t even notice it!</strong></p><p>As found on <a href=https://www.inputoutput.io/hardening-your-vpn-setup-with-iptables/>inputoutput.io</a> and <a href=https://www.agwa.name/blog/post/hardening_openvpn_for_def_con>agwa.name</a> there are several methods how to increase client security either by using firewall rules or routing tables. I&rsquo;ll have a look at both.</p><h2 id=dns>DNS</h2><p>Even though your VPN provider will &ldquo;push&rdquo; to the clients a trust DNS server, the DHCP server might override this information causing the client to use an untrusted DNS server. In that case the retrieval of DNS information over DHCP should be avoided. Hard-coding an IP address of a trusted DNS server like <code>8.8.8.8</code> is recommended.</p><p>The client will get the DNS information from the server, however the <code>/etc/resolv.conf</code> has to be adapted as well. I&rsquo;ve found some <a href=https://github.com/masterkorp/openvpn-update-resolv-conf>hook script</a> which will modify your <code>resolv.conf</code> with the information from the server. On Arch Linux there is an <a href=https://aur.archlinux.org/packages/openvpn-update-resolv-conf/>AUR package</a> as well. After installing the hook script, also change the <strong>client</strong> config file to make this work:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>script-security <span style=color:#3677a9>2</span>
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf
</code></pre></div><p>After connecting to the server, you should see sth like this:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>...
Mon Nov <span style=color:#3677a9>16</span> 14:05:45 <span style=color:#3677a9>2015</span> /etc/openvpn/update-resolv-conf tun0 <span style=color:#3677a9>1500</span> <span style=color:#3677a9>1570</span> 10.66.0.6 10.66.0.5 init
push <span style=color:#ed9d13>&#34;dhcp-option DNS 208.67.222.222&#34;</span>
push <span style=color:#ed9d13>&#34;dhcp-option DNS 8.8.8.8&#34;</span>
...
</code></pre></div><p><strong>[Update 2015-11-24]</strong>: The <code>update-resolv-conf</code> is now called from <a href=https://gist.github.com/dorneanu/9303dca4a81898b74fa6#file-init-sh>another script</a> (see below). The config file should now look like this:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Run scripts after tunnel is up or down</span>
up <span style=color:#ed9d13>&#34;./init.sh -u&#34;</span>
down <span style=color:#ed9d13>&#34;./init.sh -d&#34;</span>
</code></pre></div><h2 id=denial-of-service>Denial of Service</h2><p>In the case of our VPN connection DoS attacks would bring down the TCP stream which in turn will cause the virtual interface go down and finally also removing all routing information. In the worst case the client won&rsquo;t have any protection at all (otherwise provided by the VPN tunnel). But first let&rsquo;s have a look at what happens when a client connects to the VPN server:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>1) Fri Nov <span style=color:#3677a9>13</span> 13:17:13 <span style=color:#3677a9>2015</span> /usr/bin/ip link <span style=color:#24909d>set</span> dev tun0 up mtu <span style=color:#3677a9>1500</span>
2) Fri Nov <span style=color:#3677a9>13</span> 13:17:13 <span style=color:#3677a9>2015</span> /usr/bin/ip addr add dev tun0 <span style=color:#24909d>local</span> 10.66.0.6 peer 10.66.0.5
3) Fri Nov <span style=color:#3677a9>13</span> 13:17:13 <span style=color:#3677a9>2015</span> /usr/bin/ip route add xx.xx.xx.xx/32 via 192.168.66.1
4) Fri Nov <span style=color:#3677a9>13</span> 13:17:13 <span style=color:#3677a9>2015</span> /usr/bin/ip route add 0.0.0.0/1 via 10.66.0.5
5) Fri Nov <span style=color:#3677a9>13</span> 13:17:13 <span style=color:#3677a9>2015</span> /usr/bin/ip route add 128.0.0.0/1 via 10.66.0.5
6) Fri Nov <span style=color:#3677a9>13</span> 13:17:13 <span style=color:#3677a9>2015</span> /usr/bin/ip route add 192.168.178.0/24 via 10.66.0.5
7) Fri Nov <span style=color:#3677a9>13</span> 13:17:13 <span style=color:#3677a9>2015</span> /usr/bin/ip route add 10.66.0.1/32 via 10.66.0.5
</code></pre></div><p>Obviously the VPN client did following steps:</p><ol><li>Set the MTU for the virtual device (tun0)</li><li>Set the virtual client (<code>10.66.0.6</code>) and the server endpoints (<code>10.66.0.5</code>)</li><li>Add a static routing rule for the VPN server over 192.168.66.1. Prevents the encrypted VPN traffic from being sent via the VPN itself.</li><li><code>0.0.0.0/1</code> and <code>128.0.0.0/1</code> cover the entire IPv4 IP address pool. This will basically route all traffic to the Internet through <code>10.66.0.5</code> (tun0)</li><li>The <code>home-net</code> subnet (<code>192.168.178.0/24</code>) should also be routable over tun0</li><li>Route for the server IP address in the <code>vpn-net</code> subnet</li></ol><p>Now if a DHCP server pushes a subnet mask for a bigger subnet then this will mask/override the masks from the VPN server. So in some cases the routing information from the DHCP server will be more specific than the OpenVPN routes. For example</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>/usr/bin/ip route add 8.8.8.0/16 via 192.168.66.2
</code></pre></div><p>will be more specific than:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>/usr/bin/ip route add 128.0.0.0/1 via 10.66.0.5
/usr/bin/ip route add 192.168.178.0/24 via 10.66.0.5
</code></pre></div><p>I&rsquo;ve found some ways how to prevent this kind of attacks. On a Linux based system one could use <strong>different routing tables</strong> or harden <strong>firewall rules</strong> to restrict connection outside the VPN tunnel.</p><h3 id=use-of-different-routing-tables>Use of different routing tables</h3><p>So the main idea described by <a href=https://www.agwa.name/blog/post/hardening_openvpn_for_def_con>Andrew</a> was to use multiple routing tables (I didn&rsquo;t even know one could do that) by putting the OpenVPN routes into a dedicated routing table. So basically we&rsquo;ll add routing information that say:</p><ol><li>If a packet is destinated to the OpenVPN server, use the <strong>main</strong> table</li><li>All other packets should use the <strong>OpenVPN</strong> table</li></ol><p>This way you&rsquo;ll keep your OpenVPN routes safe from the DHCP ones. Using <code>/usr/bin/ip</code> we will add some rules in the routing policy database and do what is called <strong>policy routing</strong>. The rules are being stored in a <strong>RPDB</strong> (routing policy database). The RPDB controls in which order the kernel search through the routing tables.</p><p>According to the man page (<code>ip-rule(8)</code>):</p><blockquote><p>Each policy routing rule consists of a selector and an action predicate. The RPDB is scanned in order of
decreasing priority. The selector of each rule is applied to {source address, destination address, incoming
interface, tos, fwmark} and, if the selector matches the packet, the action is performed. The action predi‐
cate may return with success. In this case, it will either give a route or failure indication and the RPDB
lookup is terminated. Otherwise, the RPDB program continues with the next rule.</p></blockquote><p>Also have a look at <a href=http://linux-ip.net/html/routing-rpdb.html>http://linux-ip.net/html/routing-rpdb.html</a> for some useful examples.</p><h3 id=add-rules-to-the-rpdb>Add rules to the RPDB</h3><p>At startup time the kernel configures the default RPDB consisting of three rules (from the man page):</p><ol><li>Priority: 0, Selector: match anything, Action: lookup routing table <strong>local</strong> (ID 255). The local table is a special routing table containing high priority control routes for local and broadcast addresses. Rule 0 is special. It cannot be deleted or overridden.</li><li>Priority: 32766, Selector: match anything, Action: lookup routing table <strong>main</strong> (ID 254). The main table is the normal routing table containing all non-policy routes. This rule may be deleted and/or overridden with other ones by the administrator.</li><li>Priority: 32767, Selector: match anything, Action: lookup routing table <strong>default</strong> (ID 253). The default table is empty. It is reserved for some post-processing if no previous default rules selected the packet. This rule may also be deleted.</li></ol><p>Let&rsquo;s have a look at the configuration:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>/usr/bin/ip rule add to &lt;openvpn-server&gt; table main pref <span style=color:#3677a9>1000</span>    (1)
/usr/bin/ip rule add to &lt;openvpn-server&gt; unreachable pref <span style=color:#3677a9>1001</span>   (2)
/usr/bin/ip rule add table <span style=color:#3677a9>94</span> pref <span style=color:#3677a9>1002</span>                          (3)
/usr/bin/ip rule add unreachable pref <span style=color:#3677a9>1003</span>                       (4)
</code></pre></div><p>By using <strong>preferences</strong> numbers we can ensure that the rules are prioritized correctly. Now some explanations</p><ol><li>The first 2 rules [(1) and (2)] apply to packets whose destination is the IP address of the OpenVPN server.</li><li>The 2nd rule prevents VPN server packets being routed through the VPN tunnel itself (in the case the <strong>main</strong> routing table is empty)</li><li>The 3rd command defines a new routing table (whose id is <strong>94</strong>)</li><li>The last rules prevents packets from using the <strong>main</strong> table in case the OpenVPN table (id = 94) is empty.</li></ol><p>Let&rsquo;s have a look at the <strong>IP rule policy</strong> after the rules have been added:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#ed9d13>\\</span>( ip rule
0:	from all lookup <span style=color:#24909d>local</span> 
1000:	from all to &lt;server IP addr&gt; lookup main 
1001:	from all to &lt;server IP addr&gt; unreachable
1002:	from all lookup <span style=color:#3677a9>94</span> 
1003:	from all unreachable
32766:	from all lookup main 
32767:	from all lookup default 
</code></pre></div><p>In order of priority the rules say:</p><ol><li>All traffic destinated to the should lookup for routing information in table <strong>main</strong></li><li>All other traffic should lookup for routing information in table <strong>94</strong>.</li></ol><p>So let&rsquo;s try that out! Here are routes for table <strong>main</strong>:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#ed9d13>\\</span>) ip route show
default via 192.168.66.1 dev wlan0  proto static  metric <span style=color:#3677a9>600</span> 
192.168.66.0/24 dev wlan0  proto kernel  scope link  src 192.168.66.61  metric <span style=color:#3677a9>600</span> 
</code></pre></div><p>Although there is a default route in the main table, packets shouldn&rsquo;t be able to be sent because we have not defined yet any routes for table <strong>94</strong>:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#ed9d13>\\</span>( ping h.de
connect: Network is unreachable
</code></pre></div><p>After removing the IP rules:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>/usr/bin/ip rule del to &lt;openvpn-server&gt;table main pref <span style=color:#3677a9>1000</span>
/usr/bin/ip rule del to &lt;openvpn-server&gt; unreachable pref <span style=color:#3677a9>1001</span>
/usr/bin/ip rule del table <span style=color:#3677a9>94</span> pref <span style=color:#3677a9>1002</span>
/usr/bin/ip rule del unreachable pref <span style=color:#3677a9>1003</span>
</code></pre></div><p>&mldr; everything is back to normal:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#ed9d13>\\</span>) ping h.de -c <span style=color:#3677a9>3</span>
PING h.de (212.34.167.36) 56(84) bytes of data.
<span style=color:#3677a9>64</span> bytes from plesk3.odn.de (212.34.167.36): <span style=color:#40ffff>icmp_seq</span>=<span style=color:#3677a9>1</span> <span style=color:#40ffff>ttl</span>=<span style=color:#3677a9>53</span> <span style=color:#40ffff>time</span>=27.8 ms
<span style=color:#3677a9>64</span> bytes from plesk3.odn.de (212.34.167.36): <span style=color:#40ffff>icmp_seq</span>=<span style=color:#3677a9>2</span> <span style=color:#40ffff>ttl</span>=<span style=color:#3677a9>53</span> <span style=color:#40ffff>time</span>=32.1 ms
<span style=color:#3677a9>64</span> bytes from plesk3.odn.de (212.34.167.36): <span style=color:#40ffff>icmp_seq</span>=<span style=color:#3677a9>3</span> <span style=color:#40ffff>ttl</span>=<span style=color:#3677a9>53</span> <span style=color:#40ffff>time</span>=30.4 ms

--- h.de ping statistics ---
<span style=color:#3677a9>3</span> packets transmitted, <span style=color:#3677a9>3</span> received, 0% packet loss, <span style=color:#24909d>time</span> 2002ms
rtt min/avg/max/mdev = 27.817/30.167/32.187/1.804 ms
</code></pre></div><h3 id=adding-routes-to-the-openvpn-table>Adding routes to the OpenVPN table</h3><p>In the next steps OpenVPN should add its routing information to the previously created routing table and <strong>not</strong> the <strong>main</strong> one.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>/sbin/ip route add 0.0.0.0/0.0.0.0 table <span style=color:#3677a9>94</span> dev tun0 via 10.66.0.5
/sbin/ip route add 10.66.0.1/255.255.255.255 table <span style=color:#3677a9>94</span> dev tun0 via 10.66.0.5
</code></pre></div><p>Now you review the routing information in table <strong>94</strong>:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#ed9d13>\\</span>( ip route show table <span style=color:#3677a9>94</span>  
default via 10.66.0.5 dev tun0 
10.66.0.1 via 10.66.0.5 dev tun0 
10.66.0.5 dev tun0  proto kernel  scope link  src 10.66.0.6 
</code></pre></div><p><a href=https://www.agwa.name/blog/post/hardening_openvpn_for_def_con>Andrew</a> wrote some hook script you can <a href=https://www.agwa.name/blog/post/hardening_openvpn_for_def_con/media/route>download here</a>. Save this to you machine and make it executable:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># wget https://www.agwa.name/blog/post/hardening\_openvpn\_for\_def\_con/media/route</span>
<span style=color:#999;font-style:italic># cp route /usr/local/bin/route</span>
<span style=color:#999;font-style:italic># chmod a+x /usr/local/bin/route</span>
</code></pre></div><p>Now the <strong>client</strong> config file has to be modified:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>setenv OPENVPN<span style=color:#ed9d13>\_</span>ROUTE<span style=color:#ed9d13>\_</span>TABLE <span style=color:#3677a9>94</span>
route-noexec
route-up /usr/local/bin/route
route 0.0.0.0 0.0.0.0
</code></pre></div><p>The <strong>server</strong> config has to be modified as well by removing the <strong>remote-gateway</strong> option:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># push &#34;redirect-gateway def1&#34;</span>
</code></pre></div><h3 id=conclusion>Conclusion</h3><p>This solution seems to be very clever, however I&rsquo;ve had <strong>performance</strong> issues and also multiple <strong>routing</strong> problems. Perhaps will somebody see and comment what I&rsquo;m doing wrong.</p><h2 id=use-of-firewall-rules>Use of firewall rules</h2><h3 id=uncomplicated-firewall-ufw>Uncomplicated Firewall (ufw)</h3><p>I&rsquo;ll be using <a href=https://launchpad.net/ufw>ufw</a> for setting up my firewall. First add these lines to <code>/etc/ufw/before.rules</code> before the &ldquo;filer* line:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># NAT (Network Address Translation) table rules</span>
*nat
:POSTROUTING ACCEPT [0:0]

<span style=color:#999;font-style:italic># Allow traffic from clients to enp1s0</span>
-A POSTROUTING -s 10.66.0.0/24 -o wlan0 -j MASQUERADE

<span style=color:#999;font-style:italic># Don&#39;t delete these required lines, otherwise there will be errors</span>
*filter
...
</code></pre></div><p>Now enable the firewall:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># ufw enable</span>
Firewall is active and enabled on system startup
<span style=color:#999;font-style:italic># ufw status</span>
Status: active
</code></pre></div><p>&mldr; add some <strong>ufw</strong> rules:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#40ffff>SERVER</span>=<span style=color:#ed9d13>`</span>host &lt;vpn-server&gt; | awk <span style=color:#ed9d13>&#39;{ print \\)4; }&#39;</span><span style=color:#ed9d13>`</span>

<span style=color:#999;font-style:italic># Default policies</span>
ufw default deny incoming
ufw default deny outgoing

<span style=color:#999;font-style:italic># OpenVPN interface (adjust interface accordingly to your configuration)</span>
ufw allow in on tun0
ufw allow out on tun0

<span style=color:#999;font-style:italic># Deny any TCP/UDP connections on wlan0</span>
ufw deny out on wlan0
ufw deny in on wlan0

<span style=color:#999;font-style:italic># Allow local LAN on wlan0 (adjust ip accordingly to your configuration)</span>
ufw allow in on wlan0 from 192.168.0.0/16
ufw allow out on wlan0 to 192.168.0.0/16

<span style=color:#999;font-style:italic># Over wlan0 allow only traffic to VPN server (:80/udp)</span>
ufw allow in on wlan0 from <span style=color:#ed9d13>\\</span>(SERVER port <span style=color:#3677a9>80</span> proto udp
ufw allow out on wlan0 from <span style=color:#ed9d13>\\</span>)SERVER port <span style=color:#3677a9>80</span> proto udp

<span style=color:#999;font-style:italic># DNS</span>
ufw allow in from any to any port <span style=color:#3677a9>53</span>
ufw allow out from any to any port <span style=color:#3677a9>53</span>

</code></pre></div><p>Check that:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#ed9d13>\\</span>( ufw status verbose
Status: active

To                         Action      From
--                         ------      ----
Anywhere on tun0           ALLOW       Anywhere
Anywhere on wlan0          DENY        Anywhere
Anywhere on wlan0          ALLOW       192.168.0.0/16
Anywhere on wlan0          ALLOW       &lt;vpn-server&gt; 80/udp
<span style=color:#3677a9>53</span>                         ALLOW       Anywhere

Anywhere                   ALLOW OUT   Anywhere on tun0
Anywhere                   DENY OUT    Anywhere on wlan0
192.168.0.0/16             ALLOW OUT   Anywhere on wlan0
Anywhere                   ALLOW OUT   &lt;vpn-server&gt; 80/udp on wlan0
<span style=color:#3677a9>53</span>                         ALLOW OUT   Anywhere
</code></pre></div><p><strong>[Update 2014-11-24]</strong>: The <a href=https://gist.github.com/dorneanu/9303dca4a81898b74fa6#file-init-sh>initialization script</a> called by OpenVPN uses <code>iptables</code>. But feel free to adapt if you want to stick with <code>ufw</code>.</p><h3 id=using-iptables-prefered>Using iptables (prefered)</h3><p><strong>[Update 2015-11-24]</strong>: If you don&rsquo;t want any fancy firewall frameworks, you can of course stick to <code>iptables</code>.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># VPN server address</span>
VPN<span style=color:#ed9d13>\_</span>SERVER=&lt;vpn-server&gt;

<span style=color:#999;font-style:italic># Local LAN subnet</span>
LOCAL<span style=color:#ed9d13>\_</span>LAN=192.168.0.0/16

<span style=color:#999;font-style:italic># Interface where your local LAN is accessibble</span>
GW<span style=color:#ed9d13>\_</span>INT=wlan0

<span style=color:#999;font-style:italic># The VPN virtual interface</span>
VPN<span style=color:#ed9d13>\_</span>INT=tun0

<span style=color:#999;font-style:italic># Do NATing from VPN interface to gateway interface</span>
iptables -t nat -P POSTROUTING ACCEPT
iptables -t nat -A POSTROUTING -s <span style=color:#ed9d13>\\</span>)VPN_LAN -o <span style=color:#ed9d13>\\</span>(GW<span style=color:#ed9d13>\_</span>INT -j MASQUERADE

<span style=color:#999;font-style:italic># Allow all traffic on VPN interface</span>
iptables -A OUTPUT -o <span style=color:#ed9d13>\\</span>)VPN_INT -j ACCEPT
iptables -A INPUT  -i <span style=color:#ed9d13>\\</span>(VPN<span style=color:#ed9d13>\_</span>INT -j ACCEPT

<span style=color:#999;font-style:italic># Allow traffic to/from VPN server</span>
iptables -A INPUT  -i <span style=color:#ed9d13>\\</span>)GW_INT -s <span style=color:#ed9d13>\\</span>(VPN<span style=color:#ed9d13>\_</span>SERVER -p udp --sport <span style=color:#3677a9>80</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o <span style=color:#ed9d13>\\</span>)GW_INT -d <span style=color:#ed9d13>\\</span>(VPN<span style=color:#ed9d13>\_</span>SERVER -p udp --dport <span style=color:#3677a9>80</span> -m state --state ESTABLISHED -j ACCEPT

<span style=color:#999;font-style:italic># Allow local traffic</span>
iptables -A OUTPUT -o <span style=color:#ed9d13>\\</span>)GW_INT -d <span style=color:#ed9d13>\\</span>(LOCAL<span style=color:#ed9d13>\_</span>LAN -s <span style=color:#ed9d13>\\</span>)LOCAL_LAN -j ACCEPT
iptables -A INPUT  -i <span style=color:#ed9d13>\\</span>(GW<span style=color:#ed9d13>\_</span>INT -s <span style=color:#ed9d13>\\</span>)LOCAL_LAN -d <span style=color:#ed9d13>\\</span>(LOCAL<span style=color:#ed9d13>\_</span>LAN -j ACCEPT

<span style=color:#999;font-style:italic># Define here other exceptions</span>
<span style=color:#999;font-style:italic># ...</span>

<span style=color:#999;font-style:italic># Deny all traffic on gateway interface by default</span>
iptables -A INPUT -i <span style=color:#ed9d13>\\</span>)GW_INT -j DROP
iptables -A OUTPUT -o <span style=color:#ed9d13>\\</span>(GW<span style=color:#ed9d13>\_</span>INT -j DROP

<span style=color:#999;font-style:italic># Block IPv6 traffic</span>
ip6tables -P INPUT DROP
ip6tables -P OUTPUT DROP
ip6tables -P FORWARD DROP
</code></pre></div><p>All these rules are part of <a href=https://gist.github.com/dorneanu/9303dca4a81898b74fa6#file-init-sh>this script</a> which is called by OpenVPN (up/down commands):</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#999;font-style:italic># Run scripts after tunnel is up or down</span>
up <span style=color:#ed9d13>&#34;./init.sh -u&#34;</span>
down <span style=color:#ed9d13>&#34;./init.sh -d&#34;</span>
</code></pre></div><p>Have a look at the <a href=https://gist.github.com/dorneanu/9303dca4a81898b74fa6#file-init-sh>script</a> and add your own actions to be executed when the tunnel is up or down. Also make sure you save the script in the same directory where the configuration files resides.</p><p>That&rsquo;t it! Now you should have no <strong>leaks</strong> if your VPN is down. Let&rsquo;s check that out</p><ul><li>Before establishing the VPN tunnel</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash><span style=color:#ed9d13>\\</span>) ping h.de -c <span style=color:#3677a9>4</span>
PING h.de (212.34.167.36) 56(84) bytes of data.
^C
--- h.de ping statistics ---
<span style=color:#3677a9>0</span> packets transmitted, <span style=color:#3677a9>0</span> received

</code></pre></div><ul><li>After establishing the VPN</li></ul><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.bash data-lang=.bash>$ ping h.de -c <span style=color:#3677a9>4</span>
PING h.de (212.34.167.36) 56(84) bytes of data.
<span style=color:#3677a9>64</span> bytes from plesk3.odn.de (212.34.167.36): <span style=color:#40ffff>icmp_seq</span>=<span style=color:#3677a9>1</span> <span style=color:#40ffff>ttl</span>=<span style=color:#3677a9>50</span> <span style=color:#40ffff>time</span>=<span style=color:#3677a9>122</span> ms
<span style=color:#3677a9>64</span> bytes from plesk3.odn.de (212.34.167.36): <span style=color:#40ffff>icmp_seq</span>=<span style=color:#3677a9>2</span> <span style=color:#40ffff>ttl</span>=<span style=color:#3677a9>50</span> <span style=color:#40ffff>time</span>=83.8 ms
<span style=color:#3677a9>64</span> bytes from plesk3.odn.de (212.34.167.36): <span style=color:#40ffff>icmp_seq</span>=<span style=color:#3677a9>3</span> <span style=color:#40ffff>ttl</span>=<span style=color:#3677a9>50</span> <span style=color:#40ffff>time</span>=82.6 ms
^C
--- h.de ping statistics ---
<span style=color:#3677a9>3</span> packets transmitted, <span style=color:#3677a9>3</span> received, 0% packet loss, <span style=color:#24909d>time</span> 2003ms
</code></pre></div><h1 id=download-configs>Download configs</h1><p>You can download my <strong>server</strong>/<strong>client</strong> configs and the <strong>initialization</strong> script and from following gists:</p><ul><li><a href=https://gist.github.com/dorneanu/9303dca4a81898b74fa6#file-server-conf>server.conf</a></li><li><a href=https://gist.github.com/dorneanu/9303dca4a81898b74fa6#file-client-conf>client.conf</a></li><li><a href=https://gist.github.com/dorneanu/9303dca4a81898b74fa6#file-init-sh>init.sh</a></li></ul><h1 id=todos>ToDos</h1><p>Here are some todos I&rsquo;d like to implement in near future:</p><ul><li>Use of alternative authentication methods</li><li>Configure client-specific rules and access policies</li><li>Add 2FA authentication to OpenVPN</li><li>Have a look at <a href=http://www.shorewall.net/Introduction.html>Shorewall</a></li></ul><h1 id=references>References</h1><p>Some useful references:</p><ul><li><a href=https://www.inputoutput.io/hardening-your-vpn-setup-with-iptables/>Hardening OpenVPN with iptables</a></li><li><a href=https://2kswiki.wordpress.com/2015/06/17/hardened-openvpn-on-centos-7/>Hardened OpenVPN on CentOS 7</a></li><li><a href=https://oli.new-lan.de/2015/02/openvpn-crypto-tuning-tls-auth-tls-cipher-tls-version-min-dh-verify-x509-name-cipher-auth-remote-cert-tls/>OpenVPN Crypto-Tuning: tls-auth, tls-cipher, tls-version-min, dh, verify-x509-name, cipher, auth, remote-cert-tls</a></li><li><a href=wiki.archlinux.org/index.php/OpenVPN>Arch Linux OpenVPN</a></li><li><a href=http://www.dd-wrt.com/wiki/index.php/Policy_Based_Routing>Policy Based Routing</a></li><li><a href=https://www.agwa.name/blog/post/hardening_openvpn_for_def_con>Hardening OpenVPN for DefCon</a></li></ul></div></main><div class="tl fixed list-pages lh-copy" id=contents-list></div><div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l"><a id=scroll-to-top class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick=topFunction() style="color:#fff;visibility:hidden;display:none;transition:opacity .5s,visibility .5s" title="back to top">back to top</a><br><p class="mb0 mt2"><a href=http://blog.dornea.nu/2015/11/06/advanced-inter-vlan-switching-using-cisco/>prev post</a>
<a href=http://blog.dornea.nu/2016/01/15/howto-put-nginx-and-php-to-jail-in-debian-8/>next post</a></p></div><footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l"><hr class="dn db-l ml0-l gray w3"><br>Powered by <a href=https://gohugo.io/ target=_blank class="link gray dim">Hugo</a>, based on the <a href=https://github.com/lingxz/er target=_blank class="link gray dim">Er</a> theme.<br></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css><style>.is-active-link::before{background-color:var(--secondary-color)}</style><script type=text/javascript>var prevScrollpos=window.pageYOffset;window.onscroll=function(){var currentScrollPos=window.pageYOffset;if(document.getElementById("tag-cloud")!==null){if(prevScrollpos>currentScrollPos){document.getElementById("tag-cloud").style.visibility="visible";document.getElementById("tag-cloud").style.opacity="1";}else{document.getElementById("tag-cloud").style.visibility="hidden";document.getElementById("tag-cloud").style.opacity="0";}}
if(document.body.scrollTop>1000||document.documentElement.scrollTop>1000){document.getElementById("scroll-to-top").style.display="inline";document.getElementById("scroll-to-top").style.visibility="visible";document.getElementById("scroll-to-top").style.opacity="1";}else{document.getElementById("scroll-to-top").style.visibility="hidden";document.getElementById("scroll-to-top").style.opacity="0";}
prevScrollpos=currentScrollPos;}
function topFunction(){document.body.scrollTop=0;document.documentElement.scrollTop=0;}
if(document.getElementById("contents-list")!==null&&document.getElementsByClassName("post-content").length!==0){tocbot.init({tocSelector:'#contents-list',contentSelector:'.post-content',headingSelector:'h1, h2, h3',});}</script></body></html>