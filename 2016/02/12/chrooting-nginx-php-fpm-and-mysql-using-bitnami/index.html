<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <title>Chrooting nginx, php-fpm and mysql using Bitnami  - blog.dornea.nu</title>
  <meta content='Chrooting nginx, php-fpm and mysql using Bitnami  - blog.dornea.nu' property='title' />
  <meta content='Chrooting nginx, php-fpm and mysql using Bitnami  - blog.dornea.nu' property='og:title' />


<meta property="og:description" content="Having talked about hardening your server using chroot in a previous post I&rsquo;ve felt that the whole process was way to complicated. I wanted to have a more generic solution regardless of the operating system (and especially the Linux distro). Besides that I wasn&rsquo;t quite happy changing the systems systemd settings and do several modifications to the already running system. What I wanted to achieve was a closed, portable system of running applications inside a chroot environment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.dornea.nu/2016/02/12/chrooting-nginx-php-fpm-and-mysql-using-bitnami/" />


<meta property="article:published_time" content="2016-02-12T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2016-02-12T00:00:00&#43;00:00"/>








<meta name="generator" content="Hugo 0.75.1" />

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='http://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='http://blog.dornea.nu/css/styles.css' rel="stylesheet">


<link rel="icon" 
 
  href='http://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='http://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />
</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='http://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/' title="Home">Home</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://dornea.nu' title="About">About</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/tags' title="Tags">Tags</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org/bookmarks.html' title="Bookmarks">Bookmarks</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org/bib.html' title="Books">Books</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/notes' title="Notes">Notes</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Chrooting nginx, php-fpm and mysql using Bitnami </div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>12 Feb 2016</time> 
     | 
    
    
    tags: [ <a href='http://blog.dornea.nu/tags/nginx' class="link silver">nginx</a> <a href='http://blog.dornea.nu/tags/php' class="link silver">php</a> <a href='http://blog.dornea.nu/tags/admin' class="link silver">admin</a> <a href='http://blog.dornea.nu/tags/debian' class="link silver">debian</a> <a href='http://blog.dornea.nu/tags/chroot' class="link silver">chroot</a> <a href='http://blog.dornea.nu/tags/security' class="link silver">security</a> <a href='http://blog.dornea.nu/tags/bitnami' class="link silver">bitnami</a>  ]
    
  </p>
  <div class="lh-copy post-content"><p>Having talked about hardening your server using <code>chroot</code> in a <a href="http://blog.dornea.nu/2016/01/15/howto-put-nginx-and-php-to-jail-in-debian-8">previous post</a> I&rsquo;ve felt that the whole process was way to complicated. I wanted to have a more <strong>generic</strong> solution regardless of the operating system (and especially the Linux distro). Besides that I wasn&rsquo;t quite happy changing the systems <code>systemd</code> settings and do several modifications to the already <strong>running</strong> system. What I wanted to achieve was a <strong>closed</strong>, <strong>portable</strong> system of running applications inside a <code>chroot</code> environment.</p>
<p>And then I&rsquo;ve remembered using some <a href="https://bitnami.com">bitnami</a> applications in the past. You can either run them in the <em>cloud</em>, in a <em>virtual machine</em> or install them <strong>locally</strong>. The <em>local</em> installation will install a whole software <a href="https://bitnami.com/stacks">stack</a> inside a directory (<em>closed</em> system). You can then start the whole stack using <em>shell scripts</em>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./ctlscript.sh <span style="color:#24909d">help</span>
usage: ./ctlscript.sh <span style="color:#24909d">help</span>
       ./ctlscript.sh (start|stop|restart|status)
       ./ctlscript.sh (start|stop|restart|status) mysql
       ./ctlscript.sh (start|stop|restart|status) php-fpm
       ./ctlscript.sh (start|stop|restart|status) nginx

<span style="color:#24909d">help</span>       - this screen
start      - start the service(s)
stop       - stop  the service(s)
restart    - restart or start the service(s)
status     - show the status of the service(s)
</code></pre></div><p>The binaries inside the stack are using <strong>libraries</strong> inside the <em>closed</em> system (by changing <code>LD_LIBRARY_PATH</code>). So the Bitnami installation will run out of the stack without interacting with the underlying operating system (read more about the technology <a href="https://bitnami.com/learn_more">here</a>). This is a great advantage since you can simply <strong>copy</strong> the directory, change the <strong>settings</strong> and you&rsquo;ll have another instance running in its own directory (remember the <strong>portable</strong> aspect of my wish list before?)</p>
<p>However the Bitnami stacks won&rsquo;t use <code>chroot</code> by default. This is where I had to commit my own modifications to the local installation. But, one thing after another.</p>
<h2 id="the-nginx-stack">The Nginx stack</h2>
<p>If you&rsquo;re recalling the <a href="http://blog.dornea.nu/2016/01/15/howto-put-nginx-and-php-to-jail-in-debian-8">previous post</a>, my <code>chroot</code> environment consisted of: <code>nginx</code>, <code>php-fpm</code> and <code>mysql</code>. Fortunately Bitnami provides a <a href="https://bitnami.com/stack/nginx">Nginx Stack</a> which is a:</p>
<blockquote>
<p>&ldquo;&hellip; complete,  fully-integrated and ready to run PHP, MySQL and Nginx development environment. In addition, it bundles phpMyAdmin, SQLite, ImageMagick, FastCGI, Memcache, GD, CURL, PEAR, PECL and other components. Also known as LEMP for Linux, WEMP for Windows and MEMP for OS X.&rdquo; (Source: <a href="https://bitnami.com/stack/nginx">https://bitnami.com/stack/nginx</a>)</p>
</blockquote>
<p>So let&rsquo;s give it a try.</p>
<h2 id="installing-bitnami-nginx-stack">Installing Bitnami Nginx stack</h2>
<p>Download the <a href="https://bitnami.com/stack/nginx/installer">installer</a> to your machine and run it:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"># ./bitnami-nginxstack-1.9.10-0-linux-x64-installer.run 
----------------------------------------------------------------------------
Welcome to the Bitnami Nginx Stack Setup Wizard.

----------------------------------------------------------------------------
Select the components you want to install; clear the components you do not want 
to install. Click Next when you are ready to continue.

Varnish [Y/n] :n

PhpMyAdmin : Y (Cannot be edited)

Is the selection above correct? [Y/n]: Y

----------------------------------------------------------------------------
Installation folder

Please, choose a folder to install Bitnami Nginx Stack

Select a folder [/opt/nginxstack-1.9.10-0]: /home/bitnami/nginxstack

----------------------------------------------------------------------------
Create MySQL &#39;root&#39; Account

Bitnami Nginx Stack database root user creation

Password :
Re-enter :
----------------------------------------------------------------------------
MySQL Information

Please enter your MySQL database information:

MySQL Server port [3306]: 3307 

----------------------------------------------------------------------------
Please enter the port that the bundled Nginx Server will listen to by default.

Nginx Port [80]: 8080

----------------------------------------------------------------------------
Setup is now ready to begin installing Bitnami Nginx Stack on your computer.

Do you want to continue? [Y/n]: Y

----------------------------------------------------------------------------
Please wait while Setup installs Bitnami Nginx Stack on your computer.

 Installing
 0% ______________ 50% ______________ 100%
 #########################################

----------------------------------------------------------------------------
Setup has finished installing Bitnami Nginx Stack on your computer.

Launch Bitnami Nginx Stack [Y/n]: n
</code></pre></div><p>A few observations:</p>
<ul>
<li>I&rsquo;ve installed the stack to <code>/home/bitnami/nginxstack</code></li>
<li><code>MySQL</code> will listen on <code>localhost:3307</code></li>
<li><code>nginx</code> will listen on <code>localhost:8080</code></li>
</ul>
<h2 id="setup-chroot-environment">Setup chroot environment</h2>
<p>Now that we have installed the <em>nginx stack</em>, we&rsquo;ll setup a <code>chroot</code> environment and copy the <em>nginx stack directory</em> to it. Supposing that the chroot will be located at <code>/home/bitnami/nginxstack-chroot</code>, inside the chroot we&rsquo;ll have following directory structure:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ tree -L <span style="color:#3677a9">3</span>
.
|-- bin
|-- dev
|   |-- null
|   |-- random
|    -- urandom
|-- etc
|   ...
|-- home
|   -- bitnami
|       -- nginxstack
|-- lib
|   ...
|-- lib64 -&gt; usr/lib
|-- run
|-- tmp
|-- usr
|   ...
|-- var
    ...
</code></pre></div><p>So the nginx stack directory will be available at <code>/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack</code>. This is <strong>very important</strong> and you should take care having the same structure. Let&rsquo;s setup the chroot using following script:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#24909d">export</span> <span style="color:#40ffff">N2CHROOT</span>=/home/bitnami/scripts/n2chroot
<span style="color:#24909d">export</span> <span style="color:#40ffff">JAIL</span>=/home/bitnami/nginxstack-chroot
<span style="color:#24909d">export</span> <span style="color:#40ffff">BITNAMI</span>=/home/bitnami/nginxstack
<span style="color:#24909d">export</span> <span style="color:#40ffff">BITNAMI_INSTALLDIR</span>=<span style="color:#40ffff">$JAIL</span>/<span style="color:#40ffff">$BITNAMI</span>

<span style="color:#6ab825;font-weight:bold">function</span> create_chroot {
    <span style="color:#999;font-style:italic"># Create devices</span>
    mkdir <span style="color:#40ffff">$JAIL</span>/dev
    mknod -m <span style="color:#3677a9">0666</span> <span style="color:#40ffff">$JAIL</span>/dev/null c <span style="color:#3677a9">1</span> <span style="color:#3677a9">3</span>
    mknod -m <span style="color:#3677a9">0666</span> <span style="color:#40ffff">$JAIL</span>/dev/random c <span style="color:#3677a9">1</span> <span style="color:#3677a9">8</span>
    mknod -m <span style="color:#3677a9">0444</span> <span style="color:#40ffff">$JAIL</span>/dev/urandom c <span style="color:#3677a9">1</span> <span style="color:#3677a9">9</span>

    <span style="color:#999;font-style:italic"># Create directories</span>
    mkdir -p <span style="color:#40ffff">$JAIL</span>/{etc,bin,usr,var}
    mkdir -p <span style="color:#40ffff">$JAIL</span>/usr/{lib,sbin,bin}
    mkdir -p <span style="color:#40ffff">$JAIL</span>/{run,tmp}
    mkdir -p <span style="color:#40ffff">$JAIL</span>/var/run
    mkdir -p <span style="color:#40ffff">$JAIL</span>/<span style="color:#40ffff">$BITNAMI</span>/{php,nginx,mysql}
    mkdir -p <span style="color:#40ffff">$JAIL</span>/<span style="color:#40ffff">$BITNAMI</span>/php/lib
    mkdir -p <span style="color:#40ffff">$JAIL</span>/<span style="color:#40ffff">$BITNAMI</span>/nginx/lib
    mkdir -p <span style="color:#40ffff">$JAIL</span>/<span style="color:#40ffff">$BITNAMI</span>/common/lib
    mkdir -p <span style="color:#40ffff">$JAIL</span>/<span style="color:#40ffff">$BITNAMI</span>/mysql/lib
    
    <span style="color:#999;font-style:italic"># Check if 64-bit system</span>
    <span style="color:#6ab825;font-weight:bold">if</span> [ <span style="color:#6ab825;font-weight:bold">$(</span>uname -m<span style="color:#6ab825;font-weight:bold">)</span> = <span style="color:#ed9d13">&#34;x86_64&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
        mkdir -p <span style="color:#40ffff">$JAIL</span>/lib/x86_64-linux-gnu
        <span style="color:#24909d">cd</span> <span style="color:#40ffff">$JAIL</span>; ln -s usr/lib lib64
        <span style="color:#24909d">cd</span> <span style="color:#40ffff">$JAIL</span>/usr; ln -s lib lib64
    <span style="color:#6ab825;font-weight:bold">else</span>
        <span style="color:#24909d">cd</span> <span style="color:#40ffff">$JAIL</span>; ln -s usr/lib lib
    <span style="color:#6ab825;font-weight:bold">fi</span>

    <span style="color:#999;font-style:italic"># Copy important stuff</span>
    cp -rfvL /etc/{services,localtime,nsswitch.conf,nscd.conf,protocols,hosts,ld.so.cache,ld.so.conf,resolv.conf,host.conf} <span style="color:#40ffff">$JAIL</span>/etc

    <span style="color:#999;font-style:italic"># Cp bitnami to the chroot</span>
    <span style="color:#999;font-style:italic"># cp -Rv $BITNAMI $JAIL/home/bitnami/ </span>
}

<span style="color:#6ab825;font-weight:bold">function</span> add_users {
    <span style="color:#999;font-style:italic"># Most instructions from https://wiki.archlinux.org/index.php/nginx#Installation_in_a_chroot</span>
    <span style="color:#999;font-style:italic"># Add users</span>
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;daemon:x:1:1:daemon:/:/bin/false&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/passwd
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;mysql:x:100:101:MySQL Server,,,:/nonexistent:/bin/false&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/passwd
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:x:99:99:nobody:/:/bin/false&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/passwd


    <span style="color:#999;font-style:italic"># Add groups</span>
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;daemon:x:1:&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/group
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;mysql:x:101:&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/group
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:x:99:&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/group

    <span style="color:#999;font-style:italic"># Add shadow</span>
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;daemon:x:14871::::::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/shadow
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;mysql:!:16755:0:99999:7:::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/shadow
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:x:14871::::::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/shadow

    <span style="color:#999;font-style:italic"># Add gshadow</span>
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;daemon:::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/gshadow
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;mysql:!::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/gshadow
    <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/gshadow
}

<span style="color:#6ab825;font-weight:bold">function</span> add_libraries {
    <span style="color:#999;font-style:italic"># Add system stuff</span>
    cp /lib/x86_64-linux-gnu/libnsl* <span style="color:#40ffff">$JAIL</span>/lib/x86_64-linux-gnu/
    cp /lib/x86_64-linux-gnu/libnss* <span style="color:#40ffff">$JAIL</span>/lib/x86_64-linux-gnu/
    
    <span style="color:#999;font-style:italic"># Add nginx stuff</span>
    <span style="color:#999;font-style:italic"># $N2CHROOT $BITNAMI_INSTALLDIR/nginx/sbin/.nginx.bin</span>
    cp /lib/x86_64-linux-gnu/libnsl* <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/common/lib/
    cp /lib/x86_64-linux-gnu/libnss* <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/common/lib/
    cp /lib/x86_64-linux-gnu/libpthread* <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/common/lib/
    cp /lib/x86_64-linux-gnu/libpcre* <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/common/lib/
    cp /lib/x86_64-linux-gnu/libdl* <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/common/lib/
    cp /lib/x86_64-linux-gnu/libgcc* <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/common/lib/
    cp /lib/x86_64-linux-gnu/libresolv* <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/common/lib/

    <span style="color:#999;font-style:italic"># Add php-fpm stuff</span>
    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/php/lib
    ln -s ../../common/lib/libresolv.so.2 

    <span style="color:#999;font-style:italic"># Add mysql stuff</span>
    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/mysql/lib
    ln -s ../../common/lib/libdl.so.2
    ln -s ../../common/lib/libgcc_s.so.1 
    ln -s ../../common/lib/libpthread.so.0 
}

<span style="color:#6ab825;font-weight:bold">function</span> add_binaries {
    <span style="color:#999;font-style:italic"># Add shell</span>
    cp /bin/sh <span style="color:#40ffff">$JAIL</span>/bin/
    <span style="color:#40ffff">$N2CHROOT</span> /bin/sh

    <span style="color:#999;font-style:italic"># Add nohup (mysqld needs it)</span>
    cp /usr/bin/nohup <span style="color:#40ffff">$JAIL</span>/usr/bin
}

<span style="color:#6ab825;font-weight:bold">function</span> fix_permissions {
    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/mysql
    chown -R mysql:mysql .

    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/php
    chown -R daemon:daemon .

    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$BITNAMI_INSTALLDIR</span>/nginx
    chown -R daemon:daemon .
}

<span style="color:#999;font-style:italic"># Run functions</span>
create_chroot
add_users
add_libraries
add_binaries
fix_permissions

</code></pre></div><p>The <code>N2CHROOT</code> script can be found <a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-n2chroot">here</a>. Make sure it&rsquo;s located inside <code>/home/bitnami/scripts</code> and also change the <code>BASE</code> variable inside the script to <code>/home/bitnami/nginxstack-chroot</code>.  Now <a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-nginx-chroot-bitnami">download</a> the script and run it:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#24909d">export</span> <span style="color:#40ffff">JAIL</span>=/home/bitnami/nginxstack-chroot
$ <span style="color:#24909d">cd</span> <span style="color:#40ffff">$JAIL</span>
$ ../scripts/nginx-chroot-bitnami.sh
...
</code></pre></div><p>Now you should have following structure:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ tree -L <span style="color:#3677a9">3</span>
.
|-- bin
|    -- sh
|-- dev
|   |-- null
|   |-- random
|    -- urandom
|-- etc
|   |-- group
|   |-- gshadow
|   |-- host.conf
|   |-- hosts
|   |-- ld.so.cache
|   |-- ld.so.conf
|   |-- localtime
|   |-- nsswitch.conf
|   |-- passwd
|   |-- protocols
|   |-- resolv.conf
|   |-- services
|    -- shadow
|-- home
|    -- bitnami
|        -- nginxstack
|-- lib
|    -- x86_64-linux-gnu
|       |-- libc.so.6
|       |-- libcrypt.so.1
|       |-- libm.so.6
|       |-- libpthread.so.0
|        -- librt.so.1
|-- lib64 -&gt; usr/lib
|-- run
|-- tmp
|-- usr
|   |-- bin
|   |-- lib
|   |   |-- ld-linux-x86-64.so.2
|   |    -- x86_64-linux-gnu
|   |-- lib64 -&gt; lib
|    -- sbin
 -- var
     -- run
</code></pre></div><p>Since all config files created by the bitnami installer point to <code>/home/bitnami/nginxstack</code> I will create a new <strong>link</strong> to point to the right directory inside the <code>chroot</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#24909d">cd</span> /home/bitnami
$ ln -s nginxstack-chroot/home/bitnami/nginxstack nginxstack
</code></pre></div><p><strong>This is very important</strong>, since all daemons (nginx, php-fpm, mysqld) will look at <code>/home/bitnami/nginxstack</code> for their config files etc. before entering the <code>chroot</code>.</p>
<h2 id="patch-scripts">Patch scripts</h2>
<p>Now the <strong>controll scripts</strong> have to be modified to run the binaries in a <code>chroot</code>.</p>
<h3 id="patch-setenvsh">Patch setenv.sh</h3>
<p>At <code>/home/bitnami/nginxstack/scripts/setenv.sh</code> (inside the <code>chroot</code>) there is a script which sets all the environment variables (e.g. <code>LD_LIBRARY_PATH</code>) for the binaries. We&rsquo;ll use this script to set a variable which we&rsquo;ll use a few times in some other scripts. At the beginning of the script set the <code>JAIL</code> variable accordingly:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#cd2828;font-weight:bold">#!/bin/sh
</span><span style="color:#cd2828;font-weight:bold"></span><span style="color:#24909d">export</span> <span style="color:#40ffff">JAIL</span>=/home/bitnami/nginxstack-chroot

[...]
</code></pre></div><h3 id="patch-nginx-control-script">Patch nginx control script</h3>
<p>When calling <code>./ctlscript.sh start nginx</code> the script will then call <code>./nginx/scripts/ctl.sh</code> and finally this will call <code>./nginx/sbin/nginx</code>. The last contains the commands for calling the <code>nginx</code> binary directly. You&rsquo;ll have sth like this:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#cd2828;font-weight:bold">#!/bin/sh
</span><span style="color:#cd2828;font-weight:bold"></span>
. /home/bitnami/nginxstack/scripts/setenv.sh

<span style="color:#24909d">exec</span> /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -p /home/bitnami/nginxstack/nginx/ <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$@</span><span style="color:#ed9d13">&#34;</span>
</code></pre></div><p>Now we want the <code>nginx</code> binary to run inside the <code>chroot</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#cd2828;font-weight:bold">#!/bin/sh
</span><span style="color:#cd2828;font-weight:bold"></span>
. /home/bitnami/nginxstack/scripts/setenv.sh

<span style="color:#24909d">exec</span> /usr/sbin/chroot <span style="color:#40ffff">$JAIL</span> /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -p /home/bitnami/nginxstack/nginx/ <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$@</span><span style="color:#ed9d13">&#34;</span>
</code></pre></div><p>Using almost the same command you can if <code>nginx</code> will run properly:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ /usr/sbin/chroot <span style="color:#40ffff">$JAIL</span> sh -c <span style="color:#ed9d13">&#39;LD_LIBRARY_PATH=&#34;/home/bitnami/nginxstack/sqlite/lib:/home/bitnami/nginxstack/nginx/lib:/home/bitnami/nginxstack/mysql/lib:/home/bitnami/nginxstack/common/lib&#34; /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -t -p /home/bitnami/nginxstack/nginx&#39;</span>
nginx: the configuration file /home/bitnami/nginxstack/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /home/bitnami/nginxstack/nginx/conf/nginx.conf <span style="color:#24909d">test</span> is successful

</code></pre></div><p>I&rsquo;ve set the <code>LD_LIBRARY_PATH</code> manually since not all libs are located at <code>/lib/*</code>.</p>
<h3 id="patch-php-fpm-control-script">Patch php-fpm control script</h3>
<p>Despite some previous approaches this turned out to be a very simple step. All you&rsquo;ll have to do is to add following lines to your <code>php-fpm.conf</code> insde <code>/home/bitnami/nginxstack/php/etc/php-fpm.conf</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#40ffff">chroot</span> = /home/bitnami/nginxstack-chroot
<span style="color:#40ffff">chdir</span> = /
</code></pre></div><p>This will put the <code>php-fpm</code> workers into <code>/home/bitnami/nginxstack-chroot</code>. However, you may want to restrict that a little bit more and &ldquo;jail&rdquo; <code>php-fpm</code> to <code>/home/bitnami/nginxstack/apps/yourapp</code>. I&rsquo;ll come back to this point in a sec.</p>
<h3 id="patch-mysql-control-script">Patch mysql control script</h3>
<p>Patching the <code>mysql</code> control scripts seemed to be a never-ending story. Till I&rsquo;ve found <code>--chroot</code>:</p>
<blockquote>
<p>&ldquo;Put the mysqld server in a closed environment during startup by using the chroot() system call.&rdquo; (Source: <a href="http://dev.mysql.com/doc/refman/5.7/en/server-options.html">http://dev.mysql.com/doc/refman/5.7/en/server-options.html</a>)</p>
</blockquote>
<p>Bingo! At <code>/home/bitnami/nginxstack/mysql/scripts/ctl.sh</code> you&rsquo;ll have sth like this:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#cd2828;font-weight:bold">#!/bin/sh
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#40ffff">MYSQL_PIDFILE</span>=/home/bitnami/nginxstack/mysql/data/mysqld.pid

<span style="color:#40ffff">MYSQL_START</span>=<span style="color:#ed9d13">&#34;/home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock  --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log  --pid-file=</span><span style="color:#40ffff">$MYSQL_PIDFILE</span><span style="color:#ed9d13"> --lower-case-table-names=1 &#34;</span>

[...]
</code></pre></div><p>And now just add the <code>--chroot</code> option and you&rsquo;re done:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#cd2828;font-weight:bold">#!/bin/sh
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#40ffff">MYSQL_PIDFILE</span>=/home/bitnami/nginxstack/mysql/data/mysqld.pid

<span style="color:#40ffff">MYSQL_START</span>=<span style="color:#ed9d13">&#34;/home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock  --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log  --pid-file=</span><span style="color:#40ffff">$MYSQL_PIDFILE</span><span style="color:#ed9d13"> --lower-case-table-names=1 --chroot=</span><span style="color:#40ffff">$JAIL</span><span style="color:#ed9d13">&#34;</span>

[...]
</code></pre></div><h2 id="check-setup">Check setup</h2>
<p>Now that we have modified the scripts let&rsquo;s have a dry run.</p>
<h3 id="nginx">nginx</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/nginx/scripts/ctl.sh status
Nginx not running
root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/nginx/scripts/ctl.sh start 
./home/bitnami/nginxstack/nginx/scripts/ctl.sh : Nginx started
root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/nginx/scripts/ctl.sh status
Nginx already running
root@nusec:/home/bitnami/nginxstack-chroot# netstat -ptan | grep <span style="color:#3677a9">8080</span>
tcp        <span style="color:#3677a9">0</span>      <span style="color:#3677a9">0</span> 0.0.0.0:8080            0.0.0.0:*               LISTEN      22706/          
root:/home/bitnami/nginxstack-chroot# ls -l /proc/22706/root
lrwxrwxrwx <span style="color:#3677a9">1</span> root root <span style="color:#3677a9">0</span> Feb  <span style="color:#3677a9">8</span> 21:07 /proc/22706/root -&gt; /home/bitnami/nginxstack-chroot
</code></pre></div><p>So there is a nginx instance (PID = <code>22706</code>) and this is running in a <code>chroot</code> (/home/bitnami/nginxstack-chroot). Alright!</p>
<h3 id="php-fpm">php-fpm</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/php/scripts/ctl.sh start
./home/bitnami/nginxstack/php/scripts/ctl.sh : php-fpm started
root:/home/bitnami/nginxstack-chroot# ps -ax | grep php-fpm
                                         <span style="color:#3677a9">1</span>
<span style="color:#3677a9">15134</span> ?        Ss     0:06 php-fpm: master process (/home/bitnami/nginxstack/php/etc/php-fpm.conf)                        
<span style="color:#3677a9">26557</span> ?        Ss     0:00 php-fpm: master process (/home/bitnami/nginxstack/php/etc/php-fpm.conf)                                                         
<span style="color:#3677a9">26560</span> pts/0    S+     0:00 grep php-fpm
root:/home/bitnami/nginxstack-chroot# ls -l /proc/15134/root
lrwxrwxrwx <span style="color:#3677a9">1</span> root root <span style="color:#3677a9">0</span> Feb  <span style="color:#3677a9">8</span> 21:07 /proc/15134/root -&gt; /home/bitnami/nginxstack-chroot
</code></pre></div><h3 id="mysql">mysql</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ./mysql/scripts/ctl.sh start
160209 16:36:46 mysqld_safe Logging to &#39;/home/bitnami/nginxstack/mysql/data/mysqld.log&#39;.
160209 16:36:47 mysqld_safe Starting mysqld.bin daemon with databases from /home/bitnami/nginxstack/mysql/data
./mysql/scripts/ctl.sh : mysql  started at port 3307


root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ps -ax | grep mysql
13975 pts/3    S      0:00 /bin/sh /home/bitnami/nginxstack-chroot//home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --lower-case-table-names=1
14236 pts/3    S      0:00 sh -c LD_LIBRARY_PATH=/home/bitnami/nginxstack/mysql/lib nohup /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql  --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
14237 pts/3    Sl     0:00 /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
14258 pts/3    S+     0:00 grep mysql

root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ls -l /proc/14237/root
lrwxrwxrwx 1 root root 0 Feb  9 16:37 /proc/14237/root -&gt; /home/bitnami/nginxstack-chroot
</code></pre></div><h2 id="run-the-nginx-stack">Run the nginx stack</h2>
<p>Now that everything seems to work fine, let&rsquo;s start all services using Bitnamis <code>ctlscript.sh</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ./ctlscript.sh start
<span style="color:#3677a9">160209</span> 12:59:50 mysqld_safe Logging to <span style="color:#ed9d13">&#39;/home/bitnami/nginxstack/mysql/data/mysqld.log&#39;</span>.
<span style="color:#3677a9">160209</span> 12:59:50 mysqld_safe Starting mysqld.bin daemon with databases from /home/bitnami/nginxstack/mysql/data
/home/bitnami/nginxstack/mysql/scripts/ctl.sh : mysql  started at port <span style="color:#3677a9">3307</span>
/home/bitnami/nginxstack/php/scripts/ctl.sh : php-fpm started
/home/bitnami/nginxstack/nginx/scripts/ctl.sh : Nginx started
</code></pre></div><p>Great! Now let&rsquo;s stop the services:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/home/bitnami/nginxstack/nginx/scripts/ctl.sh : Nginx stopped
/home/bitnami/nginxstack/php/scripts/ctl.sh : php-fpm stopped
<span style="color:#3677a9">160209</span> 13:01:21 mysqld_safe mysqld from pid file /home/bitnami/nginxstack/mysql/data/mysqld.pid ended
/home/bitnami/nginxstack/mysql/scripts/ctl.sh : mysql stopped
</code></pre></div><h3 id="check-uid-and-gid">Check UID and GID</h3>
<p>To make sure that the previously launched services are dropping privileges (as they are supposed to!) let&rsquo;s have a look at the running processes:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ps -eo uid,gid,args | grep nginx
<span style="color:#3677a9">1337</span>  <span style="color:#3677a9">1337</span> nginx: worker process                              
<span style="color:#3677a9">1337</span>  <span style="color:#3677a9">1337</span> nginx: worker process                              
<span style="color:#3677a9">1337</span>  <span style="color:#3677a9">1337</span> nginx: worker process                              
<span style="color:#3677a9">1337</span>  <span style="color:#3677a9">1337</span> nginx: worker process                              
   <span style="color:#3677a9">0</span>     <span style="color:#3677a9">0</span> nginx: master process /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -p /home/bitnami/nginxstack/nginx/
<span style="color:#3677a9">1337</span>  <span style="color:#3677a9">1337</span> nginx: worker process
</code></pre></div><p>You can see that there is a <strong>master</strong> process running with <code>0:0</code> (UID:GID) but the <strong>worker processes</strong> are running as <code>1337:1337</code> (daemon:daemon). Let&rsquo;s verify that for <code>php</code> and <code>mysql</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ ps -eo uid,gid,args | grep php
1337  1337 php-fpm: pool www                                                     
1337  1337 php-fpm: pool www                                                     
1337  1337 php-fpm: pool www                                                     
1337  1337 php-fpm: pool www 
   0     0 php-fpm: master process (/home/bitnami/nginxstack/php/etc/php-fpm.conf)                        
   
$ ps -eo uid,gid,args | grep mysql
 0     0 /bin/sh /home/bitnami/nginxstack-chroot//home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --lower-case-table-names=1
 0     0 sh -c LD_LIBRARY_PATH=/home/bitnami/nginxstack/mysql/lib\:/home/bitnami/nginxstack/sqlite/lib\:/home/bitnami/nginxstack/nginx/lib\:/home/bitnami/nginxstack/mysql/lib\:/home/bitnami/nginxstack/common/lib\: nohup /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql  --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
100   101 /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
</code></pre></div><h2 id="extras">Extras</h2>
<p>In this section I&rsquo;ll try to sum up some &ldquo;best practices&rdquo; I&rsquo;ve experienced while setting up the (web) application inside the bitnami nginxstack chrooted environment.</p>
<h3 id="check-uidgid">Check UID/GID</h3>
<p>Inside the chroot <code>/etc/passwd</code> should have:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">aemon:x:1:1:daemon:/:/bin/false
mysql:x:100:101:MySQL Server,,,:/nonexistent:/bin/false
nobody:x:99:99:nobody:/:/bin/false
</code></pre></div><p>When setting the user/group ownerships for your directories, make sure that you&rsquo;re using the same UID/GID for that specific user/group also outside the chroot. What I mean is: If you set the ownerships like this:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ chown -R daemon.daemon php nginx apps
$ chown -R mysql.mysql mysql
</code></pre></div><p>Make sure that the UID/GID for user/group <code>daemon</code> or <code>mysql</code> are the same as in <code>/etc/passwd</code> (outside the chroot). In my case:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat /etc/passwd  | grep -e mysql -e daemon
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
mysql:x:100:101:MySQL Server,,,:/nonexistent:/bin/false
</code></pre></div><p>If you don&rsquo;t pay attention to this, you might be setting ownserships and permissions to the right user/group, but the UID/GID might differ between the chroot and the operating system.</p>
<h3 id="applying-ld_library_path-globally">Applying LD_LIBRARY_PATH globally</h3>
<p>If some of your web applications are using some extra binaries (<code>/usr/bin/git</code> for example), you may have to install the dependent libraries for this binary like we did before using <code>n2chroot</code>. If <code>git</code> has some dependencies, that are already installed inside the chroot (let&rsquo;s say inside <code>/home/bitnami/nginxstack/common/lib</code>) you can set the <code>LD_LIBRARY_PATH</code> variable globally. Inside the chroot, you&rsquo;ll have <code>/etc/ld.so.conf</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat /etc/ld.so.conf
include /etc/ld.so.conf.d/*.conf
</code></pre></div><p>Now create an extra directory and a new conf file:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ mkdir /etc/ld.so.conf.d
$ cat /etc/ld.so.conf.d/local.conf
/home/bitnami/nginxstack/common/lib/
</code></pre></div><p>Now you&rsquo;ll have to re-create the LD cache by running <code>ldconfig</code> inside the chroot:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cp /sbin/ldconfig <span style="color:#40ffff">$JAIL</span>/sbin/
$ cp /sbin/ldconfig.real <span style="color:#40ffff">$JAIL</span>/sbin/
$ chroot <span style="color:#40ffff">$JAIL</span> /bin/sh
<span style="color:#999;font-style:italic"># /sbin/ldconfig</span>
...
</code></pre></div><p>Now you should be running <code>git</code> without any missing dependencies inside your chroot.</p>
<h3 id="run-own-php-fpm-pool-for-each-vhost">Run own php-fpm pool for each vhost</h3>
<p>In some previous thoughts I&rsquo;ve mentioned that you may want to put <code>php-fpm</code> in &ldquo;jail&rdquo; into some more specific than <code>/home/bitnami/nginxstack</code>. For example if you have a vhost at <code>bla.example.com</code> and the according conf/htdocs file structure is located at <code>/home/bitnami/nginxstack/apps/bla.example.com</code> you can <code>chroot</code> php-fpm into the same location.</p>
<blockquote>
<p>Btw: The <a href="https://wiki.bitnami.com/Infrastructure_Stacks/Bitnami_Nginx_Stack#How_can_I_create_a_custom_PHP_application.3f">bitnami documentation</a> regarding custom PHP applications  is awesome!</p>
</blockquote>
<p>Let&rsquo;s say <code>bla.example.com</code> consists of following directory structure:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ tree /home/bitnami/nginxstack/apps/bla.example.com
bla.example.com
|-- conf
|   |-- nginx-app.conf
|   |-- nginx-prefix.conf
|   <span style="color:#ed9d13">`</span>-- nginx-vhosts.conf
<span style="color:#ed9d13">`</span>-- htdocs
    |-- index.php
</code></pre></div><p>The <em>app</em> configuration will look like this:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat /home/bitnami/nginxstack/apps/bla.example.com/conf/nginx-app.conf
    index index.php index.html index.htm;

    location ~ <span style="color:#ed9d13">\.</span>php$ {
        fastcgi_split_path_info ^(.+<span style="color:#ed9d13">\.</span>php)(/.+)$;
        fastcgi_read_timeout 300;
        fastcgi_pass unix:/home/bitnami/nginxstack/php/var/run/www-bla.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME <span style="color:#40ffff">$fastcgi_script_name</span>;
        include fastcgi_params;
    }
    
    location ~* <span style="color:#ed9d13">\.</span>(js|css|png|jpg|jpeg|gif|ico)$ {
        add_header Vary <span style="color:#ed9d13">&#34;Accept-Encoding&#34;</span>;
        expires max;
        tcp_nodelay off;
        tcp_nopush on;
    }

</code></pre></div><p>The <code>fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;</code> is the most important one. Read <a href="http://serverfault.com/questions/463674/a-complicated-nginx-php-fpm-chroot-setup">here</a> and <a href="http://serverfault.com/questions/356081/chrooting-php-fpm-with-nginx">here</a>.</p>
<p>Now let&rsquo;s create the <code>php-fpm</code> pool for this specific vhost. Usually each pool conf has be created under <code>./php/etc/fpm.d/*.conf</code>. Make sure you have created this directory before and you have following in your <code>./php/etc/php-fpm.conf</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">[...]
<span style="color:#40ffff">include</span>=etc/fpm.d/*.conf
[...]
</code></pre></div><p>Now create a new file (<code>./php/etc/fpm.d/www-bla.conf</code>) and add:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">;;;;;;;;;;;;;;;;;;;;
; Pool Definitions ; 
;;;;;;;;;;;;;;;;;;;;
[www-bla]
<span style="color:#40ffff">include</span>=/home/bitnami/nginxstack/php/etc/environment.conf
<span style="color:#40ffff">include</span>=/home/bitnami/nginxstack/php/etc/common.conf
<span style="color:#40ffff">user</span>=daemon
<span style="color:#40ffff">group</span>=daemon
<span style="color:#40ffff">listen</span>=/home/bitnami/nginxstack/php/var/run/www-bla.sock
<span style="color:#40ffff">pm</span>=dynamic
pm.max_children=<span style="color:#3677a9">5</span>
pm.start_servers=<span style="color:#3677a9">2</span>
pm.min_spare_servers=<span style="color:#3677a9">1</span>
pm.max_spare_servers=<span style="color:#3677a9">3</span>
<span style="color:#40ffff">chroot</span> = /home/bitnami/nginxstack-chroot/apps/bla.example.com/htdocs
<span style="color:#40ffff">chdir</span> = /
</code></pre></div><p>You can of course add some more options. But this is the minimum one should have. Now you&rsquo;ll have to <strong>restart</strong> the <code>php-fpm</code> daemon and you should see some <strong>workers</strong> designated for your specific vhost:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./ctlscript.sh restart php-fpm
$ ps -ax | grep php-fpm
<span style="color:#3677a9">2735</span> ?        Ss     0:01 php-fpm: master process (/home/bitnami/nginxstack/php/etc/php-fpm.conf)                                  
 <span style="color:#3677a9">2736</span> ?        S      0:00 php-fpm: pool www-bla                                                               
 <span style="color:#3677a9">2737</span> ?        S      0:00 php-fpm: pool www-bla
</code></pre></div><p>Let&rsquo;s check the <code>root</code> directory of the workers:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ls -l /proc/2736/root
lrwxrwxrwx <span style="color:#3677a9">1</span> daemon daemon <span style="color:#3677a9">0</span> Feb <span style="color:#3677a9">12</span> 11:23 /proc/2736/root -&gt; /home/bitnami/nginxstack-chroot/home/bitnami/nginxstack/apps/bla.example.com/htdocs
</code></pre></div><p>Voila!</p>
<h2 id="conclusion">Conclusion</h2>
<p>The Bitnami nginx stack is a really easy-to-configure bundle one can either use in a dev or productive environment. Applying additional security measurements to it like <code>chroot</code> will help you to mitigate the impact of a potential attack. Again: <strong>chroot != security</strong>. Don&rsquo;t blindly rely on <code>chroot</code> and make sure you deeply understand how this technology works and what its potential risks could damage your business.</p>
</div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="http://blog.dornea.nu/2016/02/01/bye-bye-vodka/">prev post</a>
  <a href="http://blog.dornea.nu/2016/04/12/aws-summit-in-berlin-2016/">next post</a>
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme. <br>
  
</footer>
  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>




</body>
</html>