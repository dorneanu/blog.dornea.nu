<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<meta name="generator" content="Hugo 0.120.3">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet"/>
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">
<link rel="stylesheet" href="https://blog.dornea.nu/css/syntax.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />



<script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="b8a4b728-8eda-42fb-8376-10168c622160" async>

</script>

</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/' title="Home">Home</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://dornea.nu' title="About">About</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">Chrooting nginx, php-fpm and mysql using Bitnami </div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>12 Feb 2016</time> 
     | 
    

    
     ~
  

15 mins
|

    
    tags: [ <a href='https://blog.dornea.nu/tags/nginx' class="link silver">nginx</a> <a href='https://blog.dornea.nu/tags/php' class="link silver">php</a> <a href='https://blog.dornea.nu/tags/admin' class="link silver">admin</a> <a href='https://blog.dornea.nu/tags/debian' class="link silver">debian</a> <a href='https://blog.dornea.nu/tags/chroot' class="link silver">chroot</a> <a href='https://blog.dornea.nu/tags/security' class="link silver">security</a> <a href='https://blog.dornea.nu/tags/bitnami' class="link silver">bitnami</a>  ]
    

  </p>
  <div class="lh-copy post-content">
    

      <p>Having talked about hardening your server using <code>chroot</code> in a <a href="http://blog.dornea.nu/2016/01/15/howto-put-nginx-and-php-to-jail-in-debian-8">previous post</a> I&rsquo;ve felt that the whole process was way to complicated. I wanted to have a more <strong>generic</strong> solution regardless of the operating system (and especially the Linux distro). Besides that I wasn&rsquo;t quite happy changing the systems <code>systemd</code> settings and do several modifications to the already <strong>running</strong> system. What I wanted to achieve was a <strong>closed</strong>, <strong>portable</strong> system of running applications inside a <code>chroot</code> environment.</p>
<p>And then I&rsquo;ve remembered using some <a href="https://bitnami.com">bitnami</a> applications in the past. You can either run them in the <em>cloud</em>, in a <em>virtual machine</em> or install them <strong>locally</strong>. The <em>local</em> installation will install a whole software <a href="https://bitnami.com/stacks">stack</a> inside a directory (<em>closed</em> system). You can then start the whole stack using <em>shell scripts</em>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./ctlscript.sh <span class="nb">help</span>
</span></span><span class="line"><span class="cl">usage: ./ctlscript.sh <span class="nb">help</span>
</span></span><span class="line"><span class="cl">       ./ctlscript.sh <span class="o">(</span>start<span class="p">|</span>stop<span class="p">|</span>restart<span class="p">|</span>status<span class="o">)</span>
</span></span><span class="line"><span class="cl">       ./ctlscript.sh <span class="o">(</span>start<span class="p">|</span>stop<span class="p">|</span>restart<span class="p">|</span>status<span class="o">)</span> mysql
</span></span><span class="line"><span class="cl">       ./ctlscript.sh <span class="o">(</span>start<span class="p">|</span>stop<span class="p">|</span>restart<span class="p">|</span>status<span class="o">)</span> php-fpm
</span></span><span class="line"><span class="cl">       ./ctlscript.sh <span class="o">(</span>start<span class="p">|</span>stop<span class="p">|</span>restart<span class="p">|</span>status<span class="o">)</span> nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">help</span>       - this screen
</span></span><span class="line"><span class="cl">start      - start the service<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">stop       - stop  the service<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">restart    - restart or start the service<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">status     - show the status of the service<span class="o">(</span>s<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The binaries inside the stack are using <strong>libraries</strong> inside the <em>closed</em> system (by changing <code>LD_LIBRARY_PATH</code>). So the Bitnami installation will run out of the stack without interacting with the underlying operating system (read more about the technology <a href="https://bitnami.com/learn_more">here</a>). This is a great advantage since you can simply <strong>copy</strong> the directory, change the <strong>settings</strong> and you&rsquo;ll have another instance running in its own directory (remember the <strong>portable</strong> aspect of my wish list before?)</p>
<p>However the Bitnami stacks won&rsquo;t use <code>chroot</code> by default. This is where I had to commit my own modifications to the local installation. But, one thing after another.</p>
<h2 id="the-nginx-stack">The Nginx stack</h2>
<p>If you&rsquo;re recalling the <a href="http://blog.dornea.nu/2016/01/15/howto-put-nginx-and-php-to-jail-in-debian-8">previous post</a>, my <code>chroot</code> environment consisted of: <code>nginx</code>, <code>php-fpm</code> and <code>mysql</code>. Fortunately Bitnami provides a <a href="https://bitnami.com/stack/nginx">Nginx Stack</a> which is a:</p>
<blockquote>
<p>&ldquo;&hellip; complete,  fully-integrated and ready to run PHP, MySQL and Nginx development environment. In addition, it bundles phpMyAdmin, SQLite, ImageMagick, FastCGI, Memcache, GD, CURL, PEAR, PECL and other components. Also known as LEMP for Linux, WEMP for Windows and MEMP for OS X.&rdquo; (Source: <a href="https://bitnami.com/stack/nginx">https://bitnami.com/stack/nginx</a>)</p>
</blockquote>
<p>So let&rsquo;s give it a try.</p>
<h2 id="installing-bitnami-nginx-stack">Installing Bitnami Nginx stack</h2>
<p>Download the <a href="https://bitnami.com/stack/nginx/installer">installer</a> to your machine and run it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># ./bitnami-nginxstack-1.9.10-0-linux-x64-installer.run 
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Welcome to the Bitnami Nginx Stack Setup Wizard.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Select the components you want to install; clear the components you do not want 
</span></span><span class="line"><span class="cl">to install. Click Next when you are ready to continue.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Varnish [Y/n] :n
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PhpMyAdmin : Y (Cannot be edited)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Is the selection above correct? [Y/n]: Y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Installation folder
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please, choose a folder to install Bitnami Nginx Stack
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Select a folder [/opt/nginxstack-1.9.10-0]: /home/bitnami/nginxstack
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Create MySQL &#39;root&#39; Account
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Bitnami Nginx Stack database root user creation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Password :
</span></span><span class="line"><span class="cl">Re-enter :
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">MySQL Information
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please enter your MySQL database information:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MySQL Server port [3306]: 3307 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Please enter the port that the bundled Nginx Server will listen to by default.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nginx Port [80]: 8080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Setup is now ready to begin installing Bitnami Nginx Stack on your computer.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Do you want to continue? [Y/n]: Y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Please wait while Setup installs Bitnami Nginx Stack on your computer.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Installing
</span></span><span class="line"><span class="cl"> 0% ______________ 50% ______________ 100%
</span></span><span class="line"><span class="cl"> #########################################
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Setup has finished installing Bitnami Nginx Stack on your computer.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Launch Bitnami Nginx Stack [Y/n]: n
</span></span></code></pre></td></tr></table>
</div>
</div><p>A few observations:</p>
<ul>
<li>I&rsquo;ve installed the stack to <code>/home/bitnami/nginxstack</code></li>
<li><code>MySQL</code> will listen on <code>localhost:3307</code></li>
<li><code>nginx</code> will listen on <code>localhost:8080</code></li>
</ul>
<h2 id="setup-chroot-environment">Setup chroot environment</h2>
<p>Now that we have installed the <em>nginx stack</em>, we&rsquo;ll setup a <code>chroot</code> environment and copy the <em>nginx stack directory</em> to it. Supposing that the chroot will be located at <code>/home/bitnami/nginxstack-chroot</code>, inside the chroot we&rsquo;ll have following directory structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ tree -L <span class="m">3</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- bin
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- dev
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- null
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- random
</span></span><span class="line"><span class="cl"><span class="p">|</span>    -- urandom
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- etc
</span></span><span class="line"><span class="cl"><span class="p">|</span>   ...
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- home
</span></span><span class="line"><span class="cl"><span class="p">|</span>   -- bitnami
</span></span><span class="line"><span class="cl"><span class="p">|</span>       -- nginxstack
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- lib
</span></span><span class="line"><span class="cl"><span class="p">|</span>   ...
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- lib64 -&gt; usr/lib
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- run
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- tmp
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- usr
</span></span><span class="line"><span class="cl"><span class="p">|</span>   ...
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- var
</span></span><span class="line"><span class="cl">    ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the nginx stack directory will be available at <code>/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack</code>. This is <strong>very important</strong> and you should take care having the same structure. Let&rsquo;s setup the chroot using following script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">N2CHROOT</span><span class="o">=</span>/home/bitnami/scripts/n2chroot
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">JAIL</span><span class="o">=</span>/home/bitnami/nginxstack-chroot
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">BITNAMI</span><span class="o">=</span>/home/bitnami/nginxstack
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">BITNAMI_INSTALLDIR</span><span class="o">=</span><span class="nv">$JAIL</span>/<span class="nv">$BITNAMI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> create_chroot <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Create devices</span>
</span></span><span class="line"><span class="cl">    mkdir <span class="nv">$JAIL</span>/dev
</span></span><span class="line"><span class="cl">    mknod -m <span class="m">0666</span> <span class="nv">$JAIL</span>/dev/null c <span class="m">1</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">    mknod -m <span class="m">0666</span> <span class="nv">$JAIL</span>/dev/random c <span class="m">1</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">    mknod -m <span class="m">0444</span> <span class="nv">$JAIL</span>/dev/urandom c <span class="m">1</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Create directories</span>
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/<span class="o">{</span>etc,bin,usr,var<span class="o">}</span>
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/usr/<span class="o">{</span>lib,sbin,bin<span class="o">}</span>
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/<span class="o">{</span>run,tmp<span class="o">}</span>
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/var/run
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/<span class="nv">$BITNAMI</span>/<span class="o">{</span>php,nginx,mysql<span class="o">}</span>
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/<span class="nv">$BITNAMI</span>/php/lib
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/<span class="nv">$BITNAMI</span>/nginx/lib
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/<span class="nv">$BITNAMI</span>/common/lib
</span></span><span class="line"><span class="cl">    mkdir -p <span class="nv">$JAIL</span>/<span class="nv">$BITNAMI</span>/mysql/lib
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Check if 64-bit system</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="k">$(</span>uname -m<span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;x86_64&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        mkdir -p <span class="nv">$JAIL</span>/lib/x86_64-linux-gnu
</span></span><span class="line"><span class="cl">        <span class="nb">cd</span> <span class="nv">$JAIL</span><span class="p">;</span> ln -s usr/lib lib64
</span></span><span class="line"><span class="cl">        <span class="nb">cd</span> <span class="nv">$JAIL</span>/usr<span class="p">;</span> ln -s lib lib64
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">cd</span> <span class="nv">$JAIL</span><span class="p">;</span> ln -s usr/lib lib
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Copy important stuff</span>
</span></span><span class="line"><span class="cl">    cp -rfvL /etc/<span class="o">{</span>services,localtime,nsswitch.conf,nscd.conf,protocols,hosts,ld.so.cache,ld.so.conf,resolv.conf,host.conf<span class="o">}</span> <span class="nv">$JAIL</span>/etc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Cp bitnami to the chroot</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># cp -Rv $BITNAMI $JAIL/home/bitnami/ </span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> add_users <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Most instructions from https://wiki.archlinux.org/index.php/nginx#Installation_in_a_chroot</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Add users</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;daemon:x:1:1:daemon:/:/bin/false&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/passwd
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;mysql:x:100:101:MySQL Server,,,:/nonexistent:/bin/false&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/passwd
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;nobody:x:99:99:nobody:/:/bin/false&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/passwd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Add groups</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;daemon:x:1:&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/group
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;mysql:x:101:&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/group
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;nobody:x:99:&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/group
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Add shadow</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;daemon:x:14871::::::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/shadow
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;mysql:!:16755:0:99999:7:::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/shadow
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;nobody:x:14871::::::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/shadow
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Add gshadow</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;daemon:::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/gshadow
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;mysql:!::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/gshadow
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;nobody:::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/gshadow
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> add_libraries <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Add system stuff</span>
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libnsl* <span class="nv">$JAIL</span>/lib/x86_64-linux-gnu/
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libnss* <span class="nv">$JAIL</span>/lib/x86_64-linux-gnu/
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Add nginx stuff</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># $N2CHROOT $BITNAMI_INSTALLDIR/nginx/sbin/.nginx.bin</span>
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libnsl* <span class="nv">$BITNAMI_INSTALLDIR</span>/common/lib/
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libnss* <span class="nv">$BITNAMI_INSTALLDIR</span>/common/lib/
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libpthread* <span class="nv">$BITNAMI_INSTALLDIR</span>/common/lib/
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libpcre* <span class="nv">$BITNAMI_INSTALLDIR</span>/common/lib/
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libdl* <span class="nv">$BITNAMI_INSTALLDIR</span>/common/lib/
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libgcc* <span class="nv">$BITNAMI_INSTALLDIR</span>/common/lib/
</span></span><span class="line"><span class="cl">    cp /lib/x86_64-linux-gnu/libresolv* <span class="nv">$BITNAMI_INSTALLDIR</span>/common/lib/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Add php-fpm stuff</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$BITNAMI_INSTALLDIR</span>/php/lib
</span></span><span class="line"><span class="cl">    ln -s ../../common/lib/libresolv.so.2 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Add mysql stuff</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$BITNAMI_INSTALLDIR</span>/mysql/lib
</span></span><span class="line"><span class="cl">    ln -s ../../common/lib/libdl.so.2
</span></span><span class="line"><span class="cl">    ln -s ../../common/lib/libgcc_s.so.1 
</span></span><span class="line"><span class="cl">    ln -s ../../common/lib/libpthread.so.0 
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> add_binaries <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Add shell</span>
</span></span><span class="line"><span class="cl">    cp /bin/sh <span class="nv">$JAIL</span>/bin/
</span></span><span class="line"><span class="cl">    <span class="nv">$N2CHROOT</span> /bin/sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Add nohup (mysqld needs it)</span>
</span></span><span class="line"><span class="cl">    cp /usr/bin/nohup <span class="nv">$JAIL</span>/usr/bin
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> fix_permissions <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$BITNAMI_INSTALLDIR</span>/mysql
</span></span><span class="line"><span class="cl">    chown -R mysql:mysql .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$BITNAMI_INSTALLDIR</span>/php
</span></span><span class="line"><span class="cl">    chown -R daemon:daemon .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$BITNAMI_INSTALLDIR</span>/nginx
</span></span><span class="line"><span class="cl">    chown -R daemon:daemon .
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run functions</span>
</span></span><span class="line"><span class="cl">create_chroot
</span></span><span class="line"><span class="cl">add_users
</span></span><span class="line"><span class="cl">add_libraries
</span></span><span class="line"><span class="cl">add_binaries
</span></span><span class="line"><span class="cl">fix_permissions
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>N2CHROOT</code> script can be found <a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-n2chroot">here</a>. Make sure it&rsquo;s located inside <code>/home/bitnami/scripts</code> and also change the <code>BASE</code> variable inside the script to <code>/home/bitnami/nginxstack-chroot</code>.  Now <a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-nginx-chroot-bitnami">download</a> the script and run it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">JAIL</span><span class="o">=</span>/home/bitnami/nginxstack-chroot
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="nv">$JAIL</span>
</span></span><span class="line"><span class="cl">$ ../scripts/nginx-chroot-bitnami.sh
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now you should have following structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ tree -L <span class="m">3</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- bin
</span></span><span class="line"><span class="cl"><span class="p">|</span>    -- sh
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- dev
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- null
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- random
</span></span><span class="line"><span class="cl"><span class="p">|</span>    -- urandom
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- etc
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- group
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- gshadow
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- host.conf
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- hosts
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- ld.so.cache
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- ld.so.conf
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- localtime
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- nsswitch.conf
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- passwd
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- protocols
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- resolv.conf
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- services
</span></span><span class="line"><span class="cl"><span class="p">|</span>    -- shadow
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- home
</span></span><span class="line"><span class="cl"><span class="p">|</span>    -- bitnami
</span></span><span class="line"><span class="cl"><span class="p">|</span>        -- nginxstack
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- lib
</span></span><span class="line"><span class="cl"><span class="p">|</span>    -- x86_64-linux-gnu
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- libc.so.6
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- libcrypt.so.1
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- libm.so.6
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- libpthread.so.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>        -- librt.so.1
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- lib64 -&gt; usr/lib
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- run
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- tmp
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- usr
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- bin
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- lib
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- ld-linux-x86-64.so.2
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>    -- x86_64-linux-gnu
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- lib64 -&gt; lib
</span></span><span class="line"><span class="cl"><span class="p">|</span>    -- sbin
</span></span><span class="line"><span class="cl"> -- var
</span></span><span class="line"><span class="cl">     -- run
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since all config files created by the bitnami installer point to <code>/home/bitnami/nginxstack</code> I will create a new <strong>link</strong> to point to the right directory inside the <code>chroot</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">cd</span> /home/bitnami
</span></span><span class="line"><span class="cl">$ ln -s nginxstack-chroot/home/bitnami/nginxstack nginxstack
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>This is very important</strong>, since all daemons (nginx, php-fpm, mysqld) will look at <code>/home/bitnami/nginxstack</code> for their config files etc. before entering the <code>chroot</code>.</p>
<h2 id="patch-scripts">Patch scripts</h2>
<p>Now the <strong>controll scripts</strong> have to be modified to run the binaries in a <code>chroot</code>.</p>
<h3 id="patch-setenvsh">Patch setenv.sh</h3>
<p>At <code>/home/bitnami/nginxstack/scripts/setenv.sh</code> (inside the <code>chroot</code>) there is a script which sets all the environment variables (e.g. <code>LD_LIBRARY_PATH</code>) for the binaries. We&rsquo;ll use this script to set a variable which we&rsquo;ll use a few times in some other scripts. At the beginning of the script set the <code>JAIL</code> variable accordingly:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">export</span> <span class="nv">JAIL</span><span class="o">=</span>/home/bitnami/nginxstack-chroot
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="patch-nginx-control-script">Patch nginx control script</h3>
<p>When calling <code>./ctlscript.sh start nginx</code> the script will then call <code>./nginx/scripts/ctl.sh</code> and finally this will call <code>./nginx/sbin/nginx</code>. The last contains the commands for calling the <code>nginx</code> binary directly. You&rsquo;ll have sth like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">. /home/bitnami/nginxstack/scripts/setenv.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -p /home/bitnami/nginxstack/nginx/ <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we want the <code>nginx</code> binary to run inside the <code>chroot</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">. /home/bitnami/nginxstack/scripts/setenv.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> /usr/sbin/chroot <span class="nv">$JAIL</span> /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -p /home/bitnami/nginxstack/nginx/ <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using almost the same command you can if <code>nginx</code> will run properly:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ /usr/sbin/chroot <span class="nv">$JAIL</span> sh -c <span class="s1">&#39;LD_LIBRARY_PATH=&#34;/home/bitnami/nginxstack/sqlite/lib:/home/bitnami/nginxstack/nginx/lib:/home/bitnami/nginxstack/mysql/lib:/home/bitnami/nginxstack/common/lib&#34; /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -t -p /home/bitnami/nginxstack/nginx&#39;</span>
</span></span><span class="line"><span class="cl">nginx: the configuration file /home/bitnami/nginxstack/nginx/conf/nginx.conf syntax is ok
</span></span><span class="line"><span class="cl">nginx: configuration file /home/bitnami/nginxstack/nginx/conf/nginx.conf <span class="nb">test</span> is successful
</span></span></code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ve set the <code>LD_LIBRARY_PATH</code> manually since not all libs are located at <code>/lib/*</code>.</p>
<h3 id="patch-php-fpm-control-script">Patch php-fpm control script</h3>
<p>Despite some previous approaches this turned out to be a very simple step. All you&rsquo;ll have to do is to add following lines to your <code>php-fpm.conf</code> insde <code>/home/bitnami/nginxstack/php/etc/php-fpm.conf</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">chroot</span> <span class="o">=</span> /home/bitnami/nginxstack-chroot
</span></span><span class="line"><span class="cl"><span class="nv">chdir</span> <span class="o">=</span> /
</span></span></code></pre></td></tr></table>
</div>
</div><p>This will put the <code>php-fpm</code> workers into <code>/home/bitnami/nginxstack-chroot</code>. However, you may want to restrict that a little bit more and &ldquo;jail&rdquo; <code>php-fpm</code> to <code>/home/bitnami/nginxstack/apps/yourapp</code>. I&rsquo;ll come back to this point in a sec.</p>
<h3 id="patch-mysql-control-script">Patch mysql control script</h3>
<p>Patching the <code>mysql</code> control scripts seemed to be a never-ending story. Till I&rsquo;ve found <code>--chroot</code>:</p>
<blockquote>
<p>&ldquo;Put the mysqld server in a closed environment during startup by using the chroot() system call.&rdquo; (Source: <a href="http://dev.mysql.com/doc/refman/5.7/en/server-options.html">http://dev.mysql.com/doc/refman/5.7/en/server-options.html</a>)</p>
</blockquote>
<p>Bingo! At <code>/home/bitnami/nginxstack/mysql/scripts/ctl.sh</code> you&rsquo;ll have sth like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">MYSQL_PIDFILE</span><span class="o">=</span>/home/bitnami/nginxstack/mysql/data/mysqld.pid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">MYSQL_START</span><span class="o">=</span><span class="s2">&#34;/home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock  --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log  --pid-file=</span><span class="nv">$MYSQL_PIDFILE</span><span class="s2"> --lower-case-table-names=1 &#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And now just add the <code>--chroot</code> option and you&rsquo;re done:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">MYSQL_PIDFILE</span><span class="o">=</span>/home/bitnami/nginxstack/mysql/data/mysqld.pid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">MYSQL_START</span><span class="o">=</span><span class="s2">&#34;/home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock  --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log  --pid-file=</span><span class="nv">$MYSQL_PIDFILE</span><span class="s2"> --lower-case-table-names=1 --chroot=</span><span class="nv">$JAIL</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="check-setup">Check setup</h2>
<p>Now that we have modified the scripts let&rsquo;s have a dry run.</p>
<h3 id="nginx">nginx</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/nginx/scripts/ctl.sh status
</span></span><span class="line"><span class="cl">Nginx not running
</span></span><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/nginx/scripts/ctl.sh start 
</span></span><span class="line"><span class="cl">./home/bitnami/nginxstack/nginx/scripts/ctl.sh : Nginx started
</span></span><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/nginx/scripts/ctl.sh status
</span></span><span class="line"><span class="cl">Nginx already running
</span></span><span class="line"><span class="cl">root@nusec:/home/bitnami/nginxstack-chroot# netstat -ptan <span class="p">|</span> grep <span class="m">8080</span>
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:8080            0.0.0.0:*               LISTEN      22706/          
</span></span><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot# ls -l /proc/22706/root
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Feb  <span class="m">8</span> 21:07 /proc/22706/root -&gt; /home/bitnami/nginxstack-chroot
</span></span></code></pre></td></tr></table>
</div>
</div><p>So there is a nginx instance (PID = <code>22706</code>) and this is running in a <code>chroot</code> (/home/bitnami/nginxstack-chroot). Alright!</p>
<h3 id="php-fpm">php-fpm</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot# ./home/bitnami/nginxstack/php/scripts/ctl.sh start
</span></span><span class="line"><span class="cl">./home/bitnami/nginxstack/php/scripts/ctl.sh : php-fpm started
</span></span><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot# ps -ax <span class="p">|</span> grep php-fpm
</span></span><span class="line"><span class="cl">                                         <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">15134</span> ?        Ss     0:06 php-fpm: master process <span class="o">(</span>/home/bitnami/nginxstack/php/etc/php-fpm.conf<span class="o">)</span>                        
</span></span><span class="line"><span class="cl"><span class="m">26557</span> ?        Ss     0:00 php-fpm: master process <span class="o">(</span>/home/bitnami/nginxstack/php/etc/php-fpm.conf<span class="o">)</span>                                                         
</span></span><span class="line"><span class="cl"><span class="m">26560</span> pts/0    S+     0:00 grep php-fpm
</span></span><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot# ls -l /proc/15134/root
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Feb  <span class="m">8</span> 21:07 /proc/15134/root -&gt; /home/bitnami/nginxstack-chroot
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mysql">mysql</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ./mysql/scripts/ctl.sh start
</span></span><span class="line"><span class="cl">160209 16:36:46 mysqld_safe Logging to &#39;/home/bitnami/nginxstack/mysql/data/mysqld.log&#39;.
</span></span><span class="line"><span class="cl">160209 16:36:47 mysqld_safe Starting mysqld.bin daemon with databases from /home/bitnami/nginxstack/mysql/data
</span></span><span class="line"><span class="cl">./mysql/scripts/ctl.sh : mysql  started at port 3307
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ps -ax | grep mysql
</span></span><span class="line"><span class="cl">13975 pts/3    S      0:00 /bin/sh /home/bitnami/nginxstack-chroot//home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --lower-case-table-names=1
</span></span><span class="line"><span class="cl">14236 pts/3    S      0:00 sh -c LD_LIBRARY_PATH=/home/bitnami/nginxstack/mysql/lib nohup /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql  --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
</span></span><span class="line"><span class="cl">14237 pts/3    Sl     0:00 /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
</span></span><span class="line"><span class="cl">14258 pts/3    S+     0:00 grep mysql
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ls -l /proc/14237/root
</span></span><span class="line"><span class="cl">lrwxrwxrwx 1 root root 0 Feb  9 16:37 /proc/14237/root -&gt; /home/bitnami/nginxstack-chroot
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="run-the-nginx-stack">Run the nginx stack</h2>
<p>Now that everything seems to work fine, let&rsquo;s start all services using Bitnamis <code>ctlscript.sh</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root:/home/bitnami/nginxstack-chroot/home/bitnami/nginxstack# ./ctlscript.sh start
</span></span><span class="line"><span class="cl"><span class="m">160209</span> 12:59:50 mysqld_safe Logging to <span class="s1">&#39;/home/bitnami/nginxstack/mysql/data/mysqld.log&#39;</span>.
</span></span><span class="line"><span class="cl"><span class="m">160209</span> 12:59:50 mysqld_safe Starting mysqld.bin daemon with databases from /home/bitnami/nginxstack/mysql/data
</span></span><span class="line"><span class="cl">/home/bitnami/nginxstack/mysql/scripts/ctl.sh : mysql  started at port <span class="m">3307</span>
</span></span><span class="line"><span class="cl">/home/bitnami/nginxstack/php/scripts/ctl.sh : php-fpm started
</span></span><span class="line"><span class="cl">/home/bitnami/nginxstack/nginx/scripts/ctl.sh : Nginx started
</span></span></code></pre></td></tr></table>
</div>
</div><p>Great! Now let&rsquo;s stop the services:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">/home/bitnami/nginxstack/nginx/scripts/ctl.sh : Nginx stopped
</span></span><span class="line"><span class="cl">/home/bitnami/nginxstack/php/scripts/ctl.sh : php-fpm stopped
</span></span><span class="line"><span class="cl"><span class="m">160209</span> 13:01:21 mysqld_safe mysqld from pid file /home/bitnami/nginxstack/mysql/data/mysqld.pid ended
</span></span><span class="line"><span class="cl">/home/bitnami/nginxstack/mysql/scripts/ctl.sh : mysql stopped
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="check-uid-and-gid">Check UID and GID</h3>
<p>To make sure that the previously launched services are dropping privileges (as they are supposed to!) let&rsquo;s have a look at the running processes:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ps -eo uid,gid,args <span class="p">|</span> grep nginx
</span></span><span class="line"><span class="cl"><span class="m">1337</span>  <span class="m">1337</span> nginx: worker process                              
</span></span><span class="line"><span class="cl"><span class="m">1337</span>  <span class="m">1337</span> nginx: worker process                              
</span></span><span class="line"><span class="cl"><span class="m">1337</span>  <span class="m">1337</span> nginx: worker process                              
</span></span><span class="line"><span class="cl"><span class="m">1337</span>  <span class="m">1337</span> nginx: worker process                              
</span></span><span class="line"><span class="cl">   <span class="m">0</span>     <span class="m">0</span> nginx: master process /home/bitnami/nginxstack/nginx/sbin/.nginx.bin -p /home/bitnami/nginxstack/nginx/
</span></span><span class="line"><span class="cl"><span class="m">1337</span>  <span class="m">1337</span> nginx: worker process
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that there is a <strong>master</strong> process running with <code>0:0</code> (UID:GID) but the <strong>worker processes</strong> are running as <code>1337:1337</code> (daemon:daemon). Let&rsquo;s verify that for <code>php</code> and <code>mysql</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ ps -eo uid,gid,args | grep php
</span></span><span class="line"><span class="cl">1337  1337 php-fpm: pool www                                                     
</span></span><span class="line"><span class="cl">1337  1337 php-fpm: pool www                                                     
</span></span><span class="line"><span class="cl">1337  1337 php-fpm: pool www                                                     
</span></span><span class="line"><span class="cl">1337  1337 php-fpm: pool www 
</span></span><span class="line"><span class="cl">   0     0 php-fpm: master process (/home/bitnami/nginxstack/php/etc/php-fpm.conf)                        
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">$ ps -eo uid,gid,args | grep mysql
</span></span><span class="line"><span class="cl"> 0     0 /bin/sh /home/bitnami/nginxstack-chroot//home/bitnami/nginxstack/mysql/bin/mysqld_safe --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --datadir=/home/bitnami/nginxstack/mysql/data --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --lower-case-table-names=1
</span></span><span class="line"><span class="cl"> 0     0 sh -c LD_LIBRARY_PATH=/home/bitnami/nginxstack/mysql/lib\:/home/bitnami/nginxstack/sqlite/lib\:/home/bitnami/nginxstack/nginx/lib\:/home/bitnami/nginxstack/mysql/lib\:/home/bitnami/nginxstack/common/lib\: nohup /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql  --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
</span></span><span class="line"><span class="cl">100   101 /home/bitnami/nginxstack/mysql/bin/mysqld.bin --defaults-file=/home/bitnami/nginxstack/mysql/my.cnf --basedir=/home/bitnami/nginxstack/mysql --datadir=/home/bitnami/nginxstack/mysql/data --plugin-dir=/home/bitnami/nginxstack/mysql/lib/plugin --user=mysql --lower-case-table-names=1 --log-error=/home/bitnami/nginxstack/mysql/data/mysqld.log --pid-file=/home/bitnami/nginxstack/mysql/data/mysqld.pid --socket=/home/bitnami/nginxstack/mysql/tmp/mysql.sock --port=3307
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="extras">Extras</h2>
<p>In this section I&rsquo;ll try to sum up some &ldquo;best practices&rdquo; I&rsquo;ve experienced while setting up the (web) application inside the bitnami nginxstack chrooted environment.</p>
<h3 id="check-uidgid">Check UID/GID</h3>
<p>Inside the chroot <code>/etc/passwd</code> should have:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">aemon:x:1:1:daemon:/:/bin/false
</span></span><span class="line"><span class="cl">mysql:x:100:101:MySQL Server,,,:/nonexistent:/bin/false
</span></span><span class="line"><span class="cl">nobody:x:99:99:nobody:/:/bin/false
</span></span></code></pre></td></tr></table>
</div>
</div><p>When setting the user/group ownerships for your directories, make sure that you&rsquo;re using the same UID/GID for that specific user/group also outside the chroot. What I mean is: If you set the ownerships like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ chown -R daemon.daemon php nginx apps
</span></span><span class="line"><span class="cl">$ chown -R mysql.mysql mysql
</span></span></code></pre></td></tr></table>
</div>
</div><p>Make sure that the UID/GID for user/group <code>daemon</code> or <code>mysql</code> are the same as in <code>/etc/passwd</code> (outside the chroot). In my case:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /etc/passwd  <span class="p">|</span> grep -e mysql -e daemon
</span></span><span class="line"><span class="cl">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span class="line"><span class="cl">mysql:x:100:101:MySQL Server,,,:/nonexistent:/bin/false
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you don&rsquo;t pay attention to this, you might be setting ownserships and permissions to the right user/group, but the UID/GID might differ between the chroot and the operating system.</p>
<h3 id="applying-ld_library_path-globally">Applying LD_LIBRARY_PATH globally</h3>
<p>If some of your web applications are using some extra binaries (<code>/usr/bin/git</code> for example), you may have to install the dependent libraries for this binary like we did before using <code>n2chroot</code>. If <code>git</code> has some dependencies, that are already installed inside the chroot (let&rsquo;s say inside <code>/home/bitnami/nginxstack/common/lib</code>) you can set the <code>LD_LIBRARY_PATH</code> variable globally. Inside the chroot, you&rsquo;ll have <code>/etc/ld.so.conf</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /etc/ld.so.conf
</span></span><span class="line"><span class="cl">include /etc/ld.so.conf.d/*.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now create an extra directory and a new conf file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ mkdir /etc/ld.so.conf.d
</span></span><span class="line"><span class="cl">$ cat /etc/ld.so.conf.d/local.conf
</span></span><span class="line"><span class="cl">/home/bitnami/nginxstack/common/lib/
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now you&rsquo;ll have to re-create the LD cache by running <code>ldconfig</code> inside the chroot:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cp /sbin/ldconfig <span class="nv">$JAIL</span>/sbin/
</span></span><span class="line"><span class="cl">$ cp /sbin/ldconfig.real <span class="nv">$JAIL</span>/sbin/
</span></span><span class="line"><span class="cl">$ chroot <span class="nv">$JAIL</span> /bin/sh
</span></span><span class="line"><span class="cl"><span class="c1"># /sbin/ldconfig</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now you should be running <code>git</code> without any missing dependencies inside your chroot.</p>
<h3 id="run-own-php-fpm-pool-for-each-vhost">Run own php-fpm pool for each vhost</h3>
<p>In some previous thoughts I&rsquo;ve mentioned that you may want to put <code>php-fpm</code> in &ldquo;jail&rdquo; into some more specific than <code>/home/bitnami/nginxstack</code>. For example if you have a vhost at <code>bla.example.com</code> and the according conf/htdocs file structure is located at <code>/home/bitnami/nginxstack/apps/bla.example.com</code> you can <code>chroot</code> php-fpm into the same location.</p>
<blockquote>
<p>Btw: The <a href="https://wiki.bitnami.com/Infrastructure_Stacks/Bitnami_Nginx_Stack#How_can_I_create_a_custom_PHP_application.3f">bitnami documentation</a> regarding custom PHP applications  is awesome!</p>
</blockquote>
<p>Let&rsquo;s say <code>bla.example.com</code> consists of following directory structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ tree /home/bitnami/nginxstack/apps/bla.example.com
</span></span><span class="line"><span class="cl">bla.example.com
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- conf
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- nginx-app.conf
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- nginx-prefix.conf
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="sb">`</span>-- nginx-vhosts.conf
</span></span><span class="line"><span class="cl"><span class="sb">`</span>-- htdocs
</span></span><span class="line"><span class="cl">    <span class="p">|</span>-- index.php
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <em>app</em> configuration will look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /home/bitnami/nginxstack/apps/bla.example.com/conf/nginx-app.conf
</span></span><span class="line"><span class="cl">    index index.php index.html index.htm<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location ~ <span class="se">\.</span>php$ <span class="o">{</span>
</span></span><span class="line"><span class="cl">        fastcgi_split_path_info ^<span class="o">(</span>.+<span class="se">\.</span>php<span class="o">)(</span>/.+<span class="o">)</span>$<span class="p">;</span>
</span></span><span class="line"><span class="cl">        fastcgi_read_timeout 300<span class="p">;</span>
</span></span><span class="line"><span class="cl">        fastcgi_pass unix:/home/bitnami/nginxstack/php/var/run/www-bla.sock<span class="p">;</span>
</span></span><span class="line"><span class="cl">        fastcgi_index index.php<span class="p">;</span>
</span></span><span class="line"><span class="cl">        fastcgi_param SCRIPT_FILENAME <span class="nv">$fastcgi_script_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        include fastcgi_params<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    location ~* <span class="se">\.</span><span class="o">(</span>js<span class="p">|</span>css<span class="p">|</span>png<span class="p">|</span>jpg<span class="p">|</span>jpeg<span class="p">|</span>gif<span class="p">|</span>ico<span class="o">)</span>$ <span class="o">{</span>
</span></span><span class="line"><span class="cl">        add_header Vary <span class="s2">&#34;Accept-Encoding&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        expires max<span class="p">;</span>
</span></span><span class="line"><span class="cl">        tcp_nodelay off<span class="p">;</span>
</span></span><span class="line"><span class="cl">        tcp_nopush on<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;</code> is the most important one. Read <a href="http://serverfault.com/questions/463674/a-complicated-nginx-php-fpm-chroot-setup">here</a> and <a href="http://serverfault.com/questions/356081/chrooting-php-fpm-with-nginx">here</a>.</p>
<p>Now let&rsquo;s create the <code>php-fpm</code> pool for this specific vhost. Usually each pool conf has be created under <code>./php/etc/fpm.d/*.conf</code>. Make sure you have created this directory before and you have following in your <code>./php/etc/php-fpm.conf</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">include</span><span class="o">=</span>etc/fpm.d/*.conf
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now create a new file (<code>./php/etc/fpm.d/www-bla.conf</code>) and add:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="p">;;;;;;;;;;;;;;;;;;;;</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> Pool Definitions <span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">;;;;;;;;;;;;;;;;;;;;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>www-bla<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">include</span><span class="o">=</span>/home/bitnami/nginxstack/php/etc/environment.conf
</span></span><span class="line"><span class="cl"><span class="nv">include</span><span class="o">=</span>/home/bitnami/nginxstack/php/etc/common.conf
</span></span><span class="line"><span class="cl"><span class="nv">user</span><span class="o">=</span>daemon
</span></span><span class="line"><span class="cl"><span class="nv">group</span><span class="o">=</span>daemon
</span></span><span class="line"><span class="cl"><span class="nv">listen</span><span class="o">=</span>/home/bitnami/nginxstack/php/var/run/www-bla.sock
</span></span><span class="line"><span class="cl"><span class="nv">pm</span><span class="o">=</span>dynamic
</span></span><span class="line"><span class="cl">pm.max_children<span class="o">=</span><span class="m">5</span>
</span></span><span class="line"><span class="cl">pm.start_servers<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">pm.min_spare_servers<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">pm.max_spare_servers<span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="nv">chroot</span> <span class="o">=</span> /home/bitnami/nginxstack-chroot/apps/bla.example.com/htdocs
</span></span><span class="line"><span class="cl"><span class="nv">chdir</span> <span class="o">=</span> /
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can of course add some more options. But this is the minimum one should have. Now you&rsquo;ll have to <strong>restart</strong> the <code>php-fpm</code> daemon and you should see some <strong>workers</strong> designated for your specific vhost:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./ctlscript.sh restart php-fpm
</span></span><span class="line"><span class="cl">$ ps -ax <span class="p">|</span> grep php-fpm
</span></span><span class="line"><span class="cl"><span class="m">2735</span> ?        Ss     0:01 php-fpm: master process <span class="o">(</span>/home/bitnami/nginxstack/php/etc/php-fpm.conf<span class="o">)</span>                                  
</span></span><span class="line"><span class="cl"> <span class="m">2736</span> ?        S      0:00 php-fpm: pool www-bla                                                               
</span></span><span class="line"><span class="cl"> <span class="m">2737</span> ?        S      0:00 php-fpm: pool www-bla
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s check the <code>root</code> directory of the workers:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ls -l /proc/2736/root
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> daemon daemon <span class="m">0</span> Feb <span class="m">12</span> 11:23 /proc/2736/root -&gt; /home/bitnami/nginxstack-chroot/home/bitnami/nginxstack/apps/bla.example.com/htdocs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Voila!</p>
<h2 id="conclusion">Conclusion</h2>
<p>The Bitnami nginx stack is a really easy-to-configure bundle one can either use in a dev or productive environment. Applying additional security measurements to it like <code>chroot</code> will help you to mitigate the impact of a potential attack. Again: <strong>chroot != security</strong>. Don&rsquo;t blindly rely on <code>chroot</code> and make sure you deeply understand how this technology works and what its potential risks could damage your business.</p>

    

  </div>
  <div id="comments">
      

  </div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="https://blog.dornea.nu/2016/02/01/bye-bye-vodka/">prev</a>
  <a href="https://blog.dornea.nu/2016/04/12/aws-summit-in-berlin-2016/">next</a>
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
  2009-2024 Victor Dorneanu - All rights reserved
  <a href="https://blog.dornea.nu/feed.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
</footer>

  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
