<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <title>ringzer0 CTF - Binaries - Heap Allocator - blog.dornea.nu</title>
  <meta content='ringzer0 CTF - Binaries - Heap Allocator - blog.dornea.nu' property='title' />
  <meta content='ringzer0 CTF - Binaries - Heap Allocator - blog.dornea.nu' property='og:title' />


<meta property="og:description" content="First let&rsquo;s collect some information about the binary itself:
$ readelf IntelligenSoftware -h ELF Header: Magic: 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 Class: ELF64 Data: 2&#39;s complement, little endian Version: 1 (current) OS/ABI: UNIX - System V ABI Version: 0 Type: EXEC (Executable file) Machine: Advanced Micro Devices X86-64 Version: 0x1 Entry point address: 0x400688 Start of program headers: 64 (bytes into file) Start of section headers: 4608 (bytes into file) Flags: 0x0 Size of this header: 64 (bytes) Size of program headers: 56 (bytes) Number of program headers: 9 Size of section headers: 64 (bytes) Number of section headers: 30 Section header string table index: 27 Let&rsquo;s see some code:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.dornea.nu/2016/11/30/ringzer0-ctf-binaries-heap-allocator/" />


<meta property="article:published_time" content="2016-11-30T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2016-11-30T00:00:00&#43;00:00"/>








<meta name="generator" content="Hugo 0.89.4" />

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />

</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/' title="Home">Home</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://dornea.nu' title="About">About</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">ringzer0 CTF - Binaries - Heap Allocator</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>30 Nov 2016</time> 
     | 
    
    
    tags: [ <a href='https://blog.dornea.nu/tags/ringzer0' class="link silver">ringzer0</a> <a href='https://blog.dornea.nu/tags/ctf' class="link silver">ctf</a> <a href='https://blog.dornea.nu/tags/wargames' class="link silver">wargames</a> <a href='https://blog.dornea.nu/tags/asm' class="link silver">asm</a> <a href='https://blog.dornea.nu/tags/x86' class="link silver">x86</a> <a href='https://blog.dornea.nu/tags/sploitfun' class="link silver">sploitfun</a>  ]
    
  </p>
  <div class="lh-copy post-content"><p>First let&rsquo;s collect some information about the binary itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ readelf IntelligenSoftware -h
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
  Data:                              2&#39;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x400688
  Start of program headers:          64 (bytes into file)
  Start of section headers:          4608 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         9
  Size of section headers:           64 (bytes)
  Number of section headers:         30
  Section header string table index: 27

</code></pre></div><p>Let&rsquo;s see some code:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ objdump -d IntelligentSoftware -j .text 
...
0000000000400660 &lt;main&gt;:
  400660:       48 83 ec 08             sub    $0x8,%rsp
  400664:       ba a0 10 60 00          mov    $0x6010a0,%edx
  400669:       be 87 08 40 00          mov    $0x400887,%esi
  40066e:       bf 01 00 00 00          mov    $0x1,%edi
  400673:       31 c0                   xor    %eax,%eax
  400675:       e8 26 ff ff ff          callq  4005a0 &lt;__printf_chk@plt&gt;
  40067a:       31 c0                   xor    %eax,%eax
  40067c:       e8 ff 00 00 00          callq  400780 &lt;get_flag&gt;
  400681:       31 c0                   xor    %eax,%eax
  400683:       48 83 c4 08             add    $0x8,%rsp
  400687:       c3                      retq
</code></pre></div><p>Nothing interesting here. But there is a <code>call</code> to <code>get_flag</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">0000000000400780 &lt;get_flag&gt;:
  400780:       53                      push   %rbx
  400781:       bf 00 04 00 00          mov    $0x400,%edi
  400786:       e8 05 fe ff ff          callq  400590 &lt;malloc@plt&gt;
  40078b:       be 54 08 40 00          mov    $0x400854,%esi
  400790:       48 89 c3                mov    %rax,%rbx
  400793:       48 89 c2                mov    %rax,%rdx
  400651:       eb d0                   jmp    400623 &lt;__libc_csu_ctor+0x73&gt;
  400653:       66 a5                   movsw  %ds:(%rsi),%es:(%rdi)
  400655:       83 e8 02                sub    $0x2,%eax
  400658:       eb cf                   jmp    400629 &lt;__libc_csu_ctor+0x79&gt;
  40065a:       e8 01 ff ff ff          callq  400560 &lt;__stack_chk_fail@plt&gt;
  40065f:       90                      nop
</code></pre></div><p>And there is some <code>jmp</code> to a <strong>libc constructor</strong> (`__libc_csu_ctor').</p>
<h3 id="libc-constructors--destructors">Libc constructors / destructors</h3>
<p>If you don&rsquo;t have a clue what <strong>libc</strong> constructors/destructors are, make sure
you have a look at:</p>
<ul>
<li><a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">Linux x86 Program Start Up</a></li>
<li><a href="http://bottomupcs.sourceforge.net/csbu/x3564.htm">Starting a process</a></li>
<li><a href="http://eli.thegreenplace.net/2012/08/13/how-statically-linked-programs-run-on-linux">How statically linked programs run on Linux</a></li>
<li><a href="http://nairobi-embedded.org/070_elf_c_runtime.html">C Run-time for ELF Executables</a></li>
</ul>
<h3 id="dynamic-analysis">Dynamic analysis</h3>
<p>Again using <code>radare</code> I&rsquo;ll disassemble <code>get_flag</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[0x00400688]&gt; pdf @ sym.get_flag
/ (fcn) sym.get_flag 73
|   sym.get_flag ();
|       |   ; CALL XREF from 0x0040067c (sym.main)
|       |   0x00400780      53             push rbx
|       |   0x00400781      bf00040000     mov edi, 0x400
|       |   0x00400786      e805feffff     call sym.imp.malloc        ;  void *malloc(size_t size);
|       |   0x0040078b      be54084000     mov esi, str.Allocating_1024_bytes__p..._n ; &#34;Allocating 1024 bytes %p....&#34; @ 0x400854
|       |   0x00400790      4889c3         mov rbx, rax
|       |   0x00400793      4889c2         mov rdx, rax
|       |   0x00400796      bf01000000     mov edi, 1
|       |   0x0040079b      31c0           xor eax, eax
|       |   0x0040079d      e8fefdffff     call sym.imp.__printf_chk
|       |   0x004007a2      4889df         mov rdi, rbx
|       |   0x004007a5      e896fdffff     call sym.imp.free          ; void free(void *ptr);
|       |   0x004007aa      4889da         mov rdx, rbx
|       |   0x004007ad      bf01000000     mov edi, 1
|       |   0x004007b2      be71084000     mov esi, str.Freeing_buffer__p..._n ; &#34;Freeing buffer %p....&#34; @ 0x400871
|       |   0x004007b7      31c0           xor eax, eax
|       |   0x004007b9      e8e2fdffff     call sym.imp.__printf_chk
|       |   0x004007be      5b             pop rbx
|       |   0x004007bf      bf90084000     mov edi, str.Heap_is_working_perfectly__No_Flag_then ; &#34;Heap is working perfectly! No Flag then&#34; @ 0x400890
\       `=&lt; 0x004007c4      e987fdffff     jmp sym.imp.puts
</code></pre></div><p>Nothing suspicious about it: <code>malloc</code> is being called and then <code>free</code>. Now let&rsquo;s have a look at the constructors, which are usually
called before <code>main</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[0x00400688]&gt; pdf @ entry0
            ;-- _start:
/ (fcn) entry0 41
|   entry0 ();
|           ; UNKNOWN XREF from 0x00400018 (unk)
|           0x00400688      31ed           xor ebp, ebp
|           0x0040068a      4989d1         mov r9, rdx
|           0x0040068d      5e             pop rsi
|           0x0040068e      4889e2         mov rdx, rsp
|           0x00400691      4883e4f0       and rsp, 0xfffffffffffffff0
|           0x00400695      50             push rax
|           0x00400696      54             push rsp
|           0x00400697      49c7c0400840.  mov r8, sym.__libc_csu_fini ; sym.__libc_csu_fini
|           0x0040069e      48c7c1d00740.  mov rcx, sym.__libc_csu_init ; &#34;AWA..AVI..AUI..ATL.% . &#34; @ 0x4007d0
|           0x004006a5      48c7c7600640.  mov rdi, sym.main           ; &#34;H......`&#34; @ 0x400660
\           0x004006ac      e8bffeffff     call sym.imp.__libc_start_main; int __libc_start_main(func main, int argc, char **ubp_av, func init, func fini, func rtld_fini, void *stack_end);
</code></pre></div><p>Ahh, there we go. From the links mentioned before we know that <code>__libc_start_main</code> has following syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.c" data-lang=".c"><span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">__libc_start_main</span>( 
	<span style="color:#6ab825;font-weight:bold">int</span> (*main) (<span style="color:#6ab825;font-weight:bold">int</span>, <span style="color:#6ab825;font-weight:bold">char</span> * *, <span style="color:#6ab825;font-weight:bold">char</span> * *), 
	<span style="color:#6ab825;font-weight:bold">int</span> argc, 
	<span style="color:#6ab825;font-weight:bold">char</span> * * ubp_av, 
	<span style="color:#6ab825;font-weight:bold">void</span> (*init) (<span style="color:#6ab825;font-weight:bold">void</span>), 
	<span style="color:#6ab825;font-weight:bold">void</span> (*fini) (<span style="color:#6ab825;font-weight:bold">void</span>), 
	<span style="color:#6ab825;font-weight:bold">void</span> (*rtld_fini) (<span style="color:#6ab825;font-weight:bold">void</span>), 
	<span style="color:#6ab825;font-weight:bold">void</span> (* stack_end)
);
</code></pre></div><p>So before calling <code>main</code> its arguments are copied to the corresponding registers. Since we&rsquo;re dealing with <code>x86-64</code>
the <strong>ABI</strong> requires that registers are used instead of the stack. On Linux we have the <a href="https://en.wikipedia.org/wiki/X86_calling_conventions#System_V_AMD64_ABI">System V AMD64 ABI</a> calling convention which uses following registers for the parameters:</p>
<ul>
<li>RDI</li>
<li>RSI</li>
<li>RDX</li>
<li>RCX</li>
<li>R8</li>
<li>R9</li>
</ul>
<p>Additional arguments can be passed on the stack. In our case we have:</p>
<details>
  <summary style="background-color:#f5f5f5;border:1px solid #ccc;padding:5px;">
    Graphviz code
    
  </summary>
  <pre><code>digraph G {
    // Define layout
    graph [pad=&quot;.75&quot;, ranksep=&quot;0.95&quot;, nodesep=&quot;0.05&quot;];
    rankdir=LR;
    node [shape=&quot;record&quot;];
    rank=same;
 
    // Define pointers
    rsp [
        label=&quot;&lt;p&gt; $rdi \l&quot;, height=&quot;0.1&quot;,
        color=white, fontcolor=black,fontsize=9,style=filled, fillcolor=white
    ];
    
    // rbp [
    // 	label=&quot;&lt;p&gt; $rbp \l&quot;, height=&quot;0.1&quot;,
    // 	color=white, fontcolor=black,fontsize=9,style=filled, fillcolor=white
    // ];
 
    rsp_4 [
        label=&quot;&lt;p&gt; $rsi \l&quot;, height=&quot;0.01&quot;,
        color=white, fontcolor=black,fontsize=9,style=filled, fillcolor=white
    ];
 
 
    rsp_8 [
        label=&quot;&lt;p&gt; $rdx \l&quot;, height=&quot;0.01&quot;,
        color=white, fontcolor=black,fontsize=9,style=filled, fillcolor=white,
    ];
 
    rsp_12 [
        label=&quot;&lt;p&gt; $rcx \l&quot;, height=&quot;0.01&quot;,
        color=white, fontcolor=black,fontsize=9,style=filled, fillcolor=white,
    ];
    
    rsp_16 [
        label=&quot;&lt;p&gt; $r8 \l&quot;, height=&quot;0.01&quot;,
        color=white, fontcolor=black,fontsize=9,style=filled, fillcolor=white,
    ];
    
    rsp_20 [
        label=&quot;&lt;p&gt; $r9 \l&quot;, height=&quot;0.01&quot;,
        color=white, fontcolor=black,fontsize=9,style=filled, fillcolor=white,
    ];
 
    // Define stack
    stack [
        width=&quot;3&quot;,
        label=&quot;&lt;p&gt;\nArguments\n\n | &lt;bp&gt;\n...\n\n | &lt;20&gt;0x7ffff7de9900 (_dl_fini) \l| &lt;16&gt;0x00400840 (sym.__libc_csu_fini) \l| &lt;12&gt;0x4007d0 (sym.__libc_csu_init)  \l | &lt;8&gt;(char **ubp_av = $rsp) \l | &lt;4&gt;(int argc = pop)  \l | &lt;0&gt;0x400660 (sym.main) \l&quot;
    ];
   
   
    // Pointer -&gt; Stack edges
    //rbp:p -&gt; stack:bp [style=invis];
    rsp:p -&gt; stack:0 [style=invis];
    rsp_4:p -&gt; stack:4 [style=invis];
    rsp_8:p -&gt; stack:8 [style=invis];
    rsp_12:p -&gt; stack:12 [style=invis];
    rsp_16:p -&gt; stack:16 [style=invis];
    rsp_20:p -&gt; stack:20 [style=invis];
}
</code></pre>

</details>

<p><img src="https://blog.dornea.nu/posts/img/2016/r0-binaries-heap-allocator/stack.dot.png" alt=""></p>
<p>As stated <a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">here</a> <code>__libc_start_main</code> does
the following:</p>
<ul>
<li>Takes care of some security problems with setuid setgid programs</li>
<li>Starts up threading</li>
<li>Registers the fini (our program), and rtld_fini (run-time loader) arguments to get run by at_exit to run the program&rsquo;s and the loader&rsquo;s cleanup routines</li>
<li>Calls the init argument</li>
<li>Calls the main with the argc and argv arguments passed to it and with the global __environ argument as detailed above.</li>
<li>Calls exit with the return value of main</li>
</ul>
<p>The <code>init</code> argument is set to <code>__libc_csu_init</code>. In the <strong>glibc</strong> source tree you will find <code>csu/elf-init.c</code> which contains <code>__libc_csu_init</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.c" data-lang=".c"><span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">__libc_csu_init</span> (<span style="color:#6ab825;font-weight:bold">int</span> argc, <span style="color:#6ab825;font-weight:bold">char</span> **argv, <span style="color:#6ab825;font-weight:bold">char</span> **envp) {
	 _init (); 
	
	<span style="color:#6ab825;font-weight:bold">const</span> size_t size = __init_array_end - __init_array_start; 
	<span style="color:#6ab825;font-weight:bold">for</span> (size_t i = <span style="color:#3677a9">0</span>; i &lt; size; i++) 
		(*__init_array_start [i]) (argc, argv, envp); 
}
</code></pre></div><p>Let&rsquo;s have a look at the disassembly:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[0x00400688]&gt; pdf @ sym.__libc_csu_init
/ (fcn) sym.__libc_csu_init 101
|   sym.__libc_csu_init ();
|           ; DATA XREF from 0x0040069e (entry0)
|           ; DATA XREF from 0x004005c4 (sym.__libc_csu_ctor)
|           ; DATA XREF from 0x004005c9 (sym.__libc_csu_ctor)
|           0x004007d0      4157           push r15
|           0x004007d2      4189ff         mov r15d, edi
|           ; DATA XREF from 0x004005d2 (sym.__libc_csu_ctor)
|           0x004007d5      4156           push r14
|           0x004007d7      4989f6         mov r14, rsi
|           0x004007da      4155           push r13
|           0x004007dc      4989d5         mov r13, rdx
|           0x004007df      4154           push r12
|           0x004007e1      4c8d25200620.  lea r12, qword obj.__frame_dummy_init_array_entry ; 0x600e08 ; loc.__init_array_start ; &#34;P.@&#34; @ 0x600e08
|           0x004007e8      55             push rbp
|           0x004007e9      488d2d280620.  lea rbp, qword obj.__do_global_dtors_aux_fini_array_entry ; 0x600e18 ; loc.__init_array_end ; &#34;0.@&#34; @ 0x600e18
|           0x004007f0      53             push rbx
|           0x004007f1      4c29e5         sub rbp, r12
|           0x004007f4      31db           xor ebx, ebx
|           0x004007f6      48c1fd03       sar rbp, 3
|           0x004007fa      4883ec08       sub rsp, 8
|           0x004007fe      e805fdffff     call sym._init
|           0x00400803      4885ed         test rbp, rbp
|       ,=&lt; 0x00400806      741e           je 0x400826
|       |   0x00400808      0f1f84000000.  nop dword [rax + rax]
|      .--&gt; 0x00400810      4c89ea         mov rdx, r13
|      ||   0x00400813      4c89f6         mov rsi, r14
|      ||   0x00400816      4489ff         mov edi, r15d
|      ||   0x00400819      41ff14dc       call qword [r12 + rbx*8]
|      ||   0x0040081d      4883c301       add rbx, 1
|      ||   0x00400821      4839eb         cmp rbx, rbp
|      `==&lt; 0x00400824      75ea           jne 0x400810
|       `-&gt; 0x00400826      4883c408       add rsp, 8
|           0x0040082a      5b             pop rbx
|           0x0040082b      5d             pop rbp
|           0x0040082c      415c           pop r12
|           0x0040082e      415d           pop r13
|           0x00400830      415e           pop r14
|           0x00400832      415f           pop r15
\           0x00400834      c3             ret
</code></pre></div><p>You can definitely see the call to <code>_init()</code>. The loop inside looks very interesting:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">|       |   0x08048592      8db600000000   lea esi, [esi]
|      .--&gt; 0x08048598      8b442438       mov eax, dword [esp + arg_38h] ; [0x38:4]=52 ; &#39;8&#39;
|      ||   0x0804859c      892c24         mov dword [esp], ebp
|      ||   0x0804859f      89442408       mov dword [esp + local_8h], eax
|      ||   0x080485a3      8b442434       mov eax, dword [esp + arg_34h] ; [0x34:4]=6 ; &#39;4&#39;
|      ||   0x080485a7      89442404       mov dword [esp + local_4h], eax
|      ||   0x080485ab      ff94b308ffff.  call dword [ebx + esi*4 - 0xf8]
|      ||   0x080485b2      83c601         add esi, 1
|      ||   0x080485b5      39fe           cmp esi, edi
|      `==&lt; 0x080485b7      75df           jne 0x8048598
</code></pre></div><p>Let&rsquo;s have a look what&rsquo;s happening inside this loop:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">gef&gt; b *0x0000000000400803
gef&gt; r
gef&gt; 
0x0000000000400819    &lt;__libc_csu_init+73&gt;     call   QWORD PTR [r12+rbx*8]   &lt;- $pc

gef&gt; x/x $r12
0x600e08:       0x00400750
gef&gt; x/x $rbx
0x0:    Cannot access memory at address 0x0
</code></pre></div><p>As you can see the address at <code>$r12 + rbx*8</code> will be called. Since <code>$rbx</code> is null the programm
execution will jump to the address <code>0x00400750</code>. But where does this address come from?</p>
<h3 id="constructors">Constructors</h3>
<p>As you have seen previously an <code>init_array</code> is used to call some functions. In C you&rsquo;d usually
implement some constructors using <code>__attribute__</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.c" data-lang=".c"><span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">init</span>(<span style="color:#6ab825;font-weight:bold">int</span> argc, <span style="color:#6ab825;font-weight:bold">char</span> **argv, <span style="color:#6ab825;font-weight:bold">char</span> **envp) { 
	printf(<span style="color:#ed9d13">&#34;INIT!&#34;</span>); 
}
__attribute__((section(<span style="color:#ed9d13">&#34;.init_array&#34;</span>))) typeof(init) *__init = init;
</code></pre></div><p>This whole information is stored inside the ELF binary at a section called <code>init_array</code>. Let&rsquo;s
see what it contains:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ objdump -d -j .init_array IntelligentSoftware

IntelligentSoftware:     file format elf64-x86-64


Disassembly of section .init_array:

0000000000600e08 &lt;__frame_dummy_init_array_entry&gt;:
  600e08:       50 07 40 00 00 00 00 00 b0 05 40 00 00 00 00 00     P.@.......@.....
</code></pre></div><p>Did you recognize the address <code>0x600e08</code> and the value <code>0x00400750</code>? Let&rsquo;s go back to <code>radare</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[0x00400688]&gt; pxr @ obj.__frame_dummy_init_array_entry
0x00600e08  0x0000000000400750   P.@..... (.text) sym.frame_dummy sym.frame_dummy R X &#39;cmp qword [rip + 0x2006c8], 0&#39;
0x00600e10  0x00000000004005b0   ..@..... (.text) sym.__libc_csu_ctor sym.__libc_csu_ctor R X &#39;sub rsp, 0x48&#39;
0x00600e18  0x0000000000400730   0.@..... (.text) sym.__do_global_dtors_aux sym.__do_global_dtors_aux R X &#39;cmp byte [rip + 0x200998], 0&#39;
0x00600e20  0x0000000000000000   ........ section_end.GNU_STACK
...
</code></pre></div><p>Let&rsquo;s have a look at the <strong>2nd</strong>  constructor/entry:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">/ (fcn) sym.__libc_csu_ctor 216
|   sym.__libc_csu_ctor ();
|           ; var int local_8h @ rsp+0x8
|           ; var int local_10h @ rsp+0x10
|           ; var int local_11h @ rsp+0x11
|           ; var int local_12h @ rsp+0x12
|           ; var int local_14h @ rsp+0x14
|           ; var int local_18h @ rsp+0x18
|           ; var int local_38h @ rsp+0x38
|           ; UNKNOWN XREF from 0x00400e10 (unk)
|           ; CALL XREF from 0x004005b0 (sym.__libc_csu_ctor)
|           0x004005b0      4883ec48       sub rsp, 0x48               ; &#39;H&#39; ; [13] va=0x004005b0 pa=0x000005b0 sz=658 vsz=658 rwx=--r-x .text
|           0x004005b4      64488b042528.  mov rax, qword fs:[0x28]    ; [0x28:8]=0x1200 ; &#39;(&#39;
|           0x004005bd      4889442438     mov qword [rsp + local_38h], rax
|           0x004005c2      31c0           xor eax, eax
|           0x004005c4      b8d0074000     mov eax, sym.__libc_csu_init ; &#34;AWA..AVI..AUI..ATL.% . &#34; @ 0x4007d0
|           0x004005c9      48c7442408d0.  mov qword [rsp + local_8h], sym.__libc_csu_init ; [0x4007d0:8]=0x495641ff89415741 LEA sym.__libc_csu_init ; &#34;AWA..AVI..AUI..ATL.% . &#34; @ 0x4007d0
|           0x004005d2      678b4005       mov eax, dword [eax + 5]    ; [0x5:4]=257
|           0x004005d6      3ccc           cmp al, 0xcc
|       ,=&lt; 0x004005d8      7415           je 0x4005ef
|       |   ; JMP XREF from 0x0040064c (sym.__libc_csu_ctor)
|       |   0x004005da      488b442438     mov rax, qword [rsp + local_38h] ; [0x38:8]=0x1b001e00400009 ; &#39;8&#39;
|       |   0x004005df      644833042528.  xor rax, qword fs:[0x28]
|      ,==&lt; 0x004005e8      7570           jne 0x40065a
|      ||   0x004005ea      4883c448       add rsp, 0x48               ; &#39;H&#39;
|      ||   0x004005ee      c3             ret
|      |`-&gt; 0x004005ef      488b3d8a0a20.  mov rdi, qword [obj.__libc_ptr] ; [0x601080:8]=0x6010a0 obj.banner LEA obj.__libc_ptr ; obj.__libc_ptr
|      |    0x004005f6      c644241046     mov byte [rsp + local_10h], 0x46 ; &#39;F&#39; ; [0x46:1]=0 ; &#39;F&#39;
|      |    0x004005fb      488d742410     lea rsi, qword [rsp + local_10h] ; 0x10
|      |    0x00400600      c64424114c     mov byte [rsp + local_11h], 0x4c ; &#39;L&#39; ; [0x4c:1]=0 ; &#39;L&#39;
|      |    0x00400605      66c744241833.  mov word [rsp + local_18h], 0x3933 ; [0x3933:2]=0xffff
|      |    0x0040060c      b828000000     mov eax, 0x28               ; &#39;(&#39;
|      |    0x00400611      66c744241241.  mov word [rsp + local_12h], 0x4741 ; [0x4741:2]=0xffff
|      |    0x00400618      c64424142d     mov byte [rsp + local_14h], 0x2d ; &#39;-&#39; ; [0x2d:1]=0 ; &#39;-&#39;
|      |    0x0040061d      40f6c701       test dil, 1
|      |,=&lt; 0x00400621      752b           jne 0x40064e
|      ||   ; JMP XREF from 0x00400651 (sym.__libc_csu_ctor)
|      ||   0x00400623      40f6c702       test dil, 2
|     ,===&lt; 0x00400627      752a           jne 0x400653
|     |||   ; JMP XREF from 0x00400658 (sym.__libc_csu_ctor)
|     |||   0x00400629      89c1           mov ecx, eax
|     |||   0x0040062b      31d2           xor edx, edx
|     |||   0x0040062d      c1e902         shr ecx, 2
|     |||   0x00400630      a802           test al, 2

</code></pre></div><p>Do you see how the string <code>FLAG-</code> is being concatenated? Let&rsquo;s <code>seek</code> to that address and let <code>radare</code> give us some
graphics:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[0x00400688]&gt; s 0x00000000004005b
[0x004005b0]&gt; VV

                                                         =---------------------------------=
                                                         | [0x4005b0]                      |
                                                         | 0x004005c4 sym.__libc_csu_init  |
                                                         | 0x004005c9 sym.__libc_csu_init  |
                                                         =---------------------------------=
                                                               t f
                                                             .-&#39; &#39;-----------------.
                                                             |                     |
                                                             |                     |
                                                       =--------------------=      |
                                                       |  0x4005ef          |      |
                                                       =--------------------=      |
                                                             t f                   |
                                                       .-----&#39; &#39;-------------.     |
                                                       |                     |     |
                                                       |                     |     |
                                                 =--------------------=      |     |
                                                 |  0x40064e          |      |     |
                                                 =--------------------=      |     |
                                                     v                       |     |
                                                     &#39;-----.   .-------------&#39;     |
                                                           |   |                   |
                                                           |   |                   |
                                                       =--------------------=      |
                                                       |  0x400623          |      |
                                                       =--------------------=      |
                                                             t f                   |
                                                       .-----&#39; &#39;-------------.     |
                                                       |                     |     |
                                                       |                     |     |
                                                 =--------------------=      |     |
                                                 |  0x400653          |      |     |
                                                 =--------------------=      |     |
                                                     v                       |     |
                                                     &#39;-----.   .-------------&#39;     |
                                                           |   |                   |
                                                           |   |                   |
                                                       =--------------------=      |
                                                       |  0x400629          |      |
                                                       =--------------------=      |
                                                               f t                 |
                                                         .-----&#39; &#39;-----------.     |
                                                         |                   |     |
                                                         |                   |     |
                                                 =--------------------=      |     |
                                                 |  0x400636          |      |     |
                                                 =--------------------=      |     |
                                                     v                       |     |
                                                     &#39;-----.     .-----------&#39;     |
                                                           |     |                 |
                                                           |     |                 |
                                                       =--------------------=      |
                                                       |  0x400641          |      |
                                                       =--------------------=      |
                                                               f t                 |
                                                         .-----&#39; &#39;-----------.     |
                                                         |                   |     |
                                                         |                   |     |
                                                 =--------------------=      |     |
                                                 |  0x400645          |      |     |
                                                 =--------------------=      |     |
                                                     v                       |     |
                                                     &#39;------------.   .-.----&#39;-----&#39;
                                                                  |   | |
                                                                  |   | |
                                                              =--------------------=
                                                              |  0x4005da          |
                                                              =--------------------=
                                                                    t f
                                      .-----------------------------&#39; &#39;-------------------.
                                      |                                                   |
                                      |                                                   |
                                =------------------------------------------=      =--------------------=
                                |  0x40065a                                |      |  0x4005ea          |
                                | 0x0040065a call sym.imp.__stack_chk_fail |      =--------------------=
                                | 0x00400675 call sym.imp.__printf_chk     |
                                | 0x0040067c call sym.get_flag             |
                                =------------------------------------------=

</code></pre></div><p>As you can see there is one execution path which will directly lead to <code>0x4005da</code> and then either
to <code>0x4005ea</code> or <code>sym.imp.__stack_chk_fail</code> if sth was wrong with the stack (this function
wil be called if the stack canaries were modified). Now let&rsquo;s have a look what happens inside
the first block:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">                =----------------------------------------------------------------------------=
                | [0x4005b0]                                                                 |
                |   ;-- section_end..plt:                                                    |
                |   ;-- section..text:                                                       |
                | (fcn) sym.__libc_csu_ctor 216                                              |
                |   sym.__libc_csu_ctor ();                                                  |
                | ; var int local_8h @ rsp+0x8                                               |
                | ; var int local_10h @ rsp+0x10                                             |
                | ; var int local_11h @ rsp+0x11                                             |
                | ; var int local_12h @ rsp+0x12                                             |
                | ; var int local_14h @ rsp+0x14                                             |
                | ; var int local_18h @ rsp+0x18                                             |
                | ; var int local_38h @ rsp+0x38                                             |
                | 0x004005b0 4883ec48       sub rsp, 0x48                                    |
                | 0x004005b4 64488b042528.  mov rax, qword fs:[0x28]                         |
                | 0x004005bd 4889442438     mov qword [rsp + local_38h], rax                 |
                | 0x004005c2 31c0           xor eax, eax                                     |
                | 0x004005c4 b8d0074000     mov eax, sym.__libc_csu_init                     |
                | 0x004005c9 48c7442408d0.  mov qword [rsp + local_8h], sym.__libc_csu_init  |
                | 0x004005d2 678b4005       mov eax, dword [eax + 5]                         |
                | 0x004005d6 3ccc           cmp al, 0xcc                                     |
                | 0x004005d8 7415           je 0x4005ef ;[a]                                 |
                =----------------------------------------------------------------------------=
                      t f
          .-----------&#39; &#39;-------------------------------------------------.
          |                                                               |
          |                                                               |
    =---------------------------------------------------------------=     |
    |  0x4005ef                                                     |     |
    | 0x004005ef 488b3d8a0a20.  mov rdi, qword [obj.__libc_ptr]     |     |
    | 0x004005f6 c644241046     mov byte [rsp + local_10h], 0x46    |     |
    | 0x004005fb 488d742410     lea rsi, qword [rsp + local_10h]    |     |
    | 0x00400600 c64424114c     mov byte [rsp + local_11h], 0x4c    |     |
    | 0x00400605 66c744241833.  mov word [rsp + local_18h], 0x3933  |     |
    | 0x0040060c b828000000     mov eax, 0x28                       |     |
    | 0x00400611 66c744241241.  mov word [rsp + local_12h], 0x4741  |     |
    | 0x00400618 c64424142d     mov byte [rsp + local_14h], 0x2d    |     |
    | 0x0040061d 40f6c701       test dil, 1                         |     |
    | 0x00400621 752b           jne 0x40064e ;[b]                   |     |
    =---------------------------------------------------------------=     |

</code></pre></div><p>Apparently the programm will jump to <code>0x4005ef</code> only if <code>$al = 0xcc</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">|           0x004005d6      3ccc           cmp al, 0xcc
|       ,=&lt; 0x004005d8      7415           je 0x4005ef
</code></pre></div><p>Let&rsquo;s debug the binary and see what happens:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">gef&gt;  b *0x004005d6
Breakpoint 1 at 0x4005d6
gef&gt;  r
gef&gt;  set $al=0xcc
gef&gt;  c
Continuing.
FLAG-Allocating 1024 bytes 0x602420...
Freeing buffer 0x602420...
Heap is working perfectly! No Flag then
[Inferior 1 (process 1745) exited normally]
</code></pre></div><p>Well <code>FLAG-Allocating</code> looks like a flag! ;)</p>
</div>
  <div id="comments">
      
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dorneanu" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="https://blog.dornea.nu/2016/11/29/ringzer0-ctf-binaries-time-to-learn-x86-asm-and-gdb/">prev</a>
  <a href="https://blog.dornea.nu/2016/12/09/ringzer0-ctf-binaries-introduction-to-mips/">next</a>
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
  2009-2022 Victor Dorneanu - All rights reserved
  <a href="https://blog.dornea.nu/feed.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
</footer>

  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
