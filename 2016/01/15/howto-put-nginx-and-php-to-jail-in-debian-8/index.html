<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <title>HowTo: Put nginx and PHP to jail in Debian 8 - blog.dornea.nu</title>
  <meta content='HowTo: Put nginx and PHP to jail in Debian 8 - blog.dornea.nu' property='title' />
  <meta content='HowTo: Put nginx and PHP to jail in Debian 8 - blog.dornea.nu' property='og:title' />


<meta property="og:description" content="Although I thought this would be an easy task, it turned out that chrooting daemons takes more than copying config files and libraries. There are donzens of tutorials out there how to do it, but the devil lies in detail - as always. Setting up a chroot environment is easy. But securing it properly is prone to faults which in worst case could let an attacker escape the chroot. And this is your worst nightmare, right?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.dornea.nu/2016/01/15/howto-put-nginx-and-php-to-jail-in-debian-8/" />


<meta property="article:published_time" content="2016-01-15T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2016-01-15T00:00:00&#43;00:00"/>








<meta name="generator" content="Hugo 0.78.1" />

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='http://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='http://blog.dornea.nu/css/styles.css' rel="stylesheet">


<link rel="icon" 
 
  href='http://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='http://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />
</head>
<body class="global-font">
  <nav class=" flex-ns justify-between border-box pa3 pl3-l pr2-l mt1 mt0-ns" id="navbar">
  <div class="flex">
    <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph2 br2" id="site-title" href='http://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
  </div>
  
  <div class=" flex-ns mt2 mt0-ns pv1">
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/' title="Home">Home</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://dornea.nu' title="About">About</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/tags' title="Tags">Tags</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org/bookmarks.html' title="Bookmarks">Bookmarks</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='https://brainfck.org/bib.html' title="Books">Books</a>
    
      <a class="link dim dark-gray f6 dib mr2 mr3-l ttu tracked" href='http://blog.dornea.nu/notes' title="Notes">Notes</a>
    
  </div>
  
</nav>
  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">HowTo: Put nginx and PHP to jail in Debian 8</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>15 Jan 2016</time> 
     | 
    
    
    tags: [ <a href='http://blog.dornea.nu/tags/nginx' class="link silver">nginx</a> <a href='http://blog.dornea.nu/tags/php' class="link silver">php</a> <a href='http://blog.dornea.nu/tags/admin' class="link silver">admin</a> <a href='http://blog.dornea.nu/tags/debian' class="link silver">debian</a> <a href='http://blog.dornea.nu/tags/chroot' class="link silver">chroot</a> <a href='http://blog.dornea.nu/tags/security' class="link silver">security</a>  ]
    
  </p>
  <div class="lh-copy post-content"><p>Although I thought this would be an easy task, it turned out that <strong>chrooting</strong> daemons takes more than copying config files and libraries. There are donzens of tutorials out there how to do it, but the devil lies in detail - as always. Setting up a chroot environment is easy. But securing it properly is prone to faults which in worst case could let an attacker escape the chroot. And this is your worst nightmare, right? So let&rsquo;s have a look at some more technical details.</p>
<p>For those unfamiliar with <code>chroot</code> make sure you have a look at least the <a href="https://en.wikipedia.org/wiki/Chroot">Wikipedia entry</a>.  There are also soms <a href="http://www.unixwiz.net/techtips/chroot-practices.html">chroot best practices</a> you could have a look at. Although there are better alternatives solving this job (e.g. docker) and being unable to load <strong>LSM</strong> (<a href="https://en.wikipedia.org/wiki/Linux_Security_Modules">Linux Security Modules</a>) on a vServer, putting a daemon to <em>jails</em> seems to be a pretty good approach. But there are several things one should keep in mind since <code>chroot</code> isn&rsquo;t a security feature per se (make sure you read <a href="https://securityblog.redhat.com/2013/03/27/is-chroot-a-security-feature/">&ldquo;Is chroot a security feature?&quot;</a> and <a href="https://lwn.net/Articles/252794/">&ldquo;What chroot() is really for&rdquo;</a>).</p>
<h2 id="before-starting">Before starting</h2>
<p>All the shell commands below are part of a <code>bash</code> script I use to setup a secure chroot. Use this <a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f">gist</a> to download the script files:</p>
<ul>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-chroot-sh">chroot.sh</a></li>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-n2chroot">n2chroot</a></li>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-nginx-chroot">nginx-chroot</a> (to copy to <code>/etc/init.d/*</code>)</li>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-php5-fpm-chroot">php5-fpm-chroot</a> (to copy to <code>/etc/init.d/*</code>)</li>
</ul>
<p>Make sure you <strong>edit</strong> the files and adapt <code>BASE</code> to your <strong>chroot path</strong> (in my scripts: <code>/var/www/chroot</code>).</p>
<h2 id="unleash-the-daemons">Unleash the daemons</h2>
<p>Nowadays hosting a typical PHP application is  pretty straight-forward. Several components are necesarry:</p>
<ul>
<li>web server (<code>nginx</code>) hosting the application</li>
<li>application (<code>PHP</code>)</li>
<li>data base (<code>mysqld</code>) for storing information</li>
</ul>
<p>The <code>mysqld</code> will usually listen on <em>localhost:3306</em> and can be thus accessed by the processes inside the chroot as well. The <code>nginx</code> and the <code>PHP</code> daemons have some dependencies to be installed inside the chroot otherwise you won&rsquo;t be able to run them. For the sake of example let&rsquo;s have a look at <code>nginx</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ ldd /usr/sbin/nginx
    linux-vdso.so.1 (0x00007fffe734d000)
    libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f47b5548000)
    libcrypt.so.1 =&gt; /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007f47b5311000)
    libpam.so.0 =&gt; /lib/x86_64-linux-gnu/libpam.so.0 (0x00007f47b5101000)
    libexpat.so.1 =&gt; /lib/x86_64-linux-gnu/libexpat.so.1 (0x00007f47b4ed8000)
    libpcre.so.3 =&gt; /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f47b4c6a000)
    libssl.so.1.0.0 =&gt; /usr/lib/x86_64-linux-gnu/libssl.so.1.0.0 (0x00007f47b4a09000)
    libcrypto.so.1.0.0 =&gt; /usr/lib/x86_64-linux-gnu/libcrypto.so.1.0.0 (0x00007f47b460e000)
[...]
</code></pre></div><p>So there are a lot of libraries which have to be copied into the chroot in order for the <code>nginx</code> binary to execute properly. But first, let&rsquo;s setup the basic directory structure.</p>
<h2 id="chroot-environment">chroot() environment</h2>
<p>First we&rsquo;ll create the basic directory structure and copy some basic stuff to it:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#999;font-style:italic"># Create devices</span>
$ mkdir <span style="color:#40ffff">$JAIL</span>/dev
$ mknod -m <span style="color:#3677a9">0666</span> <span style="color:#40ffff">$JAIL</span>/dev/null c <span style="color:#3677a9">1</span> <span style="color:#3677a9">3</span>
$ mknod -m <span style="color:#3677a9">0666</span> <span style="color:#40ffff">$JAIL</span>/dev/random c <span style="color:#3677a9">1</span> <span style="color:#3677a9">8</span>
$ mknod -m <span style="color:#3677a9">0444</span> <span style="color:#40ffff">$JAIL</span>/dev/urandom c <span style="color:#3677a9">1</span> <span style="color:#3677a9">9</span>

<span style="color:#999;font-style:italic"># Create directories</span>
$ mkdir -p <span style="color:#40ffff">$JAIL</span>/{etc,bin,usr,var}
$ mkdir -p <span style="color:#40ffff">$JAIL</span>/usr/{lib,sbin,bin}
$ mkdir -p <span style="color:#40ffff">$JAIL</span>/{run,tmp}
$ mkdir -p <span style="color:#40ffff">$JAIL</span>/var/run

<span style="color:#999;font-style:italic"># Check if 64-bit system</span>
$ <span style="color:#6ab825;font-weight:bold">if</span> [ <span style="color:#6ab825;font-weight:bold">$(</span>uname -m<span style="color:#6ab825;font-weight:bold">)</span> = <span style="color:#ed9d13">&#34;x86_64&#34;</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$JAIL</span>; ln -s usr/lib lib64
    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$JAIL</span>/usr; ln -s lib lib64
<span style="color:#6ab825;font-weight:bold">else</span>
    <span style="color:#24909d">cd</span> <span style="color:#40ffff">$JAIL</span>; ln -s usr/lib lib
<span style="color:#6ab825;font-weight:bold">fi</span>

<span style="color:#999;font-style:italic"># Copy important stuff</span>
$ cp -rfvL /etc/{services,localtime,nsswitch.conf,nscd.conf,protocols,hosts,ld.so.cache,ld.so.conf,resolv.conf,host.conf} <span style="color:#40ffff">$JAIL</span>/etc

</code></pre></div><h2 id="nginx">nginx</h2>
<p>Next we&rsquo;ll setup <code>nginx</code> and copy necessary config files and libraries:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#999;font-style:italic"># Create directories</span>
$ mkdir -p <span style="color:#40ffff">$JAIL</span>/usr/share/nginx
$ mkdir -p <span style="color:#40ffff">$JAIL</span>/var/{log,lib}/nginx
$ mkdir -p <span style="color:#40ffff">$JAIL</span>/www/cgi-bin

<span style="color:#999;font-style:italic"># Copy files</span>
$ cp -r /usr/share/nginx/* <span style="color:#40ffff">$JAIL</span>/usr/share/nginx
$ cp /usr/sbin/nginx <span style="color:#40ffff">$JAIL</span>/usr/sbin/
$ cp -r /var/lib/nginx <span style="color:#40ffff">$JAIL</span>/var/lib/nginx

<span style="color:#999;font-style:italic"># Copy libraries</span>
$ <span style="color:#ed9d13">${</span><span style="color:#40ffff">N2CHROOT</span><span style="color:#ed9d13">}</span> /usr/sbin/nginx

<span style="color:#999;font-style:italic"># Copy config files and other important stuff</span>
$ cp -rfvL /etc/nginx <span style="color:#40ffff">$JAIL</span>/etc

<span style="color:#999;font-style:italic"># Create PID file</span>
$ touch <span style="color:#40ffff">$JAIL</span>/run/nginx.pid

<span style="color:#999;font-style:italic"># Copy the nginx binary</span>
$ cp /usr/sbin/nginx <span style="color:#40ffff">$JAIL</span>/usr/sbin/
</code></pre></div><h3 id="troubleshooting">Troubleshooting</h3>
<p>First let&rsquo;s see if we can run the daemon at all:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ /usr/sbin/chroot <span style="color:#40ffff">$JAIL</span> /usr/sbin/nginx -t                
nginx: [emerg] getpwnam(<span style="color:#ed9d13">&#34;www-data&#34;</span>) failed in /etc/nginx/nginx.conf:1
nginx: configuration file /etc/nginx/nginx.conf <span style="color:#24909d">test</span> failed
</code></pre></div><p>OK. Let&rsquo;s have a look at <code>strace</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">mmap(NULL, 39842, PROT_READ, MAP_PRIVATE, 5, 0) = 0x7f1d0c620000
close(5)                                = <span style="color:#3677a9">0</span>
access(<span style="color:#ed9d13">&#34;/etc/ld.so.nohwcap&#34;</span>, F_OK)      = -1 ENOENT (No such file or directory)
open(<span style="color:#ed9d13">&#34;/lib/x86_64-linux-gnu/libnss_compat.so.2&#34;</span>, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
...
exit_group(1)                           = ?
+++ exited with <span style="color:#3677a9">1</span> +++
</code></pre></div><p>Apparently <code>libnss</code> can&rsquo;t be found. Let&rsquo;s fix that:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ find / -name <span style="color:#ed9d13">&#34;libnss*&#34;</span>
/lib/x86_64-linux-gnu/libnss_nis-2.19.so
/lib/x86_64-linux-gnu/libnss_compat-2.19.so
/lib/x86_64-linux-gnu/libnss_compat.so.2
/lib/x86_64-linux-gnu/libnss_nisplus.so.2
/lib/x86_64-linux-gnu/libnss_nis.so.2
/lib/x86_64-linux-gnu/libnss_files.so.2
/lib/x86_64-linux-gnu/libnss_dns.so.2
/lib/x86_64-linux-gnu/libnss_files-2.19.so
/lib/x86_64-linux-gnu/libnss_hesiod.so.2
/lib/x86_64-linux-gnu/libnss_nisplus-2.19.so
/lib/x86_64-linux-gnu/libnss_hesiod-2.19.so
/lib/x86_64-linux-gnu/libnss_dns-2.19.so
/usr/lib/x86_64-linux-gnu/libnss_nisplus.so
/usr/lib/x86_64-linux-gnu/libnss_hesiod.so
/usr/lib/x86_64-linux-gnu/libnss_compat.so
/usr/lib/x86_64-linux-gnu/libnss_files.so
/usr/lib/x86_64-linux-gnu/libnss_dns.so
/usr/lib/x86_64-linux-gnu/libnss_nis.so

<span style="color:#999;font-style:italic"># cp /lib/x86_64-linux-gnu/libnss_* $JAIL/lib/x86_64-linux-gnu/</span>
</code></pre></div><p>Let&rsquo;s give it a 2nd try:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ /usr/sbin/chroot <span style="color:#40ffff">$JAIL</span> /usr/sbin/nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf <span style="color:#24909d">test</span> is successful
</code></pre></div><h2 id="php5-fpm">php5-fpm</h2>
<p>The PHP FastCGI Process Manager (<code>php5-fpm</code>) also requires some libraries and config files that have to be available in the new <code>chroot</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#999;font-style:italic"># Copy config files</span>
$ cp -rfvl /etc/php5 <span style="color:#40ffff">$JAIL</span>/etc/
$ cp -rfvl /usr/share/zoneinfo <span style="color:#40ffff">$JAIL</span>/usr/share/

<span style="color:#999;font-style:italic"># Copy libraries</span>
$ <span style="color:#ed9d13">${</span><span style="color:#40ffff">N2CHROOT</span><span style="color:#ed9d13">}</span> /usr/sbin/php5-fpm

<span style="color:#999;font-style:italic"># Copy the php5-fpm binary</span>
$ cp /usr/sbin/php5-fpm <span style="color:#40ffff">$JAIL</span>/usr/sbin/
</code></pre></div><p>Let&rsquo;s check if everything is ok:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ /usr/sbin/chroot <span style="color:#40ffff">$JAIL</span> /usr/sbin/php5-fpm --help
Failed loading /usr/lib/php5/20131226/opcache.so:  /usr/lib/php5/20131226/opcache.so: cannot open shared object file: No such file or directory
[11-Jan-2016 19:46:19] NOTICE: PHP message: PHP Warning:  PHP Startup: Unable to load dynamic library <span style="color:#ed9d13">&#39;/usr/lib/php5/20131226/mysqlnd.so&#39;</span> - /usr/lib/php5/20131226/mysqlnd.so: cannot open shared object file: No such file or directory in Unknown on line <span style="color:#3677a9">0</span>
[11-Jan-2016 19:46:19] NOTICE: PHP message: PHP Warning:  PHP Startup: Unable to load dynamic library <span style="color:#ed9d13">&#39;/usr/lib/php5/20131226/pdo.so&#39;</span> - /usr/lib/php5/20131226/pdo.so: cannot open shared object file: No such file or directory in Unknown on line <span style="color:#3677a9">0</span>
[11-Jan-2016 19:46:19] NOTICE: PHP message: PHP Warning:  PHP Startup: Unable to load dynamic library <span style="color:#ed9d13">&#39;/usr/lib/php5/20131226/curl.so&#39;</span> - /usr/lib/php5/20131226/curl.so: cannot open shared object file: No such file or directory in ...
</code></pre></div><p>Obviously some libraries are still missing. Let&rsquo;s fix that:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ cp -rvfl /usr/lib/php5 <span style="color:#40ffff">$JAIL</span>/usr/lib
$ <span style="color:#6ab825;font-weight:bold">for</span> f in /usr/lib/php5/20131226/*.so; <span style="color:#6ab825;font-weight:bold">do</span>
&gt;    n2chroot <span style="color:#40ffff">$f</span>
&gt; <span style="color:#6ab825;font-weight:bold">done</span>
</code></pre></div><p>The <code>for</code>-loop will look at every php-module and copy its dependant libraries to the chroot.</p>
<h3 id="cant-execute-exec-shell_exec-or-system">Can&rsquo;t execute exec(), shell_exec() or system()</h3>
<p>If you experience some sort of problems like <a href="http://stackoverflow.com/questions/17006136/exec-with-php-fpm-on-nginx-under-chroot-returns-nothing">this</a> you probably have no <code>/bin/sh</code> inside your chroot (which is great after all, since we want to strip down the environment to a minimal setup). However <strong>PHP</strong>&rsquo;s functions like <code>exec()</code>, <code>shell_exec()</code> or <code>system()</code>will internally call <code>/bin/sh -c</code> to run the commands. So if your PHP application is using something like <code>sendmail</code> and you don&rsquo;t want to install any shell into your chroot, I&rsquo;ve found this <a href="https://knzl.de/setting-up-a-chroot-for-php/">solution</a> from <em>Sebastian Kienzl</em> which basically consists in providing a &ldquo;shell&rdquo; which will in turn use <code>execvp()</code> to run commands.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.c" data-lang=".c"><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;string.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;unistd.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span> 
<span style="color:#cd2828;font-weight:bold">#define MAXARG 64
</span><span style="color:#cd2828;font-weight:bold"></span> 
<span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>( <span style="color:#6ab825;font-weight:bold">int</span> argc, <span style="color:#6ab825;font-weight:bold">char</span>* <span style="color:#6ab825;font-weight:bold">const</span> argv[] ) {
    <span style="color:#6ab825;font-weight:bold">char</span>* args[ MAXARG ] = {};
 
    <span style="color:#6ab825;font-weight:bold">if</span>( argc &lt; <span style="color:#3677a9">3</span> || strcmp( argv[<span style="color:#3677a9">1</span>], <span style="color:#ed9d13">&#34;-c&#34;</span> ) != <span style="color:#3677a9">0</span> ) {
        fprintf( stderr, <span style="color:#ed9d13">&#34;Usage: %s -c &lt;cmd&gt;</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, argv[<span style="color:#3677a9">0</span>] );  
        <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">1</span>;
    }
 
    {
        <span style="color:#6ab825;font-weight:bold">char</span>* token;
        <span style="color:#6ab825;font-weight:bold">int</span> i = <span style="color:#3677a9">0</span>;  
        <span style="color:#6ab825;font-weight:bold">char</span>* argStr = strdup( argv[<span style="color:#3677a9">2</span>] );
        <span style="color:#6ab825;font-weight:bold">while</span>( ( token = strsep( &amp;argStr, <span style="color:#ed9d13">&#34; &#34;</span> ) ) != <span style="color:#24909d">NULL</span> ) {
            <span style="color:#6ab825;font-weight:bold">if</span>( token &amp;&amp; strlen( token ) )
                args[ i++ ] = token;
            <span style="color:#6ab825;font-weight:bold">if</span>( i &gt;= MAXARG )
                <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">2</span>;
        }
    }  
 
    <span style="color:#6ab825;font-weight:bold">return</span> execvp( args[<span style="color:#3677a9">0</span>], args );
}
</code></pre></div><p>Compile this using (I use <code>clang</code>):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ clang -O2 -fpie -pie -Wformat -Wformat-security -Werror=format-security -D_FORTIFY_SOURCE=<span style="color:#3677a9">2</span> <span style="color:#ed9d13">\
</span><span style="color:#ed9d13"></span>  sh.c -o sh
</code></pre></div><p>Now remove the sources and strip the binary:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ rm sh.c
$ strip sh
</code></pre></div><p>However this approach seemed to introduce more problems than it was a decent solution. Depending on the applications and the scope you can decide whether to use a wrapper or provide <code>/bin/sh</code> inside your chroot. Nevertheless there should be no <code>setuid</code> binaries. More on that later.</p>
<h3 id="timezone-is-corrupt">Timezone is corrupt</h3>
<p>If you have issues like:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">PHP message: PHP Fatal error:  date(): Timezone database is corrupt - this should *never* happen!
</code></pre></div><p>or</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">PHP message: PHP Notice:  date_default_timezone_set(): Timezone ID <span style="color:#ed9d13">&#39;UTC&#39;</span> is invalid
</code></pre></div><p>make sure you copy <code>/usr/share/zoneinfo</code> into the chroot:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ cp -Rv /usr/share/zoneinfo <span style="color:#40ffff">$JAIL</span>/usr/share/
</code></pre></div><h2 id="adjust-chroot-security">Adjust chroot() security</h2>
<p>In fact the actual hardening of the environment has not taken place already. Many people have pointed out that <strong>chroot != security</strong> and additional steps are vital for not being able to <strong>unchroot</strong> inside it. A few years ago <a href="https://filippo.io/escaping-a-chroot-jail-slash-1/">Filippo</a> also showed how easy an attacker could achieve that if specific conditions were satisfied. Since <code>chroot()</code> in my opinion it not <strong>THE</strong> security feature I&rsquo;d say it&rsquo;s sort of <strong>security in depth</strong>. Although there are enough cases where  leaving the chroot is possible - if securing it hasn&rsquo;t been done correctly, some recommendations from <a href="http://talby.rcs.manchester.ac.uk/~isd/_unix_security/unix_security_intro_securing_network_services.Breaking_Out_of_and_Securing_Chroot_Jails.html">here</a> should be taken into consideration:</p>
<ul>
<li><strong>not</strong> run daemons as <strong>root</strong></li>
<li>avoid <strong>setuid</strong> executables</li>
<li>ensure root (<strong>UID 0</strong>) does not even exist within the jail</li>
<li>avoid unnecessary bullshit and only install the minimum inside the jail</li>
</ul>
<p>Let&rsquo;s translate those into commands:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash"><span style="color:#999;font-style:italic"># Add users</span>
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;www-data:x:1337:1337:www-data:/:/bin/false&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/passwd
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:x:99:99:nobody:/:/bin/false&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/passwd

<span style="color:#999;font-style:italic"># Add groups</span>
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;www-data:x:1337:&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/group
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:x:99:&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/group

<span style="color:#999;font-style:italic"># Add shadow</span>
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;www-data:x:14871::::::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/shadow
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:x:14871::::::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/shadow

<span style="color:#999;font-style:italic"># Add gshadow</span>
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;www-data:::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/gshadow
$ <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;nobody:::&#34;</span> &gt;&gt; <span style="color:#40ffff">$JAIL</span>/etc/gshadow

<span style="color:#999;font-style:italic"># Set ownerships</span>
$ chown -R root:root <span style="color:#40ffff">$JAIL</span>/
$ chown -R www-data:www-data <span style="color:#40ffff">$JAIL</span>/www
$ chown -R www-data:www-data <span style="color:#40ffff">$JAIL</span>/etc/{nginx,php5}
$ chown -R www-data:www-data <span style="color:#40ffff">$JAIL</span>/var/{log,lib}/nginx
$ chown www-data:www-data <span style="color:#40ffff">$JAIL</span>/run/nginx.pid

<span style="color:#999;font-style:italic"># Restrict permissions</span>
$ find <span style="color:#40ffff">$JAIL</span>/ -gid <span style="color:#3677a9">0</span> -uid <span style="color:#3677a9">0</span> -type d -print | xargs chmod -rw
$ find <span style="color:#40ffff">$JAIL</span>/ -gid <span style="color:#3677a9">0</span> -uid <span style="color:#3677a9">0</span> -type d -print | xargs chmod +x
$ find <span style="color:#40ffff">$JAIL</span>/etc -gid <span style="color:#3677a9">0</span> -uid <span style="color:#3677a9">0</span> -type f -print | xargs chmod -x
$ find <span style="color:#40ffff">$JAIL</span>/usr/sbin -type f -print | xargs chmod ug+rx
$ find <span style="color:#40ffff">$JAIL</span>/ -group www-data -user www-data -print | xargs chmod o-rwx
$ chmod +rw <span style="color:#40ffff">$JAIL</span>/tmp
$ chmod +rw <span style="color:#40ffff">$JAIL</span>/run
</code></pre></div><h2 id="systemd">systemd</h2>
<p>Since <code>systemd</code>is now everywhere you can define your own <strong>service</strong> to start the daemons.</p>
<h3 id="nginx-1">nginx</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ sudo cat /etc/systemd/system/multi-user.target.wants/nginx.service 
<span style="color:#999;font-style:italic"># Stop dance for nginx</span>
<span style="color:#999;font-style:italic"># =======================</span>
<span style="color:#999;font-style:italic">#</span>
<span style="color:#999;font-style:italic"># ExecStop sends SIGSTOP (graceful stop) to the nginx process.</span>
<span style="color:#999;font-style:italic"># If, after 5s (--retry QUIT/5) nginx is still running, systemd takes control</span>
<span style="color:#999;font-style:italic"># and sends SIGTERM (fast shutdown) to the main process.</span>
<span style="color:#999;font-style:italic"># After another 5s (TimeoutStopSec=5), and if nginx is alive, systemd sends</span>
<span style="color:#999;font-style:italic"># SIGKILL to all the remaining processes in the process group (KillMode=mixed).</span>
<span style="color:#999;font-style:italic">#</span>
<span style="color:#999;font-style:italic"># nginx signals reference doc:</span>
<span style="color:#999;font-style:italic"># http://nginx.org/en/docs/control.html</span>
<span style="color:#999;font-style:italic">#</span>
[Unit]
<span style="color:#40ffff">Description</span>=nginx (Chroot)
<span style="color:#40ffff">After</span>=network.target

[Service]
<span style="color:#40ffff">Type</span>=forking
<span style="color:#40ffff">PIDFile</span>=/var/www/chroot/run/nginx.pid
<span style="color:#40ffff">RootDirectory</span>=/var/www/chroot
<span style="color:#40ffff">ExecStartPre</span>=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf
<span style="color:#40ffff">ExecStart</span>=/usr/sbin/nginx -c /etc/nginx/nginx.conf
<span style="color:#40ffff">ExecReload</span>=/usr/sbin/nginx -c /etc/nginx/nginx.conf -s reload
<span style="color:#40ffff">ExecStop</span>=/usr/sbin/nginx -c /etc/nginx/nginx.conf -s stop
<span style="color:#40ffff">TimeoutStopSec</span>=<span style="color:#3677a9">5</span>
<span style="color:#40ffff">KillMode</span>=mixed

[Install]
<span style="color:#40ffff">WantedBy</span>=multi-user.target
</code></pre></div><p>Now run it:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ sudo service nginx start
$ ps -ax | grep nginx
<span style="color:#3677a9">28530</span> ?        Ss     0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
<span style="color:#3677a9">28531</span> ?        S      0:00 nginx: worker process
<span style="color:#3677a9">28613</span> pts/0    S+     0:00 grep nginx
$ ls -l /proc/28530/root
sudo ls -l /proc/28530/root
lrwxrwxrwx <span style="color:#3677a9">1</span> root root <span style="color:#3677a9">0</span> Jan <span style="color:#3677a9">12</span> 21:31 /proc/28530/root -&gt; /var/www/chroot
</code></pre></div><p>If you don&rsquo;t want to use <code>systemd</code> you can use following to start/stop <code>nginx</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ chroot <span style="color:#40ffff">$JAIL</span> /usr/sbin/nginx
$ pgrep nginx | xargs <span style="color:#24909d">kill</span> -9
</code></pre></div><h3 id="php5-fpm-1">php5-fpm</h3>
<p>The same applies to <code>php5-fpm</code> too:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ cat /etc/systemd/system/multi-user.target.wants/php5-fpm.service
[Unit]
<span style="color:#40ffff">Description</span>=The PHP FastCGI Process Manager
<span style="color:#40ffff">After</span>=network.target

[Service] 
<span style="color:#40ffff">Type</span>=notify
<span style="color:#40ffff">PIDFile</span>=/var/run/php5-fpm.pid
<span style="color:#40ffff">ExecStartPre</span>=/usr/xbin/php5 -t
<span style="color:#40ffff">ExecStart</span>=/usr/sbin/php5-fpm --daemonize --fpm-config /etc/php5/fpm/php-fpm.conf
<span style="color:#40ffff">ExecReload</span>=/bin/kill -USR2 <span style="color:#40ffff">$MAINPID</span>

[Install]
<span style="color:#40ffff">WantedBy</span>=multi-user.target
</code></pre></div><p>or start it manually:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ chroot <span style="color:#40ffff">$JAIL</span> /usr/sbin/php5-fpm --daemonize --fpm-config /etc/php5/fpm/php-fpm.conf
$ pgrep php | xargs <span style="color:#24909d">kill</span> -9
</code></pre></div><p>Check if it&rsquo;s indeed running in the chroot:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ ps -ax |grep fpm
 <span style="color:#3677a9">9468</span> ?        Ss     0:00 php-fpm: master process (/etc/php5/fpm/php-fpm.conf)
 <span style="color:#3677a9">9469</span> ?        S      0:00 php-fpm: pool www
 <span style="color:#3677a9">9470</span> ?        S      0:00 php-fpm: pool www
 
$ ls -l /proc/9468/root
lrwxrwxrwx <span style="color:#3677a9">1</span> root root <span style="color:#3677a9">0</span> Jan <span style="color:#3677a9">13</span> 18:04 /proc/9468/root -&gt; /var/www/chroot
</code></pre></div><h2 id="system-v">System V</h2>
<p>If you don&rsquo;t like <code>systemd</code> you can still do it the old way and have your scripts at <code>/etc/init.d/*</code>.</p>
<h3 id="nginx-2">nginx</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ cat /etc/init.d/nginx-chroot 
<span style="color:#999;font-style:italic">#!/bin/sh</span>
 
<span style="color:#999;font-style:italic">### BEGIN INIT INFO</span>
<span style="color:#999;font-style:italic"># Provides:          nginx-chroot</span>
<span style="color:#999;font-style:italic"># Required-Start:    </span>
<span style="color:#999;font-style:italic"># Required-Stop:</span>
<span style="color:#999;font-style:italic"># Default-Start:     2 3 4 5</span>
<span style="color:#999;font-style:italic"># Default-Stop:      0 1 6</span>
<span style="color:#999;font-style:italic"># Short-Description: Start nginx in a chroot</span>
<span style="color:#999;font-style:italic">### END INIT INFO</span>
 
<span style="color:#40ffff">CHROOT</span>=/var/www/chroot
 
<span style="color:#6ab825;font-weight:bold">case</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$1</span><span style="color:#ed9d13">&#34;</span> in
  start)
        /usr/sbin/chroot <span style="color:#40ffff">$CHROOT</span> /usr/sbin/nginx -q -g <span style="color:#ed9d13">&#39;daemon on; master_process on;&#39;</span>
        ;;  
  reload)
        /usr/sbin/chroot <span style="color:#40ffff">$CHROOT</span> /usr/sbin/nginx -g <span style="color:#ed9d13">&#39;daemon on; master_process on;&#39;</span> -s reload
        ;;
  stop) 
        pgrep nginx | xargs <span style="color:#24909d">kill</span> -9  
        ;; 
  *)
        <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;Usage: </span><span style="color:#40ffff">$N</span><span style="color:#ed9d13"> {start|reload|stop}&#34;</span> &gt;&amp;<span style="color:#3677a9">2</span>
        <span style="color:#24909d">exit</span> <span style="color:#3677a9">1</span>
        ;;
<span style="color:#6ab825;font-weight:bold">esac</span>
 
<span style="color:#24909d">exit</span> <span style="color:#3677a9">0</span>
</code></pre></div><h3 id="php5-fpm-2">php5-fpm</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ cat /etc/init.d/php5-fpm-chroot 
<span style="color:#999;font-style:italic">#!/bin/sh</span>
 
<span style="color:#999;font-style:italic">### BEGIN INIT INFO</span>
<span style="color:#999;font-style:italic"># Provides:          php5-fpm-chroot</span>
<span style="color:#999;font-style:italic"># Required-Start:    </span>
<span style="color:#999;font-style:italic"># Required-Stop:</span>
<span style="color:#999;font-style:italic"># Default-Start:     2 3 4 5</span>
<span style="color:#999;font-style:italic"># Default-Stop:      0 1 6</span>
<span style="color:#999;font-style:italic"># Short-Description: Start php5-fpm in a chroot</span>
<span style="color:#999;font-style:italic">### END INIT INFO</span>
 
<span style="color:#40ffff">CHROOT</span>=/var/www/chroot
 
<span style="color:#6ab825;font-weight:bold">case</span> <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$1</span><span style="color:#ed9d13">&#34;</span> in
  start)
        /usr/sbin/chroot <span style="color:#40ffff">$CHROOT</span> /usr/sbin/php5-fpm --daemonize --fpm-config /etc/php5/fpm/php-fpm.conf
        ;;  
  stop) 
        pgrep php | xargs <span style="color:#24909d">kill</span> -9  
        ;; 
  *)
        <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;Usage: </span><span style="color:#40ffff">$N</span><span style="color:#ed9d13"> {start|stop}&#34;</span> &gt;&amp;<span style="color:#3677a9">2</span>
        <span style="color:#24909d">exit</span> <span style="color:#3677a9">1</span>
        ;;
<span style="color:#6ab825;font-weight:bold">esac</span>
 
<span style="color:#24909d">exit</span> <span style="color:#3677a9">0</span>
</code></pre></div><h3 id="install-new-services">Install new services</h3>
<p>First of all make sure you <strong>remove</strong> the old ones:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ update-rc.d nginx remove
$ update-rc.d php5-fpm remove
</code></pre></div><p>Now <strong>add</strong> the <strong>new</strong> ones:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-.bash" data-lang=".bash">$ update-rc.d nginx-chroot defaults
$ update-rc.d php5-fpm-chroot defaults
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Now you have a basic structure to work with. You might want to add more <strong>binaries</strong> to the chroot but keep in mind the implied security concerns. And also try <strong>not</strong> to use symlinks/hardlinks to directories outside the chroot. You can always always override config files in the chroot with backuped one. And to make sure that everything works well, think about using <a href="http://linux.die.net/man/8/auditd">auditd</a> for monitoring file changes inside the chroot.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-host-multiple-websites-securely-with-nginx-and-php-fpm-on-ubuntu-14-04">Howt multiple websites with nginx and php-fpm</a></li>
<li><a href="https://filippo.io/escaping-a-chroot-jail-slash-1/">Escaping a chroot</a></li>
<li><a href="http://stackoverflow.com/questions/17006136/exec-with-php-fpm-on-nginx-under-chroot-returns-nothing">exec with php-fpm on nginx under chroot</a></li>
<li><a href="https://knzl.de/setting-up-a-chroot-for-php/">Setting up a chroot for php</a></li>
</ul>
</div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="http://blog.dornea.nu/2015/11/17/openvpn-for-paranoids/">prev post</a>
  <a href="http://blog.dornea.nu/2016/01/26/some-words-on-csrf-and-cookies/">next post</a>
  </p>
</div>

  <footer class="content-width mt0 mt5-l mb4 f6 center ph3 gray tc tl-l">
  <hr class="dn db-l ml0-l gray w3"><br>
  Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme. <br>
  
</footer>
  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>




</body>
</html>