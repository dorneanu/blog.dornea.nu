<!doctype html>
<html lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<meta name="generator" content="Hugo 0.120.3">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" rel="stylesheet"/>
<style type="text/css">/*https://coolors.co/afd5aa-f0f2ef-a69f98-3d3d3d-8c6057*/
:root {
  --main-color: #8C6056; 
  --secondary-color: #AFD5AA;
  --logo-text-color: #fff;
  --body-text-color: #3d3d3d;
  --heading-text-color: #383838;
  --background-color: #fff;
}</style>
<link href='https://blog.dornea.nu/css/tachyons.min.css' rel="stylesheet">
<link href='https://blog.dornea.nu/css/styles.css' rel="stylesheet">
<link rel="stylesheet" href="https://blog.dornea.nu/css/custom.css">
<link rel="stylesheet" href="https://blog.dornea.nu/css/syntax.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>


<link rel="icon" 
 
  href='https://blog.dornea.nu/favicon.ico'

type="image/x-icon"/>

<link href='https://blog.dornea.nu/feed.xml' rel="alternate" type="application/atom+xml" title="blog.dornea.nu" />



<script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="b8a4b728-8eda-42fb-8376-10168c622160" async>

</script>

</head>
<body class="global-font">
  <nav class="fixed w-100 bg-white bb b--black-10" id="navbar" style="z-index: 9999;">
  <div class="content-width center flex flex-wrap justify-between items-center pa3">
    
    <div class="flex items-center">
      <a class="f4 fw6 ttu no-underline dim bg-main-color pv1 ph3 br2 white" id="site-title" href='https://blog.dornea.nu/' title="Home">blog.dornea.nu</a>
    </div>

    
    <div class="dn flex-l items-center">
      
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
        
          <a class="link dim dark-gray f6 dib ml4 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
        
      
    </div>

    
    <div class="db dn-l">
      <button class="bg-transparent bn pointer dim" id="menu-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  
  <div class="dn bg-white w-100 pa3 shadow-1" id="mobile-menu">
    
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/' title="Home">Home</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='http://dornea.nu' title="About">About</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/feed.xml' title="RSS">RSS</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://blog.dornea.nu/tags' title="Tags">Tags</a>
      
        <a class="link dim dark-gray f6 db pv2 ttu tracked fw5" href='https://brainfck.org' title="Zettelkasten">Zettelkasten</a>
      
    
  </div>
</nav>


<div class="h3"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    
    menuToggle.addEventListener('click', function() {
      const expanded = mobileMenu.classList.contains('db');
      mobileMenu.classList.toggle('db');
      mobileMenu.classList.toggle('dn');
    });
  });
</script>

  
<main class="center mv4 content-width ph3">
  <div class="f3 fw6 heading-color heading-font post-title">HowTo: Put nginx and PHP to jail in Debian 8</div>
  <p class="silver f6 mt1 mb4 post-meta">
    <time>15 Jan 2016</time> 
     | 
    

    
     ~
  

12 mins
|

    
    tags: [ <a href='https://blog.dornea.nu/tags/nginx' class="link silver">nginx</a> <a href='https://blog.dornea.nu/tags/php' class="link silver">php</a> <a href='https://blog.dornea.nu/tags/admin' class="link silver">admin</a> <a href='https://blog.dornea.nu/tags/debian' class="link silver">debian</a> <a href='https://blog.dornea.nu/tags/chroot' class="link silver">chroot</a> <a href='https://blog.dornea.nu/tags/security' class="link silver">security</a>  ]
    

  </p>
  <div class="lh-copy post-content">
    

      <p>Although I thought this would be an easy task, it turned out that <strong>chrooting</strong> daemons takes more than copying config files and libraries. There are donzens of tutorials out there how to do it, but the devil lies in detail - as always. Setting up a chroot environment is easy. But securing it properly is prone to faults which in worst case could let an attacker escape the chroot. And this is your worst nightmare, right? So let&rsquo;s have a look at some more technical details.</p>
<p>For those unfamiliar with <code>chroot</code> make sure you have a look at least the <a href="https://en.wikipedia.org/wiki/Chroot">Wikipedia entry</a>.  There are also soms <a href="http://www.unixwiz.net/techtips/chroot-practices.html">chroot best practices</a> you could have a look at. Although there are better alternatives solving this job (e.g. docker) and being unable to load <strong>LSM</strong> (<a href="https://en.wikipedia.org/wiki/Linux_Security_Modules">Linux Security Modules</a>) on a vServer, putting a daemon to <em>jails</em> seems to be a pretty good approach. But there are several things one should keep in mind since <code>chroot</code> isn&rsquo;t a security feature per se (make sure you read <a href="https://securityblog.redhat.com/2013/03/27/is-chroot-a-security-feature/">&ldquo;Is chroot a security feature?&rdquo;</a> and <a href="https://lwn.net/Articles/252794/">&ldquo;What chroot() is really for&rdquo;</a>).</p>
<h2 id="before-starting">Before starting</h2>
<p>All the shell commands below are part of a <code>bash</code> script I use to setup a secure chroot. Use this <a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f">gist</a> to download the script files:</p>
<ul>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-chroot-sh">chroot.sh</a></li>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-n2chroot">n2chroot</a></li>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-nginx-chroot">nginx-chroot</a> (to copy to <code>/etc/init.d/*</code>)</li>
<li><a href="https://gist.github.com/dorneanu/9f940b2ded9c05b5be9f#file-php5-fpm-chroot">php5-fpm-chroot</a> (to copy to <code>/etc/init.d/*</code>)</li>
</ul>
<p>Make sure you <strong>edit</strong> the files and adapt <code>BASE</code> to your <strong>chroot path</strong> (in my scripts: <code>/var/www/chroot</code>).</p>
<h2 id="unleash-the-daemons">Unleash the daemons</h2>
<p>Nowadays hosting a typical PHP application is  pretty straight-forward. Several components are necesarry:</p>
<ul>
<li>web server (<code>nginx</code>) hosting the application</li>
<li>application (<code>PHP</code>)</li>
<li>data base (<code>mysqld</code>) for storing information</li>
</ul>
<p>The <code>mysqld</code> will usually listen on <em>localhost:3306</em> and can be thus accessed by the processes inside the chroot as well. The <code>nginx</code> and the <code>PHP</code> daemons have some dependencies to be installed inside the chroot otherwise you won&rsquo;t be able to run them. For the sake of example let&rsquo;s have a look at <code>nginx</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ ldd /usr/sbin/nginx
</span></span><span class="line"><span class="cl">    linux-vdso.so.1 <span class="o">(</span>0x00007fffe734d000<span class="o">)</span>
</span></span><span class="line"><span class="cl">    libpthread.so.0 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libpthread.so.0 <span class="o">(</span>0x00007f47b5548000<span class="o">)</span>
</span></span><span class="line"><span class="cl">    libcrypt.so.1 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libcrypt.so.1 <span class="o">(</span>0x00007f47b5311000<span class="o">)</span>
</span></span><span class="line"><span class="cl">    libpam.so.0 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libpam.so.0 <span class="o">(</span>0x00007f47b5101000<span class="o">)</span>
</span></span><span class="line"><span class="cl">    libexpat.so.1 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libexpat.so.1 <span class="o">(</span>0x00007f47b4ed8000<span class="o">)</span>
</span></span><span class="line"><span class="cl">    libpcre.so.3 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libpcre.so.3 <span class="o">(</span>0x00007f47b4c6a000<span class="o">)</span>
</span></span><span class="line"><span class="cl">    libssl.so.1.0.0 <span class="o">=</span>&gt; /usr/lib/x86_64-linux-gnu/libssl.so.1.0.0 <span class="o">(</span>0x00007f47b4a09000<span class="o">)</span>
</span></span><span class="line"><span class="cl">    libcrypto.so.1.0.0 <span class="o">=</span>&gt; /usr/lib/x86_64-linux-gnu/libcrypto.so.1.0.0 <span class="o">(</span>0x00007f47b460e000<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So there are a lot of libraries which have to be copied into the chroot in order for the <code>nginx</code> binary to execute properly. But first, let&rsquo;s setup the basic directory structure.</p>
<h2 id="chroot-environment">chroot() environment</h2>
<p>First we&rsquo;ll create the basic directory structure and copy some basic stuff to it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="c1"># Create devices</span>
</span></span><span class="line"><span class="cl">$ mkdir <span class="nv">$JAIL</span>/dev
</span></span><span class="line"><span class="cl">$ mknod -m <span class="m">0666</span> <span class="nv">$JAIL</span>/dev/null c <span class="m">1</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">$ mknod -m <span class="m">0666</span> <span class="nv">$JAIL</span>/dev/random c <span class="m">1</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">$ mknod -m <span class="m">0444</span> <span class="nv">$JAIL</span>/dev/urandom c <span class="m">1</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create directories</span>
</span></span><span class="line"><span class="cl">$ mkdir -p <span class="nv">$JAIL</span>/<span class="o">{</span>etc,bin,usr,var<span class="o">}</span>
</span></span><span class="line"><span class="cl">$ mkdir -p <span class="nv">$JAIL</span>/usr/<span class="o">{</span>lib,sbin,bin<span class="o">}</span>
</span></span><span class="line"><span class="cl">$ mkdir -p <span class="nv">$JAIL</span>/<span class="o">{</span>run,tmp<span class="o">}</span>
</span></span><span class="line"><span class="cl">$ mkdir -p <span class="nv">$JAIL</span>/var/run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check if 64-bit system</span>
</span></span><span class="line"><span class="cl">$ <span class="k">if</span> <span class="o">[</span> <span class="k">$(</span>uname -m<span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;x86_64&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$JAIL</span><span class="p">;</span> ln -s usr/lib lib64
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$JAIL</span>/usr<span class="p">;</span> ln -s lib lib64
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="nv">$JAIL</span><span class="p">;</span> ln -s usr/lib lib
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy important stuff</span>
</span></span><span class="line"><span class="cl">$ cp -rfvL /etc/<span class="o">{</span>services,localtime,nsswitch.conf,nscd.conf,protocols,hosts,ld.so.cache,ld.so.conf,resolv.conf,host.conf<span class="o">}</span> <span class="nv">$JAIL</span>/etc
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="nginx">nginx</h2>
<p>Next we&rsquo;ll setup <code>nginx</code> and copy necessary config files and libraries:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="c1"># Create directories</span>
</span></span><span class="line"><span class="cl">$ mkdir -p <span class="nv">$JAIL</span>/usr/share/nginx
</span></span><span class="line"><span class="cl">$ mkdir -p <span class="nv">$JAIL</span>/var/<span class="o">{</span>log,lib<span class="o">}</span>/nginx
</span></span><span class="line"><span class="cl">$ mkdir -p <span class="nv">$JAIL</span>/www/cgi-bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy files</span>
</span></span><span class="line"><span class="cl">$ cp -r /usr/share/nginx/* <span class="nv">$JAIL</span>/usr/share/nginx
</span></span><span class="line"><span class="cl">$ cp /usr/sbin/nginx <span class="nv">$JAIL</span>/usr/sbin/
</span></span><span class="line"><span class="cl">$ cp -r /var/lib/nginx <span class="nv">$JAIL</span>/var/lib/nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy libraries</span>
</span></span><span class="line"><span class="cl">$ <span class="si">${</span><span class="nv">N2CHROOT</span><span class="si">}</span> /usr/sbin/nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy config files and other important stuff</span>
</span></span><span class="line"><span class="cl">$ cp -rfvL /etc/nginx <span class="nv">$JAIL</span>/etc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create PID file</span>
</span></span><span class="line"><span class="cl">$ touch <span class="nv">$JAIL</span>/run/nginx.pid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy the nginx binary</span>
</span></span><span class="line"><span class="cl">$ cp /usr/sbin/nginx <span class="nv">$JAIL</span>/usr/sbin/
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="troubleshooting">Troubleshooting</h3>
<p>First let&rsquo;s see if we can run the daemon at all:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ /usr/sbin/chroot <span class="nv">$JAIL</span> /usr/sbin/nginx -t                
</span></span><span class="line"><span class="cl">nginx: <span class="o">[</span>emerg<span class="o">]</span> getpwnam<span class="o">(</span><span class="s2">&#34;www-data&#34;</span><span class="o">)</span> failed in /etc/nginx/nginx.conf:1
</span></span><span class="line"><span class="cl">nginx: configuration file /etc/nginx/nginx.conf <span class="nb">test</span> failed
</span></span></code></pre></td></tr></table>
</div>
</div><p>OK. Let&rsquo;s have a look at <code>strace</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">mmap<span class="o">(</span>NULL, 39842, PROT_READ, MAP_PRIVATE, 5, 0<span class="o">)</span> <span class="o">=</span> 0x7f1d0c620000
</span></span><span class="line"><span class="cl">close<span class="o">(</span>5<span class="o">)</span>                                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">access<span class="o">(</span><span class="s2">&#34;/etc/ld.so.nohwcap&#34;</span>, F_OK<span class="o">)</span>      <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">open<span class="o">(</span><span class="s2">&#34;/lib/x86_64-linux-gnu/libnss_compat.so.2&#34;</span>, O_RDONLY<span class="p">|</span>O_CLOEXEC<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">exit_group<span class="o">(</span>1<span class="o">)</span>                           <span class="o">=</span> ?
</span></span><span class="line"><span class="cl">+++ exited with <span class="m">1</span> +++
</span></span></code></pre></td></tr></table>
</div>
</div><p>Apparently <code>libnss</code> can&rsquo;t be found. Let&rsquo;s fix that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ find / -name <span class="s2">&#34;libnss*&#34;</span>
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_nis-2.19.so
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_compat-2.19.so
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_compat.so.2
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_nisplus.so.2
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_nis.so.2
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_files.so.2
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_dns.so.2
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_files-2.19.so
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_hesiod.so.2
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_nisplus-2.19.so
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_hesiod-2.19.so
</span></span><span class="line"><span class="cl">/lib/x86_64-linux-gnu/libnss_dns-2.19.so
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/libnss_nisplus.so
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/libnss_hesiod.so
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/libnss_compat.so
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/libnss_files.so
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/libnss_dns.so
</span></span><span class="line"><span class="cl">/usr/lib/x86_64-linux-gnu/libnss_nis.so
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># cp /lib/x86_64-linux-gnu/libnss_* $JAIL/lib/x86_64-linux-gnu/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s give it a 2nd try:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ /usr/sbin/chroot <span class="nv">$JAIL</span> /usr/sbin/nginx -t
</span></span><span class="line"><span class="cl">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
</span></span><span class="line"><span class="cl">nginx: configuration file /etc/nginx/nginx.conf <span class="nb">test</span> is successful
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="php5-fpm">php5-fpm</h2>
<p>The PHP FastCGI Process Manager (<code>php5-fpm</code>) also requires some libraries and config files that have to be available in the new <code>chroot</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="c1"># Copy config files</span>
</span></span><span class="line"><span class="cl">$ cp -rfvl /etc/php5 <span class="nv">$JAIL</span>/etc/
</span></span><span class="line"><span class="cl">$ cp -rfvl /usr/share/zoneinfo <span class="nv">$JAIL</span>/usr/share/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy libraries</span>
</span></span><span class="line"><span class="cl">$ <span class="si">${</span><span class="nv">N2CHROOT</span><span class="si">}</span> /usr/sbin/php5-fpm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy the php5-fpm binary</span>
</span></span><span class="line"><span class="cl">$ cp /usr/sbin/php5-fpm <span class="nv">$JAIL</span>/usr/sbin/
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s check if everything is ok:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ /usr/sbin/chroot <span class="nv">$JAIL</span> /usr/sbin/php5-fpm --help
</span></span><span class="line"><span class="cl">Failed loading /usr/lib/php5/20131226/opcache.so:  /usr/lib/php5/20131226/opcache.so: cannot open shared object file: No such file or directory
</span></span><span class="line"><span class="cl"><span class="o">[</span>11-Jan-2016 19:46:19<span class="o">]</span> NOTICE: PHP message: PHP Warning:  PHP Startup: Unable to load dynamic library <span class="s1">&#39;/usr/lib/php5/20131226/mysqlnd.so&#39;</span> - /usr/lib/php5/20131226/mysqlnd.so: cannot open shared object file: No such file or directory in Unknown on line <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>11-Jan-2016 19:46:19<span class="o">]</span> NOTICE: PHP message: PHP Warning:  PHP Startup: Unable to load dynamic library <span class="s1">&#39;/usr/lib/php5/20131226/pdo.so&#39;</span> - /usr/lib/php5/20131226/pdo.so: cannot open shared object file: No such file or directory in Unknown on line <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>11-Jan-2016 19:46:19<span class="o">]</span> NOTICE: PHP message: PHP Warning:  PHP Startup: Unable to load dynamic library <span class="s1">&#39;/usr/lib/php5/20131226/curl.so&#39;</span> - /usr/lib/php5/20131226/curl.so: cannot open shared object file: No such file or directory in ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Obviously some libraries are still missing. Let&rsquo;s fix that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ cp -rvfl /usr/lib/php5 <span class="nv">$JAIL</span>/usr/lib
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> f in /usr/lib/php5/20131226/*.so<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">&gt;    n2chroot <span class="nv">$f</span>
</span></span><span class="line"><span class="cl">&gt; <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>for</code>-loop will look at every php-module and copy its dependant libraries to the chroot.</p>
<h3 id="cant-execute-exec-shell_exec-or-system">Can&rsquo;t execute exec(), shell_exec() or system()</h3>
<p>If you experience some sort of problems like <a href="http://stackoverflow.com/questions/17006136/exec-with-php-fpm-on-nginx-under-chroot-returns-nothing">this</a> you probably have no <code>/bin/sh</code> inside your chroot (which is great after all, since we want to strip down the environment to a minimal setup). However <strong>PHP</strong>&rsquo;s functions like <code>exec()</code>, <code>shell_exec()</code> or <code>system()</code>will internally call <code>/bin/sh -c</code> to run the commands. So if your PHP application is using something like <code>sendmail</code> and you don&rsquo;t want to install any shell into your chroot, I&rsquo;ve found this <a href="https://knzl.de/setting-up-a-chroot-for-php/">solution</a> from <em>Sebastian Kienzl</em> which basically consists in providing a &ldquo;shell&rdquo; which will in turn use <code>execvp()</code> to run commands.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.c" data-lang=".c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> 
</span></span><span class="line"><span class="cl"><span class="cp">#define MAXARG 64
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> 
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[]</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">args</span><span class="p">[</span> <span class="n">MAXARG</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="nf">strcmp</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-c&#34;</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s -c &lt;cmd&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span><span class="o">*</span> <span class="n">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="kt">char</span><span class="o">*</span> <span class="n">argStr</span> <span class="o">=</span> <span class="nf">strdup</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span> <span class="p">(</span> <span class="n">token</span> <span class="o">=</span> <span class="nf">strsep</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">argStr</span><span class="p">,</span> <span class="s">&#34; &#34;</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span> <span class="n">token</span> <span class="o">&amp;&amp;</span> <span class="nf">strlen</span><span class="p">(</span> <span class="n">token</span> <span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">[</span> <span class="n">i</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAXARG</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">execvp</span><span class="p">(</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Compile this using (I use <code>clang</code>):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ clang -O2 -fpie -pie -Wformat -Wformat-security -Werror<span class="o">=</span>format-security -D_FORTIFY_SOURCE<span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  sh.c -o sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now remove the sources and strip the binary:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ rm sh.c
</span></span><span class="line"><span class="cl">$ strip sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>However this approach seemed to introduce more problems than it was a decent solution. Depending on the applications and the scope you can decide whether to use a wrapper or provide <code>/bin/sh</code> inside your chroot. Nevertheless there should be no <code>setuid</code> binaries. More on that later.</p>
<h3 id="timezone-is-corrupt">Timezone is corrupt</h3>
<p>If you have issues like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">PHP message: PHP Fatal error:  date<span class="o">()</span>: Timezone database is corrupt - this should *never* happen!
</span></span></code></pre></td></tr></table>
</div>
</div><p>or</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">PHP message: PHP Notice:  date_default_timezone_set<span class="o">()</span>: Timezone ID <span class="s1">&#39;UTC&#39;</span> is invalid
</span></span></code></pre></td></tr></table>
</div>
</div><p>make sure you copy <code>/usr/share/zoneinfo</code> into the chroot:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ cp -Rv /usr/share/zoneinfo <span class="nv">$JAIL</span>/usr/share/
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="adjust-chroot-security">Adjust chroot() security</h2>
<p>In fact the actual hardening of the environment has not taken place already. Many people have pointed out that <strong>chroot != security</strong> and additional steps are vital for not being able to <strong>unchroot</strong> inside it. A few years ago <a href="https://filippo.io/escaping-a-chroot-jail-slash-1/">Filippo</a> also showed how easy an attacker could achieve that if specific conditions were satisfied. Since <code>chroot()</code> in my opinion it not <strong>THE</strong> security feature I&rsquo;d say it&rsquo;s sort of <strong>security in depth</strong>. Although there are enough cases where  leaving the chroot is possible - if securing it hasn&rsquo;t been done correctly, some recommendations from <a href="http://talby.rcs.manchester.ac.uk/~isd/_unix_security/unix_security_intro_securing_network_services.Breaking_Out_of_and_Securing_Chroot_Jails.html">here</a> should be taken into consideration:</p>
<ul>
<li><strong>not</strong> run daemons as <strong>root</strong></li>
<li>avoid <strong>setuid</strong> executables</li>
<li>ensure root (<strong>UID 0</strong>) does not even exist within the jail</li>
<li>avoid unnecessary bullshit and only install the minimum inside the jail</li>
</ul>
<p>Let&rsquo;s translate those into commands:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl"><span class="c1"># Add users</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;www-data:x:1337:1337:www-data:/:/bin/false&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/passwd
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;nobody:x:99:99:nobody:/:/bin/false&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/passwd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add groups</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;www-data:x:1337:&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/group
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;nobody:x:99:&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/group
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add shadow</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;www-data:x:14871::::::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/shadow
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;nobody:x:14871::::::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/shadow
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add gshadow</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;www-data:::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/gshadow
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;nobody:::&#34;</span> &gt;&gt; <span class="nv">$JAIL</span>/etc/gshadow
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set ownerships</span>
</span></span><span class="line"><span class="cl">$ chown -R root:root <span class="nv">$JAIL</span>/
</span></span><span class="line"><span class="cl">$ chown -R www-data:www-data <span class="nv">$JAIL</span>/www
</span></span><span class="line"><span class="cl">$ chown -R www-data:www-data <span class="nv">$JAIL</span>/etc/<span class="o">{</span>nginx,php5<span class="o">}</span>
</span></span><span class="line"><span class="cl">$ chown -R www-data:www-data <span class="nv">$JAIL</span>/var/<span class="o">{</span>log,lib<span class="o">}</span>/nginx
</span></span><span class="line"><span class="cl">$ chown www-data:www-data <span class="nv">$JAIL</span>/run/nginx.pid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Restrict permissions</span>
</span></span><span class="line"><span class="cl">$ find <span class="nv">$JAIL</span>/ -gid <span class="m">0</span> -uid <span class="m">0</span> -type d -print <span class="p">|</span> xargs chmod -rw
</span></span><span class="line"><span class="cl">$ find <span class="nv">$JAIL</span>/ -gid <span class="m">0</span> -uid <span class="m">0</span> -type d -print <span class="p">|</span> xargs chmod +x
</span></span><span class="line"><span class="cl">$ find <span class="nv">$JAIL</span>/etc -gid <span class="m">0</span> -uid <span class="m">0</span> -type f -print <span class="p">|</span> xargs chmod -x
</span></span><span class="line"><span class="cl">$ find <span class="nv">$JAIL</span>/usr/sbin -type f -print <span class="p">|</span> xargs chmod ug+rx
</span></span><span class="line"><span class="cl">$ find <span class="nv">$JAIL</span>/ -group www-data -user www-data -print <span class="p">|</span> xargs chmod o-rwx
</span></span><span class="line"><span class="cl">$ chmod +rw <span class="nv">$JAIL</span>/tmp
</span></span><span class="line"><span class="cl">$ chmod +rw <span class="nv">$JAIL</span>/run
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="systemd">systemd</h2>
<p>Since <code>systemd</code>is now everywhere you can define your own <strong>service</strong> to start the daemons.</p>
<h3 id="nginx-1">nginx</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ sudo cat /etc/systemd/system/multi-user.target.wants/nginx.service 
</span></span><span class="line"><span class="cl"><span class="c1"># Stop dance for nginx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># =======================</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ExecStop sends SIGSTOP (graceful stop) to the nginx process.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If, after 5s (--retry QUIT/5) nginx is still running, systemd takes control</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and sends SIGTERM (fast shutdown) to the main process.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># After another 5s (TimeoutStopSec=5), and if nginx is alive, systemd sends</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SIGKILL to all the remaining processes in the process group (KillMode=mixed).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># nginx signals reference doc:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># http://nginx.org/en/docs/control.html</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Unit<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Description</span><span class="o">=</span>nginx <span class="o">(</span>Chroot<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">After</span><span class="o">=</span>network.target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Type</span><span class="o">=</span>forking
</span></span><span class="line"><span class="cl"><span class="nv">PIDFile</span><span class="o">=</span>/var/www/chroot/run/nginx.pid
</span></span><span class="line"><span class="cl"><span class="nv">RootDirectory</span><span class="o">=</span>/var/www/chroot
</span></span><span class="line"><span class="cl"><span class="nv">ExecStartPre</span><span class="o">=</span>/usr/sbin/nginx -t -c /etc/nginx/nginx.conf
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/nginx -c /etc/nginx/nginx.conf
</span></span><span class="line"><span class="cl"><span class="nv">ExecReload</span><span class="o">=</span>/usr/sbin/nginx -c /etc/nginx/nginx.conf -s reload
</span></span><span class="line"><span class="cl"><span class="nv">ExecStop</span><span class="o">=</span>/usr/sbin/nginx -c /etc/nginx/nginx.conf -s stop
</span></span><span class="line"><span class="cl"><span class="nv">TimeoutStopSec</span><span class="o">=</span><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="nv">KillMode</span><span class="o">=</span>mixed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Install<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now run it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ sudo service nginx start
</span></span><span class="line"><span class="cl">$ ps -ax <span class="p">|</span> grep nginx
</span></span><span class="line"><span class="cl"><span class="m">28530</span> ?        Ss     0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
</span></span><span class="line"><span class="cl"><span class="m">28531</span> ?        S      0:00 nginx: worker process
</span></span><span class="line"><span class="cl"><span class="m">28613</span> pts/0    S+     0:00 grep nginx
</span></span><span class="line"><span class="cl">$ ls -l /proc/28530/root
</span></span><span class="line"><span class="cl">sudo ls -l /proc/28530/root
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Jan <span class="m">12</span> 21:31 /proc/28530/root -&gt; /var/www/chroot
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you don&rsquo;t want to use <code>systemd</code> you can use following to start/stop <code>nginx</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ chroot <span class="nv">$JAIL</span> /usr/sbin/nginx
</span></span><span class="line"><span class="cl">$ pgrep nginx <span class="p">|</span> xargs <span class="nb">kill</span> -9
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="php5-fpm-1">php5-fpm</h3>
<p>The same applies to <code>php5-fpm</code> too:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ cat /etc/systemd/system/multi-user.target.wants/php5-fpm.service
</span></span><span class="line"><span class="cl"><span class="o">[</span>Unit<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Description</span><span class="o">=</span>The PHP FastCGI Process Manager
</span></span><span class="line"><span class="cl"><span class="nv">After</span><span class="o">=</span>network.target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="nv">Type</span><span class="o">=</span>notify
</span></span><span class="line"><span class="cl"><span class="nv">PIDFile</span><span class="o">=</span>/var/run/php5-fpm.pid
</span></span><span class="line"><span class="cl"><span class="nv">ExecStartPre</span><span class="o">=</span>/usr/xbin/php5 -t
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/php5-fpm --daemonize --fpm-config /etc/php5/fpm/php-fpm.conf
</span></span><span class="line"><span class="cl"><span class="nv">ExecReload</span><span class="o">=</span>/bin/kill -USR2 <span class="nv">$MAINPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Install<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></span></code></pre></td></tr></table>
</div>
</div><p>or start it manually:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ chroot <span class="nv">$JAIL</span> /usr/sbin/php5-fpm --daemonize --fpm-config /etc/php5/fpm/php-fpm.conf
</span></span><span class="line"><span class="cl">$ pgrep php <span class="p">|</span> xargs <span class="nb">kill</span> -9
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check if it&rsquo;s indeed running in the chroot:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ ps -ax <span class="p">|</span>grep fpm
</span></span><span class="line"><span class="cl"> <span class="m">9468</span> ?        Ss     0:00 php-fpm: master process <span class="o">(</span>/etc/php5/fpm/php-fpm.conf<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="m">9469</span> ?        S      0:00 php-fpm: pool www
</span></span><span class="line"><span class="cl"> <span class="m">9470</span> ?        S      0:00 php-fpm: pool www
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">$ ls -l /proc/9468/root
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Jan <span class="m">13</span> 18:04 /proc/9468/root -&gt; /var/www/chroot
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="system-v">System V</h2>
<p>If you don&rsquo;t like <code>systemd</code> you can still do it the old way and have your scripts at <code>/etc/init.d/*</code>.</p>
<h3 id="nginx-2">nginx</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ cat /etc/init.d/nginx-chroot 
</span></span><span class="line"><span class="cl"><span class="c1">#!/bin/sh</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">### BEGIN INIT INFO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Provides:          nginx-chroot</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Required-Start:    </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Required-Stop:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default-Start:     2 3 4 5</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default-Stop:      0 1 6</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Short-Description: Start nginx in a chroot</span>
</span></span><span class="line"><span class="cl"><span class="c1">### END INIT INFO</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nv">CHROOT</span><span class="o">=</span>/var/www/chroot
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">  start<span class="o">)</span>
</span></span><span class="line"><span class="cl">        /usr/sbin/chroot <span class="nv">$CHROOT</span> /usr/sbin/nginx -q -g <span class="s1">&#39;daemon on; master_process on;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">;;</span>  
</span></span><span class="line"><span class="cl">  reload<span class="o">)</span>
</span></span><span class="line"><span class="cl">        /usr/sbin/chroot <span class="nv">$CHROOT</span> /usr/sbin/nginx -g <span class="s1">&#39;daemon on; master_process on;&#39;</span> -s reload
</span></span><span class="line"><span class="cl">        <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  stop<span class="o">)</span> 
</span></span><span class="line"><span class="cl">        pgrep nginx <span class="p">|</span> xargs <span class="nb">kill</span> -9  
</span></span><span class="line"><span class="cl">        <span class="p">;;</span> 
</span></span><span class="line"><span class="cl">  *<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Usage: </span><span class="nv">$N</span><span class="s2"> {start|reload|stop}&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="php5-fpm-2">php5-fpm</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ cat /etc/init.d/php5-fpm-chroot 
</span></span><span class="line"><span class="cl"><span class="c1">#!/bin/sh</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">### BEGIN INIT INFO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Provides:          php5-fpm-chroot</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Required-Start:    </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Required-Stop:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default-Start:     2 3 4 5</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default-Stop:      0 1 6</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Short-Description: Start php5-fpm in a chroot</span>
</span></span><span class="line"><span class="cl"><span class="c1">### END INIT INFO</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nv">CHROOT</span><span class="o">=</span>/var/www/chroot
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">  start<span class="o">)</span>
</span></span><span class="line"><span class="cl">        /usr/sbin/chroot <span class="nv">$CHROOT</span> /usr/sbin/php5-fpm --daemonize --fpm-config /etc/php5/fpm/php-fpm.conf
</span></span><span class="line"><span class="cl">        <span class="p">;;</span>  
</span></span><span class="line"><span class="cl">  stop<span class="o">)</span> 
</span></span><span class="line"><span class="cl">        pgrep php <span class="p">|</span> xargs <span class="nb">kill</span> -9  
</span></span><span class="line"><span class="cl">        <span class="p">;;</span> 
</span></span><span class="line"><span class="cl">  *<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Usage: </span><span class="nv">$N</span><span class="s2"> {start|stop}&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="install-new-services">Install new services</h3>
<p>First of all make sure you <strong>remove</strong> the old ones:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ update-rc.d nginx remove
</span></span><span class="line"><span class="cl">$ update-rc.d php5-fpm remove
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now <strong>add</strong> the <strong>new</strong> ones:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-.bash" data-lang=".bash"><span class="line"><span class="cl">$ update-rc.d nginx-chroot defaults
</span></span><span class="line"><span class="cl">$ update-rc.d php5-fpm-chroot defaults
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="conclusion">Conclusion</h2>
<p>Now you have a basic structure to work with. You might want to add more <strong>binaries</strong> to the chroot but keep in mind the implied security concerns. And also try <strong>not</strong> to use symlinks/hardlinks to directories outside the chroot. You can always always override config files in the chroot with backuped one. And to make sure that everything works well, think about using <a href="http://linux.die.net/man/8/auditd">auditd</a> for monitoring file changes inside the chroot.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-host-multiple-websites-securely-with-nginx-and-php-fpm-on-ubuntu-14-04">Howt multiple websites with nginx and php-fpm</a></li>
<li><a href="https://filippo.io/escaping-a-chroot-jail-slash-1/">Escaping a chroot</a></li>
<li><a href="http://stackoverflow.com/questions/17006136/exec-with-php-fpm-on-nginx-under-chroot-returns-nothing">exec with php-fpm on nginx under chroot</a></li>
<li><a href="https://knzl.de/setting-up-a-chroot-for-php/">Setting up a chroot for php</a></li>
</ul>

    

  </div>
  
  
  

<section class="related-topics mt5 mb4">
  <div class="bt b--black-10 pt4">
    <h3 class="f4 fw6 mb3">Explore Related Topics</h3>
    
    <div class="cf">
      
      
      
      
      
      
      
      
      
      
      
      <div class="fl w-100">
        <div class="pa3 br2 bg-white ba b--black-10">
          <h4 class="f5 fw6 mt0 mb2">Explore My Main Topics</h4>
          <div class="cf">
            <div class="fl w-third-l pr2">
              <ul class="list pl0 mt0">
                <li class="pv1"><a href="https://blog.dornea.nu/tags/books" class="link dim dark-gray f6">Books & Reading</a></li>
                <li class="pv1"><a href="https://blog.dornea.nu/tags/summary" class="link dim dark-gray f6">Book Summaries</a></li>
              </ul>
            </div>
            <div class="fl w-third-l ph2">
              <ul class="list pl0 mt0">
                <li class="pv1"><a href="https://blog.dornea.nu/tags/philosophy" class="link dim dark-gray f6">Philosophy</a></li>
                <li class="pv1"><a href="https://blog.dornea.nu/tags/productivity" class="link dim dark-gray f6">Productivity</a></li>
                <li class="pv1"><a href="https://blog.dornea.nu/tags/politics" class="link dim dark-gray f6">Politics</a></li>
              </ul>
            </div>
            <div class="fl w-third-l pl2">
              <ul class="list pl0 mt0">
                <li class="pv1"><a href="https://blog.dornea.nu/tags/coding" class="link dim dark-gray f6">Coding</a></li>
                <li class="pv1"><a href="https://blog.dornea.nu/tags/emacs" class="link dim dark-gray f6">Emacs</a></li>
                <li class="pv1"><a href="https://brainfck.org" class="link dim dark-gray f6">My Zettelkasten</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
    </div>
    
    <div class="tc mt4">
      <a href="https://blog.dornea.nu/tags" class="f6 link dim br-pill ph3 pv2 mb2 dib white bg-main-color">Browse All Tags</a>
    </div>
  </div>
</section>
  
  <div id="comments">
      

  </div>
</main>
 






<div class="tl fixed list-pages lh-copy" id="contents-list"></div>



<div class="pagination tc tr-l db fixed-l bottom-2-l right-2-l mb3 mb0-l">
  
<a id="scroll-to-top" class="f6 o-0 link br2 ph2 pv1 mb1 bg-main-color pointer" onclick="topFunction()" style="color: #fff; visibility: hidden; display: none; transition: opacity .5s, visibility .5s;" title="back to top">back to top</a>
<br>
  <p class="mb0 mt2">
  <a href="https://blog.dornea.nu/2015/11/17/openvpn-for-paranoids/">prev</a>
  <a href="https://blog.dornea.nu/2016/01/26/some-words-on-csrf-and-cookies/">next</a>
  </p>
</div>

  <footer class="content-width mt5 mb4 center ph3 gray f6">
  
  <div class="bt b--black-10 pv3"></div>
  
  
  <div class="cf">
    
    <div class="fl w-100 w-50-l pr4-l">
      <p class="mb2 fw6">About this blog</p>
      <p class="mv0 lh-copy">
        Personal thoughts on programming, productivity, and philosophy. I write about things I'm learning and ideas I find interesting.
      </p>
      <p class="mt3 o-70">
        © 2025 Victor Dorneanu
      </p>
    </div>
    
    
    <div class="fl w-100 w-50-l pl4-l mt4 mt0-l">
      <div class="cf">
        
        <div class="fl w-33">
          <p class="mb2 fw6">Navigation</p>
          <ul class="list pl0">
            <li class="pv1"><a href='https://blog.dornea.nu/' title="Home" class="link gray dim">Home</a></li>
            <li class="pv1"><a href='http://dornea.nu' title="About" class="link gray dim">About</a></li>
            <li class="pv1"><a href='https://blog.dornea.nu/tags' title="Tags" class="link gray dim">Tags</a></li>
            <li class="pv1"><a href='https://brainfck.org' title="Zettelkasten" class="link gray dim">Zettelkasten</a></li>
          </ul>
        </div>
        
        
        <div class="fl w-33">
          <p class="mb2 fw6">Connect</p>
          <ul class="list pl0">
            <li class="pv1">
              <a href='https://blog.dornea.nu/feed.xml' title="RSS" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
                RSS Feed
              </a>
            </li>
            <li class="pv1">
              <a href='https://github.com/dorneanu' title="GitHub" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                GitHub
              </a>
            </li>
            <li class="pv1">
              <a href='https://www.goodreads.com/user/show/121423977-victor-dorneanu' title="Goodreads" class="link gray dim">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="v-mid mr1"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                Goodreads
              </a>
            </li>
          </ul>
        </div>

        
        <div class="fl w-33">
          <p class="mb2 fw6">Support</p>
          <div class="pv1">
            <a href="https://www.buymeacoffee.com/dorneanu" target="_blank" class="dib">
              <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px;">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  
  <div class="tc mt4 pt3 f7 o-70">
    Powered by <a href="https://gohugo.io/" target="_blank" class="link gray dim">Hugo</a>, based on the <a href="https://github.com/lingxz/er" target="_blank" class="link gray dim">Er</a> theme.
  </div>
</footer>
  



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<style>.is-active-link::before { background-color: var(--secondary-color); }</style>




<script type="text/javascript">
var prevScrollpos = window.pageYOffset;
window.onscroll = function() {
  var currentScrollPos = window.pageYOffset;

  
  if (document.getElementById("tag-cloud") !== null) { 
    if (prevScrollpos > currentScrollPos) { 
      document.getElementById("tag-cloud").style.visibility = "visible";
      document.getElementById("tag-cloud").style.opacity = "1";
    } else {
      document.getElementById("tag-cloud").style.visibility = "hidden";
      document.getElementById("tag-cloud").style.opacity = "0";
    }
  }
  

  
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
      document.getElementById("scroll-to-top").style.display = "inline";
      document.getElementById("scroll-to-top").style.visibility = "visible";
      document.getElementById("scroll-to-top").style.opacity = "1";
  } else {
      document.getElementById("scroll-to-top").style.visibility = "hidden";
      document.getElementById("scroll-to-top").style.opacity = "0";
  }
  
  prevScrollpos = currentScrollPos;
}


function topFunction() {
  document.body.scrollTop = 0; 
  document.documentElement.scrollTop = 0; 
}






if (document.getElementById("contents-list") !== null && document.getElementsByClassName("post-content").length !== 0) { 
  tocbot.init({
    
    tocSelector: '#contents-list',
    
    contentSelector: '.post-content',
    
    headingSelector: 'h1, h2, h3',
  });
}


</script>





<script>
 var glightbox = GLightbox({
     selector: '.glightbox'
 });
</script>

  
</body>
</html>
